function WBin(){}WBin.HEADER_SIZE=64;WBin.FOUR_CC="WBIN";WBin.VERSION=0.3;WBin.CLASSNAME_SIZE=32;WBin.LUMPNAME_SIZE=54;WBin.LUMPHEADER_SIZE=10+WBin.LUMPNAME_SIZE;WBin.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",String:"ST",WString:"WS",Number:"NU","null":"00"};WBin.REVERSE_CODES={};for(var i in WBin.CODES)WBin.REVERSE_CODES[WBin.CODES[i]]=i;WBin.FULL_BINARY=1;
WBin.isWBin=function(a){a=a.subarray(0,4);for(var b=0;b<a.length;b++)if(0!=a[b]&&a[b]!=WBin.FOUR_CC.charCodeAt(b))return!1;return!0};
WBin.create=function(a,b){if(!a)throw"WBin null origin passed";var c=new Uint8Array([0,0]),d=new Uint8Array((new Float32Array([WBin.VERSION])).buffer);b=b||"";if(a.toBinary){var e=a.toBinary();if(!e)return null;if(e.constructor==ArrayBuffer){c[0]|=WBin.FULL_BINARY;var f=WBin.getObjectClassName(a),g=new Uint8Array(WBin.HEADER_SIZE+e.length);g.set(WBin.stringToUint8Array(WBin.FOUR_CC));g.set(d,4);g.set(c,8);g.set(WBin.stringToUint8Array(f,WBin.CLASSNAME_SIZE),14);g.set(e,WBin.HEADER_SIZE);return g}a=
e}var h=WBin.HEADER_SIZE,e=[],l=0,k;for(k in a)if(g=a[k],null!=g){f=WBin.getObjectClassName(g);(f=WBin.CODES[f])||(f="OB");"NU"==f?g=new Float64Array([g]):"OB"==f&&(g=JSON.stringify(g));var m=0;"string"==typeof g&&(g=WBin.stringToUint8Array(g));if(g.buffer&&g.buffer.constructor==ArrayBuffer)g=new Uint8Array(new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength)),m=g.byteLength;else if(g.constructor==ArrayBuffer)m=g.byteLength;else throw"WBin: cannot be anything different to ArrayBuffer";
var n=k.substring(0,WBin.LUMPNAME_SIZE);n.length<k.length&&console.error("Lump name is too long (max is "+WBin.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future");e.push({code:f,name:n,data:g,start:l,size:m});l+=m;h+=WBin.LUMPHEADER_SIZE+m}g=new Uint8Array(h);g.set(WBin.stringToUint8Array(WBin.FOUR_CC));g.set(d,4);g.set(c,8);g.set(new Uint8Array((new Uint16Array([e.length])).buffer),10);b&&g.set(WBin.stringToUint8Array(b,WBin.CLASSNAME_SIZE),12);var c=WBin.HEADER_SIZE+
e.length*WBin.LUMPHEADER_SIZE,d=WBin.HEADER_SIZE,p;for(p in e)k=e[p],h=new Uint8Array(WBin.LUMPHEADER_SIZE),h.set(new Uint8Array((new Uint32Array([k.start])).buffer),0),h.set(new Uint8Array((new Uint32Array([k.size])).buffer),4),h.set(WBin.stringToUint8Array(k.code,2),8),h.set(WBin.stringToUint8Array(k.name,WBin.LUMPNAME_SIZE),10),g.set(h,d),d+=WBin.LUMPHEADER_SIZE,h=new Uint8Array(k.data),g.set(h,c+k.start);return g};
WBin.load=function(a,b){a=new Uint8Array(a);var c=WBin.getHeaderInfo(a);if(!c)return console.error("Wrong WBin Header"),null;c.version>(new Float32Array([WBin.VERSION]))[0]&&console.log("ALERT: WBin version is higher that code version");var d={},e;for(e in c.lumps){var f=c.lumps[e],g=c.lump_data.subarray(f.start,f.start+f.size);if(f.size!=g.length)throw"WBin: incorrect wbin lump size";var h=null,l=WBin.REVERSE_CODES[f.code];if(!l)throw"WBin: Incorrect data code";switch(l){case "null":break;case "String":h=
WBin.Uint8ArrayToString(g);break;case "Number":h=0.3>c.version?parseFloat(WBin.Uint8ArrayToString(g)):(new Float64Array(g.buffer))[0];break;case "Object":h=JSON.parse(WBin.Uint8ArrayToString(g));break;case "ArrayBuffer":h=(new Uint8Array(g)).buffer;break;default:g=new Uint8Array(g);h=window[l];if(!h)throw"ctor not found in WBin: "+l;if(0!=g.length/h.BYTES_PER_ELEMENT%1)throw"WBin: size do not match type";h=new h(g.buffer)}d[f.name]=h}if(!b&&c.classname){if((h=window[c.classname])&&h.fromBinary)return h.fromBinary(d);
if(h&&h.prototype.fromBinary)return c=new h,c.fromBinary(d),c;d["@classname"]=c.classname}return d};
WBin.getHeaderInfo=function(a){for(var b=a.subarray(0,4),c=0;c<b.length;c++)if(0!=b[c]&&b[c]!=WBin.FOUR_CC.charCodeAt(c))return null;for(var b=WBin.readFloat32(a,4),d=new Uint8Array(a.subarray(8,10)),e=WBin.readUint16(a,10),f=WBin.Uint8ArrayToString(a.subarray(12,12+WBin.CLASSNAME_SIZE)),g=[],c=0;c<e;++c){var h=WBin.HEADER_SIZE+c*WBin.LUMPHEADER_SIZE,h=a.subarray(h,h+WBin.LUMPHEADER_SIZE),l={};l.start=WBin.readUint32(h,0);l.size=WBin.readUint32(h,4);l.code=WBin.Uint8ArrayToString(h.subarray(8,10));
l.name=WBin.Uint8ArrayToString(h.subarray(10));g.push(l)}a=a.subarray(WBin.HEADER_SIZE+e*WBin.LUMPHEADER_SIZE);return{version:b,flags:d,classname:f,numlumps:e,lumps:g,lump_data:a}};WBin.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};
WBin.stringToUint8Array=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=!1,e=0;e<a.length;e++){var f=a.charCodeAt(e);255<f&&(d=!0);c[e]=f}d&&console.warn("WBin: there are characters in the string that cannot be encoded in 1 byte.");return c};WBin.Uint8ArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};WBin.readUint16=function(a,b){var c=new Uint16Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+2));return c[0]};
WBin.readUint32=function(a,b){var c=new Uint32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};WBin.readFloat32=function(a,b){var c=new Float32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};
var Draw={ready:!1,images:{},onRequestFrame:null,init:function(){!this.ready&&gl&&(this.color=new Float32Array(4),this.color[3]=1,this.mvp_matrix=mat4.create(),this.temp_matrix=mat4.create(),this.point_size=2,this.stack=new Float32Array(512),this.model_matrix=new Float32Array(this.stack.buffer,0,16),mat4.identity(this.model_matrix),this.camera=null,this.camera_position=vec3.create(),this.view_matrix=mat4.create(),this.projection_matrix=mat4.create(),this.viewprojection_matrix=mat4.create(),this.camera_stack=
[],this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]}),this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t"),
this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:""}),this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_TEXTURE:""}),this.shader_points=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_POINTS:""}),this.shader_points_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_POINTS:""}),this.shader_points_color_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_SIZE:"",USE_POINTS:""}),this.shader_image=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t"),
this.shader_points_color_texture_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tattribute float a_extra;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size * a_extra;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * v_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t"),
this.shader_phong=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_vertex + a_normal,1.0)).xyz - v_pos;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\t\t"),
this.shader_depth=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tvarying vec4 v_pos;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = u_model * vec4(a_vertex,1.0);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec4 v_pos;\n\t\t\t\n\t\t\tvec4 PackDepth32(float depth)\n\t\t\t{\n\t\t\t\tconst vec4 bitSh  = vec4(   256*256*256, 256*256,   256,         1);\n\t\t\t\tconst vec4 bitMsk = vec4(   0,      1.0/256.0,    1.0/256.0,    1.0/256.0);\n\t\t\t\tvec4 comp;\n\t\t\t\tcomp\t= depth * bitSh;\n\t\t\t\tcomp\t= fract(comp);\n\t\t\t\tcomp\t-= comp.xxyz * bitMsk;\n\t\t\t\treturn comp;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = (v_pos.z / v_pos.w) * 0.5 + 0.5;\n\t\t\t\tgl_FragColor = PackDepth32(depth);\n\t\t\t}\t\t"),
this.ready=!0)},reset:function(){this.ready||this.init();this.model_matrix=new Float32Array(this.stack.buffer,0,16);mat4.identity(this.model_matrix)},setColor:function(a){for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setPointSize:function(a){this.point_size=a},setCamera:function(a){this.camera=a;vec3.copy(this.camera_position,a.getEye());mat4.copy(this.view_matrix,a._view_matrix);mat4.copy(this.projection_matrix,a._projection_matrix);mat4.copy(this.viewprojection_matrix,
a._viewprojection_matrix)},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},setViewProjectionMatrix:function(a,b,c){mat4.copy(this.view_matrix,a);mat4.copy(this.projection_matrix,b);c?mat4.copy(this.viewprojection_matrix,c):mat4.multiply(this.viewprojection_matrix,a,c)},setMatrix:function(a){mat4.copy(this.model_matrix,a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?
a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=d.length/3&&(b=null);a=GL.Mesh.load({vertices:d,colors:b});return this.renderMesh(a,c?gl.LINE_STRIP:gl.LINES,b?this.shader_color:this.shader)}},renderPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&b.constructor!=Float32Array&&(b=b.constructor===Array?new Float32Array(b):this.linearize(b));a=GL.Mesh.load({vertices:d,colors:b});
c||(c=b?this.shader_color:this.shader);return this.renderMesh(a,gl.POINTS,c)}},renderRoundPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));a=GL.Mesh.load({vertices:d,colors:b});c||(c=b?this.shader_points_color:this.shader_points);return this.renderMesh(a,gl.POINTS,c)}},renderPointsWithSize:function(a,b,c,d,e){if(a&&a.length){var f=null,f=a.constructor==Float32Array?
a:a[0].length?this.linearize(a):new Float32Array(a);if(!b)throw"colors required in Draw.renderPointsWithSize";b=b.constructor==Float32Array?b:this.linearize(b);if(!c)throw"sizes required in Draw.renderPointsWithSize";c=c.constructor==Float32Array?c:this.linearize(c);a=GL.Mesh.load({vertices:f,colors:b,extra:c});e=e||(d?this.shader_points_color_texture_size:this.shader_points_color_size);return this.renderMesh(a,gl.POINTS,e)}},createRectangleMesh:function(a,b,c){var d=new Float32Array(12);c?d.set([0.5*
-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):d.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);return GL.Mesh.load({vertices:d})},renderRectangle:function(a,b,c){a=this.createRectangleMesh(a,b,c);return this.renderMesh(a,gl.LINE_LOOP)},createCircleMesh:function(a,b,c){b=b||32;quat.create();for(var d=vec3.create(),e=new Float32Array(3*b),f=2*Math.PI/b,g=0;g<b;g++)d[0]=Math.sin(f*g)*a,c?(d[1]=0,d[2]=Math.cos(f*g)*a):(d[2]=0,d[1]=Math.cos(f*g)*a),e.set(d,3*g);return GL.Mesh.load({vertices:e})},
renderCircle:function(a,b,c,d){a=this.createCircleMesh(a,b,c);return this.renderMesh(a,d?gl.TRIANGLE_FAN:gl.LINE_LOOP)},renderSolidCircle:function(a,b,c){return this.renderCircle(a,b,c,!0)},createSphereMesh:function(a,b){b=b||100;quat.create();for(var c=vec3.create(),d=new Float32Array(18*b),e=1/b*Math.PI*2,f=0;f<b;f++)c.set([Math.sin(f*e)*a,Math.cos(f*e)*a,0]),d.set(c,18*f),c.set([Math.sin((f+1)*e)*a,Math.cos((f+1)*e)*a,0]),d.set(c,18*f+3),c.set([Math.sin(f*e)*a,0,Math.cos(f*e)*a]),d.set(c,18*f+
6),c.set([Math.sin((f+1)*e)*a,0,Math.cos((f+1)*e)*a]),d.set(c,18*f+9),c.set([0,Math.sin(f*e)*a,Math.cos(f*e)*a]),d.set(c,18*f+12),c.set([0,Math.sin((f+1)*e)*a,Math.cos((f+1)*e)*a]),d.set(c,18*f+15);return GL.Mesh.load({vertices:d})},renderWireSphere:function(a,b){var c=this.createSphereMesh(a,b);return this.renderMesh(c,gl.LINES)},createWireBoxMesh:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,
1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);return GL.Mesh.load({vertices:a,lines:b})},renderWireBox:function(a,b,c){a=this.createWireBoxMesh(a,b,c);return this.renderMesh(a,gl.LINES)},createSolidBoxMesh:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;return GL.Mesh.load({vertices:[[-a,b,-c],[-a,-b,+c],[-a,b,c],[-a,b,-c],[-a,-b,-c],[-a,-b,+c],[a,b,-c],[a,b,c],[a,-b,+c],[a,b,-c],[a,-b,+c],[a,-b,-c],[-a,b,c],[a,-b,c],[a,b,c],[-a,b,c],[-a,-b,c],[a,-b,c],[-a,b,-c],[a,b,-c],[a,-b,-c],[-a,b,-c],[a,-b,-c],[-a,-b,-c],[-a,
b,-c],[a,b,c],[a,b,-c],[-a,b,-c],[-a,b,c],[a,b,c],[-a,-b,-c],[a,-b,-c],[a,-b,c],[-a,-b,-c],[a,-b,c],[-a,-b,c]]})},renderSolidBox:function(a,b,c){a=this.createSolidBoxMesh(a,b,c);return this.renderMesh(a,gl.TRIANGLES)},renderWireCube:function(a){return this.renderWireBox(a,a,a)},renderSolidCube:function(a){return this.renderSolidCube(a,a,a)},renderPlane:function(a,b,c,d){this.push();this.translate(a);this.scale(b[0],b[1],1);c&&c.bind(0);!d&&c&&(d=this.shader_texture);this.renderMesh(this.quad_mesh,
gl.TRIANGLE_FAN,d);c&&c.unbind(0);this.pop()},createGridMesh:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,e=-b;e<=b;e++)c.set([e*a,0,a*b],d),c.set([e*a,0,-a*b],d+3),c.set([a*b,0,e*a],d+6),c.set([-a*b,0,e*a],d+9),d+=12;return GL.Mesh.load({vertices:c})},renderGrid:function(a,b){var c=this.createGridMesh(a,b);return this.renderMesh(c,gl.LINES)},createConeMesh:function(a,b,c,d){var e=[0,1,0];c=c||100;var f=quat.create(),g=vec3.create(),h=new Float32Array(3*(c+2));h.set(d?
[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(f,e,b/c*Math.PI*2),vec3.transformQuat(g,[0,0,a],f),d&&vec3.set(g,g[0],g[2],g[1]),h.set(g,3*b+3);return GL.Mesh.load({vertices:h})},renderCone:function(a,b,c,d){a=this.createConeMesh(a,b,c,d);return this.renderMesh(a,gl.TRIANGLE_FAN)},createCylinderMesh:function(a,b,c,d){d=[0,1,0];c=c||100;for(var e=quat.create(),f=vec3.create(),g=new Float32Array(6*(c+1)),h=0;h<=c;h++)quat.setAxisAngle(e,d,h/c*Math.PI*2),vec3.transformQuat(f,[0,0,a],e),g.set(f,
6*h+3),f[1]=b,g.set(f,6*h);return GL.Mesh.load({vertices:g})},renderCylinder:function(a,b,c,d){a=this.createCylinderMesh(a,b,c,d);return this.renderMesh(a,gl.TRIANGLE_STRIP)},renderImage:function(a,b,c,d){c=c||10;var e=null;if("string"==typeof b){e=this.images[b];if(null==e){Draw.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);Draw.images[b]=a;if(Draw.onRequestFrame)Draw.onRequestFrame()};return}if(1==e)return}else b.constructor==Texture&&(e=b);e&&(d?(this.setPointSize(c),
e.bind(0),this.renderPoints(a,null,this.shader_image)):(this.push(),this.billboard(a),this.scale(c,c,c),e.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture),this.pop()))},renderMesh:function(a,b,c,d){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";c||(c=a.vertexBuffers.colors?this.shader_color:this.shader);mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms({u_model:this.model_matrix,u_mvp:this.mvp_matrix,u_color:this.color,
u_point_size:this.point_size,u_texture:0}).draw(a,void 0===b?gl.LINES:b,d);return this.last_mesh=a},renderText:function(a){Draw.font_atlas||this.createFontAtlas();for(var b=this.font_atlas,c=a.length,d=b.atlas.char_size,e=b.atlas.spacing,f=0,g=0;g<c;++g)null!=b.atlas[a.charCodeAt(g)]&&f++;for(var h=new Float32Array(18*f),f=new Float32Array(12*f),l=0,k=0,g=y=0;g<c;++g){var m=b.atlas[a.charCodeAt(g)];m?(h.set([k,y,0],18*l),h.set([k,y+d,0],18*l+3),h.set([k+d,y+d,0],18*l+6),h.set([k+d,y,0],18*l+9),h.set([k,
y,0],18*l+12),h.set([k+d,y+d,0],18*l+15),f.set([m[0],m[1]],12*l),f.set([m[0],m[3]],12*l+2),f.set([m[2],m[3]],12*l+4),f.set([m[2],m[1]],12*l+6),f.set([m[0],m[1]],12*l+8),f.set([m[2],m[3]],12*l+10),k+=e,++l):10==a.charCodeAt(g)?(k=0,y-=d):k+=d}a=GL.Mesh.load({vertices:h,coords:f});b.bind(0);return this.renderMesh(a,gl.TRIANGLES,this.shader_texture)},createFontAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";
d.textAlign="center";for(var e=0,f=0,b=-0.3*b,g={char_size:c,spacing:0.6*c},h=6;100>h;h++){var l=String.fromCharCode(h+27);g[h+27]=[e/a.width,1-(f+c)/a.height,(e+c)/a.width,1-f/a.height];d.fillText(l,Math.floor(e+0.5*c),Math.floor(f+c+b),c);e+=c;e+c>a.width&&(e=0,f+=c)}this.font_atlas=GL.Texture.fromImage(a,{magFilter:gl.NEAREST,minFilter:gl.LINEAR});this.font_atlas.atlas=g},linearize:function(a){for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,e=0;e<d;++e)c.set(a[e],e*b);return c},
push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset+64,16);mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,16)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},popCamera:function(){if(0==
this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,b,c){3==arguments.length?mat4.scale(this.model_matrix,this.model_matrix,[a,b,c]):mat4.scale(this.model_matrix,this.model_matrix,a)},translate:function(a,b,c){3==arguments.length?mat4.translate(this.model_matrix,this.model_matrix,[a,b,c]):mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,d){4==arguments.length?
mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d]):mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},billboard:function(a){mat4.invert(this.model_matrix,this.view_matrix);mat4.setTranslation(this.model_matrix,a)},fromTranslationFrontTop:function(a,b,c){mat4.fromTranslationFrontTop(this.model_matrix,a,b,c)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,
this.mvp_matrix,a)},getPhongShader:function(a,b,c){this.shader_phong.uniforms({u_ambient_color:a,u_light_color:b,u_light_dir:c});return this.shader_phong},getDepthShader:function(){return this.shader_depth}};"undefined"!=typeof LS&&(LS.Draw=Draw);function LScript(){this.code="function update(dt) {\n\n}";this.exported_callbacks=["start","update"];this.extracode="";this.catch_exceptions=!0}LScript.onerror=null;LScript.show_errors_in_console=!0;
LScript.prototype.compile=function(a){var b=[],c=[];if(a)for(var d in a)b.push(d),c.push(a[d]);b=b.join(",");a=this.code;a=LScript.expandCode(a);var e="";for(d in this.exported_callbacks)var f=this.exported_callbacks[d],e=e+("\tif(typeof("+f+") != 'undefined' && "+f+' != window["'+f+'"] ) this.'+f+" = "+f+";\n");this._last_executed_code=a+=e;try{this._class=new Function(b,a),this._context=LScript.applyToConstructor(this._class,c)}catch(g){this._context=this._class=null;LScript.show_errors_in_console&&
(console.error("Error in script\n"+g),console.error(this._last_executed_code));if(this.onerror)this.onerror(g,this._last_executed_code);if(LScript.onerror)LScript.onerror(g,this._last_executed_code,this);return!1}return!0};LScript.prototype.hasMethod=function(a){return this._context&&this._context[a]&&"function"==typeof this._context[a]?!0:!1};
LScript.prototype.callMethod=function(a,b,c){if(this._context&&this._context[a]){if(!this.catch_exceptions)return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b);try{return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b)}catch(d){if(console.error("Error in function\n"+d),this.onerror)this.onerror(d)}}};
LScript.applyToConstructor=function(a,b){var c=[null].concat(b);return new (a.bind.apply(a,c))};LScript.expandCode=function(a){if(-1!=a.indexOf("'''")){var b=a.split("'''");a="";for(var c=0;c<b.length;c++)a=0==c%2?a+b[c]:a+('"'+b[c].split("\n").join("\\n\\\n")+'"')}return a};var trace=window.console?console.log.bind(console):function(){};function toArray(a){return Array.apply([],a)}
Object.defineProperty(Object.prototype,"merge",{value:function(a){for(var b in a)this[b]=a[b];return this},configurable:!1,writable:!1,enumerable:!1});var typed_arrays=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array];typed_arrays.forEach(function(a){a.prototype.toJSON=function(){return Array.prototype.slice.call(this)}});
var LS={_last_uid:1,_uid_prefix:"@",generateUId:function(a,b){b=b||"";var c=this._uid_prefix+(a||"")+(window.navigator.userAgent.hashCode()%16777216).toString(16)+"-",c=c+((GL.getTime()|0).toString(16)+"-"),c=c+(Math.floor(16777216*(1+Math.random())).toString(16)+"-"),c=c+(this._last_uid++).toString(16);return c+b},validateName:function(a){return a.match(/^[a-z\s0-9-_]+$/i)},catch_errors:!1,Components:{},registerComponent:function(a){for(var b in arguments)this.Components[LS.getClassName(arguments[b])]=
arguments[b],LS.extendClass(a,LS.Component),LEvent.trigger(LS,"component_registered",arguments[b])},isClassComponent:function(a){a=this.getClassName(a);return!!this.Components[a]},MaterialClasses:{},registerMaterialClass:function(a){this.MaterialClasses[LS.getClassName(a)]=a;LS.extendClass(a,Material);LEvent.trigger(LS,"materialclass_registered",a);a.resource_type="Material"},setTimeout:function(a,b){if(!LS.catch_errors)return setTimeout(a,b);try{return setTimeout(a,b)}catch(c){LEvent.trigger(LS,
"code_error",c)}},setInterval:function(a,b){if(!LS.catch_errors)return setInterval(a,b);try{return setInterval(a,b)}catch(c){LEvent.trigger(LS,"code_error",c)}},extendClass:function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(c in b.prototype)b.prototype.hasOwnProperty(c)&&!a.prototype.hasOwnProperty(c)&&(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,
b.prototype.__lookupSetter__(c)))},cloneObject:function(a,b){var c=b||{},d;for(d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){var e=a[d];if(null==e)c[d]=null;else if(!isFunction(e))if("number"==typeof e||"string"==typeof e)c[d]=e;else if(e.constructor==Float32Array)c[d]=Array.apply([],e);else if(isArray(e))c[d]&&c[d].constructor==Float32Array?c[d].set(e):c[d]=JSON.parse(JSON.stringify(e));else if(LS.catch_errors)try{c[d]=JSON.parse(JSON.stringify(e))}catch(f){console.error(f)}else c[d]=JSON.parse(JSON.stringify(e))}return c},
clearUIds:function(a){a.uid&&delete a.uid;var b=a.components;!b&&a.getComponents&&(b=a.getComponents());if(b){if(b)for(var c in b){var d=b[c];d[1].uid&&delete d[1].uid;d[1]._uid&&delete d[1]._uid}b=a.children;!b&&a.getChildren&&(b=a.getChildren());if(b)for(c in b)LS.clearUIds(b[c])}},getObjectClassName:function(a){if(a){if(a.constructor.name)return a.constructor.name;if((a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getClassName:function(a){if(a){if(a.name)return a.name;
if(a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getObjectAttributes:function(a){if(a.getAttributes)return a.getAttributes();var b=a.constructor;if(b.attributes)return b.attributes;var c={},d;for(d in a)if("_"!=d[0]&&"@"!=d[0]&&"jQuery"!=d.substr(0,6)){if(b!=Object){var e=b["@"+d];if(e&&e.type){c[d]=e.type;continue}}e=a[d];null==e?c[d]=null:isFunction(e)||(c[d]=e.constructor===Boolean?"boolean":e.constructor===Number?"number":e.constructor===String?"string":e.buffer&&
e.buffer.constructor===ArrayBuffer?2==e.length?"vec2":3==e.length?"vec3":4==e.length?"vec4":9==e.length?"mat3":16==e.length?"mat4":0:0)}return c},setObjectAttribute:function(a,b,c){if(a.setAttribute)return a.setAttribute(b,c);var d=a[b];d&&d.set?d.set(c):a[b]=c},getCurveValueAt:function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var f=0,f=0;f<a.length;f+=1){var g=a[f];if(e==g[0])return g[1];if(e<g[0])return f=(e-b[0])/(g[0]-b[0]),b[1]*(1-f)+g[1]*f;b=g}g=[c,d];f=(e-b[0])/(g[0]-b[0]);return b[1]*(1-
f)+g[1]*f},resampleCurve:function(a,b,c,d,e){var f=[];f.length=e;for(var g=(c-b)/e,h=0;h<e;h++)f[h]=LS.getCurveValueAt(a,b,c,d,b+g*h);return f}};
Object.prototype.hasOwnProperty("defineAttribute")||(Object.defineProperty(Object.prototype,"defineAttribute",{value:function(a,b,c){c&&"string"==typeof c&&(c={type:c});var d=this;"function"!=typeof this&&(this[a]=b,d=this.constructor);Object.defineProperty(d,"@"+a,{value:c||{},enumerable:!1})},enumerable:!1}),Object.defineProperty(Object.prototype,"getAttribute",{value:function(a){a="@"+a;return this.hasOwnProperty(a)?this[a]:this.constructor&&this.constructor.hasOwnProperty(a)?this.constructor[a]:
null},enumerable:!1}));String.prototype.hashCode=function(){var a=0,b,c,d;if(0==this.length)return a;b=0;for(d=this.length;b<d;++b)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};
var Network={request:function(a){if("string"===typeof a)throw"LS.Network.request expects object, not string. Use LS.Network.requestText or LS.Network.requestJSON";var b=a.dataType||"text";if("json"==b)b="text";else if("xml"==b)b="text";else if("binary"==b)b="arraybuffer",a.mimeType="application/octet-stream";else if("image"==b)return b=new Image,b.onload=function(){a.success&&a.success.call(this)},b.onerror=a.error,b.src=a.url,b;var c=new XMLHttpRequest;c.open(a.data?"POST":"GET",a.url,!0);c.withCredentials=
!0;b&&(c.responseType=b);a.mimeType&&c.overrideMimeType(a.mimeType);c.onload=function(b){b=this.response;if(200!=this.status)b="Error "+this.status,a.error&&a.error(b);else{if("json"==a.dataType)try{b=JSON.parse(b)}catch(e){a.error&&a.error(e)}else if("xml"==a.dataType)try{b=(new DOMParser).parseFromString(b,"text/xml")}catch(f){a.error&&a.error(f)}if(LS.catch_errors)try{a.success&&a.success.call(this,b),LEvent.trigger(c,"done",b)}catch(g){LEvent.trigger(LS,"code_error",g)}else a.success&&a.success.call(this,
b),LEvent.trigger(c,"done",b)}};c.onerror=function(b){a.error&&a.error(b);LEvent.trigger(this,"fail",b)};a.progress&&c.addEventListener("progress",a.progress);c.send(a.data);return c},requestFile:function(a,b,c,d){"function"==typeof b&&(c=b=null);return LS.Network.request({url:a,data:b,success:c,error:d})},requestJSON:function(a,b,c,d){"function"==typeof b&&(c=b=null);return LS.Network.request({url:a,data:b,dataType:"json",success:c,error:d})},requestText:function(a,b,c,d){"function"==typeof b&&(c=
null);return LS.Network.request({url:a,dataType:"txt",success:c,success:c,error:d})}};LS.Network=Network;
var ResourcesManager={path:"",proxy:"",ignore_cache:!1,free_data:!1,keep_files:!1,resources:{},meshes:{},textures:{},materials:{},resources_not_found:{},resources_being_loaded:{},resources_being_processed:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,formats:{js:"text",json:"json",xml:"xml"},formats_resource:{},resource_pre_callbacks:{},resource_post_callbacks:{},resource_once_callbacks:{},virtual_file_systems:{},getNoCache:function(a){return this.ignore_cache||a?"nocache="+getTime()+Math.floor(1E3*
Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={}},registerFileFormat:function(a,b){this.formats[a.toLowerCase()]=b},registerResourcePreProcessor:function(a,b,c,d){a=a.split(",");for(var e in a){var f=a[e].toLowerCase();this.resource_pre_callbacks[f]=b;c&&(this.formats[f]=c);d&&(this.formats_resource[f]=d)}},registerResourcePostProcessor:function(a,b){this.resource_post_callbacks[a]=b},getExtension:function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));b=a.lastIndexOf(".");
return-1==b?"":a.substr(b+1).toLowerCase()},getFilename:function(a){var b=a.lastIndexOf("/"),c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c)},getBasename:function(a){a=this.getFilename(a);var b=a.indexOf(".");return-1==b?a:a.substr(0,b)},loadResources:function(a,b){for(var c in a)"string"==typeof c&&":"!=c[0]&&this.load(c,b)},setPath:function(a){this.path=a},setProxy:function(a){-1!=a.indexOf("@")?this.proxy="http://"+a.replace("@",window.location.host):this.proxy=a},getFullURL:function(a,
b){var c=a.indexOf(":"),d="";-1!=c&&(d=a.substr(0,c));var e=this.path;b&&b.force_local_url&&(e=".");b&&b.local_repository&&(e=b.local_repository);if(d)switch(d){case "http":case "https":full_url=a;if(this.proxy)return this.proxy+a.substr(c+3);break;case "blob":return a;case "":return a;default:return(this.virtual_file_systems[d]||e)+"/"+a.substr(c+1)}else return e+"/"+a},registerFileSystem:function(a,b){this.virtual_file_systems[a]=b},getResource:function(a){return this.resources[a]},load:function(a,
b,c){b=b||{};if(null!=this.resources[a])return c&&c(this.resources[a]),!0;var d=this.getExtension(a);if(!d)return!1;if(!this.resources_not_found[a])if(this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});else if(!this.resources_being_processed[a]){this.resources_being_loaded[a]=[{options:b,callback:c}];LEvent.trigger(LS.ResourcesManager,"resource_loading",a);0==this.num_resources_being_loaded&&LEvent.trigger(LS.ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;
c=this.getFullURL(a);var e=this.getNoCache();e&&(c+=(-1==c.indexOf("?")?"?":"&")+e);c={url:c,success:function(c){LS.ResourcesManager.processResource(a,c,b,ResourcesManager._resourceLoadedSuccess)},error:function(b){LS.ResourcesManager._resourceLoadedError(a,b)},progress:function(b){LEvent.trigger(LS.ResourcesManager,"resource_loading_progress",{url:a,event:b})}};if(d=this.formats[d])c.dataType=d;LS.Network.request(c);return!1}},processResource:function(a,b,c,d){function e(e,f){f.filename=e;c.filename&&
(f.filename=c.filename);f.fullpath||(f.fullpath=a);LS.ResourcesManager.resources_being_processed[e]&&delete LS.ResourcesManager.resources_being_processed[e];!LS.ResourcesManager.keep_files||b.constructor!=ArrayBuffer&&b.constructor!=String||(f._original_data=b);f.getResources&&ResourcesManager.loadResources(f.getResources({}));LS.ResourcesManager.registerResource(a,f);d&&d(a,f,c)}c=c||{};if(!b)throw"No data found when processing resource: "+a;var f=null,f=this.getExtension(a);this.resources_being_processed[a]=
!0;if(!f){"string"==typeof b&&(b=JSON.parse(b));if(b.constructor==ArrayBuffer){f=WBin.load(b);e(a,f);return}var g=b.object_type;if(g&&window[g]){var h=window[g],f=null;h.prototype.configure?(f=new window[g],f.configure(b)):f=new window[g](b);e(a,f);return}return!1}g=this.resource_pre_callbacks[f.toLowerCase()];if(!g)return console.log("Resource format unknown: "+f),!1;(f=g(a,b,c,e))&&e(a,f)},registerResource:function(a,b){if(this.resources[a]!=b){b.filename=a;b.object_type||(b.object_type=LS.getObjectClassName(b));
var c=b.object_type;b.constructor.resource_type&&(c=b.constructor.resource_type);(c=this.resource_post_callbacks[c])&&c(a,b);this.resources[a]=b;LEvent.trigger(this,"resource_registered",b);LS.GlobalScene.refresh()}},unregisterResource:function(a){if(!this.resources[a])return!1;delete this.resources[a];this.meshes[a]&&delete this.meshes[a];this.textures[a]&&delete this.textures[a];LEvent.trigger(this,"resource_unregistered",resource);LS.GlobalScene.refresh();return!0},computeResourceInternalData:function(a){if(!a)throw"Resource is null";
var b=null,c="text",d="";a._original_file?(b=a._original_file,c="file"):a._original_data?b=a._original_data:a.toBinary?(b=a.toBinary(),c="binary",d="wbin"):a.toBlob?(b=a.toBlob(),c="file"):a.toBase64?(b=a.toBase64(),c="base64"):b=a.serialize?JSON.stringify(a.serialize()):a.data?a.data:JSON.stringify(a);b.buffer&&b.buffer.constructor==ArrayBuffer&&(b=b.buffer);return{data:b,encoding:c,extension:d}},getURLasFile:function(a,b){var c=new XMLHttpRequest;c.open("GET",this.getFullURL(a),!0);c.responseType=
"blob";c.onload=function(d){d=c.response;b&&b(d,a)};c.send()},renameResource:function(a,b,c){var d=this.resources[a];if(!d)return!1;d.filename=b;d.fullpath=b;this.resources[b]=d;delete this.resources[a];c||this.sendResourceRenamedEvent(a,b,d);this.meshes[a]&&(delete this.meshes[a],this.meshes[b]=d);this.textures[a]&&(delete this.textures[a],this.textures[b]=d);return!0},isLoading:function(){return 0<this.num_resources_being_loaded},clearNotFoundResources:function(){this.resources_not_found={}},processScene:function(a,
b,c){a=Parser.parse(a,b,c);if(a.meshes)for(var d in a.meshes)b=GL.Mesh.load(a.meshes[d]),LS.ResourcesManager.registerResource(d,b);d=new LS.SceneTree;d.configure(a);d.loadResources();return d},computeImageMetadata:function(a){return{width:a.width,height:a.height}},getMesh:function(a){return null!=a?this.meshes[a]:null},getTexture:function(a){return a?this.textures[a]:null},sendResourceRenamedEvent:function(a,b,c){for(var d=LS.GlobalScene,e=0;e<d._nodes.length;e++){for(var f=d._nodes[e],g=0;g<f._components.length;g++){var h=
f._components[g];if(h.onResourceRenamed)h.onResourceRenamed(a,b,c)}if((f=f.getMaterial())&&f.onResourceRenamed)f.onResourceRenamed(a,b,c)}},onceLoaded:function(a,b){var c=this.resource_once_callbacks[a];if(c){for(var d in c)if(c[d]==b)return;c.push(b)}else this.resource_once_callbacks=[b]},_resourceLoadedSuccess:function(a,b){LS.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+LS.ResourcesManager.num_resources_being_loaded);for(var c in LS.ResourcesManager.resources_being_loaded[a])null!=
LS.ResourcesManager.resources_being_loaded[a][c].callback&&LS.ResourcesManager.resources_being_loaded[a][c].callback(b);if(LS.ResourcesManager.resource_once_callbacks[a]){var d=LS.ResourcesManager.resource_once_callbacks[a];for(c in d)d[c](a,b);delete LS.ResourcesManager.resource_once_callbacks[a]}LS.ResourcesManager.resources_being_loaded[a]&&(delete LS.ResourcesManager.resources_being_loaded[a],LS.ResourcesManager.num_resources_being_loaded--,LEvent.trigger(LS.ResourcesManager,"resource_loaded",
a),0==LS.ResourcesManager.num_resources_being_loaded&&LEvent.trigger(LS.ResourcesManager,"end_loading_resources",!0))},_resourceLoadedError:function(a,b){console.log("Error loading "+a);delete LS.ResourcesManager.resources_being_loaded[a];delete LS.ResourcesManager.resource_once_callbacks[a];LS.ResourcesManager.resources_not_found[a]=!0;LEvent.trigger(LS.ResourcesManager,"resource_not_found",a);LS.ResourcesManager.num_resources_being_loaded--;0==LS.ResourcesManager.num_resources_being_loaded&&LEvent.trigger(LS.ResourcesManager,
"end_loading_resources",!1)},require:function(a,b){function c(a){for(var b=a.shift(1);ResourcesManager._required_files[b]&&b;)b=a.shift(1);ResourcesManager._required_files[b]=!0;LS.Network.request({url:b,success:function(d){eval(d);if(ResourcesManager._waiting_callbacks[b])for(var h in ResourcesManager._waiting_callbacks[b])ResourcesManager._waiting_callbacks[b][h]();c(a)}})}"string"==typeof a&&(a=[a]);var d=a[a.length-1];b&&(ResourcesManager._waiting_callbacks[d]?ResourcesManager._waiting_callbacks[d].push(b):
ResourcesManager._waiting_callbacks[d]=[b]);c(a)},_required_files:{},_waiting_callbacks:{}};LS.ResourcesManager=ResourcesManager;LS.RM=ResourcesManager;LS.getTexture=function(a){return LS.ResourcesManager.getTexture(a)};
LS.ResourcesManager.registerResourcePostProcessor("Mesh",function(a,b){b.object_type="Mesh";b.metadata&&(b.metadata={},b.generateMetadata());b.bounding&&b.bounding.length==BBox.data_length||(b.bounding=null,b.updateBounding());b.getBuffer("normals")||b.computeNormals();LS.ResourcesManager.free_data&&b.freeData();LS.ResourcesManager.meshes[a]=b});LS.ResourcesManager.registerResourcePostProcessor("Texture",function(a,b){LS.ResourcesManager.textures[a]=b});
LS.ResourcesManager.registerResourcePostProcessor("Material",function(a,b){LS.ResourcesManager.materials[a]=b});LS.ResourcesManager.registerResourcePreProcessor("wbin",function(a,b,c){return b=new WBin.load(b)},"binary");LS.ResourcesManager.registerResourcePreProcessor("json",function(a,b,c){a=b;"object"==typeof b&&b.object_type&&window[b.object_type]&&(a=window[b.object_type],a.prototype.configure?(a=new a,a.configure(b)):a=new a(b));return a});
LS.ResourcesManager.processImage=function(a,b,c){if(b.width==b.height/6||-1!=a.indexOf("CUBECROSS"))c={wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR},-1!=a.indexOf("CUBECROSSL")&&(c.is_cross=1),c=Texture.cubemapFromImage(b,c),c.img=b,console.log("Cubemap created");else{c=gl.LINEAR;var d=gl.REPEAT,e=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(e=gl.LINEAR,d=gl.CLAMP_TO_EDGE);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,
{format:24==b.bpp?gl.RGB:gl.RGBA,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:e}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:d,wrapT:d,magFilter:c,minFilter:e});c.img=b}c.filename=a;c.generateMetadata();return c};
LS.ResourcesManager.registerResourcePreProcessor("jpg,jpeg,png,webp,gif",function(a,b,c,d){var e=LS.ResourcesManager.getExtension(a),f="image/png";if("jpg"==e||"jpeg"==e)f="image/jpg";"webp"==e&&(f="image/webp");"gif"==e&&(f="image/gif");var e=new Blob([b],{type:f}),g=URL.createObjectURL(e),e=new Image;e.src=g;e.real_filename=a;e.onload=function(){var a=this.real_filename,e=LS.ResourcesManager.processImage(a,this,c);e&&(LS.ResourcesManager.registerResource(a,e),LS.ResourcesManager.keep_files&&(e._original_data=
b));URL.revokeObjectURL(g);e&&d&&d(a,e,c)}},"binary","Texture");LS.ResourcesManager.registerResourcePreProcessor("dds,tga",function(a,b,c){b=(new Uint8Array(b)).buffer;c=Parser.parse(a,b,c);return c.constructor==Texture?(c.filename=a,c):c=LS.ResourcesManager.processImage(a,c)},"binary","Texture");LS.ResourcesManager.processASCIIMesh=function(a,b,c){b=Parser.parse(a,b,c);return null==b?(console.error("Error parsing mesh: "+a),null):GL.Mesh.load(b)};
LS.ResourcesManager.registerResourcePreProcessor("obj,ase",LS.ResourcesManager.processASCIIMesh,"text","Mesh");LS.ResourcesManager.processASCIIScene=function(a,b,c){b=Parser.parse(a,b,c);if(null==b)return console.error("Error parsing mesh: "+a),null;for(var d in b.meshes)LS.ResourcesManager.processResource(d,b.meshes[d]);for(d in b.resources)LS.ResourcesManager.processResource(d,b.resources[d]);a=new LS.SceneNode;a.configure(b.root);LS.GlobalScene.root.addChild(a);return a};
LS.ResourcesManager.registerResourcePreProcessor("dae",LS.ResourcesManager.processASCIIScene,"text","Scene");
GL.Mesh.fromBinary=function(a){var b=null,b=a.constructor==ArrayBuffer?WBin.load(a):a;a={};for(var c in b.vertex_buffers)a[b.vertex_buffers[c]]=b[b.vertex_buffers[c]];var d={};for(c in b.index_buffers)d[b.index_buffers[c]]=b[b.index_buffers[c]];a=new GL.Mesh(a,d);a.info=b.info;a.bounding=b.bounding;if(b.bones){a.bones=b.bones;for(c=0;c<a.bones.length;++c)a.bones[c][1]=mat4.clone(a.bones[c][1]);b.bind_matrix&&(a.bind_matrix=mat4.clone(b.bind_matrix))}return a};
GL.Mesh.prototype.toBinary=function(){this.info||(this.info={});var a={object_type:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBounding();a.bounding=this.bounding;var b=[],d=[];for(c in this.vertexBuffers){var e=this.vertexBuffers[c];a[e.name]=e.data;b.push(e.name);"vertices"==e.name&&(a.info.num_vertices=
e.data.length/3)}for(c in this.indexBuffers)e=this.indexBuffers[c],a[c]=e.data,d.push(c);a.vertex_buffers=b;a.index_buffers=d;return WBin.create(a,"Mesh")};
var ShadersManager={default_xml_url:"data/shaders.xml",snippets:{},compiled_programs:{},compiled_shaders:{},global_shaders:{},default_shader:null,dump_compile_errors:!0,on_compile_error:null,init:function(a,b){this.default_shader=null;this.compiled_programs={};this.compiled_shaders={};this.global_shaders={};this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+String.fromCharCode(10);this.createDefaultShaders();this.default_shader=this.get("flat");this.last_shaders_url=a=a||this.default_xml_url;
this.loadFromXML(a,!1,b)},reloadShaders:function(a){this.loadFromXML(this.last_shaders_url,!0,!0,a)},get:function(a,b){if(!a)return null;if(!b){var c=this.compiled_programs[a];if(c)return c}var d=this.global_shaders[a];if(null==d)return this.default_shader;var c=a+":",e="";if(0!=d.num_macros)for(var f in b)d.macros[f]&&(c+=f+"="+b[f]+":",e+=String.fromCharCode(10)+"#define "+f+" "+b[f]+String.fromCharCode(10));f=c.hashCode();if(null!=this.compiled_programs[f])return this.compiled_programs[f];var g=
e+d.vs_code,e=e+d.ps_code;if(d.imports)var h={},l=function(a){a=a.split('"')[1];if(h[a])return"//already imported: "+a+"\n";var b=ShadersManager.snippets[a];h[a]=!0;return b?b.code:"//snippet not found: "+a+"\n"},g=g.replace(/#import\s+\"(\w+)\"\s*\n/g,l),h={},e=e.replace(/#import\s+\"(\w+)\"\s*\n/g,l);if(c=this.compileShader(g,e,c))c.global=d;return this.registerCompiledShader(c,f,a)},getGlobalShaderInfo:function(a){return this.global_shaders[a]},compileShader:function(a,b,c){if(!gl)return null;
var d=null;try{a=this.global_extra_code+a;b=this.global_extra_code+b;var e=this.compiled_shaders[c+":VS"];e||(e=this.compiled_shaders[c+":VS"]=GL.Shader.compileSource(gl.VERTEX_SHADER,a));var f=this.compiled_shaders[c+":FS"];f||(f=this.compiled_shaders[c+":FS"]=GL.Shader.compileSource(gl.FRAGMENT_SHADER,b));d=new GL.Shader(e,f);d.name=c}catch(g){if(this.dump_compile_errors){console.error("Error compiling shader: "+c);console.log(g);console.groupCollapsed("Vertex Shader Code");a=(this.global_extra_code+
a).split("\n");for(var h in a)console.log(h+": "+a[h]);console.groupEnd();console.groupCollapsed("Fragment Shader Code");a=(this.global_extra_code+b).split("\n");for(h in a)console.log(h+": "+a[h]);console.groupEnd();this.dump_compile_errors=!1}if(this.on_compile_error)this.on_compile_error(g);return null}return d},registerCompiledShader:function(a,b,c){if(null==a)return this.compiled_programs[b]=this.default_shader;a.id=c;a.key=b;return this.compiled_programs[b]=a},loadFromXML:function(a,b,c,d){c=
c?"?nocache="+getTime()+Math.floor(1E3*Math.random()):"";LS.Network.request({url:a+c,dataType:"xml",success:function(c){console.log("Shaders XML loaded: "+a);b&&(LS.ShadersManager.global_shaders={},LS.ShadersManager.compiled_programs={},LS.ShadersManager.compiled_shaders={});LS.ShadersManager.processShadersXML(c);d&&d()},error:function(a){console.log("Error parsing Shaders XML: "+a);throw"Error parsing Shaders XML: "+a;}})},processShadersXML:function(a){var b=a.querySelectorAll("shader"),c;for(c in b){var d=
b[c];if(d&&d.attributes){var e=d.attributes.id;if(e){var e=e.value,f="",g="",h="";(f=d.attributes.macros)&&(h+=f.value);(f=d.querySelector("macros"))&&(h+=f.textContent);f=h.split(",");h={};for(c in f)h[f[c].trim()]=!0;f=d.querySelector("code[type='vertex_shader']").textContent;g=d.querySelector("code[type='pixel_shader']").textContent;if(f&&g){var l={},k=d.getAttribute("multipass");k&&(l.multipass="1"==k||"true"==k);if(d=d.getAttribute("imports"))l.imports="1"==d||"true"==d;LS.ShadersManager.registerGlobalShader(f,
g,e,h,l)}else console.log("no code in shader: "+e)}}}a=a.querySelectorAll("snippet");for(c=0;c<a.length;++c)b=a[c],e=b.getAttribute("id"),this.registerSnippet(e,b.textContent)},registerGlobalShader:function(a,b,c,d,e){var f=0,g;for(g in d)f+=1;a={vs_code:a,ps_code:b,macros:d,num_macros:f,macros_found:{}};if(e)for(g in e)a[g]=e[g];this.global_shaders[c]=a;LEvent.trigger(ShadersManager,"newShader");return a},registerSnippet:function(a,b){this.snippets[a]={id:a,code:b}},getSnippet:function(a){return this.snippets[a]},
common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_mvp;\n\t",common_pscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.registerGlobalShader(this.common_vscode+"\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t",
"flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t","texture_flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",
this.common_pscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen")}};LS.SM=LS.ShadersManager=ShadersManager;function ShaderQuery(){this.name="global";this.extra_streams={};this.extra_uniforms={};this.hooks={}}ShaderQuery.prototype.resolve=function(){};var Blend={NORMAL:"normal",ALPHA:"alpha",ADD:"add",MULTIPLY:"multiply",SCREEN:"screen",CUSTOM:"custom"};LS.Blend=Blend;
if("undefined"==typeof GL)throw"LiteSCENE requires to have litegl.js included before litescene.js";LS.BlendFunctions={normal:[GL.ONE,GL.ZERO],alpha:[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA],add:[GL.SRC_ALPHA,GL.ONE],multiply:[GL.DST_COLOR,GL.ONE_MINUS_SRC_ALPHA],screen:[GL.SRC_ALPHA,GL.ONE],custom:[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA]};
function Material(a){this.name="";this.uid=LS.generateUId("MAT-");this._dirty=!0;this._color=new Float32Array([1,1,1,1]);this.createProperty("diffuse",new Float32Array([1,1,1]),"color");this.shader_name="global";this.blend_mode=LS.Blend.NORMAL;this._specular_data=vec2.fromValues(0.1,10);this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.textures={};Object.defineProperty(this,"color",{get:function(){return this._color.subarray(0,3)},set:function(a){vec3.copy(this._color,a)},enumerable:!0});
Object.defineProperty(this,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(this,"specular_factor",{get:function(){return this._specular_data[0]},set:function(a){this._specular_data[0]=a},enumerable:!0});Object.defineProperty(this,"specular_gloss",{get:function(){return this._specular_data[1]},set:function(a){this._specular_data[1]=a},enumerable:!0});a&&this.configure(a)}Material["@color"]={type:"color"};
Material["@blend_mode"]={type:"enum",values:LS.Blend};Material.icon="mini-icon-material.png";Material.COLOR="color";Material.OPACITY="opacity";Material.BLEND_MODE="blend_mode";Material.SPECULAR_FACTOR="specular_factor";Material.SPECULAR_GLOSS="specular_gloss";Material.OPACITY_TEXTURE="opacity";Material.COLOR_TEXTURE="color";Material.AMBIENT_TEXTURE="ambient";Material.SPECULAR_TEXTURE="specular";Material.EMISSIVE_TEXTURE="emissive";Material.ENVIRONMENT_TEXTURE="environment";Material.COORDS_UV0="0";
Material.COORDS_UV1="1";Material.COORDS_UV_TRANSFORMED="transformed";Material.COORDS_SCREEN="screen";Material.COORDS_SCREENCENTERED="screen_centered";Material.COORDS_FLIPPED_SCREEN="flipped_screen";Material.COORDS_POLAR="polar";Material.COORDS_POLAR_REFLECTED="polar_reflected";Material.COORDS_POLAR_VERTEX="polar_vertex";Material.COORDS_WORLDXZ="worldxz";Material.COORDS_WORLDXY="worldxy";Material.COORDS_WORLDYZ="worldyz";
Material.TEXTURE_COORDINATES=[Material.COORDS_UV0,Material.COORDS_UV1,Material.COORDS_UV_TRANSFORMED,Material.COORDS_SCREEN,Material.COORDS_SCREENCENTERED,Material.COORDS_FLIPPED_SCREEN,Material.COORDS_POLAR,Material.COORDS_POLAR_REFLECTED,Material.COORDS_POLAR_VERTEX,Material.COORDS_WORLDXY,Material.COORDS_WORLDXZ,Material.COORDS_WORLDYZ];Material.DEFAULT_UVS={normal:Material.COORDS_UV0,displacement:Material.COORDS_UV0,environment:Material.COORDS_POLAR_REFLECTED,irradiance:Material.COORDS_POLAR};
Material.available_shaders="default global lowglobal phong_texture flat normal phong flat_texture cell_outline".split(" ");Material.texture_channels=[Material.COLOR_TEXTURE,Material.OPACITY_TEXTURE,Material.AMBIENT_TEXTURE,Material.SPECULAR_TEXTURE,Material.EMISSIVE_TEXTURE,Material.ENVIRONMENT_TEXTURE];Material.prototype.applyToRenderInstance=function(a){this.blend_mode!=LS.Blend.NORMAL&&(a.flags|=RI_BLEND);a.blend_func=this.blend_mode==LS.Blend.CUSTOM&&this.blend_func?this.blend_func:LS.BlendFunctions[this.blend_mode]};
Material.prototype.fillSurfaceShaderMacros=function(a){a={};for(var b in this.textures){var c=this.getTextureSampler(b);if(c){var d=c.uvs||Material.DEFAULT_UVS[b]||"0";(c=Material.getTextureFromSampler(c))&&(a["USE_"+b.toUpperCase()+(c.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+d)}}if(this.extra_macros)for(var e in this.extra_macros)a[e]=this.extra_macros[e];this._macros=a};
Material.prototype.fillSurfaceUniforms=function(a,b){var c={},d={};c.u_material_color=this._color;c.u_ambient_color=a.info?a.info.ambient_color:this._diffuse;c.u_diffuse_color=this._diffuse;c.u_specular=this._specular_data;c.u_texture_matrix=this.uvs_matrix;c.u_reflection=this.reflection_factor;for(var e in this.textures){var f=this.getTextureSampler(e);if(f){var g=Material.getTextureFromSampler(f);g&&(d[e+(g.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=f)}}for(e in this.extra_uniforms)c[e]=
this.extra_uniforms[e];this._uniforms=c;this._samplers=d};Material.prototype.configure=function(a){for(var b in a)this.setProperty(b,a[b])};Material.prototype.serialize=function(){var a=LS.cloneObject(this);a.material_class=LS.getObjectClassName(this);return a};Material.prototype.clone=function(){var a=this.serialize();a.uid&&delete a.uid;return new this.constructor(JSON.parse(JSON.stringify(a)))};
Material.prototype.loadAndSetTexture=function(a,b,c){c=c||{};var d=this;if("string"===typeof b)":"!=b[0]?LS.ResourcesManager.load(b,c,function(b){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};
Material.prototype.getProperties=function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",specular_factor:"number",specular_gloss:"number",uvs_matrix:"mat3"},b=this.getTextureChannels(),c;for(c in b)a["tex_"+b[c]]="Sampler";return a};Material.prototype.getProperty=function(a){return"tex_"==a.substr(0,4)?this.textures[a.substr(4)]:this[a]};
Material.prototype.setProperty=function(a,b){if("tex_"==a.substr(0,4))return this.textures[a.substr(4)]=b,!0;switch(a){case "opacity":case "specular_factor":case "specular_gloss":case "reflection":case "blend_mode":case "shader_name":this[a]=b;break;case "uvs_matrix":case "color":this[a].length==b.length&&this[a].set(b);break;case "textures":for(var c in b){var d=b[c];"string"==typeof d&&(d={texture:d,uvs:"0",wrap:0,minFilter:0,magFilter:0});this.textures[c]=d}break;case "transparency":this.opacity=
1-b;break;default:return!1}return!0};Material.prototype.getTextureChannels=function(){return this.constructor.texture_channels?this.constructor.texture_channels:[]};
Material.prototype.setTexture=function(a,b,c){if(!a)throw"Material.prototype.setTexture channel must be specified";if(b){var d=this.textures[a];d?d.texture=b:this.textures[a]=d={texture:b,uvs:Material.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0};if(c)for(var e in c)d[e]=c[e];b.constructor===String&&":"!=b[0]&&LS.ResourcesManager.load(b);return d}delete this.textures[a]};
Material.prototype.setTextureProperty=function(a,b,c){var d=this.textures[a];d?d[b]=c:"texture"==b&&(this.textures[a]={texture:c,uvs:Material.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0})};Material.prototype.getTexture=function(a){a=a||Material.COLOR_TEXTURE;a=this.textures[a];return a?a.constructor===String?LS.ResourcesManager.textures[a]:(a=a.texture)?a.constructor===String?LS.ResourcesManager.textures[a]:a.constructor==Texture?a:null:null:null};Material.prototype.getTextureSampler=function(a){return this.textures[a]};
Material.getTextureFromSampler=function(a){a=a.constructor===String?a:a.texture;if(!a)return null;a.constructor===String&&(a=LS.ResourcesManager.textures[a]);return a&&a.constructor==Texture?a:null};Material.prototype.setTextureSampler=function(a,b){b?this.textures[a]=b:delete this.textures[a]};Material.prototype.getResources=function(a){for(var b in this.textures){var c=this.textures[b];c&&"string"==typeof c.texture&&(a[c.texture]=GL.Texture)}return a};
Material.prototype.onResourceRenamed=function(a,b,c){for(var d in this.textures)(c=this.textures[d])&&c.texture==a&&(c.texture=b)};Material.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)LS.ResourcesManager.load(b)};Material.prototype.registerMaterial=function(a){this.name=a;LS.ResourcesManager.registerResource(a,this);this.material=a};Material.prototype.getCategory=function(){return this.category||"Material"};
Material.prototype.updatePreview=function(a,b){b=b||{};var c={};this.getResources(c);for(var d in c)if(!LS.ResourcesManager.resources[d])return console.warn("Cannot generate preview with resources missing."),null;LS.GlobalScene.info.textures.environment&&(b.environment=LS.GlobalScene.info.textures.environment);this.preview=c=LS.Renderer.renderMaterialPreview(this,a||256,b);c.toDataURL&&(this.preview_url=c.toDataURL("image/png"))};
Material.prototype.getLocatorString=function(){return this._root?this._root.uid+"/material":this.uid};Material.processShaderCode=function(a){a=a.split("\n");for(var b in a)a[b]=a[b].split("//")[0];return(a=a.join(""))?a:null};
Material.prototype.createProperty=function(a,b,c){c&&(this.constructor["@"+a]={type:c});b.constructor===Number||b.constructor===String||b.constructor===Boolean?this[a]=b:b.constructor===Float32Array&&(c="_"+a,b=new Float32Array(b),this[c]=b,Object.defineProperty(this,a,{get:function(){return b},set:function(a){b.set(a)},enumerable:!0}))};LS.registerMaterialClass(Material);LS.Material=Material;
function StandardMaterial(a){Material.call(this,null);this.createProperty("ambient",new Float32Array([1,1,1]),"color");this.createProperty("emissive",new Float32Array(3),"color");this.backlight_factor=0;this.specular_ontop=!1;this.reflection_factor=0;this.reflection_fresnel=1;this.reflection_specular=this.reflection_additive=!1;this.createProperty("velvet",new Float32Array([0.5,0.5,0.5]),"color");this.velvet_exp=0;this.velvet_additive=!1;this._velvet_info=vec4.create();this._detail=new Float32Array([0,
10,10]);this._extra_data=vec4.create();this.normalmap_factor=1;this.displacementmap_factor=0.1;this.bumpmap_factor=1;this.use_scene_ambient=!0;this.extra_surface_shader_code="";this.extra_uniforms={};a&&this.configure(a)}Object.defineProperty(StandardMaterial.prototype,"detail_factor",{get:function(){return this._detail[0]},set:function(a){this._detail[0]=a},enumerable:!0});
Object.defineProperty(StandardMaterial.prototype,"detail_scale",{get:function(){return this._detail.subarray(1,3)},set:function(a){this._detail[1]=a[0];this._detail[2]=a[1]},enumerable:!0});Object.defineProperty(StandardMaterial.prototype,"extra_factor",{get:function(){return this._extra_data[3]},set:function(a){this._extra_data[3]=a},enumerable:!0});
Object.defineProperty(StandardMaterial.prototype,"extra_color",{get:function(){return this._extra_data.subarray(0,3)},set:function(a){this._extra_data.set(a)},enumerable:!0});StandardMaterial.DETAIL_TEXTURE="detail";StandardMaterial.NORMAL_TEXTURE="normal";StandardMaterial.DISPLACEMENT_TEXTURE="displacement";StandardMaterial.BUMP_TEXTURE="bump";StandardMaterial.REFLECTIVITY_TEXTURE="reflectivity";StandardMaterial.IRRADIANCE_TEXTURE="irradiance";StandardMaterial.EXTRA_TEXTURE="extra";
StandardMaterial.texture_channels=[Material.COLOR_TEXTURE,Material.OPACITY_TEXTURE,Material.AMBIENT_TEXTURE,Material.SPECULAR_TEXTURE,Material.EMISSIVE_TEXTURE,StandardMaterial.DETAIL_TEXTURE,StandardMaterial.NORMAL_TEXTURE,StandardMaterial.DISPLACEMENT_TEXTURE,StandardMaterial.BUMP_TEXTURE,StandardMaterial.REFLECTIVITY_TEXTURE,Material.ENVIRONMENT_TEXTURE,StandardMaterial.IRRADIANCE_TEXTURE,StandardMaterial.EXTRA_TEXTURE];StandardMaterial.available_shaders="default lowglobal phong_texture flat normal phong flat_texture".split(" ");
StandardMaterial.coding_help="Input IN -> info about the mesh\nSurfaceOutput o -> info about the surface properties of this pixel\n\nstruct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Ambient;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";
StandardMaterial.prototype.fillSurfaceShaderMacros=function(a){a={};for(var b in this.textures){var c=this.getTextureSampler(b);if(c){var d=c.uvs||Material.DEFAULT_UVS[b]||"0";if(c=Material.getTextureFromSampler(c))"normal"==b?0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.USE_NORMAL_TEXTURE="uvs_"+d,0!=this.normalmap_factor&&(a.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.USE_TANGENT_NORMALMAP="")):"displacement"==
b?0!=this.displacementmap_factor&&gl.derivatives_supported&&(a.USE_DISPLACEMENT_TEXTURE="uvs_"+d,1!=this.displacementmap_factor&&(a.USE_DISPLACEMENTMAP_FACTOR="")):"bump"==b?0!=this.bump_factor&&gl.derivatives_supported&&(a.USE_BUMP_TEXTURE="uvs_"+d,1!=this.bumpmap_factor&&(a.USE_BUMP_FACTOR="")):a["USE_"+b.toUpperCase()+(c.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+d}}this.velvet&&this.velvet_exp&&(a.USE_VELVET="");this.emissive_material&&(a.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&
(a.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(a.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(a.USE_SPECULAR_IN_REFLECTION="");0.001<this.backlight_factor&&(a.USE_BACKLIGHT="");0<this.reflection_factor&&(a.USE_REFLECTION="");this.extra_surface_shader_code&&(b=null,this._last_extra_surface_shader_code!=this.extra_surface_shader_code?this._last_processed_extra_surface_shader_code=b=Material.processShaderCode(this.extra_surface_shader_code):b=this._last_processed_extra_surface_shader_code,
b&&(a.USE_EXTRA_SURFACE_SHADER_CODE=b));if(this.extra_macros)for(var e in this.extra_macros)a[e]=this.extra_macros[e];this._macros=a};
StandardMaterial.prototype.fillSurfaceUniforms=function(a,b){var c={},d={};c.u_material_color=this._color;c.u_ambient_color=this.use_scene_ambient&&a.info?vec3.fromValues(a.info.ambient_color[0]*this.ambient[0],a.info.ambient_color[1]*this.ambient[1],a.info.ambient_color[2]*this.ambient[2]):this.ambient;c.u_emissive_color=this.emissive||vec3.create();c.u_specular=this._specular_data;c.u_reflection_info=[this.reflection_additive?-this.reflection_factor:this.reflection_factor,this.reflection_fresnel];
c.u_backlight_factor=this.backlight_factor;c.u_normalmap_factor=this.normalmap_factor;c.u_displacementmap_factor=this.displacementmap_factor;c.u_bumpmap_factor=this.bumpmap_factor;this._velvet_info.set(this.velvet);this._velvet_info[3]=this.velvet_additive?this.velvet_exp:-this.velvet_exp;c.u_velvet_info=this._velvet_info;c.u_detail_info=this._detail;c.u_extra_data=this._extra_data;c.u_texture_matrix=this.uvs_matrix;for(var e in this.textures){var f=this.getTextureSampler(e);if(f){var g=f.texture;
if(g){if(g.constructor===String)g=LS.ResourcesManager.textures[g];else if(g.constructor!=Texture)continue;g&&(d[e+(g.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=f);g&&"irradiance"==e&&g.type==gl.TEXTURE_2D&&(g.bind(0),g.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),g.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),g.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE))}}}for(e in this.extra_uniforms)c[e]=this.extra_uniforms[e];this._uniforms=c;this._samplers=d};
StandardMaterial.prototype.setProperty=function(a,b){if(Material.prototype.setProperty.call(this,a,b))return!0;switch(a){case "backlight_factor":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "normalmap_tangent":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "detail_factor":case "specular_ontop":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "extra_surface_shader_code":this[a]=b;break;
case "ambient":case "emissive":case "velvet":case "detail_scale":case "extra_color":this[a].length==b.length&&this[a].set(b);break;case "extra_uniforms":this.extra_uniforms=LS.cloneObject(b);break;default:return!1}return!0};
StandardMaterial.prototype.getProperties=function(){var a=Material.prototype.getProperties.call(this);a.merge({backlight_factor:"number",reflection_factor:"number",reflection_fresnel:"number",velvet_exp:"number",normalmap_factor:"number",displacementmap_factor:"number",extra_factor:"number",extra_surface_shader_code:"string",ambient:"vec3",emissive:"vec3",velvet:"vec3",extra_color:"vec3",detail_factor:"number",detail_scale:"vec2",specular_ontop:"boolean",normalmap_tangent:"boolean",reflection_specular:"boolean",
use_scene_ambient:"boolean",velvet_additive:"boolean"});return a};LS.registerMaterialClass(StandardMaterial);LS.StandardMaterial=StandardMaterial;function CustomMaterial(a){Material.call(this,null);this.vs_code="";this.code="vec4 surf() {\n\treturn u_material_color * vec4(1.0,0.0,0.0,1.0);\n}\n";this._uniforms={};this._macros={};a&&this.configure(a);this.computeCode()}CustomMaterial.ps_shader_definitions="\n";CustomMaterial.icon="mini-icon-material.png";CustomMaterial.prototype.onCodeChange=function(){this.computeCode()};
CustomMaterial.prototype.getCode=function(){return this.code};CustomMaterial.prototype.computeCode=function(){this._ps_uniforms_code="";var a=this.code.split("\n"),b;for(b in a)a[b]=a[b].split("//")[0];this._ps_functions_code=a.join("");this._ps_code="vec4 result = surf(); color = result.xyz; alpha = result.a;"};
CustomMaterial.prototype.onModifyMacros=function(a){a.USE_PIXEL_SHADER_UNIFORMS=a.USE_PIXEL_SHADER_UNIFORMS?a.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code;a.USE_PIXEL_SHADER_FUNCTIONS=a.USE_PIXEL_SHADER_FUNCTIONS?a.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code;a.USE_PIXEL_SHADER_CODE=a.USE_PIXEL_SHADER_CODE?a.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code};CustomMaterial.prototype.fillSurfaceShaderMacros=function(a){this._macros={}};
CustomMaterial.prototype.fillSurfaceUniforms=function(a,b){var c={},d;for(d in this.textures){var e=this.getTexture(d);e&&(c[d+(e.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=e)}this._uniforms.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.opacity]);this._samplers=c};CustomMaterial.prototype.configure=function(a){LS.cloneObject(a,this)};CustomMaterial.prototype.serialize=function(){return LS.cloneObject(this)};LS.registerMaterialClass(CustomMaterial);
LS.CustomMaterial=CustomMaterial;function SurfaceMaterial(a){Material.call(this,null);this.vs_code="";this.code="void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = 0.0;\n\to.Alpha = IN.color.a;\n}\n";this._uniforms={};this._macros={};this.properties=[];a&&this.configure(a);this.flags=0;this.computeCode()}SurfaceMaterial.icon="mini-icon-material.png";
SurfaceMaterial.coding_help="struct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";SurfaceMaterial.prototype.onCodeChange=function(){this.computeCode()};SurfaceMaterial.prototype.getCode=function(){return this.code};
SurfaceMaterial.prototype.computeCode=function(){for(var a="",b=0,c=this.properties.length;b<c;++b){var d="uniform ",e=this.properties[b];switch(e.type){case "number":d+="float ";break;case "vec2":d+="vec2 ";break;case "vec3":d+="vec3 ";break;case "vec4":case "color":d+="vec4 ";break;case "texture":d+="sampler2D ";break;case "cubemap":d+="samplerCube ";break;default:continue}d+=e.name+";";a+=d}d=this.code.split("\n");b=0;for(c=d.length;b<c;++b)d[b]=d[b].split("//")[0];this.surf_code=a+d.join("")};
SurfaceMaterial.prototype.onModifyMacros=function(a){this._ps_uniforms_code&&(a.USE_PIXEL_SHADER_UNIFORMS=a.USE_PIXEL_SHADER_UNIFORMS?a.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code);this._ps_functions_code&&(a.USE_PIXEL_SHADER_FUNCTIONS=a.USE_PIXEL_SHADER_FUNCTIONS?a.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code);this._ps_code&&(a.USE_PIXEL_SHADER_CODE=a.USE_PIXEL_SHADER_CODE?a.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code);a.USE_SURFACE_SHADER=
this.surf_code};SurfaceMaterial.prototype.fillSurfaceShaderMacros=function(a){this._macros={};if(this.textures.environment){a=this.textures.environment;var b=LS.getTexture(a.texture);b&&(this._macros["USE_ENVIRONMENT_"+(b.type==gl.TEXTURE_2D?"TEXTURE":"CUBEMAP")]=a.uvs)}};
SurfaceMaterial.prototype.fillSurfaceUniforms=function(a,b){for(var c={},d=0,e=this.properties.length;d<e;++d){var f=this.properties[d];if("texture"==f.type||"cubemap"==f.type||"sampler"==f.type){if(f.value){var g=LS.getTexture("sampler"==f.type?f.value.texture:f.value);g||(g=":missing");c[f.name]=g}}else this._uniforms[f.name]=f.value}this._uniforms.u_material_color=this._color;this.textures.environment&&(d=this.textures.environment,(g=LS.getTexture(d.texture))&&(c["environment"+(g.texture_type==
gl.TEXTURE_2D?"_texture":"_cubemap")]=d));this._samplers=c};SurfaceMaterial.prototype.configure=function(a){LS.cloneObject(a,this);this.computeCode()};SurfaceMaterial.prototype.getProperties=function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",code:"string"},b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};
SurfaceMaterial.prototype.onResourceRenamed=function(a,b,c){Material.prototype.onResourceRenamed.call(this,a,b,c);c=0;for(var d=this.properties.length;c<d;++c){var e=this.properties[c];e.value==a&&(e.value=b)}};SurfaceMaterial.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return(a=this.textures[a.substr(4)])?a.texture:null;for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return d.value}return null};
SurfaceMaterial.prototype.setProperty=function(a,b){if(Material.prototype.setProperty.call(this,a,b))return!0;for(var c=0,d=this.properties.length;c<d;++c){var e=this.properties[c];if(e.name==a)return e.value=b,!0}return!1};SurfaceMaterial.prototype.getTextureChannels=function(){for(var a=[],b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||a.push(d.name)}return a};
SurfaceMaterial.prototype.setTexture=function(a,b,c){if(!a)throw"SurfaceMaterial.prototype.setTexture channel must be specified";var d=null;if("environment"==a)return Material.prototype.setTexture.call(this,a,b,c);for(var e=0;e<this.properties.length;++e){var f=this.properties[e];if("texture"==f.type||"cubemap"==f.type||"sampler"==f.type)if(!a||f.name==a){(d=this.textures[a])||(d=this.textures[a]={texture:b,uvs:"0",wrap:0,minFilter:0,magFilter:0});if(c)for(e in c)d[e]=c[e];f.value="sampler"==f.type?
d:b;break}}b&&b.constructor==String&&":"!=b[0]&&LS.ResourcesManager.load(b);return d};SurfaceMaterial.prototype.getResources=function(a){for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||!d.value||(d="sampler"==d.type?d.value.texture:d.value,"string"==typeof d&&(a[d]=GL.Texture))}return a};LS.registerMaterialClass(SurfaceMaterial);LS.SurfaceMaterial=SurfaceMaterial;function ComponentContainer(){this._components=[]}
ComponentContainer.prototype.configureComponents=function(a){if(a.components)for(var b=0,c=a.components.length;b<c;++b){var d=a.components[b],e=d[0];"Transform"==e&&0==b?this.transform.configure(d[1]):LS.Components[e]?(d=new LS.Components[e](d[1]),this.addComponent(d)):console.error("Unknown component found: "+e)}};
ComponentContainer.prototype.serializeComponents=function(a){if(this._components){a.components=[];for(var b=0,c=this._components.length;b<c;++b){var d=this._components[b];if(d.serialize){var e=d.serialize();d.hasOwnProperty("uid")&&!e.uid&&(e.uid=d.uid);a.components.push([LS.getObjectClassName(d),e])}}}};ComponentContainer.prototype.getComponents=function(){return this._components};
ComponentContainer.prototype.addComponent=function(a){if(!a)return console.error("addComponent cannot receive null");a._root=this;if(a.onAddedToNode)a.onAddedToNode(this);if(this._in_tree&&a.onAddedToScene)a.onAddedToScene(this._in_tree);this._components||Object.defineProperty(this,"_components",{value:[],enumerable:!1});if(-1!=this._components.indexOf(a))throw"inserting the same component twice";this._components.push(a);a.hasOwnProperty("uid")||Object.defineProperty(a,"uid",{value:LS.generateUId("COMP-"),
enumerable:!1,writable:!0});return a};ComponentContainer.prototype.removeComponent=function(a){if(!a)return console.error("removeComponent cannot receive null");a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);if(this._in_tree&&a.onRemovedFromScene)a.onRemovedFromScene(this._in_tree);LEvent.unbindAll(this,a);a=this._components.indexOf(a);-1!=a&&this._components.splice(a,1)};ComponentContainer.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};
ComponentContainer.prototype.hasComponent=function(a){if(!this._components)return!1;if(a.constructor===String){for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].constructor.name==a)return!0;return!1}b=0;for(c=this._components.length;b<c;++b)if(this._components[b].constructor===a)return!0;return!1};
ComponentContainer.prototype.getComponent=function(a){if(!this._components)return null;if(a.constructor===String){for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].constructor.name==a)return this._components[b];return null}b=0;for(c=this._components.length;b<c;++b)if(this._components[b].constructor==a)return this._components[b];return null};
ComponentContainer.prototype.getComponentByUId=function(a){if(!this._components)return null;for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].uid==a)return this._components[b];return null};ComponentContainer.prototype.getIndexOfComponent=function(a){return this._components?this._components.indexOf(a):-1};ComponentContainer.prototype.getComponentByIndex=function(a){return this._components?this._components[a]:null};
ComponentContainer.prototype.processActionInComponents=function(a,b){if(this._components)for(var c=0,d=this._components.length;c<d;++c){var e=this._components[c];e[a]&&e[a].constructor===Function&&(b&&b.constructor===Array?e[a].apply(e,b):e[a].call(e,b))}};function CompositePattern(){}CompositePattern.prototype.compositeCtor=function(){};
CompositePattern.prototype.addChild=function(a,b,c){function d(a){if(a._children)for(var b in a._children){var c=a._children[b];c._in_tree||(LEvent.trigger(f,"treeItemAdded",c),c._in_tree=f);d(c)}}for(var e=this;e._parentNode;){if(e==a)throw"addChild: Cannot insert a node as his own child";e=e._parentNode}a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):this._children.splice(b,0,a):this._children=[a];var f=this._in_tree;if(f&&a._in_tree&&
a._in_tree!=f)throw"Cannot add a node that belongs to another scene tree";a._in_tree=f;this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);f&&(LEvent.trigger(f,"treeItemAdded",a),d(a))};
CompositePattern.prototype.removeChild=function(a,b){function c(a){if(a._children)for(var b=0,d=a._children.length;b<d;++b){var h=a._children[b];h._in_tree&&(LEvent.trigger(h._in_tree,"treeItemRemoved",h),h._in_tree=null);c(h)}}if(!this._children||a._parentNode!=this||a._parentNode!=this)return!1;var d=this._children.indexOf(a);if(-1==d)return!1;this._children.splice(d,1);this._onChildRemoved&&this._onChildRemoved(a,b);LEvent.trigger(this,"childRemoved",a);a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemRemoved",
a),c(a));a._in_tree=null;return!0};CompositePattern.prototype.destroy=function(){this._parentNode&&this._parentNode.removeChild(this)};CompositePattern.prototype.serializeChildren=function(){var a=[];if(this._children)for(var b in this._children)a.push(this._children[b].serialize());return a};CompositePattern.prototype.configureChildren=function(a){if(a.children)for(var b in a.children){var c=a.children[b],d=new this.constructor(c.id);c.uid&&(d.uid=c.uid);this.addChild(d);d.configure(c)}};
CompositePattern.prototype.getParent=function(){return this._parentNode};CompositePattern.prototype.getChildren=function(){return this._children||[]};Object.defineProperty(CompositePattern.prototype,"childNodes",{enumerable:!0,get:function(){return this._children||[]},set:function(a){}});Object.defineProperty(CompositePattern.prototype,"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){}});
Object.defineProperty(CompositePattern.prototype,"scene",{enumerable:!0,get:function(){return this._in_tree},set:function(a){throw"Scene cannot be set, you must use addChild in parent";}});CompositePattern.prototype.getDescendants=function(){if(!this._children||0==this._children.length)return[];for(var a=this._children.concat(),b=0;b<this._children.length;++b)a=a.concat(this._children[b].getDescendants());return a};function Component(a){a&&this.configure(a)}
Component.prototype.configure=function(a){a&&(a.uid&&(void 0!==this.uid||Object.hasOwnProperty(this,"uid")?this.uid=a.uid:Object.defineProperty(this,"uid",{value:a.uid,enumerable:!1,writable:!0})),LS.cloneObject(a,this))};Component.prototype.serialize=function(){var a=LS.cloneObject(this);this.uid&&(a.uid=this.uid);return a};
Component.prototype.createProperty=function(a,b,c){c&&(this.constructor["@"+a]={type:c});b.constructor===Number||b.constructor===String||b.constructor===Boolean?this[a]=b:b.constructor===Float32Array&&(c="_"+a,b=new Float32Array(b),this[c]=b,Object.defineProperty(this,a,{get:function(){return b},set:function(a){b.set(a)},enumerable:!0}))};Component.prototype.getLocatorString=function(){return this._root?this._root.uid+"/"+this.uid:""};LS.Component=Component;
function Transform(a){this._position=vec3.create();this._rotation=quat.create();this._scaling=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;if(Object.observe){var b=function(a){this._must_update_matrix=!0}.bind(this);Object.observe(this._position,b);Object.observe(this._rotation,b);Object.observe(this._scaling,b)}a&&this.configure(a)}Transform.temp_matrix=mat4.create();Transform.icon="mini-icon-gizmo.png";Transform.ZERO=vec3.create();
Transform.UP=vec3.fromValues(0,1,0);Transform.RIGHT=vec3.fromValues(1,0,0);Transform.FRONT=vec3.fromValues(0,0,-1);Transform["@position"]={type:"position"};Transform["@rotation"]={type:"quat"};Transform.attributes={position:"vec3",scaling:"vec3",rotation:"quat"};Transform.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};Transform.prototype.onRemovedFromNode=function(a){a.transform==this&&delete a.transform};Transform.prototype.mustUpdate=function(){this._must_update_matrix=!0};
Object.defineProperty(Transform.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(Transform.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(Transform.prototype,"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update_matrix=!0},enumerable:!1});
Object.defineProperty(Transform.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(Transform.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});
Object.defineProperty(Transform.prototype,"scaling",{get:function(){return this._scaling},set:function(a){a.constructor===Number?this._scaling[0]=this._scaling[1]=this._scaling[2]=a:this._scaling.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(Transform.prototype,"matrix",{get:function(){this._must_update_matrix&&this.updateMatrix();return this._local_matrix},set:function(a){this.fromMatrix(a)},enumerable:!0});
Object.defineProperty(Transform.prototype,"globalPosition",{get:function(){return this.getGlobalPosition()},set:function(a){},enumerable:!0});Object.defineProperty(Transform.prototype,"globalMatrix",{get:function(){this.updateGlobalMatrix();return this._global_matrix},set:function(a){},enumerable:!0});
Transform.prototype.getAttributes=function(a){return"output"==a?{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4",globalPosition:"vec3",globalMatrix:"mat4"}:{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4"}};Transform.prototype.copyFrom=function(a){this.configure(a.serialize())};
Transform.prototype.configure=function(a){a.uid&&(this.uid=a.uid);a.position&&this._position.set(a.position);a.scaling&&this._scaling.set(a.scaling);a.rotation&&4==a.rotation.length&&this._rotation.set(a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,
[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._must_update_matrix=!0;this.updateGlobalMatrix();this._on_change()};Transform.prototype.serialize=function(){return{uid:this.uid,position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scaling:[this._scaling[0],this._scaling[1],this._scaling[2]],matrix:toArray(this._local_matrix)}};
Transform.prototype.identity=function(){vec3.copy(this._position,[0,0,0]);quat.copy(this._rotation,[0,0,0,1]);vec3.copy(this._scaling,[1,1,1]);mat4.identity(this._local_matrix);mat4.identity(this._global_matrix);this._must_update_matrix=!1};Transform.prototype.reset=Transform.prototype.identity;Transform.prototype.getPosition=function(a){a=a||vec3.create();a.set(this._position);return a};
Transform.prototype.getGlobalPosition=function(a){a=a||vec3.create();return this._parent?mat4.multiplyVec3(a,this.getGlobalMatrix(),Transform.ZERO):vec3.copy(a,this._position)};Transform.prototype.getRotation=function(a){a=a||quat.create();return vec3.copy(a,this._rotation)};Transform.prototype.getGlobalRotation=function(a){a=a||quat.create();if(!this._parent)return quat.copy(a,this._rotation),a;var b=this._parent;for(quat.copy(a,this._rotation);b;)quat.multiply(a,b._rotation,a),b=b._parent;return a};
Transform.prototype.getScale=function(a){a=a||vec3.create();return vec3.copy(a,this._scaling)};Transform.prototype.getGlobalScale=function(a){a=a||vec3.create();if(this._parent){var b=this;for(vec3.copy(a,this._scaling);b._parent;)vec3.multiply(a,a,b._scaling),b=b._parent;return a}return vec3.copy(a,this._scaling)};
Transform.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scaling);this._must_update_matrix=!1};Transform.prototype.updateLocalMatrix=Transform.prototype.updateMatrix;
Transform.prototype.updateGlobalMatrix=function(a){this._must_update_matrix&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):this._global_matrix.set(this._local_matrix)};Transform.prototype.getMatrix=function(a){a=a||mat4.create();this._must_update_matrix&&this.updateMatrix();return mat4.copy(a,this._local_matrix)};Transform.prototype.getLocalMatrix=Transform.prototype.getMatrix;
Transform.prototype.getLocalMatrixRef=function(){this._must_update_matrix&&this.updateMatrix();return this._local_matrix};Transform.prototype.getGlobalMatrix=function(a,b){this._must_update_matrix&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,b?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):mat4.copy(this._global_matrix,this._local_matrix);return mat4.copy(a,this._global_matrix)};
Transform.prototype.getGlobalMatrixRef=function(){this.updateGlobalMatrix();return this._global_matrix};Transform.prototype.getAncestors=function(){for(var a=[this],b=this;b=b._parent;)a.unshift(b);return a};Transform.prototype.getGlobalTranslationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1)};
Transform.prototype.getGlobalRotationMatrix=function(a){a=a||mat4.create();if(!this._parent)return mat4.fromQuat(a,this._rotation);for(var b=mat4.create(),c=this;c;)mat4.fromQuat(b,c._rotation),mat4.multiply(a,a,b),c=c._parent;return a};Transform.prototype.getGlobalTranslationRotationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromRotationTranslation(mat4.create(),this.getGlobalRotation(),a)};Transform.prototype.getGlobalMatrixWithoutScale=Transform.prototype.getGlobalTranslationRotationMatrix;
Transform.prototype.getNormalMatrix=function(a){this._must_update_matrix&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};
Transform.prototype.fromMatrix=function(a,b){if(b&&this._parent){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();this._scaling[0]=vec3.length(mat4.rotateVec3(d,c,[1,0,0]));this._scaling[1]=vec3.length(mat4.rotateVec3(d,c,[0,1,0]));this._scaling[2]=vec3.length(mat4.rotateVec3(d,c,[0,0,1]));mat4.scale(mat4.create(),c,[1/this._scaling[0],1/this._scaling[1],
1/this._scaling[2]]);vec3.normalize(c.subarray(0,3),c.subarray(0,3));vec3.normalize(c.subarray(4,7),c.subarray(4,7));vec3.normalize(c.subarray(8,11),c.subarray(8,11));c=mat3.fromMat4(mat3.create(),c);mat3.transpose(c,c);quat.fromMat3(this._rotation,c);quat.normalize(this._rotation,this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1;this._on_change(!0)};
Transform.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.setRotation=function(a){quat.copy(this._rotation,a);this._must_update_matrix=!0;this._on_change()};
Transform.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scaling,a,b,c):vec3.set(this._scaling,a,a,a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.translate=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._must_update_matrix=!0;this._on_change()};
Transform.prototype.translateGlobal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,this.transformVector([a,b,c])):vec3.add(this._position,this._position,this.transformVector(a));this._must_update_matrix=!0;this._on_change()};Transform.prototype.rotate=function(){var a=quat.create();return function(b,c){quat.setAxisAngle(a,c,0.0174532925*b);quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0;this._on_change()}}();
Transform.prototype.rotateX=function(a){quat.rotateX(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.rotateY=function(a){quat.rotateY(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.rotateZ=function(a){quat.rotateZ(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};
Transform.prototype.rotateGlobal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._must_update_matrix=!0;this._on_change()};Transform.prototype.rotateQuat=function(a){quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0;this._on_change()};Transform.prototype.rotateQuatGlobal=function(a){quat.multiply(this._rotation,a,this._rotation);this._must_update_matrix=!0;this._on_change()};
Transform.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scaling,this._scaling,[a,b,c]):vec3.multiply(this._scaling,this._scaling,a);this._must_update_matrix=!0;this._on_change()};Transform.interpolate=function(a,b,c,d){vec3.lerp(d._scaling,a._scaling,b._scaling,c);vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._must_update_matrix=!0;this._on_change()};
Transform.prototype.lookAt=function(){var a=mat4.create(),b=mat4.create(),c=vec3.create(),d=vec3.create(),e=vec3.create();return function(f,g,h,l){l&&this._parent?(this._parent.getGlobalMatrix(a),l=mat4.invert(a,a),mat4.multiplyVec3(c,l,f),mat4.multiplyVec3(d,l,g),mat4.rotateVec3(e,l,h)):(c.set(f),d.set(g),e.set(h));mat4.lookAt(b,c,d,e);quat.fromMat4(this._rotation,b);this._position.set(c);this._must_update_matrix=!0}}();
Transform.prototype._on_change=function(a){a||(this._must_update_matrix=!0);LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,"transformChanged",this)};Transform.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),Transform.FRONT,this.getGlobalRotation())};Transform.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),Transform.UP,this.getGlobalRotation())};
Transform.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),Transform.RIGHT,this.getGlobalRotation())};Transform.prototype.transformPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};Transform.prototype.transformPointGlobal=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrixRef(),a)};
Transform.prototype.localToGlobal=Transform.prototype.transformPointGlobal;Transform.prototype.globalToLocal=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();var c=mat4.invert(mat4.create(),this.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};Transform.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this._rotation)};Transform.prototype.transformVectorGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getGlobalRotation())};
Transform.prototype.localVectorToGlobal=Transform.prototype.transformVectorGlobal;Transform.prototype.globalVectorToLocal=function(a,b){var c=this.getGlobalRotation();quat.invert(c,c);return vec3.transformQuat(b||vec3.create(),a,c)};Transform.prototype.applyTransform=function(a,b,c){vec3.add(this._position,this._position,a._position);quat.multiply(this._rotation,this._rotation,a._rotation);vec3.multiply(this._scaling,this._scaling,a._scaling);this._must_update_matrix=!0};
Transform.prototype.applyTransformMatrix=function(a,b,c){c=a;if(b){var d=mat4.setTranslation(mat4.create(),b);c=vec3.scale(vec3.create(),b,-1);b=mat4.setTranslation(mat4.create(),c);c=mat4.create();mat4.multiply(c,d,a);mat4.multiply(c,c,b)}this._parent?(a=this.getGlobalMatrix(),d=this._parent._global_matrix,b=mat4.create(),mat4.multiply(this._global_matrix,c,a),mat4.invert(b,d),mat4.multiply(this._local_matrix,b,this._global_matrix),this.fromMatrix(this._local_matrix)):this.applyLocalTransformMatrix(c)};
Transform.prototype.applyLocalTransformMatrix=function(a){var b=vec3.create();vec3.transformMat4(this._position,this._position,a);mat4.rotateVec3(b,a,[1,0,0]);this._scaling[0]*=vec3.length(b);mat4.rotateVec3(b,a,[0,1,0]);this._scaling[1]*=vec3.length(b);mat4.rotateVec3(b,a,[0,0,1]);this._scaling[2]*=vec3.length(b);a=mat4.invert(mat4.create(),a);mat4.transpose(a,a);a=mat3.fromMat4(mat3.create(),a);a=quat.fromMat3(quat.create(),a);quat.normalize(a,a);quat.multiply(this._rotation,a,this._rotation);this._must_update_matrix=
!0};LS.registerComponent(Transform);LS.Transform=Transform;
function Camera(a){this.clear_depth=this.clear_color=this.enabled=!0;this._type=Camera.PERSPECTIVE;this._eye=vec3.fromValues(0,100,100);this._center=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._global_eye=vec3.fromValues(0,100,100);this._global_center=vec3.fromValues(0,0,0);this._global_up=vec3.fromValues(0,1,0);this._near=1;this._far=1E3;this._ortho=new Float32Array([-1,1,-1,1]);this._aspect=1;this._fov=45;this._frustum_size=50;this._real_aspect=1;this._viewport=new Float32Array([0,
0,1,1]);this._viewport_in_pixels=vec4.create();this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._must_update_projection_matrix=this._must_update_view_matrix=!0;this.render_to_texture=!1;this.texture_name="";this.texture_size=vec2.fromValues(0,0);this.texture_clone=this.texture_high=!1;a&&this.configure(a)}Camera.icon="mini-icon-camera.png";Camera.PERSPECTIVE=1;Camera.ORTHOGRAPHIC=2;
Camera.ORTHO2D=3;Camera["@type"]={type:"enum",values:{perspective:Camera.PERSPECTIVE,orthographic:Camera.ORTHOGRAPHIC,ortho2D:Camera.ORTHO2D}};Camera["@eye"]={type:"position"};Camera["@center"]={type:"position"};Camera["@texture_name"]={type:"texture"};
Camera.cubemap_camera_parameters=[{dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];Camera.prototype.getResources=function(a){return a};
Object.defineProperty(Camera.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._must_update_projection_matrix=this._must_update_view_matrix=!0);this._type=a}});Object.defineProperty(Camera.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._must_update_view_matrix=!0}});Object.defineProperty(Camera.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._must_update_view_matrix=!0}});
Object.defineProperty(Camera.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_view_matrix=!0}});Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._must_update_projection_matrix=!0);this._near=a}});Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._must_update_projection_matrix=!0);this._far=a}});
Object.defineProperty(Camera.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._must_update_projection_matrix=!0);this._aspect=a}});Object.defineProperty(Camera.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._must_update_projection_matrix=!0);this._fov=a}});
Object.defineProperty(Camera.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size!=a&&(this._must_update_projection_matrix=this._must_update_view_matrix=!0);this._frustum_size=a}});Object.defineProperty(Camera.prototype,"viewport",{get:function(){return this._viewport},set:function(a){this._viewport.set(a)}});Camera.prototype.onAddedToNode=function(a){a.camera||(a.camera=this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};
Camera.prototype.onRemovedFromNode=function(a){a.camera==this&&delete a.camera;this._texture&&(this._renderbuffer=this._fbo=this._texture=null)};Camera.prototype.isRenderedToTexture=function(){return this.enabled&&this.render_to_texture&&this.texture_name};
Camera.prototype.onCollectCameras=function(a,b){this.enabled&&(this.isRenderedToTexture()?b.unshift(this):b.push(this),this.render_to_texture&&this.texture_name?this._binded_render_frame||(LEvent.bind(this,"beforeRenderFrame",this.startFBO,this),LEvent.bind(this,"afterRenderFrame",this.endFBO,this),this._binded_render_frame=!0):this._binded_render_frame&&(LEvent.unbind(this,"beforeRenderFrame",this.startFBO,this),LEvent.unbind(this,"afterRenderFrame",this.endFBO,this)))};
Camera.prototype.lookAt=function(a,b,c){vec3.copy(this._eye,a);vec3.copy(this._center,b);vec3.copy(this._up,c);this._must_update_view_matrix=!0};
Camera.prototype.updateMatrices=function(){this.type==Camera.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this._frustum_size*this._real_aspect*0.5,this._frustum_size*this._real_aspect*0.5,0.5*-this._frustum_size,0.5*this._frustum_size,this._near,this._far):this.type==Camera.ORTHO2D?mat4.ortho(this._projection_matrix,this._ortho[0],this._ortho[1],this._ortho[2],this._ortho[3],this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._real_aspect,this._near,this._far);
this._root&&this._root._is_root?mat4.lookAt(this._view_matrix,this._eye,this._center,this._up):mat4.lookAt(this._view_matrix,this.getEye(this._global_eye),this.getCenter(this._global_center),this.getUp(this._global_up));mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_projection_matrix=this._must_update_view_matrix=!1};
Camera.prototype.getModelMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};Camera.prototype.getViewMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};Camera.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._must_update_projection_matrix&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};
Camera.prototype.getViewProjectionMatrix=function(a){a=a||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};Camera.prototype.getModelViewProjectionMatrix=function(a,b){b=b||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return mat4.multiply(b,this._viewprojection_matrix,a)};
Camera.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};
Camera.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._must_update_view_matrix&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};
Camera.prototype.getLocalVector=function(a,b){b=b||vec3.create();this._must_update_view_matrix&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.rotateVec3(b,c,a)};Camera.prototype.getEye=function(a){a=a||vec3.create();a.set(this._eye);return this._root&&this._root.transform?this._root.transform.getGlobalPosition(a):a};
Camera.prototype.getCenter=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),a);a.set(this._center);return a};Camera.prototype.getFront=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a);vec3.sub(a,this._center,this._eye);return vec3.normalize(a,a)};
Camera.prototype.getUp=function(a){a=a||vec3.create();a.set(this._up);return this._root&&this._root.transform?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};Camera.prototype.getTop=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye),c=vec3.cross(vec3.create(),this._up,b);a=vec3.cross(a,b,c);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};
Camera.prototype.getRight=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye);a=vec3.cross(a,this._up,b);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};Camera.prototype.setEye=function(a){this._eye.set(a);this._must_update_view_matrix=!0};Camera.prototype.setCenter=function(a){this._center.set(a);this._must_update_view_matrix=!0};
Camera.prototype.setOrthographic=function(a,b,c,d,e,f){this._near=e;this._far=f;this._ortho.set([a,b,c,d]);this._type=Camera.ORTHO2D;this._must_update_projection_matrix=!0};Camera.prototype.move=function(a){vec3.add(this._center,this._center,a);vec3.add(this._eye,this._eye,a);this._must_update_view_matrix=!0};
Camera.prototype.rotate=function(a,b,c){c&&this.getLocalVector(b,b);a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._center,this._eye);vec3.transformQuat(b,b,a);vec3.add(this._center,this._eye,b);this._must_update_view_matrix=!0};
Camera.prototype.orbit=function(a,b,c){c=c||this._center;a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._eye,c);vec3.transformQuat(b,b,a);vec3.add(this._eye,c,b);this._must_update_view_matrix=!0};Camera.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._must_update_view_matrix=!0};
Camera.prototype.setOrientation=function(a,b){var c=this.getCenter(),d=this.getEye(),e=[0,1,0],c=vec3.sub(vec3.create(),c,d),c=vec3.length(c),f=null,f=vec3.fromValues(0,0,-c);b&&(vec3.rotateY(f,f,-0.5*Math.PI),vec3.rotateY(e,e,-0.5*Math.PI));vec3.transformQuat(f,f,a);vec3.transformQuat(e,e,a);b&&(vec3.rotateY(f,f,0.5*Math.PI),vec3.rotateY(e,e,0.5*Math.PI));this.center=vec3.add(vec3.create(),d,f);this.up=e;this._must_update_view_matrix=!0};
Camera.prototype.setEulerAngles=function(a,b,c){var d=quat.create();quat.fromEuler(d,[a,b,c]);this.setOrientation(d)};Camera.prototype.fromViewmatrix=function(a){a=mat4.invert(mat4.create(),a);this.eye=vec3.transformMat4(vec3.create(),vec3.create(),a);this.center=vec3.transformMat4(vec3.create(),[0,0,-1],a);this.up=mat4.rotateVec3(vec3.create(),a,[0,1,0]);this._must_update_view_matrix=!0};
Camera.prototype.setViewportInPixels=function(a,b,c,d){this._viewport[0]=a/gl.canvas.width;this._viewport[1]=b/gl.canvas.height;this._viewport[2]=c/gl.canvas.width;this._viewport[3]=d/gl.canvas.height};Camera.prototype.project=function(a,b,c,d){c=c||vec3.create();b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();vec3.project(c,a,this._viewprojection_matrix,b);d||(c[1]=b[3]-c[1]+2*b[1]);return c};
Camera.prototype.unproject=function(a,b,c){b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};
Camera.prototype.getLocalViewport=function(a,b){b=b||vec4.create();if(!a)return b[0]=gl.canvas.width*this._viewport[0],b[1]=gl.canvas.height*this._viewport[1],b[2]=gl.canvas.width*this._viewport[2],b[3]=gl.canvas.height*this._viewport[3],b;b[0]=Math.floor(a[2]*this._viewport[0]+a[0]);b[1]=Math.floor(a[3]*this._viewport[1]+a[1]);b[2]=Math.ceil(a[2]*this._viewport[2]);b[3]=Math.ceil(a[3]*this._viewport[3]);return b};
Camera.prototype.getRayInPixel=function(a,b,c,d){d||(c=this.getLocalViewport(c,this._viewport_in_pixels));(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();d=this.getEye();var e=vec3.unproject(vec3.create(),[a,b,1],this._viewprojection_matrix,c);this.type==Camera.ORTHOGRAPHIC&&(d=vec3.unproject(d,[a,b,0],this._viewprojection_matrix,c));a=vec3.subtract(e,e,d);vec3.normalize(a,a);return{start:d,direction:a}};
Camera.prototype.isPointInCamera=function(a,b,c){c=this.getLocalViewport(c,this._viewport_in_pixels);return a<c[0]||a>c[0]+c[2]||b<c[1]||b>c[1]+c[3]?!1:!0};
Camera.prototype.configure=function(a){void 0!==a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.type&&(this._type=a.type);void 0!==a.eye&&this._eye.set(a.eye);void 0!==a.center&&this._center.set(a.center);void 0!==a.up&&this._up.set(a.up);void 0!==a.near&&(this._near=a.near);void 0!==a.far&&(this._far=a.far);void 0!==a.fov&&(this._fov=a.fov);void 0!==a.aspect&&(this._aspect=a.aspect);void 0!==a.frustum_size&&(this._frustum_size=a.frustum_size);void 0!==a.viewport&&
this._viewport.set(a.viewport);void 0!==a.render_to_texture&&(this.render_to_texture=a.render_to_texture);void 0!==a.texture_name&&(this.texture_name=a.texture_name);a.texture_size&&2==a.texture_size.length&&this.texture_size.set(a.texture_size);void 0!==a.texture_high&&(this.texture_high=a.texture_high);void 0!==a.texture_clone&&(this.texture_clone=a.texture_clone);this.updateMatrices()};
Camera.prototype.serialize=function(){return{uid:this.uid,enabled:this.enabled,type:this._type,eye:vec3.toArray(this._eye),center:vec3.toArray(this._center),up:vec3.toArray(this._up),near:this._near,far:this._far,fov:this._fov,aspect:this._aspect,frustum_size:this._frustum_size,viewport:toArray(this._viewport),render_to_texture:this.render_to_texture,texture_name:this.texture_name,texture_size:toArray(this.texture_size),texture_high:this.texture_high,texture_clone:this.texture_clone}};
Camera.prototype.getTransformMatrix=function(a){if(this._root&&this._root.transform)return null;var b=null,b="center"==a?this._center:this._eye;a=mat4.create();mat4.setTranslation(a,b);return a};Camera.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="center"==c?this._center:this._eye;mat4.multiplyVec3(b,a,b);return!0};
Camera.prototype.startFBO=function(){if(this.render_to_texture&&this.texture_name){var a=this.texture_size[0]||gl.canvas.width,b=this.texture_size[1]||gl.canvas.height,c=this.texture_high?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;if(!this._texture||this._texture.width!=a||this._texture.height!=b||this._texture.type!=c){var d=isPowerOfTwo(a)&&isPowerOfTwo(b);this._texture=new GL.Texture(a,b,{format:gl.RGB,wrap:d?gl.REPEAT:gl.CLAMP_TO_EDGE,filter:d?gl.LINEAR:gl.NEAREST,type:c})}c=this._texture;this._old_fbo=
gl.getParameter(gl.FRAMEBUFFER_BINDING);this._old_viewport||(this._old_viewport=vec4.create());this._old_viewport.set(gl.viewport_data);this._fbo=this._fbo||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo);gl.viewport(0,0,a,b);LS.Renderer._full_viewport.set([0,0,a,b]);LS.Renderer.global_aspect=gl.canvas.width/gl.canvas.height/(c.width/c.height);d=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer();if(d.width!=a||d.height!=b)d.width=a,d.height=b;gl.bindRenderbuffer(gl.RENDERBUFFER,
d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,c.handler,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d)}};
Camera.prototype.endFBO=function(){if(this.render_to_texture&&this.texture_name){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo);LS.Renderer.global_aspect=1;this._old_fbo=null;gl.NEAREST_MIPMAP_NEAREST<=this._texture.minFilter&&this._texture.minFilter<=gl.LINEAR_MIPMAP_LINEAR&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type));var a=this._old_viewport;gl.viewport(a[0],a[1],a[2],a[3]);LS.Renderer._full_viewport.set(a);this.texture_name&&(a=this._texture,this.texture_clone&&(this._texture_clone&&
this._texture_clone.width==a.width&&this._texture_clone.height==a.height&&this._texture_clone.type==a.type||(this._texture_clone=new GL.Texture(a.width,a.height,{format:gl.RGB,filter:gl.LINEAR,type:a.type})),a.copyTo(this._texture_clone),a=this._texture_clone),LS.ResourcesManager.registerResource(this.texture_name,a))}};LS.registerComponent(Camera);LS.Camera=Camera;
function CameraFX(a){this.use_viewport_size=this.enabled=!0;this.use_high_precision=!1;this.fx=[];this._uniforms={u_aspect:1,u_viewport:vec2.create(),u_iviewport:vec2.create(),u_texture:0,u_texture_depth:1};a&&this.configure(a)}CameraFX.icon="mini-icon-fx.png";
CameraFX.available_fx={"brightness/contrast":{name:"Brightness & Contrast",uniforms:{brightness:{name:"u_brightness",type:"float",value:1,min:0,max:2,step:0.01},contrast:{name:"u_contrast",type:"float",value:1,min:0,max:2,step:0.01}},code:"color.xyz = (color.xyz * u_brightness@ - vec3(0.5)) * u_contrast@ + vec3(0.5);"},invert:{name:"Invert color",code:"color.xyz = vec3(1.0) - color.xyz;"},threshold:{name:"Threshold",uniforms:{threshold:{name:"u_threshold",type:"float",value:0.5,min:0,max:2,step:0.01},
threshold_width:{name:"u_threshold_width",type:"float",value:0.01,min:0,max:1,step:0.001}},code:"color.xyz = vec3( smoothstep( u_threshold@ - u_threshold_width@ * 0.5, u_threshold@ + u_threshold_width@ * 0.5,  length(color.xyz) ));"},colorize:{name:"Colorize",uniforms:{colorize:{name:"u_colorize",type:"color3",value:[1,1,1]},vibrance:{name:"u_vibrance",type:"float",value:0,min:0,max:2,step:0.01}},code:"color.xyz = color.xyz * (u_colorize@ + vec3(u_vibrance@ * 0.1)) * (1.0 + u_vibrance@);"},halftone:{name:"Halftone",
uniforms:{"Halftone angle":{name:"u_halftone_angle",type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.x = ( (color.x * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );color.y = ( (color.y * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.167, u_halftone_size@ ) );color.z = ( (color.z * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.333, u_halftone_size@ ) );"},"halftone B/N":{name:"HalftoneBN",uniforms:{"Halftone angle":{name:"u_halftone_angle",
type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.xyz = vec3( (length(color.xyz) * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );"},lens:{name:"Lens Distortion",uniforms:{lens_k:{name:"u_lens_k",type:"float",value:-0.15},lens_kcube:{name:"u_lens_kcube",type:"float",value:0.8},lens_scale:{name:"u_lens_scale",type:"float",value:1}},uv_code:"float r2 = u_aspect * u_aspect * (uv.x-0.5) * (uv.x-0.5) + (uv.y-0.5) * (uv.y-0.5); float distort@ = 1. + r2 * (u_lens_k@ + u_lens_kcube@ * sqrt(r2)); uv = vec2( u_lens_scale@ * distort@ * (uv.x-0.5) + 0.5, u_lens_scale@  * distort@ * (uv.y-0.5) + 0.5 );"},
pixelate:{name:"Pixelate",uniforms:{width:{name:"u_width",type:"float",value:256,step:1,min:1},height:{name:"u_height",type:"float",value:256,step:1,min:1}},uv_code:"uv = vec2( floor(uv.x * u_width@) / u_width@, floor(uv.y * u_height@) / u_height@ );"},quantize:{name:"Quantize",uniforms:{levels:{name:"u_levels",type:"float",value:8,step:1,min:1}},code:"color.xyz = floor(color.xyz * u_levels@) / u_levels@;"},edges:{name:"Edges",uniforms:{"Edges factor":{name:"u_edges_factor",type:"float",value:1}},
code:"vec4 color@ = texture2D(u_texture, uv );\n\t\t\t\tvec4 color_up@ = texture2D(u_texture, uv + vec2(0., u_iviewport.y));\n\t\t\t\tvec4 color_right@ = texture2D(u_texture, uv + vec2(u_iviewport.x,0.));\n\t\t\t\tvec4 color_down@ = texture2D(u_texture, uv + vec2(0., -u_iviewport.y));\n\t\t\t\tvec4 color_left@ = texture2D(u_texture, uv + vec2(-u_iviewport.x,0.));\n\t\t\t\tcolor = u_edges_factor@ * (abs(color@ - color_up@) + abs(color@ - color_down@) + abs(color@ - color_left@) + abs(color@ - color_right@));"},
depth:{name:"Depth",uniforms:{near:{name:"u_near",type:"float",value:0.01,step:0.1},far:{name:"u_far",type:"float",value:1E3,step:1}},code:"color.xyz = vec3( (2.0 * u_near@) / (u_far@ + u_near@ - texture2D(u_texture_depth, uv ).x * (u_far@ - u_near@)) );"},logarithmic:{name:"Logarithmic",uniforms:{"Log. A Factor":{name:"u_logfactor_a",type:"float",value:2,step:0.01},"Log. B Factor":{name:"u_logfactor_b",type:"float",value:2,step:0.01}},code:"color.xyz = log( color.xyz * u_logfactor_a@ ) * u_logfactor_b@;"}};
CameraFX.available_functions={pattern:"float pattern(float angle, float size) {\n\t\t\t\tfloat s = sin(angle * 3.1415), c = cos(angle * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_viewport.xy;\n\t\t\t\tvec2 point = vec2( c * tex.x - s * tex.y , s * tex.x + c * tex.y ) * size;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t"};
CameraFX.prototype.configure=function(a){this.enabled=!!a.enabled;this.use_viewport_size=!!a.use_viewport_size;this.use_high_precision=!!a.use_high_precision;a.fx&&(this.fx=a.fx.concat())};CameraFX.prototype.serialize=function(){return{enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_viewport_size:this.use_viewport_size,fx:this.fx.concat()}};CameraFX.prototype.getResources=function(a){return a};CameraFX.prototype.addFX=function(a){a&&this.fx.push({name:a})};
CameraFX.prototype.getFX=function(a){return this.fx[a]};CameraFX.prototype.removeFX=function(a){for(var b=0;b<this.fx.length;b++)if(this.fx[b]===a){this.fx.splice(b,1);break}};CameraFX.prototype.onAddedToNode=function(a){LEvent.bind(LS.GlobalScene,"beforeRenderMainPass",this.onBeforeRender,this)};CameraFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(LS.GlobalScene,"beforeRenderMainPass",this.onBeforeRender,this)};
CameraFX.prototype.onBeforeRender=function(a,b){this.enabled&&(this._renderFrameContainer||(this._renderFrameContainer=new LS.RenderFrameContainer,this._renderFrameContainer.component=this,this._renderFrameContainer.postRender=CameraFX.postRender),this.use_viewport_size&&this._renderFrameContainer.useCanvasSize(),this._renderFrameContainer.use_high_precision=this.use_high_precision,LS.Renderer.assignGlobalRenderFrameContainer(this._renderFrameContainer))};
CameraFX.postRender=function(){this.endFBO();for(var a=this.color_texture,b=this.depth_texture,c=this.component,d=c.fx,e="",f=!0,g=0;g<d.length;g++)e+=d[g]+"|";e==this._last_shader_key&&(f=!1);this._last_shader_key=e;var h=e="",l={},k="",c=c._uniforms;c.u_viewport[0]=a.width;c.u_viewport[1]=a.height;c.u_iviewport[0]=1/a.width;c.u_iviewport[1]=1/a.height;c.u_aspect=a.width/a.height;for(var m=0,g=0;g<d.length;g++){var n=d[g],m=g,p=CameraFX.available_fx[n.name];if(p){if(f){if(p.functions)for(var q in p.functions)l[p.functions[q]]=
!0;p.code&&(h+=p.code.split("@").join(m)+";\n");p.uv_code&&(e+=p.uv_code.split("@").join(m)+";\n")}if(p.uniforms)for(var r in p.uniforms){var s=p.uniforms[r],u=s.name+m;f&&(k+="uniform "+s.type+" "+u+";\n");c[u]=void 0!==n[r]?n[r]:s.value}}}d=null;if(f){f="";for(g in l)(l=CameraFX.available_functions[g])?f+=l+"\n":console.error("CameraFX: Function not found: "+g);this._last_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_OES_standard_derivatives : enable\n\t\t\tprecision highp float;\n\t\t\t#define color3 vec3\n\t\t\t#define color4 vec4\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_depth;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_iviewport;\n\t\t\tuniform float u_aspect;\n\t\t\t"+
k+"\n\t\t\t"+f+"\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\t"+e+"\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\tfloat temp = 0.0;\n\t\t\t\t"+h+"\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t")}d=this._last_shader;d.hasUniform("u_texture_depth")&&b.bind(1);a.toViewport(d,c)};LS.registerComponent(CameraFX);
function Light(a){this._position=vec3.create();this._target=vec3.fromValues(0,0,1);this._up=vec3.fromValues(0,1,0);this.enabled=!0;this.near=1;this.far=500;this.angle=45;this.angle_end=60;this.constant_diffuse=!1;this.use_specular=!0;this.linear_attenuation=!1;this.range_attenuation=!0;this.att_start=0;this.att_end=1E3;this.offset=0;this.spot_cone=!0;this._attenuation_info=new Float32Array([this.att_start,this.att_end]);this.use_target=!1;this._color=vec3.fromValues(1,1,1);this.intensity=1;this.cast_shadows=
!1;this.shadow_bias=0.005;this.shadowmap_resolution=1024;this.type=Light.OMNI;this.frustum_size=50;this.extra_light_shader_code=null;this._front=vec3.clone(Light.FRONT_VECTOR);this._right=vec3.clone(Light.RIGHT_VECTOR);this._top=vec3.clone(Light.UP_VECTOR);this._macros={};this._uniforms={};a&&(this.configure(a),a.shadowmap_resolution&&(this.shadowmap_resolution=parseInt(a.shadowmap_resolution)))}
Object.defineProperty(Light.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a)},enumerable:!0});Object.defineProperty(Light.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a)},enumerable:!0});Object.defineProperty(Light.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a)},enumerable:!0});
Object.defineProperty(Light.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Light.FRONT_VECTOR=new Float32Array([0,0,-1]);Light.RIGHT_VECTOR=new Float32Array([1,0,0]);Light.UP_VECTOR=new Float32Array([0,1,0]);Light.OMNI=1;Light.SPOT=2;Light.DIRECTIONAL=3;Light.DEFAULT_SHADOWMAP_RESOLUTION=1024;Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;Light.coding_help="LightInfo LIGHT -> light info before applying equation\nInput IN -> info about the mesh\nSurfaceOutput o -> info about the surface properties of this pixel\n\nstruct LightInfo {\n\tvec3 Color;\n\tvec3 Ambient;\n\tfloat Diffuse; //NdotL\n\tfloat Specular; //RdotL\n\tvec3 Emission;\n\tvec3 Reflection;\n\tfloat Attenuation;\n\tfloat Shadow; //1.0 means fully lit\n};\n\nstruct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Ambient;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";
Light.prototype.onAddedToNode=function(a){a.light||(a.light=this);LEvent.bind(a,"collectLights",this.onCollectLights,this)};Light.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light;delete ResourcesManager.textures[":shadowmap_"+this.uid]};Light.prototype.onCollectLights=function(a,b){this.enabled&&b.push(this)};Light._temp_matrix=mat4.create();Light._temp2_matrix=mat4.create();Light._temp3_matrix=mat4.create();Light._temp_position=vec3.create();Light._temp_target=vec3.create();
Light._temp_up=vec3.create();Light._temp_front=vec3.create();
Light.prototype.updateLightCamera=function(){this._light_camera||(this._light_camera=new Camera);var a=this._light_camera;a.eye=this.getPosition(Light._temp_position);a.center=this.getTarget(Light._temp_target);var b=this.getUp(Light._temp_up),c=this.getFront(Light._temp_front);0.999<Math.abs(vec3.dot(c,b))&&vec3.set(b,0,0,1);a.up=b;a.type=this.type==Light.DIRECTIONAL?Camera.ORTHOGRAPHIC:Camera.PERSPECTIVE;b=this.computeShadowmapFar();a._frustum_size=this.frustum_size||Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;
a.near=this.near;a.far=b;a.fov=this.angle_end||45;a.updateMatrices();this._light_matrix=a._viewprojection_matrix;return a};Light.prototype.getLightCamera=function(){this._light_camera||this.updateLightCamera();return this._light_camera};Light.prototype.serialize=function(){this.position=vec3.toArray(this.position);this.target=vec3.toArray(this.target);this.color=vec3.toArray(this.color);return LS.cloneObject(this)};Light.prototype.configure=function(a){LS.cloneObject(a,this)};
Light.prototype.updateVectors=function(){var a=vec3.create();return function(){if(this._root&&this._root.transform){var b=this._root.transform.getGlobalMatrixRef();mat4.getTranslation(this._position,b);this.use_target||mat4.multiplyVec3(this._target,b,Light.FRONT_VECTOR);mat4.multiplyVec3(this._up,b,Light.UP_VECTOR);mat4.rotateVec3(this._front,b,Light.FRONT_VECTOR);mat4.rotateVec3(this._right,b,Light.RIGHT_VECTOR);vec3.copy(this._top,this.up)}else vec3.subtract(this._front,this._target,this._position),
vec3.normalize(this._front,this._front),vec3.normalize(a,this._up),vec3.cross(this._right,this._front,a),vec3.cross(this._top,this._right,this._front)}}();Light.prototype.getPosition=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.getGlobalPosition(a);a.set(this._position);return a};
Light.prototype.getTarget=function(a){a=a||vec3.create();if(this._root&&this._root.transform&&!this.use_target)return this._root.transform.transformPointGlobal(Light.FRONT_VECTOR,a);a.set(this._target);return a};Light.prototype.getUp=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.transformVector(Light.UP_VECTOR,a);a.set(this._up);return a};
Light.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this.getPosition(),this.getTarget());vec3.normalize(a,a);return a};Light.prototype.getLightRotationMatrix=function(){};Light.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=Texture);return a};Light.prototype.onResourceRenamed=function(a,b,c){this.projective_texture==a&&(this.projective_texture=b)};
Light.prototype.prepare=function(a){var b=this._uniforms,c=this._macros;wipeObject(c);(this.projective_texture||this.cast_shadows)&&this.updateLightCamera();!this.cast_shadows&&this._shadowmap&&(this._shadowmap=null,delete LS.ResourcesManager.textures[":shadowmap_"+this.uid]);this.updateVectors();this.type==Light.DIRECTIONAL?c.USE_DIRECTIONAL_LIGHT="":this.type==Light.SPOT?c.USE_SPOT_LIGHT="":c.USE_OMNI_LIGHT="";this.spot_cone&&(c.USE_SPOT_CONE="");this.linear_attenuation&&(c.USE_LINEAR_ATTENUATION=
"");this.range_attenuation&&(c.USE_RANGE_ATTENUATION="");0.001<this.offset&&(c.USE_LIGHT_OFFSET="");if(this.projective_texture){var d=this.projective_texture.constructor===String?LS.ResourcesManager.textures[this.projective_texture]:this.projective_texture;d&&(d.texture_type==gl.TEXTURE_CUBE_MAP?c.USE_LIGHT_CUBEMAP="":c.USE_LIGHT_TEXTURE="")}if(this.type==Light.DIRECTIONAL||this.type==Light.SPOT)b.u_light_front=this._front;this.type==Light.SPOT&&(b.u_light_angle=[this.angle*DEG2RAD,this.angle_end*
DEG2RAD,Math.cos(this.angle*DEG2RAD*0.5),Math.cos(this.angle_end*DEG2RAD*0.5)]);b.u_light_position=this.position;b.u_light_color=vec3.scale(b.u_light_color||vec3.create(),this.color,this.intensity);this._attenuation_info[0]=this.att_start;this._attenuation_info[1]=this.att_end;b.u_light_att=this._attenuation_info;b.u_light_offset=this.offset;this.extra_light_shader_code?(c=null,this._last_extra_light_shader_code!=this.extra_light_shader_code&&(this._last_processed_extra_light_shader_code=c=LS.Material.processShaderCode(this.extra_light_shader_code))):
this._last_processed_extra_light_shader_code=null;!a.update_shadowmaps||a.shadows_disabled||a.lights_disabled||a.low_quality||this.generateShadowmap(a);this._shadowmap&&!this.cast_shadows&&(this._shadowmap=null);this._uniforms=b};
Light.prototype.getMacros=function(a,b){var c=this._macros,d=this.cast_shadows&&this._shadowmap&&null!=this._light_matrix&&!b.shadows_disabled;this.constant_diffuse||a.material.constant_diffuse?delete c.USE_DIFFUSE_LIGHT:c.USE_DIFFUSE_LIGHT="";this.use_specular&&0<a.material.specular_factor?c.USE_SPECULAR_LIGHT="":delete c.USE_SPECULAR_LIGHT;d&&a.flags&RI_RECEIVE_SHADOWS?(c.USE_SHADOW_MAP="",this._shadowmap&&this._shadowmap.texture_type==gl.TEXTURE_CUBE_MAP&&(c.USE_SHADOW_CUBEMAP=""),this.hard_shadows&&
(c.USE_HARD_SHADOWS=""),c.SHADOWMAP_OFFSET=""):delete c.USE_SHADOW_MAP;this._last_processed_extra_light_shader_code&&(c.USE_EXTRA_LIGHT_SHADER_CODE=this._last_processed_extra_light_shader_code);return c};
Light.prototype.getUniforms=function(a,b){var c=this._uniforms,d=this.cast_shadows&&a.flags&RI_RECEIVE_SHADOWS&&this._shadowmap&&null!=this._light_matrix&&!b.shadows_disabled;this._light_matrix&&(c.u_lightMatrix=mat4.multiply(c.u_lightMatrix||mat4.create(),this._light_matrix,a.matrix));if(this.projective_texture){var e=this.projective_texture.constructor===String?ResourcesManager.textures[this.projective_texture]:this.projective_texture;e&&(e.texture_type==gl.TEXTURE_CUBE_MAP?c.light_cubemap=e.bind(11):
c.light_texture=e.bind(11))}else delete c.light_texture,delete c.light_texture;d?(d=this.computeShadowmapFar(),c.u_shadow_params=[1/this._shadowmap.width,this.shadow_bias,this.near,d],c.shadowmap=this._shadowmap.bind(10)):(delete c.u_shadow_params,delete c.shadowmap);return c};Light.prototype.computeShadowmapFar=function(){var a=this.far;this.type==Light.OMNI?this.range_attenuation&&this.att_end*Math.SQRT2<a&&(a=this.att_end*Math.SQRT2):this.range_attenuation&&this.att_end<a&&(a=this.att_end);return a};
Light.prototype.computeLightIntensity=function(){var a=Math.max(this.color[0],this.color[1],this.color[2]);return Math.max(0,a*this.intensity)};Light.prototype.computeLightRadius=function(){return this.range_attenuation?this.type==Light.OMNI?this.att_end*Math.SQRT2:this.att_end:-1};
Light.prototype.generateShadowmap=function(a){if(this.cast_shadows&&!(1E-4>this.computeLightIntensity())){var b=a.current_renderer,c=this.shadowmap_resolution;c||(c=Light.DEFAULT_SHADOWMAP_RESOLUTION);var d=this.type==Light.OMNI?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;if(null==this._shadowmap||this._shadowmap.width!=c||this._shadowmap.texture_type!=d)this._shadowmap=new GL.Texture(c,c,{texture_type:d,format:gl.RGBA,magFilter:gl.NEAREST,minFilter:gl.NEAREST}),LS.ResourcesManager.textures[":shadowmap_"+this.uid]=
this._shadowmap;this.type==Light.OMNI?(d=this.computeShadowmapFar(),a.current_pass="shadow",a.is_shadowmap=!0,this._shadowmap.unbind(),b.renderToCubemap(this.getPosition(),c,this._shadowmap,a,this.near,d),a.is_shadowmap=!1):(c=this.getLightCamera(),b.enableCamera(c,a,!0),this._shadowmap.unbind(),b._current_target=this._shadowmap,this._shadowmap.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.current_pass="shadow";a.is_shadowmap=!0;b.renderInstances(a);
a.is_shadowmap=!1}),b._current_target=null)}};Light.prototype.getTransformMatrix=function(a,b){if(this._root&&this._root.transform)return null;var c=null,c="target"==a?this.target:this.position,d=b||mat4.create();mat4.setTranslation(d,c);return d};Light.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="target"==c?this.target:this.position;mat4.multiplyVec3(b,a,b);return!0};LS.registerComponent(Light);LS.Light=Light;
function LightFX(a){this.test_visibility=this.enabled=!0;this.volume_visibility=0;this.glare_visibility=this.volume_density=this.volume_radius=1;this.glare_size=vec2.fromValues(0.2,0.2);this.glare_texture=null;this._macros={};this._uniforms={};a&&this.configure(a)}LightFX["@glare_texture"]={type:"texture"};LightFX["@glare_size"]={type:"vec2",step:0.001};LightFX["@glare_visibility"]={type:"number",step:0.001};LightFX.icon="mini-icon-lightfx.png";
LightFX.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};LightFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};LightFX.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this._root.light;if(!c||c.enabled)this.volume_visibility&&c&&b.push(this.getVolumetricRenderInstance(c)),this.glare_visibility&&(c=this.getGlareRenderInstance(c))&&b.push(c)}};
LightFX.prototype.getVolumetricRenderInstance=function(){this._volumetric_mesh||(this._volumetric_mesh=GL.Mesh.sphere());var a=this._volumetric_render_instance;a||(this._volumetric_render_instance=a=new RenderInstance(this._root,this));a.flags=RenderInstance.ALPHA;var b=this._volumetric_material;b||(b=this._volumetric_material=new Material({shader_name:"volumetric_light",blending:Material.ADDITIVE_BLENDING}));vec3.copy(b.color,light.color);b.opacity=this.volume_visibility;a.material=b;a.matrix.set(this._root.transform._global_matrix);
mat4.multiplyVec3(a.center,a.matrix,light.position);mat4.scale(a.matrix,a.matrix,[this.volume_radius,this.volume_radius,this.volume_radius]);b=vec4.create();b.set(a.center);b[3]=0.5*this.volume_radius;a.uniforms.u_volume_info=b;a.uniforms.u_volume_density=this.volume_density;a.setMesh(this._mesh,gl.TRIANGLES);a.flags=RI_CULL_FACE|RI_BLEND|RI_DEPTH_TEST;return a};
LightFX.prototype.getGlareRenderInstance=function(a){if(!this.glare_texture)return null;var b=this._glare_render_instance;b||(this._glare_render_instance=b=new RenderInstance(this._root,this),b.setMesh(GL.Mesh.plane({size:1}),gl.TRIANGLES),b.priority=1,b.onPreRender=LightFX.onGlarePreRender);b.flags=RI_2D_FLAGS;a?vec3.copy(b.center,a.getPosition()):vec3.copy(b.center,this._root.transform.getGlobalPosition());b.pos2D=vec3.create();b.scale_2D=this.glare_size;b.test_visibility=this.test_visibility;var c=
this._glare_material;c||(c=this._glare_material=new Material({blending:Material.ADDITIVE_BLENDING}));a&&(vec3.scale(c.color,a.color,this.glare_visibility*a.intensity),c.setTexture("color",this.glare_texture));b.setMaterial(c);b.flags|=RI_BLEND;return b};
LightFX.onGlarePreRender=function(a){if("color"==a.current_pass){mat4.projectVec3(this.pos2D,LS.Renderer._viewprojection_matrix,this.center);this.pos2D[0]=2*this.pos2D[0]-1;this.pos2D[1]=2*this.pos2D[1]-1;this.pos2D[2]=0;a=this.center;var b=Renderer._current_camera.getEye(),c=Renderer._current_scene,b=vec3.sub(vec3.create(),b,a),d=vec3.length(b);vec3.scale(b,b,1/d);var e=0;this.test_visibility&&(e=LS.Picking.raycast(c,a,b,d));e.length?(this.material.opacity-=0.05,0>this.material.opacity&&(this.material.opacity=
0)):(this.material.opacity+=0.05,1<this.material.opacity&&(this.material.opacity=1))}};LightFX.prototype.getResources=function(a){this.glare_texture&&(a[this.glare_texture]=Texture);return a};LightFX.prototype.onResourceRenamed=function(a,b,c){this.glare_texture==a&&(this.glare_texture=b)};LS.registerComponent(LightFX);LS.LightFX=LightFX;
function MeshRenderer(a){this.enabled=!0;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.material=null;this._primitive=-1;this.two_sided=!1;a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}Object.defineProperty(MeshRenderer.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});MeshRenderer.icon="mini-icon-teapot.png";
MeshRenderer["@mesh"]={type:"mesh"};MeshRenderer["@lod_mesh"]={type:"mesh"};MeshRenderer["@primitive"]={type:"enum",values:{Default:-1,Points:0,Lines:1,Triangles:4,Wireframe:10}};MeshRenderer["@submesh_id"]={type:"enum",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};
MeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};MeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
MeshRenderer.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=a.enabled);this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material));a.morph_targets&&(this.morph_targets=a.morph_targets)};
MeshRenderer.prototype.serialize=function(){var a={enabled:this.enabled,mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());-1!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};MeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?LS.ResourcesManager.meshes[this.mesh]:this.mesh};
MeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?LS.ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};MeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};MeshRenderer.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b)};
MeshRenderer.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getMesh();if(!c)return null;if(this._root){var d=this._RI;d||(this._RI=d=new LS.RenderInstance(this._root,this));d.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.flags=RI_DEFAULT_FLAGS|RI_RAYCAST_ENABLED;d.applyNodeFlags();this.two_sided&&(d.flags&=~RI_CULL_FACE);d.setMaterial(this.material||this._root.getMaterial());d.setMesh(c,this.primitive);if(-1!=this.submesh_id&&
null!=this.submesh_id&&c.info&&c.info.groups){var e=c.info.groups[this.submesh_id];e&&d.setRange(e.start,e.length)}else d.setRange(0,-1);this.lod_mesh?(d.collision_mesh="string"===typeof this.lod_mesh?LS.ResourcesManager.resources[this.lod_mesh]:this.lod_mesh,d.setLODMesh(d.collision_mesh)):d.collision_mesh=c;b.push(d)}}};LS.registerComponent(MeshRenderer);LS.MeshRenderer=MeshRenderer;
function SkinnedMeshRenderer(a){this.apply_skinning=this.enabled=!0;this.cpu_skinning=!1;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.material=null;this._primitive=-1;this.two_sided=!1;this.ignore_transform=!0;SkinnedMeshRenderer.num_supported_uniforms||(SkinnedMeshRenderer.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),SkinnedMeshRenderer.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),SkinnedMeshRenderer.num_supported_uniforms<3*SkinnedMeshRenderer.MAX_BONES&&
0==SkinnedMeshRenderer.num_supported_textures&&(SkinnedMeshRenderer.gpu_skinning_supported=!1));a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}Object.defineProperty(SkinnedMeshRenderer.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});SkinnedMeshRenderer.MAX_BONES=64;SkinnedMeshRenderer.gpu_skinning_supported=!0;
SkinnedMeshRenderer.icon="mini-icon-stickman.png";SkinnedMeshRenderer["@mesh"]={widget:"mesh"};SkinnedMeshRenderer["@lod_mesh"]={widget:"mesh"};SkinnedMeshRenderer["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};
SkinnedMeshRenderer["@submesh_id"]={widget:"combo",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};SkinnedMeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
SkinnedMeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
SkinnedMeshRenderer.prototype.configure=function(a){null!=a.enabled&&(this.enabled=!!a.enabled);this.cpu_skinning=!!a.cpu_skinning;this.ignore_transform=!!a.ignore_transform;this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material))};
SkinnedMeshRenderer.prototype.serialize=function(){var a={enabled:this.enabled,apply_skinning:this.apply_skinning,cpu_skinning:this.cpu_skinning,ignore_transform:this.ignore_transform,mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());null!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};
SkinnedMeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};SkinnedMeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};SkinnedMeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};
SkinnedMeshRenderer.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b)};SkinnedMeshRenderer.prototype.getNodeMatrix=function(a){var b=this._root.scene;if(!b)return null;a=b.getNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};
SkinnedMeshRenderer.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();for(c=0;c<a.bones.length;++c){var d=b[c],e=a.bones[c],f=this.getNodeMatrix(e[0]);f?(mat4.multiply(d,f,e[1]),a.bind_matrix&&mat4.multiply(d,d,a.bind_matrix)):mat4.identity(d)}return b};
SkinnedMeshRenderer.prototype.onCollectInstances=function(a,b,c){if(this.enabled){c=this.getMesh();if(!c)return null;if(this._root&&(a=this._render_instance,a||(this._render_instance=a=new RenderInstance(this._root,this)),c.getBuffer("vertices")&&c.getBuffer("bone_indices"))){if(this.apply_skinning)if(SkinnedMeshRenderer.gpu_skinning_supported&&!this.cpu_skinning){a.setMesh(c,this.primitive);a.macros.USE_SKINNING="";var d=this.getBoneMatrices(c),e=12*d.length,f=this._u_bones;f&&f.length==e||(this._u_bones=
f=new Float32Array(e));for(var g=0;g<d.length;g++)mat4.transpose(d[g],d[g]),f.set(d[g].subarray(0,12),12*g,12*(g+1));SkinnedMeshRenderer.num_supported_uniforms>=e?(a.uniforms.u_bones=f,d.length>SkinnedMeshRenderer.MAX_BONES&&(a.macros.MAX_BONES=d.length.toString()),delete a.samplers.u_bones):0<SkinnedMeshRenderer.num_supported_textures?(g=this._bones_texture,g||(g=this._bones_texture=new GL.Texture(1,3*d.length,{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),g._data=new Float32Array(g.width*g.height*
4)),g._data.set(f),g.uploadData(g._data,{no_flip:!0}),LS.RM.textures[":bones"]=g,a.macros.USE_SKINNING_TEXTURE="",a.samplers.u_bones=g,delete a.uniforms.u_bones):console.error("impossible to get here")}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=c){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=c;d=c.getBuffer("vertices");f=c.getBuffer("normals");for(g in c.vertexBuffers)this._skinned_mesh.vertexBuffers[g]=c.vertexBuffers[g];for(g in c.indexBuffers)this._skinned_mesh.indexBuffers[g]=
c.indexBuffers[g];this._skinned_mesh.createVertexBuffer("vertices","a_vertex",3,new Float32Array(d.data),gl.STREAM_DRAW);f&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(f.data),gl.STREAM_DRAW)}this.applySkin(c,this._skinned_mesh);a.setMesh(this._skinned_mesh,this.primitive);delete a.macros.USE_SKINNING;delete a.macros.USE_SKINNING_TEXTURE;delete a.samplers.u_bones}else a.setMesh(c,this.primitive),delete a.macros.USE_SKINNING,delete a.macros.USE_SKINNING_TEXTURE,delete a.samplers.u_bones;
this.ignore_transform?mat4.identity(a.matrix):this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,vec3.create());-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups?(g=c.info.groups[this.submesh_id])&&a.setRange(g.start,g.length):a.setRange(0,-1);a.material=this.material||this._root.getMaterial();a.flags=RI_DEFAULT_FLAGS;a.applyNodeFlags();this.two_sided&&(a.flags&=~RI_CULL_FACE);this.apply_skinning&&(a.flags|=RI_IGNORE_FRUSTUM);b.push(a)}}};
SkinnedMeshRenderer.zero_matrix=new Float32Array(16);
SkinnedMeshRenderer.prototype.applySkin=function(a,b){var c=a.getBuffer("vertices").data,d=null;a.getBuffer("normals")&&(d=a.getBuffer("normals").data);var e=a.getBuffer("weights").data,f=a.getBuffer("bone_indices").data,g=b.getBuffer("vertices"),h=g.data,l=null,k=null;d&&(l=b.getBuffer("normals"),k=l.data);var m=this.getBoneMatrices(a);if(0==m.length)return null;vec3.create();vec3.create();for(var n=mat4.create(),p=0,q=h.length/3;p<q;++p){c.subarray(3*p,3*p+3);var r=f.subarray(4*p,4*p+4),s=e.subarray(4*
p,4*p+4),u=h.subarray(3*p,3*p+3),r=[m[r[0]],m[r[1]],m[r[2]],m[r[3]]];n.set(SkinnedMeshRenderer.zero_matrix);mat4.scaleAndAdd(n,n,r[0],s[0]);0<s[1]&&mat4.scaleAndAdd(n,n,r[1],s[1]);0<s[2]&&mat4.scaleAndAdd(n,n,r[2],s[2]);0<s[3]&&mat4.scaleAndAdd(n,n,r[3],s[3]);mat4.multiplyVec3(u,n,c.subarray(3*p,3*p+3));k&&(s=k.subarray(3*p,3*p+3),mat4.rotateVec3(s,n,d.subarray(3*p,3*p+3)))}g.upload(gl.STREAM_DRAW);l&&l.upload(gl.STREAM_DRAW)};SkinnedMeshRenderer.prototype.extractSkeleton=function(){};LS.registerComponent(SkinnedMeshRenderer);
LS.SkinnedMeshRenderer=SkinnedMeshRenderer;function SpriteRenderer(a){this.texture="";this.size=vec2.create();a&&this.configure(a)}SpriteRenderer.icon="mini-icon-teapot.png";SpriteRenderer["@texture"]={type:"texture"};SpriteRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};SpriteRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
SpriteRenderer.prototype.onCollectInstances=function(a,b){if(this._root){var c=this._mesh;this._mesh||(c=this._mesh=GL.Mesh.plane());var d=this._render_instance;d||(this._render_instance=d=new RenderInstance(this._root,this));this._root.transform&&d.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.setMesh(c,gl.TRIANGLES);d.material=this._root.getMaterial();d.flags=RI_DEFAULT_FLAGS;d.applyNodeFlags();b.push(d)}};
function Skybox(a){this.enabled=!0;this.texture=null;this.intensity=1;this.use_environment=!0;a&&this.configure(a)}Skybox.icon="mini-icon-dome.png";Skybox["@texture"]={widget:"texture"};Skybox.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Skybox.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
Skybox.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};Skybox.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};
Skybox.prototype.onCollectInstances=function(a,b){if(this._root&&this.enabled){var c=null;if(c=this.use_environment?LS.Renderer._current_scene.info.textures.environment:this.texture)if(c.constructor===String&&(c=LS.ResourcesManager.textures[c]),c){var d=this._mesh;d||(d=this._mesh=GL.Mesh.cube({size:10}));var e=this._render_instance;e||(this._render_instance=e=new LS.RenderInstance(this._root,this),e.priority=100,e.onPreRender=function(a){a=a.current_camera.getEye();mat4.identity(this.matrix);mat4.setTranslation(this.matrix,
a);if(this.node.transform){var b=this.node.transform.getGlobalRotationMatrix();mat4.multiply(this.matrix,this.matrix,b)}vec3.copy(this.center,a)});var f=this._material;f||(f=this._material=new LS.Material({use_scene_ambient:!1}));vec3.copy(f.color,[this.intensity,this.intensity,this.intensity]);var g=f.setTexture(LS.Material.COLOR,c);c&&c.texture_type==gl.TEXTURE_2D?(g.uvs="polar_vertex",c.bind(0),c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR)):
g.uvs="0";e.setMesh(d);e.flags=RI_DEFAULT_FLAGS;e.applyNodeFlags();e.enableFlag(RI_CW|RI_IGNORE_LIGHTS|RI_IGNORE_FRUSTUM|RI_IGNORE_CLIPPING_PLANE);e.disableFlag(RI_CAST_SHADOWS|RI_DEPTH_WRITE|RI_DEPTH_TEST);e.setMaterial(f);b.push(e)}}};LS.registerComponent(Skybox);LS.Skybox=Skybox;function BackgroundRenderer(a){this.enabled=!0;this.texture=null;this.createProperty("color",vec3.fromValues(1,1,1),"color");this.opacity=1;this.blend_mode=Blend.NORMAL;this.material_name=null;a&&this.configure(a)}
BackgroundRenderer.icon="mini-icon-bg.png";BackgroundRenderer["@texture"]={type:"texture"};BackgroundRenderer["@material_name"]={type:"material"};BackgroundRenderer["@blend_mode"]={type:"enum",values:LS.Blend};BackgroundRenderer["@opacity"]={type:"number",step:0.01};BackgroundRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
BackgroundRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};BackgroundRenderer.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};BackgroundRenderer.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};
BackgroundRenderer.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=null;this.material_name&&(c=LS.ResourcesManager.materials[this.material_name]);if(!c){var d=this.texture;if(!d)return;d.constructor===String&&(d=LS.ResourcesManager.textures[d]);c=this._material?this._material:this._material=new LS.Material({use_scene_ambient:!1});c.setTexture("color",d);c.color.set(this.color);c.opacity=this.opacity;c.blend_mode=this.blend_mode}d=this._mesh;d||(d=this._mesh=GL.Mesh.plane({size:2}));
var e=this._render_instance;e||(this._render_instance=e=new LS.RenderInstance(this._root,this),e.priority=100);e.setMesh(d);e.setMaterial(c);e.flags=RI_DEFAULT_FLAGS;e.applyNodeFlags();e.disableFlag(RI_CAST_SHADOWS);e.enableFlag(RI_IGNORE_LIGHTS);e.enableFlag(RI_CW);e.disableFlag(RI_DEPTH_WRITE);e.disableFlag(RI_DEPTH_TEST);e.disableFlag(RI_CULL_FACE);e.enableFlag(RI_IGNORE_FRUSTUM);e.enableFlag(RI_IGNORE_VIEWPROJECTION);b.push(e)}};LS.registerComponent(BackgroundRenderer);
function Collider(a){this.enabled=!0;this.shape=1;this.mesh=null;this.size=vec3.fromValues(0.5,0.5,0.5);this.center=vec3.create();this.use_mesh_bounding=!1;a&&this.configure(a)}Collider.icon="mini-icon-collider.png";Collider["@size"]={type:"vec3",step:0.01};Collider["@center"]={type:"vec3",step:0.01};Collider["@mesh"]={type:"mesh"};Collider["@shape"]={widget:"combo",values:{Box:1,Sphere:2,Mesh:5}};
Collider.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectPhysicInstances",this.onGetColliders,this)};Collider.prototype.onRemovedFromScene=function(a){LEvent.unbind(scene,"collectPhysicInstances",this.onGetColliders,this)};Collider.prototype.getMesh=function(){return"string"===typeof this.mesh?LS.ResourcesManager.meshes[this.mesh]:this.mesh};Collider.prototype.getResources=function(a){if(this.mesh)return"string"==typeof this.mesh&&(a[this.mesh]=Mesh),a};
Collider.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b)};
Collider.prototype.onGetColliders=function(a,b){if(this.enabled){var c=this._PI;c||(this._PI=c=new LS.PhysicsInstance(this._root,this));c.matrix.set(this._root.transform._global_matrix);c.type=this.shape;var d=null;if(c.type===LS.PhysicsInstance.MESH||this.use_mesh_bounding)d=this.getMesh();c.type===LS.PhysicsInstance.SPHERE?d?BBox.copy(c.oobb,d.bounding):BBox.setCenterHalfsize(c.oobb,this.center,[this.size[0],this.size[0],this.size[0]]):c.type===LS.PhysicsInstance.BOX&&(d?BBox.copy(c.oobb,d.bounding):
BBox.setCenterHalfsize(c.oobb,this.center,this.size));d?vec3.copy(c.center,BBox.getCenter(d.bounding)):vec3.copy(c.center,this.center);if(c.type===LS.PhysicsInstance.MESH){if(!d)return;c.setMesh(d)}b.push(c)}};LS.registerComponent(Collider);function AnnotationComponent(a){this.text="";this.notes=[];this._screen_pos=vec3.create();this._selected=null;this.configure(a)}AnnotationComponent.editor_color=[0.33,0.874,0.56,0.9];
AnnotationComponent.onShowMainAnnotation=function(a){"undefined"!=typeof AnnotationModule&&AnnotationModule.editAnnotation(a)};
AnnotationComponent.onShowPointAnnotation=function(a,b){function c(a){this.text=a}var d=a.getComponent(AnnotationComponent);d&&"undefined"!=typeof AnnotationModule&&AnnotationModule.showDialog(b.text,{item:b,on_close:c.bind(b),on_delete:function(a){d.removeAnnotation(a.item);LS.GlobalScene.refresh()},on_focus:function(a){AnnotationModule.focusInAnnotation(a.item);d._selected=a.item}})};AnnotationComponent.prototype.addAnnotation=function(a){this._selected=null;this.notes.push(a)};
AnnotationComponent.prototype.getAnnotation=function(a){return this.nodes[a]};AnnotationComponent.prototype.removeAnnotation=function(a){this._selected=null;a=this.notes.indexOf(a);-1!=a&&this.notes.splice(a,1)};AnnotationComponent.prototype.setStartTransform=function(){this.start_position=this.getObjectCenter()};
AnnotationComponent.prototype.getObjectCenter=function(){var a=vec3.create(),b=this._root.getMesh();b&&b.bounding&&vec3.copy(a,BBox.getCenter(b.bounding));return this._root.transform.transformPointGlobal(a,vec3.create())};AnnotationComponent.prototype.serialize=function(){var a={text:this.text,notes:[],start_position:this.start_position},b;for(b in this.notes){var c=this.notes[b],d;for(d in c)c[d].constructor==Float32Array&&Array.prototype.slice.call(c[d]);a.notes.push(c)}return a};
AnnotationComponent.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousedown",this.onMouse.bind(this),this)};AnnotationComponent.prototype.onRemovedFromNode=function(a){};
AnnotationComponent.prototype.onMouse=function(a,b){if("mousedown"==b.eventType){this._screen_pos[2]=0;var c=vec3.dist(this._screen_pos,[b.canvasx,gl.canvas.height-b.canvasy,0]);if(30>c)AnnotationComponent.onShowMainAnnotation(this._root);for(var d in this.notes){var e=this.notes[d],c=vec2.dist(e._end_screen,[b.mousex,gl.canvas.height-b.mousey]);if(30>c)return this._selected=e,AnnotationComponent.onShowPointAnnotation(this._root,e),!0}}};LS.registerComponent(AnnotationComponent);
function Rotator(a){this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45;a&&this.configure(a)}Rotator.icon="mini-icon-rotator.png";Rotator.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Rotator.prototype.onRemoveFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};
Rotator.prototype.onUpdate=function(a,b){if(this._root){var c=this._root.scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var d=quat.setAxisAngle(quat.create(),this.axis,Math.sin(this.speed*c._global_time*2*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,d,this._default);this._root.transform._dirty=!0}else this.local_space?this._root.transform.rotate(this.speed*b,this.axis):this._root.transform.rotateGlobal(this.speed*
b,this.axis);c&&c.refresh()}};LS.registerComponent(Rotator);function CameraController(a){this.speed=10;this.wheel_speed=this.rot_speed=1;this.smooth=!1;this.allow_panning=!0;this.cam_type="orbit";this._moving=vec3.fromValues(0,0,0);this.orbit_center=null;this._collision=vec3.create();this.configure(a)}CameraController.icon="mini-icon-cameracontroller.png";
CameraController.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousedown",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"mousewheel",this.onMouse,this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};
CameraController.prototype.onUpdate=function(a){if(this._root){if(!this._root.transform&&this._root.camera&&(a=this._root.camera,"fps"==this.cam_type&&(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]))){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.speed*(this._move_fast?10:1));a.move(b);a.updateMatrices()}this.smooth&&this._root.scene.refresh()}};
CameraController.prototype.onMouse=function(a,b){if(this._root){var c=this._root.camera;if(c)if(b||(b=a),"mousewheel"==b.eventType)c.orbitDistanceFactor(1+-0.05*(0<b.wheel?1:-1)*this.wheel_speed,this.orbit_center),c.updateMatrices();else if("mousedown"==b.eventType&&this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,c.getCenter(),this._collision),b.dragging&&!this._root.transform)if("fps"==this.cam_type){c.rotate(-b.deltax*this.rot_speed,[0,1,0]);c.updateMatrices();var d=c.getLocalVector([1,
0,0]);c.rotate(-b.deltay*this.rot_speed,d);c.updateMatrices()}else"orbit"==this.cam_type&&(this.allow_panning&&(b.ctrlKey||1==b.button)?(d=vec3.create(),this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,c.getCenter(),d),d=vec3.sub(vec3.create(),this._collision,d),c.move(d),c.updateMatrices()):(c.orbit(-b.deltax*this.rot_speed,[0,1,0],this.orbit_center),c.updateMatrices(),d=c.getLocalVector([1,0,0]),c.orbit(-b.deltay*this.rot_speed,d,this.orbit_center)))}};
CameraController.prototype.testPerpendicularPlane=function(a,b,c,d){var e=this._root.camera;a=e.getRayInPixel(a,gl.canvas.height-b);b=e.getFront();c=c||e.getCenter();d=d||vec3.create();return geo.testRayPlane(a.start,a.direction,c,b,d)?!0:!1};
CameraController.prototype.onKey=function(a,b){this._root&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode?this._moving[0]="keydown"==b.type?1:0:16==b.keyCode&&(this._move_fast="keydown"==b.type?!0:!1))};LS.registerComponent(CameraController);function NodeManipulator(a){this.rot_speed=[1,1];this.smooth=!1;a&&this.configure(a)}NodeManipulator.icon="mini-icon-rotator.png";
NodeManipulator.prototype.onAddedToNode=function(a){a.flags.interactive=!0;LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"update",this.onUpdate,this)};NodeManipulator.prototype.onUpdate=function(a){};
NodeManipulator.prototype.onMouse=function(a,b){if(this._root&&this._root.transform&&b.dragging){var c=this._root.scene,d=c.getCamera().getLocalVector(LS.Components.Transform.RIGHT);this._root.transform.rotateGlobal(b.deltax*this.rot_speed[0],LS.Components.Transform.UP);this._root.transform.rotateGlobal(b.deltay*this.rot_speed[1],d);c.refresh()}};LS.registerComponent(NodeManipulator);
function Target(a){this.enabled=!0;this.node_id=null;this.cylindrical=this.face_camera=!1;this.front=Target.NEGZ;this.up=Target.POSY;this._target_position=vec3.create();a&&this.configure(a)}Target.icon="mini-icon-billboard.png";Target.POSX=1;Target.NEGX=2;Target.POSY=3;Target.NEGY=4;Target.POSZ=5;Target.NEGZ=6;Target["@node_id"]={type:"node"};Target["@front"]={type:"enum",values:{"-Z":Target.NEGZ,"+Z":Target.POSZ,"-Y":Target.NEGY,"+Y":Target.POSY,"-X":Target.NEGX,"+X":Target.POSX}};
Target["@up"]={type:"enum",values:{"-Z":Target.NEGZ,"+Z":Target.POSZ,"-Y":Target.NEGY,"+Y":Target.POSY,"-X":Target.NEGX,"+X":Target.POSX}};Target.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updateOrientation,this)};
Target.prototype.updateOrientation=function(a){if(this.enabled&&this._root&&this._root.transform){var b=this._root.scene;a=this._root.transform;var c=null,d=null,e=a.getGlobalPosition();switch(this.up){case Target.NEGX:d=vec3.fromValues(-1,0,0);break;case Target.POSX:d=vec3.fromValues(1,0,0);break;case Target.NEGZ:d=vec3.fromValues(0,0,-1);break;case Target.POSZ:d=vec3.fromValues(0,0,1);break;case Target.NEGY:d=vec3.fromValues(0,-1,0);break;default:d=vec3.fromValues(0,1,0)}if(this.node_id){c=b.getNode(this.node_id);
if(!c||c==this._root)return;c=c.transform.getGlobalPosition(this._target_position)}else if(this.face_camera)(b=LS.Renderer._main_camera||LS.Renderer._current_camera)&&(c=b.getEye());else return;this.cylindrical&&(c[1]=e[1]);a.lookAt(e,c,d,!0);switch(this.front){case Target.POSY:quat.rotateX(a._rotation,a._rotation,-0.5*Math.PI);break;case Target.NEGY:quat.rotateX(a._rotation,a._rotation,0.5*Math.PI);break;case Target.POSX:quat.rotateY(a._rotation,a._rotation,0.5*Math.PI);break;case Target.NEGX:quat.rotateY(a._rotation,
a._rotation,-0.5*Math.PI);break;case Target.POSZ:quat.rotateY(a._rotation,a._rotation,Math.PI)}}};LS.registerComponent(Target);function FogFX(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=FogFX.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);a&&this.configure(a)}FogFX.icon="mini-icon-fog.png";FogFX.LINEAR=1;FogFX.EXP=2;FogFX.EXP2=3;FogFX["@color"]={type:"color"};FogFX["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};
FogFX["@type"]={type:"enum",values:{linear:FogFX.LINEAR,exponential:FogFX.EXP,"exponential 2":FogFX.EXP2}};FogFX.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"fillSceneMacros",this.fillSceneMacros,this);LEvent.bind(Scene,"fillSceneUniforms",this.fillSceneUniforms,this)};FogFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"fillSceneMacros",this.fillSceneMacros,this);LEvent.unbind(Scene,"fillSceneUniforms",this.fillSceneUniforms,this)};
FogFX.prototype.fillSceneMacros=function(a,b){if(this.enabled)switch(b.USE_FOG="",this.type){case FogFX.EXP:b.USE_FOG_EXP="";break;case FogFX.EXP2:b.USE_FOG_EXP2=""}};FogFX.prototype.fillSceneUniforms=function(a,b){this.enabled&&(b.u_fog_info=[this.start,this.end,this.density],b.u_fog_color=this.color)};LS.registerComponent(FogFX);function FollowNode(a){this.node_name="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}FollowNode.icon="mini-icon-follow.png";
FollowNode.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updatePosition,this)};FollowNode.prototype.updatePosition=function(a,b){if(this._root){var c=null,c=this._root.scene,d=c.getCamera();if(this.follow_camera)c=d.getEye();else{c=c.getNode(this.node_name);if(!c)return;c=c.transform.getPosition()}this.fixed_y&&(c[1]=this._root.transform._position[1]);this._root.transform.setPosition(c)}};LS.registerComponent(FollowNode);
function GeometricPrimitive(a){this.enabled=!0;this.subdivisions=this.size=10;this.geometry=GeometricPrimitive.CUBE;this._primitive=-1;this.align_z=!1;a&&this.configure(a)}Object.defineProperty(GeometricPrimitive.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});GeometricPrimitive.CUBE=1;GeometricPrimitive.PLANE=2;GeometricPrimitive.CYLINDER=3;GeometricPrimitive.SPHERE=4;
GeometricPrimitive.CIRCLE=5;GeometricPrimitive.HEMISPHERE=6;GeometricPrimitive.ICOSAHEDRON=7;GeometricPrimitive.icon="mini-icon-cube.png";GeometricPrimitive["@geometry"]={type:"enum",values:{Cube:GeometricPrimitive.CUBE,Plane:GeometricPrimitive.PLANE,Cylinder:GeometricPrimitive.CYLINDER,Sphere:GeometricPrimitive.SPHERE,Icosahedron:GeometricPrimitive.ICOSAHEDRON,Circle:GeometricPrimitive.CIRCLE,Hemisphere:GeometricPrimitive.HEMISPHERE}};
GeometricPrimitive["@primitive"]={widget:"enum",values:{Default:-1,Points:0,Lines:1,Triangles:4,Wireframe:10}};GeometricPrimitive["@subdivisions"]={type:"number",step:1,min:0};GeometricPrimitive.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};GeometricPrimitive.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
GeometricPrimitive.prototype.updateMesh=function(){var a=Math.max(0,this.subdivisions|0),b=""+this.geometry+"|"+this.size+"|"+a+"|"+this.align_z;switch(this.geometry){case GeometricPrimitive.CUBE:this._mesh=GL.Mesh.cube({size:this.size,normals:!0,coords:!0});break;case GeometricPrimitive.PLANE:this._mesh=GL.Mesh.plane({size:this.size,detail:a,xz:this.align_z,normals:!0,coords:!0});break;case GeometricPrimitive.CYLINDER:this._mesh=GL.Mesh.cylinder({size:this.size,subdivisions:a,normals:!0,coords:!0});
break;case GeometricPrimitive.SPHERE:this._mesh=GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0});break;case GeometricPrimitive.CIRCLE:this._mesh=GL.Mesh.circle({size:this.size,slices:a,xz:this.align_z,normals:!0,coords:!0});break;case GeometricPrimitive.HEMISPHERE:this._mesh=GL.Mesh.sphere({size:this.size,slices:a,xz:this.align_z,normals:!0,coords:!0,hemi:!0});break;case GeometricPrimitive.ICOSAHEDRON:this._mesh=GL.Mesh.icosahedron({size:this.size,subdivisions:a})}this._key=b};
GeometricPrimitive.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root){var c=Math.max(0,this.subdivisions|0),c=""+this.geometry+"|"+this.size+"|"+c+"|"+this.align_z;this._mesh&&this._key==c||this.updateMesh();c=this._render_instance;c||(this._render_instance=c=new LS.RenderInstance(this._root,this));this._root.transform.getGlobalMatrix(c.matrix);c.setMatrix(c.matrix);mat4.getTranslation(c.center,c.matrix);c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;c.flags=
RI_DEFAULT_FLAGS|RI_RAYCAST_ENABLED;c.applyNodeFlags();c.setMaterial(this.material||this._root.getMaterial());b.push(c)}};LS.registerComponent(GeometricPrimitive);function GlobalInfo(a){this.ambient_color=new Float32Array(GlobalInfo.DEFAULT_AMBIENT_COLOR);this.background_color=new Float32Array(GlobalInfo.DEFAULT_BACKGROUND_COLOR);this.textures={};a&&this.configure(a)}GlobalInfo.icon="mini-icon-bg.png";GlobalInfo.DEFAULT_BACKGROUND_COLOR=new Float32Array([0,0,0,1]);
GlobalInfo.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);GlobalInfo.prototype.onAddedToScene=function(a){a.info=this};GlobalInfo.prototype.onRemovedFromScene=function(a){};GlobalInfo.prototype.getResources=function(a){for(var b in this.textures)"string"==typeof this.textures[b]&&(a[this.textures[b]]=GL.Texture);return a};GlobalInfo.prototype.onResourceRenamed=function(a,b,c){for(var d in this.textures)this.textures[d]==a&&(this.texture[d]=b)};LS.registerComponent(GlobalInfo);LS.GlobalInfo=GlobalInfo;
"undefined"!=typeof LGraphTexture&&(LGraphTexture.getTexturesContainer=function(){return LS.ResourcesManager.textures},LGraphTexture.loadTexture=LS.ResourcesManager.load.bind(LS.ResourcesManager));
function GraphComponent(a){this.force_redraw=this.enabled=!0;this.on_event="update";if("undefined"==typeof LGraphTexture)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph=new LGraph;this._graph._scene=Scene;this._graph.getScene=function(){return this._scene};a?this.configure(a):(a=LiteGraph.createNode("scene/node"),this._graph.add(a));LEvent.bind(this,"trigger",this.trigger,this)}GraphComponent["@on_event"]={type:"enum",values:["start","render","update","trigger"]};
GraphComponent.icon="mini-icon-graph.png";GraphComponent.prototype.configure=function(a){this.enabled=!!a.enabled;if(a.graph_data)try{var b=JSON.parse(a.graph_data);this._graph.configure(b)}catch(c){console.error("Error configuring Graph data: "+c)}a.on_event&&(this.on_event=a.on_event);a.force_redraw&&(this.force_redraw=a.force_redraw)};GraphComponent.prototype.serialize=function(){return{enabled:this.enabled,force_redraw:this.force_redraw,graph_data:JSON.stringify(this._graph.serialize()),on_event:this.on_event}};
GraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;LEvent.bind(a,"start",this.onEvent,this);LEvent.bind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.bind(a,"update",this.onEvent,this)};GraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"start",this.onEvent,this);LEvent.unbind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.unbind(a,"update",this.onEvent,this)};
GraphComponent.prototype.onResourceRenamed=function(a,b,c){this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};GraphComponent.prototype.onEvent=function(a,b){"beforeRenderMainPass"==a&&(a="render");this.on_event==a&&this.runGraph()};GraphComponent.prototype.trigger=function(a){"trigger"==this.on_event&&this.runGraph()};
GraphComponent.prototype.runGraph=function(){this._root._in_tree&&this.enabled&&(this._graph&&this._graph.runStep(1),this.force_redraw&&LEvent.trigger(this._root._in_tree,"change"))};GraphComponent.prototype.getGraph=function(){return this._graph};GraphComponent.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};
GraphComponent.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var d=0;d<c.length;++d){var e=c[d];if(e.properties.name==a)return e.properties.value&&e.properties.value.set?e.properties.value.set(b):e.properties.value=b,!0}};LS.registerComponent(GraphComponent);
function FXGraphComponent(a){this.use_viewport_size=this.enabled=!0;this.use_extra_texture=this.use_antialiasing=this.use_high_precision=!1;if("undefined"==typeof LGraphTexture)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph=new LGraph;this._graph._scene=Scene;this._graph.getScene=function(){return this._scene};a?this.configure(a):(this._graph_color_texture_node=LiteGraph.createNode("texture/texture","Color Buffer"),this._graph_color_texture_node.ignore_remove=
!0,this._graph_depth_texture_node=LiteGraph.createNode("texture/texture","Depth Buffer"),this._graph_depth_texture_node.ignore_remove=!0,this._graph_depth_texture_node.pos[1]=400,this._graph_extra_texture_node=LiteGraph.createNode("texture/texture","Extra Buffer"),this._graph_extra_texture_node.pos[1]=800,this._graph_extra_texture_node.ignore_remove=!0,this._graph.add(this._graph_color_texture_node),this._graph.add(this._graph_extra_texture_node),this._graph.add(this._graph_depth_texture_node),this._graph_viewport_node=
LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=500,this._graph.add(this._graph_viewport_node),this._graph_color_texture_node.connect(0,this._graph_viewport_node));null==FXGraphComponent.high_precision_format&&(FXGraphComponent.high_precision_format=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.float_ext?gl.FLOAT:gl.UNSIGNED_BYTE)}FXGraphComponent.icon="mini-icon-graph.png";FXGraphComponent.buffer_size=[1024,512];
FXGraphComponent.prototype.configure=function(a){a.graph_data&&(this.enabled=!!a.enabled,this.use_viewport_size=!!a.use_viewport_size,this.use_high_precision=!!a.use_high_precision,this.use_antialiasing=!!a.use_antialiasing,this.use_extra_texture=!!a.use_extra_texture,this.apply_to_node_camera=!1,this._graph.configure(JSON.parse(a.graph_data)),this._graph_color_texture_node=this._graph.findNodesByTitle("Color Buffer")[0],this._graph_depth_texture_node=this._graph.findNodesByTitle("Depth Buffer")[0],
this._graph_extra_texture_node=this._graph.findNodesByTitle("Extra Buffer")[0],this._graph_viewport_node=this._graph.findNodesByType("texture/toviewport")[0])};FXGraphComponent.prototype.serialize=function(){return{enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_extra_texture:this.use_extra_texture,use_viewport_size:this.use_viewport_size,graph_data:JSON.stringify(this._graph.serialize())}};
FXGraphComponent.prototype.getResources=function(a){var b=this._graph.findNodesByType("texture/texture"),c;for(c in b)b[c].properties.name&&(a[b[c].properties.name]=Texture);return a};FXGraphComponent.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};
FXGraphComponent.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var d=0;d<c.length;++d){var e=c[d];if(e.properties.name==a)return e.properties.value&&e.properties.value.set?e.properties.value.set(b):e.properties.value=b,!0}};FXGraphComponent.prototype.onResourceRenamed=function(a,b,c){this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};
FXGraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;LEvent.bind(LS.GlobalScene,"beforeRenderMainPass",this.onBeforeRender,this)};FXGraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(LS.GlobalScene,"beforeRenderMainPass",this.onBeforeRender,this)};
FXGraphComponent.prototype.onBeforeRender=function(a,b){if(this._graph&&b.render_fx&&this.enabled){var c=this._renderFrameContainer;c||(c=this._renderFrameContainer=new LS.RenderFrameContainer,c.use_depth_texture=!0,c.component=this,c.postRender=FXGraphComponent.postRender);c.use_high_precision=this.use_high_precision;this.use_viewport_size?c.useCanvasSize():c.useDefaultSize();c.use_extra_texture=this.use_extra_texture;LS.Renderer.assignGlobalRenderFrameContainer(c)}};
FXGraphComponent.prototype.getGraph=function(){return this._graph};
FXGraphComponent.prototype.applyGraph=function(){this._graph&&(this._graph_color_texture_node||(this._graph_color_texture_node=this._graph.findNodesByTitle("Color Buffer")[0]),this._graph_extra_texture_node||(this._graph_extra_texture_node=this._graph.findNodesByTitle("Extra Buffer")[0]),this._graph_depth_texture_node||(this._graph_depth_texture_node=this._graph.findNodesByTitle("Depth Buffer")[0]),this._graph_viewport_node||(this._graph_viewport_node=this._graph.findNodesByType("texture/toviewport")[0]),
this._graph_color_texture_node&&(this._graph_color_texture_node.properties.name=":color_"+this.uid,this._graph_extra_texture_node&&(this._graph_extra_texture_node.properties.name=":extra_"+this.uid),this._graph_depth_texture_node&&(this._graph_depth_texture_node.properties.name=":depth_"+this.uid),this._graph_viewport_node&&(this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1)))};
FXGraphComponent.postRender=function(){this.endFBO();LS.ResourcesManager.textures[":color_"+this.component.uid]=this.color_texture;this.extra_texture&&(LS.ResourcesManager.textures[":extra_"+this.component.uid]=this.extra_texture);this.depth_texture&&(LS.ResourcesManager.textures[":depth_"+this.component.uid]=this.depth_texture);this.component.applyGraph()};LS.registerComponent(FXGraphComponent);
(function(){function a(a){this.value=0;this.delta=0.01;this.min_value=this.steps=0;this.max_value=1;this.min_angle=-120;this.max_angle=120;this.axis=vec3.fromValues(0,0,1);a&&this.configure(a)}a.icon="mini-icon-knob.png";a.prototype.configure=function(a){cloneObject(a,this)};a.prototype.serialize=function(){return cloneObject(this)};a.prototype.onAddedToNode=function(a){a.flags.interactive=!0;LEvent.bind(a,"mousemove",this.onmousemove,this);this.updateKnob()};a.prototype.updateKnob=function(){this._root&&
(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+this.value/(this.max_value-this.min_value)*(this.max_angle-this.min_angle))*DEG2RAD),this._root.transform._dirty=!0)};a.prototype.onmousemove=function(a,c){this.value-=c.deltay*this.delta;this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value);this.updateKnob();LEvent.trigger(this,"change",this.value);this._root&&LEvent.trigger(this._root,"knobChange",this.value);return!1};
LS.registerComponent(a)})();
function ParticleEmissor(a){this.max_particles=1024;this.warm_up_time=0;this.emissor_type=ParticleEmissor.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=[10,10,10];this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this.particle_start_color=[1,1,1];this.particle_end_color=[1,1,1];this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=
1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.stop_update=!1;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=
this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;this.createMesh()}ParticleEmissor.icon="mini-icon-particles.png";ParticleEmissor.BOX_EMISSOR=1;ParticleEmissor.SPHERE_EMISSOR=2;ParticleEmissor.MESH_EMISSOR=3;ParticleEmissor.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
ParticleEmissor.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this);LEvent.unbind(a,"start",this.onStart,this);LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ParticleEmissor.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};ParticleEmissor.prototype.onResourceRenamed=function(a,b,c){this.emissor_mesh==a&&(this.emissor_mesh=b);this.texture==a&&(this.texture=b)};
ParticleEmissor.prototype.createParticle=function(a){a=a||{};switch(this.emissor_type){case ParticleEmissor.BOX_EMISSOR:a.pos=vec3.fromValues(this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5));break;case ParticleEmissor.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a.pos=vec3.fromValues(Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c));vec3.multiply(a.pos,a.pos,this.emissor_size);break;
case ParticleEmissor.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor==String&&(b=ResourcesManager.getMesh(this.emissor_mesh));b&&b.vertices?(c=3*Math.floor(Math.random()*b.vertices.length/3),a.pos=vec3.fromValues(b.vertices[c],b.vertices[c+1],b.vertices[c+2])):a.pos=vec3.create();break;default:a.pos=vec3.create()}vec3.add(a.pos,a.pos,this.follow_emitter?[0,0,0]:this._emissor_pos);a.vel=vec3.fromValues(Math.random()-0.5,Math.random()-0.5,Math.random()-0.5);a.life=this.particle_life;a.id=this._last_id;
a.angle=0;a.rot=this.particle_rotation+0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a.vel,a.vel,this.particle_speed);return a};ParticleEmissor.prototype.onStart=function(a){if(!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};
ParticleEmissor.prototype.onUpdate=function(a,b,c){this._root.transform&&this._root.transform.getGlobalPosition(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),e=this.physics_friction;a=[];for(var f=vec3.create(),g=0;g<this._particles.length;++g){var h=this._particles[g];vec3.copy(f,h.vel);vec3.add(f,d,f);vec3.scale(f,f,b);e&&(f[0]-=f[0]*e,f[1]-=f[1]*e,f[2]-=f[2]*e);vec3.add(h.pos,f,h.pos);h.angle+=h.rot*b;h.life-=b;0<h.life&&
a.push(h)}if(0!=this.emissor_rate)for(b=(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),g=0;g<b;g++)h=this.createParticle(),a.length<this.max_particles&&a.push(h);this._particles=a}this.align_always||c||this.updateMesh(Renderer._current_camera);LEvent.trigger(Scene,"change")};
ParticleEmissor.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);for(var a=0;a<this.max_particles;a++)this._coords.set([1,1,0,1,1,0,0,1,0,0,1,0],12*a),this._colors.set([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],24*a);this._computed_grid_size=1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,
coords:this._coords,colors:this._colors},null,gl.STREAM_DRAW);this._mesh_maxparticles=this.max_particles}};
ParticleEmissor.prototype.updateMesh=function(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),e=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a=vec3.create();var g=vec3.fromValues(-1,0,-1),h=vec3.fromValues(1,0,-1),l=vec3.fromValues(-1,0,1),k=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(g,f,e),vec3.add(h,f,e),vec3.scale(l,h,-1),vec3.scale(k,g,-1));var e=vec3.create(),f=vec3.create(),m=
vec3.create(),n=vec3.create(),p=this._particles;if(this.sort_in_z){for(var p=this._particles.concat(),q=geo.createPlane(b,d),r=Math.sqrt(q[0]*q[0]+q[1]*q[1]+q[2]*q[2]),b=0;b<p.length;++b)p[b]._dist=Math.abs(vec3.dot(p[b].pos,q)+q[3])/r;p.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0});this._particles=p}0==this.particle_life&&(this.particle_life=1E-4);var q=new Float32Array([1,1,1,1]),r=new Float32Array(this.particle_start_color),s=new Float32Array(this.particle_end_color),u=!1;
(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size)&&!this.stop_update&&(u=!0,this._computed_grid_size=this.texture_grid_size);for(var A=1/this.texture_grid_size,t=0,w=0,C=this.texture_grid_size<<2,B=this.animated_texture,x=this.loop_animation,z=this._root.scene.getTime()*this.animation_fps,E=new Float32Array(60*this.particle_life<<0),H=new Float32Array(60*this.particle_life<<0),G=1/(60*this.particle_life),b=0;b<E.length;b+=1)E[b]=LS.getCurveValueAt(this.particle_opacity_curve,
0,1,0,b*G),H[b]=LS.getCurveValueAt(this.particle_size_curve,0,1,0,b*G);for(var G=quat.create(),D=t=b=0;D<p.length;++D)if(w=p[D],!(0>=w.life)){var t=1-w.life/this.particle_life,F=E[t*E.length<<0];this.independent_color&&w.c?vec3.clone(q,w.c):vec3.lerp(q,r,s,t);this.premultiplied_alpha?(vec3.scale(q,q,F),q[3]=1):q[3]=F;if(!(0.001>F)&&(F=this.particle_size*H[t*H.length<<0],!(Math.abs(F)<c)&&(vec3.scale(m,l,F),vec3.scale(f,h,F),vec3.scale(e,g,F),vec3.scale(n,k,F),0!=w.angle&&(quat.setAxisAngle(G,d,w.angle*
DEG2RAD),vec3.transformQuat(m,m,G),vec3.transformQuat(f,f,G),vec3.transformQuat(e,e,G),vec3.transformQuat(n,n,G)),vec3.add(a,w.pos,f),this._vertices.set(a,18*b),vec3.add(a,w.pos,e),this._vertices.set(a,18*b+3),vec3.add(a,w.pos,n),this._vertices.set(a,18*b+6),vec3.add(a,w.pos,e),this._vertices.set(a,18*b+9),vec3.add(a,w.pos,m),this._vertices.set(a,18*b+12),vec3.add(a,w.pos,n),this._vertices.set(a,18*b+15),this._colors.set(q,24*b),this._colors.set(q,24*b+4),this._colors.set(q,24*b+8),this._colors.set(q,
24*b+12),this._colors.set(q,24*b+16),this._colors.set(q,24*b+20),u&&(t=(B?(x?z:t)*C<<0:w.id)%C*A,w=1-(t<<0)*A-A,t%=1,this._coords.set([t+A,w+A,t,w+A,t+A,w,t,w+A,t,w,t+A,w],12*b)),++b,18*b>=this._vertices.length)))break}this._visible_particles=b;this._mesh.vertexBuffers.vertices.data=this._vertices;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=this._colors;this._mesh.vertexBuffers.colors.upload();u&&(this._mesh.vertexBuffers.coords.data=this._coords,this._mesh.vertexBuffers.coords.upload())};
ParticleEmissor._identity=mat4.create();
ParticleEmissor.prototype.onCollectInstances=function(a,b,c){if(this._root){a=Renderer._current_camera;this.align_always&&this.updateMesh(a);this._material||(this._material=new Material({shader_name:"lowglobal"}));this._material.opacity=this.opacity-0.01;this._material.setTexture(Material.COLOR,this.texture);this._material.blend_mode=this.additive_blending?Blend.ADD:Blend.ALPHA;this._material.soft_particles=this.soft_particles;this._material.constant_diffuse=!0;if(!this._mesh)return null;a=this._render_instance;
a||(this._render_instance=a=new RenderInstance(this._root,this));this.follow_emitter?mat4.translate(a.matrix,ParticleEmissor._identity,this._root.transform._position):mat4.copy(a.matrix,ParticleEmissor._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=RI_DEFAULT_FLAGS|RI_IGNORE_FRUSTUM;a.applyNodeFlags();a.setMaterial(c);a.setMesh(this._mesh,gl.TRIANGLES);a.setRange(0,6*this._visible_particles);
b.push(a)}};LS.registerComponent(ParticleEmissor);
(function(){function a(a){this.className=this.text="";this._world_pos=vec3.create();this._screen_pos=vec3.create();this.configure(a)}a.icon="mini-icon-text.png";a.CSS_classname="LS3D_label";a.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"beforeRender",this.render,this);a=document.createElement("div");a.innerHTML=this.text;var c=a.style;c.className=this.constructor.CSS_classname;c.position="absolute";c.top=0;c.left=0;c.fontSize="20px";c.padding="10px";c.color="white";c.pointerEvents="none";
c.backgroundColor="rgba(0,0,0,0.5)";c.borderRadius="2px";gl&&gl.canvas&&gl.canvas.parentNode&&gl.canvas.parentNode.appendChild(a);this._element=a};a.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"beforeRender",this.render,this);this._element&&(this._element.parentNode&&this._element.parentNode.removeChild(this._element),this._element=null)};a.prototype.render=function(a,c){if(this._element){var d=this._root;this._element.innerHTML!=this.text&&(this._element.innerHTML=this.text);this._element.style.display=
!1===d.flags.visible?"none":"block";if(this.text){var e=this.constructor.CSS_classname+" "+this.className;this._element.className!=e&&(this._element.className=e);e=c.main_camera;d.transform.getGlobalPosition(this._world_pos);e.project(this._world_pos,null,this._screen_pos);this._element.style.left=this._screen_pos[0].toFixed(0)+"px";this._element.style.top=gl.canvas.height-(this._screen_pos[1]|0)-10+"px"}else this._element.style.display="none"}};LS.registerComponent(a)})();
function PointCloud(a){this.enabled=!0;this.max_points=1024;this.mesh=null;this._points=[];this.texture_grid_size=this.size=1;this.texture=null;this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.sort_in_z=this.in_world_coordinates=this.premultiplied_alpha=this.use_node_material=this.additive_blending=!1;a&&this.configure(a);this._last_id=0;this.createMesh()}PointCloud.icon="mini-icon-points.png";PointCloud["@texture"]={widget:"texture"};PointCloud["@color"]={widget:"color"};
PointCloud.prototype.addPoint=function(a,b,c,d){var e=new Float32Array(10);e.set(a,0);b?e.set(b,3):e.set([1,1,1,1],3);e[7]=void 0!==c?c:1;e[8]=void 0!=d?d:0;this._points.push(e);this._dirty=!0;return this._points.length-1};PointCloud.prototype.clear=function(){this._points.length=0};PointCloud.prototype.setPoint=function(a,b,c,d,e){if(a=this._points[a])b&&a.set(b,0),c&&a.set(c,3),void 0!==d&&(a[7]=d),void 0!==e&&(a[8]=e),this._dirty=!0};PointCloud.prototype.setPointsFromMesh=function(a,b,c){};
PointCloud.prototype.removePoint=function(a){this._points.splice(a,1);this._dirty=!0};PointCloud.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};PointCloud.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};PointCloud.prototype.getResources=function(a){this.mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};
PointCloud.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.texture==a&&(this.texture=b)};
PointCloud.prototype.createMesh=function(){if(this._mesh_max_points!=this.max_points){this._vertices=new Float32Array(3*this.max_points);this._colors=new Float32Array(4*this.max_points);this._extra2=new Float32Array(2*this.max_points);for(var a=[1,1,1,1],b=0;b<this.max_points;b++)this._colors.set(a,4*b),this._extra2[2*b]=1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_max_points=this.max_points}};
PointCloud.prototype.updateMesh=function(a){this._mesh_max_points!=this.max_points&&this.createMesh();var b=a.getEye(),c=a.getFront();a=this._points;if(this.sort_in_z){a=this._points.concat();for(var b=geo.createPlane(b,c),c=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]),d=0;d<a.length;++d)a[d][9]=Math.abs(vec3.dot(a[d].subarray(0,3),b)+b[3])/c;a.sort(function(a,b){return a[9]<b[9]?1:a[9]>b[9]?-1:0})}for(var d=0,b=this._vertices,c=this._colors,d=this._extra2,e=this.premultiplied_alpha,f=0;f<a.length&&!(3*
f>=b.length);++f){var g=a[f];b.set(g.subarray(0,3),3*f);var h=g.subarray(3,7);e&&vec3.scale(h,h,h[3]);c.set(h,4*f);d.set(g.subarray(7,9),2*f)}this._mesh.vertexBuffers.vertices.data=b;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=c;this._mesh.vertexBuffers.colors.upload();this._mesh.vertexBuffers.extra2.data=d;this._mesh.vertexBuffers.extra2.upload()};PointCloud._identity=mat4.create();
PointCloud.prototype.onCollectInstances=function(a,b,c){if(this._root&&0!=this._points.length&&this.enabled){a=Renderer._current_camera;this._last_premultiply!==this.premultiplied_alpha&&(this._dirty=!0);this._dirty&&this.updateMesh(a);this._material||(this._material=new Material({shader_name:"lowglobal"}),this._material.extra_macros={USE_POINT_CLOUD:""});c=this._material;c.color.set(this.color);c.opacity=this.premultiplied_alpha?0.99:this.global_opacity-0.01;this._last_premultiply=this.premultiplied_alpha;
c.setTexture(Material.COLOR,this.texture);c.blend_mode=this.additive_blending?Blend.ADD:Blend.ALPHA;c.constant_diffuse=!0;c.extra_uniforms={u_pointSize:this.size};if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new RenderInstance(this._root,this));this.in_world_coordinates?a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,PointCloud._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,
a.matrix,vec3.create());a.flags=RI_DEFAULT_FLAGS|RI_IGNORE_FRUSTUM;a.applyNodeFlags();a.setMaterial(c);a.setMesh(this._mesh,gl.POINTS);c=this._points.length;c>this._vertices.length/3&&(c=this._vertices.length/3);a.setRange(0,c);b.push(a)}};LS.registerComponent(PointCloud);
function LineCloud(a){this.enabled=!0;this.max_lines=1024;this._lines=[];this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.in_world_coordinates=this.premultiplied_alpha=this.use_node_material=this.additive_blending=!1;a&&this.configure(a);this._last_id=0;this.createMesh()}LineCloud.icon="mini-icon-lines.png";LineCloud["@color"]={widget:"color"};LineCloud.prototype.clear=function(){this._lines.length=0};
LineCloud.prototype.addLine=function(a,b,c,d){var e=new Float32Array(14);e.set(a,0);e.set(b,3);c?e.set(c,6):e.set([1,1,1,1],6);d?e.set(d,10):c?e.set(c,10):e.set([1,1,1,1],10);this._lines.push(e);this._dirty=!0;return this._lines.length-1};LineCloud.prototype.setLine=function(a,b,c,d,e){a=this._lines[a];b&&a.set(b,0);c&&a.set(c,3);d&&a.set(d,6);e&&a.set(e,10);this._dirty=!0};LineCloud.prototype.removeLine=function(a){this._lines.splice(a,1);this._dirty=!0};
LineCloud.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};LineCloud.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};LineCloud.prototype.onResourceRenamed=function(a,b,c){};
LineCloud.prototype.createMesh=function(){this._mesh_max_lines!=this.max_lines&&(this._vertices=new Float32Array(6*this.max_lines),this._colors=new Float32Array(8*this.max_lines),this._mesh=new GL.Mesh,this._mesh.addBuffers({vertices:this._vertices,colors:this._colors},null,gl.STREAM_DRAW),this._mesh_max_lines=this.max_lines)};
LineCloud.prototype.updateMesh=function(){this._mesh_max_lines!=this.max_lines&&this.createMesh();for(var a=0,b=this._vertices,c=this._colors,d=this._lines,e=this._lines.length,f=b.length,a=0;a<e&&!(6*a>=f);++a){var g=d[a];b.set(g.subarray(0,6),6*a);c.set(g.subarray(6,14),8*a)}this._mesh.vertexBuffers.vertices.data=b;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=c;this._mesh.vertexBuffers.colors.upload()};LineCloud._identity=mat4.create();
LineCloud.prototype.onCollectInstances=function(a,b,c){if(this._root&&0!=this._lines.length&&this.enabled){this._dirty&&this.updateMesh();this._material||(this._material=new Material({shader_name:"lowglobal"}));c=this._material;c.color.set(this.color);c.opacity=this.global_opacity-0.01;c.blend_mode=this.additive_blending?Blend.ADD:Blend.ALPHA;c.constant_diffuse=!0;if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new RenderInstance(this._root,this));this.in_world_coordinates?
a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,LineCloud._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=RI_DEFAULT_FLAGS|RI_IGNORE_FRUSTUM;a.applyNodeFlags();a.setMaterial(c);a.setMesh(this._mesh,gl.LINES);c=2*this._lines.length;c>this._vertices.length/3&&(c=this._vertices.length/3);a.setRange(0,c);b.push(a)}};LS.registerComponent(LineCloud);
function PlayAnimation(a){this.animation="";this.take="default";this.playback_speed=1;this.mode="loop";this.play=!0;this.current_time=0;this.disabled_tracks={};a&&this.configure(a)}PlayAnimation["@animation"]={widget:"resource"};PlayAnimation["@mode"]={type:"enum",values:["loop","pingpong","once"]};PlayAnimation.prototype.configure=function(a){a.animation&&(this.animation=a.animation);a.take&&(this.take=a.take);null!=a.playback_speed&&(this.playback_speed=parseFloat(a.playback_speed))};
PlayAnimation.icon="mini-icon-clock.png";PlayAnimation.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};PlayAnimation.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};PlayAnimation.prototype.getAnimation=function(){return this.animation?LS.ResourcesManager.resources[this.animation]:null};
PlayAnimation.prototype.onUpdate=function(a,b){var c=this.getAnimation();if(c&&(this.play&&(this.current_time+=b*this.playback_speed),c=c.takes[this.take])){var d=this.current_time;if(d>c.duration)switch(this.mode){case "once":d=c.duration;break;case "loop":d=this.current_time%c.duration;break;case "pingpong":d=0==(d/c.duration|0)%2?this.current_time%c.duration:c.duration-this.current_time%c.duration}c.applyTracks(d);(c=this._root.scene)&&c.refresh()}};
PlayAnimation.prototype._processSample=function(a,b,c,d){if(d=this._root.scene)if(a=d.getNode(a)){d=a.transform;switch(b){case "translate.X":d&&(d.position[0]=c);break;case "translate.Y":d&&(d.position[1]=c);break;case "translate.Z":d&&(d.position[2]=c);break;case "matrix":d&&d.fromMatrix(c)}a.transform&&a.transform.updateMatrix()}};PlayAnimation.prototype.getResources=function(a){this.animation&&(a[this.animation]=LS.Animation)};
PlayAnimation.prototype.onResourceRenamed=function(a,b,c){this.animation==a&&(this.animation=b)};LS.registerComponent(PlayAnimation);
function RealtimeReflector(a){this.enabled=!0;this.texture_size=512;this.brightness_factor=1;this.colorclip_factor=0;this.clip_offset=0.5;this.texture_name="";this.all_cameras=this.use_cubemap=!1;this.blur=0;this.use_mesh_info=this.generate_mipmaps=!1;this.offset=vec3.create();this.ignore_this_mesh=!0;this.high_precision=!1;this.refresh_rate=1;this._textures={};a&&this.configure(a)}RealtimeReflector.icon="mini-icon-reflector.png";
RealtimeReflector["@texture_size"]={type:"enum",values:["viewport",64,128,256,512,1024,2048]};RealtimeReflector.prototype.onAddedToScene=function(a){LEvent.bind(a,"renderReflections",this.onRenderReflection,this);LEvent.bind(a,"afterCameraEnabled",this.onCameraEnabled,this)};RealtimeReflector.prototype.onRemoveFromScene=function(a){LEvent.unbindAll(a,this);this._textures={}};
RealtimeReflector.prototype.onRenderReflection=function(a,b){if(this.enabled&&this._root){var c=this._root.scene;if(c&&(this.refresh_rate<<=0,0!=c._frame&&0==c._frame%this.refresh_rate||!this._rt)){var d=c=parseInt(this.texture_size),e=c,f=this._root.flags.visible;this.ignore_this_mesh&&(this._root.flags.seen_by_reflections=!1);b.is_rt=!0;b.is_reflection=!0;b.brightness_factor=this.brightness_factor;b.colorclip_factor=this.colorclip_factor;for(var g=LS.Renderer._visible_cameras,h=0;h<g.length;h++){var l=
g[h];isNaN(c)&&"viewport"==this.texture_size&&(c=512,e=l.getLocalViewport(null,l._viewport_in_pixels),d=e[2],e=e[3]);this.use_cubemap&&(d=e=c);var k=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D,m=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,n=this._textures[l.uid];n&&n.width==d&&n.height==e&&n.type==m&&n.texture_type==k&&n.mipmaps==this.generate_mipmaps||(n=new GL.Texture(d,e,{type:m,texture_type:k,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR}),n.mipmaps=
this.generate_mipmaps,this._textures[l.uid]=n);var k=this._root.transform.getGlobalPosition(),m=this._root.transform.getTop(),p=l.getEye(),q=l.getCenter(),r=l.getUp();if(this.use_mesh_info){var s=this._root.getMesh();s&&(k=this._root.transform.transformPointGlobal(BBox.getCenter(s.bounding)),m=this._root.transform.transformVectorGlobal([0,1,0]))}vec3.add(k,k,this.offset);this._reflected_camera=s=this._reflected_camera||new LS.Camera;s.configure(l.serialize());this.use_cubemap?s.eye=k:(s.fov=l.fov,
s.aspect=l.aspect,s.eye=geo.reflectPointInPlane(p,k,m),s.center=geo.reflectPointInPlane(q,k,m),s.up=geo.reflectPointInPlane(r,[0,0,0],m),vec3.add(k,k,vec3.scale(vec3.create(),m,-this.clip_offset)),k=[m[0],m[1],m[2],vec3.dot(k,m)],b.clipping_plane=k);LS.Renderer.renderInstancesToRT(s,n,b);this.blur&&((k=this._textures["blur_"+l.uid])&&!GL.Texture.compareFormats(k,n)&&(k=null),k=n.applyBlur(this.blur,this.blur,1,k),this._textures["blur_"+l.uid]=k);this.generate_mipmaps&&isPowerOfTwo(d)&&isPowerOfTwo(e)&&
(n.bind(),gl.generateMipmap(n.texture_type),n.unbind());this.texture_name&&LS.ResourcesManager.registerResource(this.texture_name,n);LS.ResourcesManager.registerResource(":reflection_"+l.uid,n);if(!this.all_cameras)break}delete b.clipping_plane;delete b.is_rt;delete b.is_reflection;delete b.brightness_factor;delete b.colorclip_factor;this._root.flags.visible=f}}};
RealtimeReflector.prototype.onCameraEnabled=function(a,b){if(this.enabled&&this._root&&this._root.material&&this._textures[b.uid]){var c=this._root.getMaterial();c&&(c.setTexture(Material.ENVIRONMENT_TEXTURE,":reflection_"+b.uid).uvs=Material.COORDS_FLIPPED_SCREEN)}};LS.registerComponent(RealtimeReflector);
function Script(a){this.enabled=!0;this.code="this.update = function(dt)\n{\n\tnode.scene.refresh();\n}";this._script=new LScript;this._script.catch_exceptions=!1;this._script.onerror=this.onError.bind(this);this._script.exported_callbacks=[];this._last_error=null;a&&this.configure(a);if(this.code)try{this.processCode()}catch(b){console.error(b)}}Script.secure_module=!1;Script.block_execution=!1;Script.icon="mini-icon-script.png";Script["@code"]={type:"script"};Script.exported_callbacks="start update trigger sceneRender render afterRender finish collectRenderInstances".split(" ");
Script.translate_events={sceneRender:"beforeRender",beforeRender:"sceneRender",render:"renderInstances",renderInstances:"render",afterRender:"afterRenderInstances",afterRenderInstances:"afterRender",finish:"stop",stop:"finish"};Script.coding_help="\nGlobal vars:\n + node : represent the node where this component is attached.\n + component : represent the component.\n + this : represents the script context\n\nExported functions:\n + start: when the Scene starts\n + update: when updating\n + trigger : if this node is triggered\n + render : before rendering the node\n + getRenderInstances: when collecting instances\n + afterRender : after rendering the node\n + finish : when the scene stops\n\nRemember, all basic vars attached to this will be exported as global.\n";
Script.prototype.getContext=function(){return this._script?this._script._context:null};Script.prototype.getCode=function(){return this.code};
Script.prototype.processCode=function(a){this._script.code=this.code;if(this._root&&!Script.block_execution){var b=this._script.compile({component:this,node:this._root});this._script._context&&(this._script._context.__proto__.getComponent=function(){return this}.bind(this),this._script._context.__proto__.getLocatorString=function(){return this.getComponent().getLocatorString()+"/context"});a||this.hookEvents();return b}return!0};
Script.prototype.setAttribute=function(a,b){var c=this.getContext();if(c&&void 0!==c[a])if(c[a].set)c[a](b);else c[a]=b;else this[a]&&(this[a]=b)};Script.prototype.getAttributes=function(){var a=this.getContext();if(!a)return{enabled:"boolean"};a=LS.getObjectAttributes(a);a.enabled="boolean";return a};
Script.prototype.getPropertyInfoFromPath=function(a){if(!(4>a.length)&&"context"==a[2]){var b=this.getContext();a=a[3];if(b&&void 0!==b[a]){var c=b[a],d=b["@"+a],e="";d&&(e=d.type);e||null===c||void 0===c||(c.constructor===String?e="string":c.constructor===Boolean?e="boolean":c.length?e="vec"+c.length:c.constructor===Number&&(e="number"));return{node:this._root,target:b,name:a,value:c,type:e}}}};
Script.prototype.setPropertyValueFromPath=function(a,b){if(!(4>a.length)&&"context"==a[2]){var c=this.getContext(),d=a[3];c&&void 0!==c[d]&&void 0!==c[d]&&(c[d]&&c[d].set?c[d].set(b):c[d]=b)}};
Script.prototype.hookEvents=function(){var a=LS.Script.exported_callbacks,b=this._root.scene;b||(b=LS.GlobalScene);var c=this.getContext();if(c)for(var d in a){var e=a[d],f=LS.Script.translate_events[e]||e;c[e]&&c[e].constructor===Function?LEvent.isBind(b,f,this.onScriptEvent,this)||LEvent.bind(b,f,this.onScriptEvent,this):LEvent.unbind(b,f,this.onScriptEvent,this)}};Script.prototype.onAddedToScene=function(a){try{this.processCode()}catch(b){console.error(b)}};
Script.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};Script.prototype.onScriptEvent=function(a,b){this.enabled&&this._script.callMethod(LS.Script.translate_events[a]||a,b)};Script.prototype.runStep=function(a,b){this._script.callMethod(a,b)};Script.prototype.onError=function(a){var b=this._root.scene;b&&(LEvent.trigger(this,"code_error",a),LEvent.trigger(b,"code_error",[this,a]),LEvent.trigger(Script,"code_error",[this,a]),console.log("app stopping due to error in script"),b.stop())};
Script.prototype.onCodeChange=function(a){this.processCode()};Script.prototype.getResources=function(a){var b=this.getContext();b&&b.getResources&&b.getResources(a)};LS.registerComponent(Script);LS.Script=Script;function TerrainRenderer(a){this.height=2;this.subdivisions=this.size=10;this.heightmap="";this._primitive=-1;this.auto_update=!0;this.action="Update";this._mesh=null;a&&this.configure(a)}
Object.defineProperty(TerrainRenderer.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});TerrainRenderer.icon="mini-icon-terrain.png";TerrainRenderer["@subdivisions"]={type:"number",min:1,max:255,step:1};TerrainRenderer["@heightmap"]={type:"texture"};TerrainRenderer["@action"]={widget:"button",callback:function(){this.options.instance&&this.options.instance.updateMesh()}};
TerrainRenderer["@primitive"]={type:"enum",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};TerrainRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};TerrainRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._root.mesh==this._mesh&&delete this._root.mesh};TerrainRenderer.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};
TerrainRenderer.prototype.onResourceRenamed=function(a,b,c){this.heightmap==a&&(this.heightmap=b)};
TerrainRenderer.prototype.updateMesh=function(){trace("updating terrain mesh...");if(this.heightmap){var a=LS.ResourcesManager.textures[this.heightmap];if(a){var b=a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&(this.subdivisions=255);var a=0.5*this.size,c=this.subdivisions<<0,d=this.height,e=createCanvas(c,c),f=e.getContext("2d");f.drawImage(b,0,0,b.width,b.height,0,0,e.width,e.height);for(var b=f.getImageData(0,
0,e.width,e.height).data,e=[],f=[],g=[],h=[],l=[],k=detailX=c-1,m,n=a/(c-1),p=0;p<=k;p++)for(var q=p/k,r=0;r<=detailX;r++){var s=r/detailX;m=b[p*c*4+4*r]/255;g.push(a*(2*s-1),m*d,a*(2*q-1));l.push(s,1-q);0==r||0==p||r==detailX-1||p==k-1?h.push(0,1,0):(m=[-(b[p*c*4+4*(r+1)]/255-b[p*c*4+4*(r-1)]/255)*d,2*n,-(b[(p+1)*c*4+4*r]/255-b[(p-1)*c*4+4*r]/255)*d],vec3.normalize(m,m),h.push(m[0],m[1],m[2]));r<detailX&&p<k&&(m=r+p*(detailX+1),e.push(m+1,m,m+detailX+1),e.push(m+1,m+detailX+1,m+detailX+2),f.push(m+
1,m,m,m+detailX+1))}c=new GL.Mesh({vertices:g,normals:h,coords:l},{triangles:e,wireframe:f});c.setBounding([0,0.5*this.height,0],[a,0.5*this.height,a]);this._mesh=c;this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};TerrainRenderer.PLANE=null;
TerrainRenderer.prototype.onCollectInstances=function(a,b){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());var c=this._render_instance;c||(this._render_instance=c=new RenderInstance(this._root,this));if(!this._mesh)return TerrainRenderer.PLANE||(TerrainRenderer.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),
c.mesh=TerrainRenderer.PLANE,c;c.material=this._root.getMaterial();c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();b.push(c)};LS.registerComponent(TerrainRenderer);
function Cloner(a){this.enabled=!0;this.createProperty("count",vec3.fromValues(10,1,1));this.createProperty("size",vec3.fromValues(100,100,100));this.material=this.lod_mesh=this.mesh=null;this.mode=Cloner.GRID_MODE;a&&this.configure(a);Cloner._identity||(Cloner._identity=mat4.create())}Cloner.GRID_MODE=1;Cloner.RADIAL_MODE=2;Cloner.MESH_MODE=3;Cloner.icon="mini-icon-cloner.png";Cloner["@mesh"]={type:"mesh"};Cloner["@lod_mesh"]={type:"mesh"};
Cloner["@mode"]={type:"enum",values:{Grid:Cloner.GRID_MODE,Radial:Cloner.RADIAL_MODE,Mesh:Cloner.MESH_MODE}};Cloner["@count"]={type:"vec3",min:1,step:1};Cloner.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCollectData",this.onUpdateInstances,this)};
Cloner.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.unbind(a,"afterCollectData",this.onUpdateInstances,this)};Cloner.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};Cloner.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};
Cloner.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};Cloner.generateTransformKey=function(a,b,c){var d=new Float32Array(9);d.set(a);d.set(b,3);d.set(c,6);return d};Cloner.compareKeys=function(a,b){for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0};
Cloner.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getMesh();if(!c)return null;if(this._root){this.updateRenderInstancesArray();var d=this._RIs,e=this.material||this._root.getMaterial(),f=0,g=b.length;b.length=g+d.length;for(var h=0,l=d.length;h<l;++h){var k=d[h];0==h?(k.flags=RI_DEFAULT_FLAGS|RI_IGNORE_AUTOUPDATE,k.applyNodeFlags(),f=k.flags):k.flags=f;k.setMesh(c);if(this.lod_mesh){var m=this.getLODMesh();m&&k.setLODMesh(m)}k.setMaterial(e);b[g+h]=k}}}};
Cloner.prototype.updateRenderInstancesArray=function(){var a=0;this.mode===Cloner.GRID_MODE?a=(this.count[0]|0)*(this.count[1]|0)*(this.count[2]|0):this.mode===Cloner.RADIAL_MODE?a=this.count[0]|0:this.mode===Cloner.MESH_MODE&&(a=0);if(!a)this._RIs.length=0;else if(!this._RIs||this._RIs.length!=a){this._RIs?this._RIs.length=a:this._RIs=Array(a);for(var b=0;b<a;++b)this._RIs[b]||(this._RIs[b]=new LS.RenderInstance(this._root,this))}};
Cloner.prototype.onUpdateInstances=function(a,b){if(this.enabled){var c=this._RIs;if(c&&c.length){var d=this._root.transform.getGlobalMatrix(mat4.create()),e=this._count[0]|0,f=this._count[1]|0,g=this._count[2]|0;if(this.mode==Cloner.GRID_MODE){var h=vec3.scale(vec3.create(),this.size,0.5),l=vec3.create();1<e?l[0]=this.size[0]/(e-1):h[0]=0;1<f?l[1]=this.size[1]/(f-1):h[1]=0;1<g?l[2]=this.size[2]/(g-1):h[2]=0;for(var k=0,m=vec3.create(),n=vec3.create(),p=0;p<e;++p)for(var q=0;q<f;++q)for(var r=0;r<
g;++r){var s=c[k];if(!s)return;m[0]=p*l[0]-h[0];m[1]=q*l[1]-h[1];m[2]=r*l[2]-h[2];mat4.translate(s.matrix,d,m);mat4.multiplyVec3(s.center,s.matrix,n);++k}}else if(this.mode==Cloner.RADIAL_MODE)for(l=2*Math.PI/c.length,m=vec3.create(),n=vec3.create(),k=0,e=c.length;k<e;++k){s=c[k];if(!s)break;m[0]=Math.sin(l*k)*this.size[0];m[1]=0;m[2]=Math.cos(l*k)*this.size[0];s.matrix.set(d);mat4.translate(s.matrix,s.matrix,m);mat4.rotateY(s.matrix,s.matrix,l*k);mat4.multiplyVec3(s.center,s.matrix,n)}}}};LS.registerComponent(Cloner);
function Spherize(a){this.enabled=!0;this._num_id=LS._last_uid++;this.radius=10;this.center=vec3.create();this.factor=0.5;this._uniforms_code=Spherize._uniforms_code.replaceAll({"@":this._num_id});this._code=Spherize._code.replaceAll({"@":this._num_id});a&&this.configure(a)}Spherize["@factor"]={type:"number",step:0.001};Spherize["@center"]={type:"position",step:0.001};Spherize.icon="mini-icon-circle.png";
Spherize.prototype.onAddedToNode=function(a){LEvent.bind(a,"computingShaderMacros",this.onMacros,this);LEvent.bind(a,"computingShaderUniforms",this.onUniforms,this)};Spherize.prototype.onRemoveFromNode=function(a){LEvent.unbindAll(a,this)};Spherize._uniforms_code="uniform vec3 u_spherize_center@; uniform float u_spherize_radius@; uniform float u_spherize_factor@;";Spherize._code="\tvec3 off@ = vertex4.xyz - u_spherize_center@;    float dist@ = length(off@);\tvec3 vn@ = off@ / dist@;\tfloat factor@ = max(0.0, u_spherize_factor@ / dist@ );\tvertex4.xyz = mix(vertex4.xyz, vn@ * u_spherize_radius@, factor@);\tv_normal = (mix(v_normal, vn@, clamp(0.0,1.0,factor@)));";
Spherize.prototype.onMacros=function(a,b){this.enabled&&(b.USE_VERTEX_SHADER_UNIFORMS=b.USE_VERTEX_SHADER_UNIFORMS?b.USE_VERTEX_SHADER_UNIFORMS+this._uniforms_code:this._uniforms_code,b.USE_VERTEX_SHADER_CODE=b.USE_VERTEX_SHADER_CODE?b.USE_VERTEX_SHADER_CODE+this._code:this._code)};Spherize.prototype.onUniforms=function(a,b){this.enabled&&(b["u_spherize_center"+this._num_id]=this.center,b["u_spherize_radius"+this._num_id]=this.radius,b["u_spherize_factor"+this._num_id]=this.factor)};
Spherize.prototype.renderEditor=function(a,b){if(this.enabled&&a&&this.enabled){Draw.setPointSize(6);Draw.setColor([0.33,0.874,0.56,b?0.8:0.5]);var c=vec3.clone(this.center);this._root&&this._root.transform&&vec3.transformMat4(c,c,this._root.transform._global_matrix);Draw.renderRoundPoints(c)}};
Spherize.prototype.getTransformMatrix=function(a){if(!this._root||!this._root.transform)return null;var b=null;if("center"==a)b=this.center;else return!1;a=mat4.clone(this._root.transform._global_matrix);mat4.translate(a,a,b);return a};Spherize.prototype.renderPicking=function(a){a=vec3.clone(this.center);this._root&&this._root.transform&&vec3.transformMat4(a,a,this._root.transform._global_matrix);EditorView.addPickingPoint(a,4,{instance:this,info:"center"})};
Spherize.prototype.applyTransformMatrix=function(a,b,c){if(!this._root||!this._root.transform||"center"!=c)return!1;b=this.center;mat4.multiplyVec3(b,a,b);return!0};LS.registerComponent(Spherize);function VRCameraController(a){this.enabled=!0;this.eye_distance=1;a&&this.configure(a)}VRCameraController.icon="mini-icon-graph.png";VRCameraController.rift_server_url="http://tamats.com/uploads/RiftServer_0_3.zip";
VRCameraController.prototype.onAddedToNode=function(a){var b=a.scene;LEvent.bind(b,"start",this.onStart,this);LEvent.bind(b,"stop",this.onStop,this);LEvent.bind(b,"beforeRender",this.onBeforeRender,this);LEvent.bind(b,"afterRender",this.onAfterRender,this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};
VRCameraController.prototype.onRemovedFromNode=function(a){var b=this._root.scene;LEvent.unbind(b,"start",this.onStart,this);LEvent.unbind(b,"stoo",this.onStop,this);LEvent.unbind(b,"beforeRender",this.onBeforeRender,this);LEvent.unbind(b,"afterRender",this.onAfterRender,this);LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);Renderer.color_rendertarget=null};
VRCameraController.prototype.onCollectCameras=function(a,b){var c=Renderer.main_camera;this._orientation&&c.setOrientation(this._orientation,!0);var d=c.getLocalVector([0.5*this.eye_distance,0,0]),e=vec3.scale(vec3.create(),d,-1);this._left_camera||(this._left_camera=new LS.Camera,this._right_camera=new LS.Camera);var f=c.serialize();this._left_camera.configure(f);this._right_camera.configure(f);this._left_camera.eye=vec3.add(vec3.create(),c.eye,e);this._right_camera.eye=vec3.add(vec3.create(),c.eye,
d);this._left_camera._viewport.set([0,0,0.5,1]);this._right_camera._viewport.set([0.5,0,0.5,1]);this._right_camera._ignore_clear=!0;b.push(this._left_camera,this._right_camera)};
VRCameraController.prototype.onStart=function(a){a=new WebSocket("ws://localhost:1981");a.onopen=function(){console.log("VR connection stablished")};a.onmessage=this.onMessage.bind(this);a.onclose=function(){console.log("OVR connection lost")};a.onerror=function(){console.error("Oculus Server not found in your machine. To run an app using Oculus Rift you need to use a client side app, you can download it from: "+OculusController.rift_server_url)};this._ws=a};
VRCameraController.prototype.onMessage=function(a){var b=a.data,b=JSON.parse("["+b+"]");a=quat.create();a.set(b);b=quat.fromValues(-1,0,0,0);quat.multiply(a,b,a);this._orientation=a;this._root.scene&&this._root.scene.refresh()};VRCameraController.prototype.onStop=function(a){this._ws&&(this._ws.close(),this._ws=null)};
VRCameraController.prototype.onBeforeRender=function(a,b){var c=1024,d=512,c=v[2],d=v[3];this._color_texture&&this._color_texture.width==c&&this._color_texture.height==d||(this._color_texture=new GL.Texture(c,d,{format:gl.RGB,filter:gl.LINEAR}),LS.ResourcesManager.textures[":vr_color_buffer"]=this._color_texture);LS.Renderer.color_rendertarget=this.enabled?this._color_texture:null};VRCameraController.prototype.onAfterRender=function(a,b){this._color_texture&&this._color_texture.toViewport()};
function Poser(a){this.poses={};a&&this.configure(a)}Poser.prototype.configure=function(a){};Poser.icon="mini-icon-clock.png";Poser.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Poser.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};Poser.prototype.onUpdate=function(a,b){var c=this._root.scene;c||c.refresh()};Poser.prototype.getResources=function(a){};Poser.prototype.onResourceRenamed=function(a,b,c){};
if("undefined"!=typeof LiteGraph){var LGraphScene=function(){this.addOutput("Time","number")};LGraphScene.title="Scene";LGraphScene.desc="Scene";LGraphScene.getComponents=function(a,b){b=b||[];var c=a.getComponents();if(!c)return b;for(var d=0;d<c.length;++d){var e=LS.getClassName(c[d].constructor);b.push([e,e])}return b};LGraphScene.prototype.onExecute=function(){var a=this.graph.getScene();if(this.inputs)for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==
d)switch(c.name){case "Ambient color":vec3.copy(a.ambient_color,d);break;case "Bg Color":vec3.copy(a.background_color,d)}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length){d=null;switch(c.name){case "Ambient color":d=a.ambient_color;break;case "Bg Color":d=a.background_color;break;case "Time":d=a.getTime();break;case "Elapsed":d=null!=a._last_dt?a._last_dt:0;break;case "Frame":d=null!=a._frame?a._frame:0;break;default:d=a.root.getComponent(c.name)}this.setOutputData(b,
d)}};LGraphScene.prototype.onGetInputs=function(){return[["Ambient color","color"],["Bg Color","color"]]};LGraphScene.prototype.onGetOutputs=function(){return LGraphScene.getComponents(this.graph.getScene().root,[["Ambient color","color"],["Bg Color","color"],["Elapsed","number"],["Frame","number"]])};LiteGraph.registerNodeType("scene/scene",LGraphScene);window.LGraphScene=LGraphScene;var LGraphSceneNode=function(){this.properties={node_id:""};this.size=[100,20];LGraphSceneNode._current_node_id&&
(this.properties.node_id=LGraphSceneNode._current_node_id)};LGraphSceneNode.title="SceneNode";LGraphSceneNode.desc="Node on the scene";LGraphSceneNode.prototype.getNode=function(){var a=this.graph.getScene(),b=this._node;this.properties.node_id&&(b=a.getNode(this.properties.node_id));b||(b=this.graph._scenenode);return b};LGraphSceneNode.prototype.onExecute=function(){var a=this.getNode();if(this.inputs)for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==
d)switch(c.name){case "Transform":a.transform.copyFrom(d);break;case "Material":a.material=d;break;case "Visible":a.flags.visible=d}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Material":this.setOutputData(b,a.getMaterial());break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible);break;default:c=a.getComponentByUId(c.name),this.setOutputData(b,c)}};LGraphSceneNode.prototype.getComponents=
function(a){a=a||[];var b=this.getNode();if(!b)return a;b=b.getComponents();if(!b)return a;for(var c=0;c<b.length;++c){var d=LS.getClassName(b[c].constructor);a.push([b[c].uid,d,{label:d}])}return a};LGraphSceneNode.prototype.onGetInputs=function(){return this.getComponents([["Visible","boolean"]])};LGraphSceneNode.prototype.onGetOutputs=function(){return this.getComponents([["Visible","boolean"]])};LiteGraph.registerNodeType("scene/node",LGraphSceneNode);window.LGraphSceneNode=LGraphSceneNode;var LGraphTransform=
function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform");this.addOutput("Position","vec3")};LGraphTransform.title="Transform";LGraphTransform.desc="Transform info of a node";LGraphTransform.prototype.onExecute=function(){var a=this.graph.getScene();if(a){var b=this._node;this.properties.node_id&&(b=a.getNode(this.properties.node_id));b||(b=this.graph._scenenode);if(this.inputs)for(a=
0;a<this.inputs.length;++a){var c=this.inputs[a],d=this.getInputData(a);if(void 0!==d)switch(c.name){case "Position":b.transform.setPosition(d);break;case "Rotation":b.transform.setRotation(d);break;case "Scale":b.transform.setScale(d)}}if(this.outputs)for(a=0;a<this.outputs.length;++a)if(c=this.outputs[a],c.links&&c.links.length)switch(c.name){case "Position":this.setOutputData(a,b.transform.getPosition());break;case "Rotation":this.setOutputData(a,b.transform.getRotation());break;case "Scale":this.setOutputData(a,
b.transform.getScale(scale))}}};LGraphTransform.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LiteGraph.registerNodeType("scene/transform",LGraphTransform);window.LGraphTransform=LGraphTransform;var LGraphMaterial=function(){this.properties={mat_name:""};this.addInput("Material","Material");
this.size=[100,20]};LGraphMaterial.title="Material";LGraphMaterial.desc="Material of a node";LGraphMaterial.prototype.onExecute=function(){var a=this.getMaterial();if(a){for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);void 0!==d&&"Material"!=c.name&&a.setProperty(c.name,d)}if(this.outputs)for(b=0;b<this.outputs.length;++b)c=this.outputs[b],c.links&&c.links.length&&(d=a.getProperty(c.name),this.setOutputData(b,d))}};LGraphMaterial.prototype.getMaterial=function(){var a=
this.graph.getScene();if(a){var b=this._node;this.properties.node_id&&(b=a.getNode(this.properties.node_id));b||(b=this.graph._scenenode);if(!b)return null;a=this.findInputSlot("Material");return-1!=a?this.getInputData(a):b.getMaterial()}};LGraphMaterial.prototype.onGetInputs=function(){var a=this.getMaterial();if(a){var a=a.getProperties(),b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}};LGraphMaterial.prototype.onGetOutputs=function(){var a=this.getMaterial();if(a){var a=a.getProperties(),
b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}};LiteGraph.registerNodeType("scene/material",LGraphMaterial);window.LGraphMaterial=LGraphMaterial;var LGraphComponent=function(){this.properties={node:"",component:""};this.addInput("Component");this._component=null};LGraphComponent.title="Component";LGraphComponent.desc="A component from a node";LGraphComponent.prototype.onExecute=function(){var a=this.getComponent();if(a){for(var b=1;b<this.inputs.length;b++){var c=this.inputs[b],
d=this.getInputData(b);void 0!==d&&LS.setObjectAttribute(a,c.name,d)}for(b in this.outputs)c=this.outputs[b],c.links&&c.links.length&&this.setOutputData(b,a[c.name])}};LGraphComponent.prototype.onDrawBackground=function(){var a=this.getComponent();a&&(this.title=LS.getClassName(a.constructor))};LGraphComponent.prototype.getComponent=function(){var a=this.getInputData(0);if(a)return a;var b=this.graph._scene;if(!b)return null;var c=this.properties.node;if(c){a=null;a="@"==c.charAt(0)?b.getNodeByUId(c.substr(1)):
b.getNode(c);if(!a)return null;b=this.properties.component;c=null;if("@"==b.charAt(0))c=a.getComponentByUId(b.substr(1));else if(LS.Components[b])c=a.getComponent(LS.Components[b]);else return null;return this._component=c}};LGraphComponent.prototype.getComponentAttributes=function(a){var b=this.getComponent();if(!b)return null;var c=null,c=b.getAttributes?b.getAttributes(a):LS.getObjectAttributes(b);a=[];for(var d in c)a.push([d,c[d]]);return a};LGraphComponent.prototype.onGetInputs=function(){return this.getComponentAttributes("input")};
LGraphComponent.prototype.onGetOutputs=function(){return this.getComponentAttributes("output")};LiteGraph.registerNodeType("scene/component",LGraphComponent);window.LGraphComponent=LGraphComponent;var LGraphLight=function(){this.properties={mat_name:""};this.addInput("Light","Light");this.addOutput("Intensity","number");this.addOutput("Color","color")};LGraphLight.title="Light";LGraphLight.desc="Light from a scene";LGraphLight.prototype.onExecute=function(){var a=this.graph.getScene();if(a){var b=
this._node;this.properties.node_id&&(b=a.getNode(this.properties.node_id));b||(b=this.graph._scenenode);a=null;b&&(a=b.getLight());b=this.findInputSlot("Light");-1!=b&&(a=this.getInputData(b));if(a){for(b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==d)switch(c.name){case "Intensity":a.intensity=d;break;case "Color":vec3.copy(a.color,d);break;case "Eye":vec3.copy(a.eye,d);break;case "Center":vec3.copy(a.center,d)}}for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],
c.links&&c.links.length)switch(c.name){case "Light":this.setOutputData(b,a);break;case "Intensity":this.setOutputData(b,a.intensity);break;case "Color":this.setOutputData(b,a.color);break;case "Eye":this.setOutputData(b,a.eye);break;case "Center":this.setOutputData(b,a.center)}}}};LGraphLight.prototype.onGetInputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LGraphLight.prototype.onGetOutputs=function(){return[["Light","Light"],["Intensity",
"number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LiteGraph.registerNodeType("scene/light",LGraphLight);window.LGraphLight=LGraphLight;var LGraphGlobal=function(){this.addOutput("Value");this.properties={name:"myvar",value:0,type:"number",min:0,max:1}};LGraphGlobal.title="Global";LGraphGlobal.desc="Global var for the graph";LGraphGlobal["@type"]={type:"enum",values:"number string vec2 vec3 vec4 color texture".split(" ")};LGraphGlobal.prototype.onExecute=function(){this.properties.name&&
this.setOutputData(0,this.properties.value)};LGraphGlobal.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.name};LiteGraph.registerNodeType("scene/global",LGraphGlobal);window.LGraphGlobal=LGraphGlobal}LS.NONE=0;LS.LINEAR=1;LS.TRIGONOMETRIC=2;LS.BEZIER=3;LS.SPLINE=4;function Animation(a){this.name="";this.takes={};a&&this.configure(a)}Animation.prototype.createTake=function(a,b){var c=new Animation.Take;c.name=a;c.duration=b||0;this.addTake(c);return c};
Animation.prototype.addTake=function(a){return this.takes[a.name]=a};Animation.prototype.getTake=function(a){return this.takes[a]};Animation.prototype.addTrackToTake=function(a,b){var c=this.takes[a];c||(c=this.createTake(a));c.addTrack(b)};Animation.prototype.configure=function(a){if(a.takes)for(var b in a.takes){var c=a.takes[b],d;for(d in c.tracks)this.addTrackToTake(b,new LS.Animation.Track(c.tracks[d]))}};
Animation.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));var b=a["@json"],c;for(c in b.takes){var d=b.takes[c],e;for(e in d.tracks){var f=d.tracks[e],g="@take_"+c+"_track_"+e;a[g]&&(f.data=a[g])}}return new LS.Animation(b)};
Animation.prototype.toBinary=function(){var a={},b=[],c;for(c in this.takes){var d=this.takes[c],e;for(e in d.tracks){var f=d.tracks[e];if(f.packed_data){var g=f.data,h="@take_"+c+"_track_"+e;a[h]=g;f.data=null;b.push(g)}}}a["@json"]={takes:this.takes};b=WBin.create(a,"Animation");for(c in this.takes)for(e in d=this.takes[c],d.tracks)f=d.tracks[e],h="@take_"+c+"_track_"+e,a[h]&&(f.data=a[h]);return b};LS.Animation=Animation;
function Take(a){this.name=null;this.tracks=[];this.duration=0;if(a){a.name&&(this.name=a.name);if(a.tracks)for(var b in a.tracks)this.addTrack(a.tracks[b]);a.duration&&(this.duration=a.duration)}}Take.prototype.createTrack=function(a){if(!a)throw"Data missing when creating track";var b=this.getTrack(a.property);if(b)return b;b=new LS.Animation.Track(a);this.addTrack(b);return b};
Take.prototype.applyTracks=function(a){for(var b=0;b<this.tracks.length;++b){var c=this.tracks[b];if(!1!==c.enabled){var d=c.getSample(a,!0);void 0!==d&&LS.GlobalScene.setPropertyValueFromPath(c._property_path,d)}}};Take.prototype.addTrack=function(a){this.tracks.push(a)};Take.prototype.getTrack=function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].property==a)return this.tracks[b];return null};
Take.prototype.removeTrack=function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b]==a){this.tracks.splice(b,1);break}};Take.prototype.getPropertiesSample=function(a,b){b=b||[];for(var c=0;c<this.tracks.length;++c){var d=this.tracks[c],e=d.getSample(a);b.push([d.property,e])}return b};Take.prototype.actionPerSample=function(a,b,c){for(var d in this.tracks){var e=this.tracks[d],f=e.getSample(a,!0);c.disabled_tracks&&c.disabled_tracks[e.property]||b(e.property,f,c)}};Animation.Take=Take;
function Track(a){this.enabled=!0;this.name="";this.type=null;this.interpolation=LS.NONE;this.packed_data=this.looped=!1;this.value_size=0;this.data=null;Object.defineProperty(this,"_property",{value:"",enumerable:!1,writable:!0});Object.defineProperty(this,"_property_path",{value:[],enumerable:!1,writable:!0});a&&this.configure(a)}Object.defineProperty(Track.prototype,"property",{set:function(a){this._property=a;this._property_path=a.split("/")},get:function(){return this._property},enumerable:!0});
Track.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=a.enabled);a.name&&(this.name=a.name);a.property&&(this.property=a.property);a.type&&(this.type=a.type);a.looped&&(this.looped=a.looped);a.interpolation&&(this.interpolation=a.interpolation);a.data&&(this.value_size=a.value_size,this.data=a.data,a.data.constructor==Array?this.packed_data=!1:(this.packed_data=!0,this.unpackData()))};
Track.prototype.serialize=function(){var a={enabled:this.enabled,name:this.name,property:this.property,type:this.type,interpolation:this.interpolation,looped:this.looped,value_size:this.value_size,packed_data:!1};1>=this.value_size?a.data=this.data:(this.packData(),a.data=this.data,a.packed_data=this.packed_data);return a};
Track.prototype.addKeyframe=function(a,b){1<this.value_size&&(b=new Float32Array(b));if(this.packed_data)console.warn("TODO: add keyframe in packed data");else{for(var c=0;c<this.data.length;++c)if(!(this.data[c][0]<a)){this.data[c][0]==a?this.data[c][1]=b:this.data.splice(c,0,[a,b]);return}this.data.push([a,b])}};Track.prototype.getKeyframe=function(a){return this.packed_data?(a*=1+this.value_size,a>this.data.length-this.value_size?null:[this.data[a],this.data.subarray(a+1,a+this.value_size)]):this.data[a]};
Track.prototype.moveKeyframe=function(a,b){if(this.packed_data)console.warn("Cannot move keyframes if packed");else if(a>=this.data.length)console.warn("keyframe index out of bounds");else{var c=this.data.splice(a,1);c[0]=b;var d=this.findTimeIndex(b);this.data.splice(d,0,c)}};Track.prototype.removeKeyframe=function(a){this.packed_data?console.warn("Cannot move keyframes if packed"):a>=this.data.length?console.warn("keyframe index out of bounds"):this.data.splice(a,1)};
Track.prototype.getNumberOfKeyframes=function(){return this.packed_data?this.data.length/(1+this.value_size):this.data.length};Track.prototype.computeDuration=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){var a=this.data[this.data.length-2-this.value_size];return this.duration=a}return(a=this.data[this.data.length-1])?a[0]:0};
Track.prototype.packData=function(){if(!this.packed_data&&0!=this.value_size){for(var a=this.data,b=new Float32Array(a.length*(this.value_size+1)),c=0;c<a.length;++c)b[c]=a[0],b.set(a[1],c+1);this.data=b;this.packed_data=!0}};Track.prototype.unpackData=function(){if(this.packed_data){for(var a=this.value_size+1,b=this.data,c=Array(b.length/a),d=0;d<b.length;d+=a)c[d]=[b[d],b.subarray(d+1,d+a)];this.data=c;this.packed_data=!1}};
Track.prototype.findTimeIndex=function(a){var b=this.data,c=this.data.length;if(!c)return-1;var d=0;if(this.packed_data)for(var e=this.value_size+1,d=0;d<c;d+=e){if(!(b[d]<a))return d-1}else for(d=0;d<c;++d)if(!(a>b[d][0]))return 0==d?0:d-1;return c-1};
Track.prototype.getSample=function(a,b,c){a=Math.clamp(a,0,this.duration);var d=this.findTimeIndex(a);if(-1==d)return null;var e=d+1;if(!b||!this.interpolation||1==this.data.length||0==this.value_size||e==this.data.length)return this.data[d][1];var f=this.data;b=f[d];e=f[e];a=(e[0]-a)/(e[0]-b[0]);if(this.interpolation===LS.LINEAR){if(1==this.value_size)return b[1]*a+e[1]*(1-a);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));for(d=0;d<this.value_size;d++)c[d]=
b[1][d]*a+e[1][d]*(1-a);"quat"==this.type&&quat.normalize(c,c);return c}if(this.interpolation===LS.BEZIER){var g=0<d?f[d-1]:b,d=d<f.length-2?f[d+2]:e;if(1===this.value_size)return Animation.EvaluateHermiteSpline(b[1],e[1],g[1],d[1],1-a);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));c=c||this._result;c=Animation.EvaluateHermiteSplineVector(b[1],e[1],g[1],d[1],1-a,c);"quat"==this.type&&quat.normalize(c,c);return c}return null};
Track.prototype.getPropertyInfo=function(){return LS.GlobalScene.getPropertyInfo(this.property)};Track.prototype.getSampledData=function(a,b,c){b=(b-a)/c;if(0>=b)return null;for(var d=[],e=0;e<c;++e){var f=this.getSample(e*b+a,!0);1<this.value_size&&(f=new f.constructor(f));d.push(f)}return d};Animation.Track=Track;Animation.EvaluateHermiteSpline=function(a,b,c,d,e){var f=e*e,g=f*e;return(2*g-3*f+1)*a+(-2*g+3*f)*b+(g-2*f+e)*(b-c)+(g-f)*(d-a)};
Animation.EvaluateHermiteSplineVector=function(a,b,c,d,e,f){f=f||new Float32Array(f.length);var g=e*e,h=g*e,l=2*h-3*g+1,k=-2*h+3*g;e=h-2*g+e;g=h-g;for(h=0;h<f.length;++h)f[h]=l*a[h]+k*b[h]+e*(b[h]-c[h])+g*(d[h]-a[h]);return f};function Path(){this.points=[];this.closed=!1;this.type=Path.LINE}Path.LINE=1;Path.SPLINE=2;Path.BEZIER=3;Path.prototype.addPoint=function(a){var b=vec3.create();b[0]=a[0];b[1]=a[1];2<a.length&&(b[2]=a[2]);this.points.push(b)};
Path.prototype.getSegments=function(){var a=this.points.length;switch(this.type){case Path.LINE:if(2>a)break;return a-1;case Path.SPLINE:if(3>a)break;return(a-1)/3|0}return 0};Path.prototype.computePoint=function(a,b){switch(this.type){case Path.LINE:return this.getLinearPoint(a,b);default:return this.getSplinePoint(a,b)}};
Path.prototype.getLinearPoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(2>c)return b;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[c-1]);var c=(c-1)*a,d=c|0;return vec3.lerp(b,this.points[d],this.points[d+1],c-d)};
Path.prototype.getSplinePoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(4>c)return b;c=3*((c-1)/3|0)+1;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[c-1]);var c=(c-1)/3*a,d=c|0,e=c-d,c=this.points[d],f=this.points[d+1],g=this.points[d+2],d=this.points[d+3],h=(1-e)*(1-e)*(1-e),l=3*e*(1-e)*(1-e),k=3*e*e*(1-e),e=e*e*e;b[0]=c[0]*h+f[0]*l+g[0]*k+d[0]*e;b[1]=c[1]*h+f[1]*l+g[1]*k+d[1]*e;b[2]=c[2]*h+f[2]*l+g[2]*k+d[2]*e;return b};
Path.prototype.samplePoints=function(a){0>=a&&(a=this.getSegments(),a=this.type==LS.Path.LINE?a+1:20*a);for(var b=Array(a),c=0;c<a;c++)b[c]=this.computePoint(c/(a-1));return b};Path.prototype.serialize=function(){for(var a={},b=Array(3*this.points.length),c=0;c<this.points.length;c++){var d=this.points[c];b[3*c]=d[0];b[3*c+1]=d[1];b[3*c+2]=d[2]}a.points=b;a.type=this.type;a.closed=this.closed;return a};
Path.prototype.configure=function(a){this.type=a.type;this.closed=a.closed;if(a.points){this.points.length=a.points.length/3;a=a.points;for(var b=0;b<this.points.length;b++)this.points[b]=vec3.fromValues(a[3*b],a[3*b+1],a[3*b+2])}};LS.Path=Path;
function RenderOptions(a){this.current_renderer=this.current_pass=this.current_camera=this.main_camera=null;this.low_quality=this.lights_disabled=this.shadows_disabled=this.force_wireframe=this.ignore_clear=this.ignore_viewports=!1;this.sort_instances_by_priority=this.sort_instances_by_distance=this.in_player=this.render_fx=this.render_all_cameras=this.update_materials=this.update_shadowmaps=!0;this.z_pass=!1;this.frustum_culling=!0;this.default_shader_id="global";this.default_low_shader_id="lowglobal";
if(a)for(var b in a)this[b]=a[b]}LS.RenderOptions=RenderOptions;
var RI_CULL_FACE=1,RI_CW=2,RI_DEPTH_TEST=4,RI_DEPTH_WRITE=8,RI_ALPHA_TEST=16,RI_BLEND=32,RI_CAST_SHADOWS=256,RI_RECEIVE_SHADOWS=512,RI_IGNORE_LIGHTS=1024,RI_IGNORE_FRUSTUM=2048,RI_RENDER_2D=4096,RI_IGNORE_VIEWPROJECTION=8192,RI_IGNORE_CLIPPING_PLANE=16384,RI_RAYCAST_ENABLED=65536,RI_IGNORE_AUTOUPDATE=131072,RI_DEFAULT_FLAGS=RI_CULL_FACE|RI_DEPTH_TEST|RI_DEPTH_WRITE|RI_CAST_SHADOWS|RI_RECEIVE_SHADOWS,RI_2D_FLAGS=RI_RENDER_2D|RI_CULL_FACE|RI_BLEND|RI_IGNORE_LIGHTS|RI_IGNORE_FRUSTUM;
function RenderInstance(a,b){this._key="";this.uid=LS.generateUId("RINS");this.wireframe_index_buffer=this.index_buffer=this.vertex_buffers=null;this.range=new Int32Array([0,-1]);this.primitive=gl.TRIANGLES;this.lod_index_buffer=this.lod_vertex_buffers=this.lod_mesh=this.collision_mesh=this.mesh=null;this.node=a;this.component=b;this.priority=10;this.flags=RI_DEFAULT_FLAGS;this.blend_func=LS.BlendFunctions.normal;this.matrix=mat4.create();this.normal_matrix=mat4.create();this.center=vec3.create();
this.oobb=BBox.create();this.aabb=BBox.create();this.material=null;this.macros={};this.uniforms={};this.samplers={};this._dist=0;this._final_macros={};this._final_uniforms={};this._final_samplers={}}RenderInstance.prototype.setMatrix=function(a,b){this.matrix.set(a);b?this.normal_matrix.set(b):this.computeNormalMatrix()};RenderInstance.prototype.computeNormalMatrix=function(){var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)};
RenderInstance.prototype.setMaterial=function(a){(this.material=a)&&a.applyToRenderInstance(this)};
RenderInstance.prototype.setMesh=function(a,b){if(-1==b||void 0===b)b=gl.TRIANGLES;this.mesh=a;this.primitive=b;this.vertex_buffers=a.vertexBuffers;switch(b){case gl.TRIANGLES:this.index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.index_buffer=a.indexBuffers.lines;break;case 10:this.primitive=gl.LINES;a.indexBuffers.wireframe||a.computeWireframe();this.index_buffer=a.indexBuffers.wireframe;break;default:this.index_buffer=null}a.bounding?(this.oobb.set(a.bounding),this.flags&=~RI_IGNORE_FRUSTUM):
this.flags|=RI_IGNORE_FRUSTUM};
RenderInstance.prototype.setLODMesh=function(a){if(a)switch(this.lod_mesh=a,this.lod_vertex_buffers=a.vertexBuffers,this.primitive){case gl.TRIANGLES:this.lod_index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.lod_index_buffer=a.indexBuffers.lines;break;case 10:a.indexBuffers.wireframe||a.computeWireframe();this.lod_index_buffer=a.indexBuffers.wireframe;break;default:this.lod_index_buffer=null}else this.lod_index_buffer=this.lod_vertex_buffers=this.lod_mesh=null};
RenderInstance.prototype.setRange=function(a,b){this.range[0]=a;this.range[1]=b};
RenderInstance.prototype.applyNodeFlags=function(){var a=this.node.flags;this.flags=!0==a.two_sided?this.flags&~RI_CULL_FACE:this.flags|RI_CULL_FACE;this.flags=!0==a.flip_normals?this.flags|RI_CW:this.flags&~RI_CW;this.flags=!1==a.depth_test?this.flags&~RI_DEPTH_TEST:this.flags|RI_DEPTH_TEST;this.flags=!1==a.depth_write?this.flags&~RI_DEPTH_WRITE:this.flags|RI_DEPTH_WRITE;this.flags=!0==a.alpha_test?this.flags|RI_ALPHA_TEST:this.flags&~RI_ALPHA_TEST;this.flags=!1==a.cast_shadows?this.flags&~RI_CAST_SHADOWS:
this.flags|RI_CAST_SHADOWS;this.flags=!1==a.receive_shadows?this.flags&~RI_RECEIVE_SHADOWS:this.flags|RI_RECEIVE_SHADOWS};RenderInstance.prototype.enableFlag=function(a){this.flags|=a};RenderInstance.prototype.disableFlag=function(a){this.flags&=~a};RenderInstance.prototype.isFlag=function(a){return this.flags&a};RenderInstance.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};RenderInstance.prototype.update=function(){this.node&&this.node.transform&&this.setMatrix(this.node.transform._global_matrix)};
RenderInstance.prototype.render=function(a){this.lod_mesh&&0.1>this.oobb[12]/Math.max(0.1,this._dist)?a.drawBuffers(this.lod_vertex_buffers,this.lod_index_buffer,this.primitive):a.drawBuffers(this.vertex_buffers,this.index_buffer,this.primitive,this.range[0],this.range[1])};RenderInstance.prototype.overlapsSphere=function(a,b){return this.flags&RI_IGNORE_FRUSTUM?!0:geo.testSphereBBox(a,b,this.aabb)};LS.RenderInstance=RenderInstance;
function RenderFrameContainer(){this.width=RenderFrameContainer.default_width;this.height=RenderFrameContainer.default_height;this.use_high_precision=!1;this.use_depth_texture=!0;this.use_extra_texture=!1;this.camera=null}RenderFrameContainer.default_width=1024;RenderFrameContainer.default_height=512;RenderFrameContainer.prototype.useDefaultSize=function(){this.width=RenderFrameContainer.default_width;this.height=RenderFrameContainer.default_height};
RenderFrameContainer.prototype.useCanvasSize=function(){this.width=gl.canvas.width;this.height=gl.canvas.height};RenderFrameContainer.prototype.preRender=function(a,b){this.startFBO();if(this.depth_texture&&a[0]){var c=a[0];this.depth_texture.near_far_planes||(this.depth_texture.near_far_planes=vec2.create());this.depth_texture.near_far_planes[0]=c.near;this.depth_texture.near_far_planes[1]=c.far}};RenderFrameContainer.prototype.postRender=function(a,b){this.endFBO()};
RenderFrameContainer.prototype.startFBO=function(){var a=gl.RGBA,b=this.use_high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,c=this.width,d=this.height;this.color_texture&&this.color_texture.width==c&&this.color_texture.height==d&&this.color_texture.type==b||(this.color_texture=new GL.Texture(c,d,{filter:gl.LINEAR,format:a,type:b}));!this.use_extra_texture||this.extra_texture&&this.extra_texture.width==c&&this.extra_texture.height==d&&this.extra_texture.type==b?this.use_extra_texture||(this.extra_texture=
null):this.extra_texture=new GL.Texture(c,d,{filter:gl.LINEAR,format:a,type:b});!this.use_depth_texture||this.depth_texture&&this.depth_texture.width==c&&this.depth_texture.height==d?this.use_depth_texture||(this.depth_texture=null):this.depth_texture=new GL.Texture(c,d,{filter:gl.NEAREST,format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT});var e=null;this.depth_texture||(e=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),e.width=c,e.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,e));var f=
this.color_texture,g=this.depth_texture,a=this.extra_texture;this._fbo=this._fbo||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo);gl.viewport(0,0,f.width,f.height);LS.Renderer._full_viewport.set(gl.viewport_data);LS.Renderer.global_aspect=gl.canvas.width/gl.canvas.height/(f.width/f.height);b=gl.extensions.WEBGL_draw_buffers;gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,f.handler,0);b&&a&&gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+1,
gl.TEXTURE_2D,a.handler,0);g?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,g.handler,0):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,e));c=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(c!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+c;b&&a&&b.drawBuffersWEBGL([gl.COLOR_ATTACHMENT0,gl.COLOR_ATTACHMENT0+1])};
RenderFrameContainer.prototype.endFBO=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);LS.Renderer.global_aspect=1;gl.viewport(0,0,gl.canvas.width,gl.canvas.height);LS.Renderer._full_viewport.set(gl.viewport_data)};RenderFrameContainer.prototype.renderToViewport=function(a,b){if(b){var c=GL.Shader.getFXAAShader(),d=gl.getViewport(),e=Mesh.getScreenQuad();a.bind(0);c.uniforms({u_texture:0,uViewportSize:d.subarray(2,4),inverseVP:[1/tex.width,1/tex.height]}).draw(e)}else a.toViewport()};
LS.RenderFrameContainer=RenderFrameContainer;
var Renderer={default_render_options:new RenderOptions,default_material:new StandardMaterial,global_render_frame_containers:[],global_aspect:1,default_point_size:5,_full_viewport:vec4.create(),_current_scene:null,_current_render_options:null,_current_camera:null,_current_target:null,_visible_cameras:null,_visible_lights:null,_visible_instances:null,_rendercalls:0,_rendered_instances:0,_frame:0,_collect_frequency:1,_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),
_2Dviewprojection_matrix:mat4.create(),_mvp_matrix:mat4.create(),_temp_matrix:mat4.create(),_identity_matrix:mat4.create(),init:function(){this._missing_texture=new GL.Texture(1,1,{pixel_data:[128,128,128,255]});Draw.init();Draw.onRequestFrame=function(){LS.GlobalScene.refresh()}},reset:function(){},assignGlobalRenderFrameContainer:function(a){this.global_render_frame_containers.push(a)},setFullViewport:function(a,b,c,d){this._full_viewport[0]=a;this._full_viewport[1]=b;this._full_viewport[2]=c;this._full_viewport[3]=
d},render:function(a,b,c){b=b||this.default_render_options;b.current_renderer=this;b.current_scene=a;this._current_render_options=b;this._current_scene=a;this._main_camera=c?c[0]:null;b.main_camera=this._main_camera;a._frame+=1;this._frame+=1;a._must_redraw=!1;this._rendered_instances=this._rendercalls=0;this.setFullViewport(0,0,gl.canvas.width,gl.canvas.height);LEvent.trigger(a,"beforeRender",b);a.triggerInNodes("beforeRender",b);this.processVisibleData(a,b);this._visible_cameras=c=c||this._visible_cameras;
b.main_camera=c[0];LEvent.trigger(a,"renderShadows",b);a.triggerInNodes("renderShadows",b);a.triggerInNodes("afterVisibility",b);LEvent.trigger(a,"renderReflections",b);a.triggerInNodes("renderReflections",b);LEvent.trigger(a,"beforeRenderMainPass",b);a.triggerInNodes("beforeRenderMainPass",b);if(b.render_fx&&this.global_render_frame_containers.length){var d=this.global_render_frame_containers[0];b.current_renderframe=d;d.preRender&&d.preRender(c,b);this.renderFrameCameras(c,b,d);d.postRender&&d.postRender(c,
b)}else this.renderFrameCameras(c,b);this.global_render_frame_containers.length=0;LEvent.trigger(a,"afterRender",b);a.triggerInNodes("afterRender",b)},renderFrameCameras:function(a,b,c){c=this._current_scene;for(var d=0;d<a.length;++d){var e=a[d];LEvent.trigger(c,"beforeRenderFrame",b);LEvent.trigger(e,"beforeRenderFrame",b);this.renderFrame(e,b);LEvent.trigger(e,"afterRenderFrame",b);LEvent.trigger(c,"afterRenderFrame",b)}},renderFrame:function(a,b,c){c&&this.processVisibleData(c,b);c=c||this._current_scene;
LEvent.trigger(c,"beforeCameraEnabled",a);this.enableCamera(a,b,b.skip_viewport);LEvent.trigger(c,"afterCameraEnabled",a);gl.scissor(gl.viewport_data[0],gl.viewport_data[1],gl.viewport_data[2],gl.viewport_data[3]);gl.enable(gl.SCISSOR_TEST);var d=c.info;d?gl.clearColor(d.background_color[0],d.background_color[1],d.background_color[2],d.background_color[3]):gl.clearColor(0,0,0,0);!0!=b.ignore_clear&&(a.clear_color||a.clear_depth)&&gl.clear((a.clear_color?gl.COLOR_BUFFER_BIT:0)|(a.clear_depth?gl.DEPTH_BUFFER_BIT:
0));gl.disable(gl.SCISSOR_TEST);b.current_pass="color";LEvent.trigger(c,"beforeRenderScene",a);c.triggerInNodes("beforeRenderScene",a);this.renderInstances(b);LEvent.trigger(c,"afterRenderScene",a);c.triggerInNodes("afterRenderScene",a)},enableCamera:function(a,b,c){LEvent.trigger(a,"beforeEnabled",b);var d=this._full_viewport[2],e=this._full_viewport[3],f=Math.floor(d*a._viewport[0]+this._full_viewport[0]),g=Math.floor(e*a._viewport[1]+this._full_viewport[1]),h=Math.ceil(d*a._viewport[2]),l=Math.ceil(e*
a._viewport[3]);c||(b&&b.ignore_viewports?(a._real_aspect=d/e*a._aspect*this.global_aspect,gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3])):(a._real_aspect=h/l*a._aspect*this.global_aspect,gl.viewport(f,g,h,l)));a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);mat4.ortho(this._2Dviewprojection_matrix,-1,1,-1,
1,1,-1);this._current_camera=a;b&&(b.current_camera=a);Draw.reset();Draw.setCameraPosition(a.getEye());Draw.setViewProjectionMatrix(this._view_matrix,this._projection_matrix,this._viewprojection_matrix);LEvent.trigger(a,"afterEnabled",b)},renderInstances:function(a){var b=this._current_scene;if(!b)return console.warn("Renderer.renderInstances: no scene found");var c=geo.extractPlanes(this._viewprojection_matrix,this.frustum_planes);this.frustum_planes=c;var d=a.frustum_culling;LEvent.trigger(b,"beforeRenderInstances",
a);b.triggerInNodes("beforeRenderInstances",a);this.fillSceneShaderMacros(b,a);this.fillSceneShaderUniforms(b,a);if(!a.is_shadowmap&&!a.is_picking&&b.info.textures.background){var e=null;"string"==typeof b.info.textures.background&&(e=LS.ResourcesManager.textures[b.info.textures.background]);e&&(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),e.toViewport())}this.resetGLState();var e=this._visible_lights,f=e.length,g=this._visible_instances;LEvent.trigger(b,"renderInstances",a);this.resetGLState();
for(var h=0,l=g.length;h<l;++h){var k=g[h],m=k.node.flags;k._in_camera=!1;a.is_rt&&!1==m.seen_by_reflections||a.is_shadowmap&&!(k.flags&RI_CAST_SHADOWS)||!(!1!=m.seen_by_camera||a.is_shadowmap||a.is_picking||a.is_reflection)||!1==m.seen_by_picking&&a.is_picking||!1==m.selectable&&a.is_picking||k.onPreRender&&!1===k.onPreRender(a)||0>=k.material.opacity||d&&!(k.flags&RI_IGNORE_FRUSTUM)&&geo.frustumTestBox(c,k.aabb)==CLIP_OUTSIDE||(k._in_camera=!0)}c=[];h=0;for(l=g.length;h<l;++h)if(k=g[h],k._in_camera){if(k.flags&
RI_RENDER_2D)this.render2DInstance(k,b,a);else if(this._rendered_instances+=1,a.is_shadowmap)this.renderShadowPassInstance(k,a);else if(a.is_picking)this.renderPickingInstance(k,a);else{for(d=c.length=0;d<f;d++)if(m=e[d],!(1E-4>m.computeLightIntensity())){var n=m.computeLightRadius(),p=m.position;(-1==n||k.overlapsSphere(p,n))&&c.push(m)}this.renderColorPassInstance(k,c,b,a)}if(k.onPostRender)k.onPostRender(a)}LEvent.trigger(b,"renderScreenSpace",a);a.is_shadowmap||a.is_picking||!b.info.textures.foreground||
(e=null,"string"==typeof b.info.textures.foreground&&(e=LS.ResourcesManager.textures[b.info.textures.foreground]),e&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.disable(gl.DEPTH_TEST),e.toViewport(),gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)));this.resetGLState();LEvent.trigger(b,"afterRenderInstances",a);b.triggerInNodes("afterRenderInstances",a);this.resetGLState()},resetGLState:function(){gl.enable(gl.CULL_FACE);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.depthFunc(gl.LESS);
gl.depthMask(!0);gl.frontFace(gl.CCW);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)},bindSamplers:function(a,b){var c={},d=0,e;for(e in a){var f=a[e];if(!f)throw"Samplers should always be valid values";var g=null;if(f.constructor===String||f.constructor===Texture)g=f,f=null;else if(f.texture)g=f.texture;else continue;g.constructor===String&&(g=LS.ResourcesManager.textures[g]);g||(g=this._missing_texture);c[e]=g.bind(d++);f&&(f.minFilter&&gl.texParameteri(g.texture_type,gl.TEXTURE_MIN_FILTER,f.minFilter),
f.magFilter&&gl.texParameteri(g.texture_type,gl.TEXTURE_MAG_FILTER,f.magFilter),f.wrap&&(gl.texParameteri(g.texture_type,gl.TEXTURE_WRAP_S,f.wrap),gl.texParameteri(g.texture_type,gl.TEXTURE_WRAP_T,f.wrap)))}return c},renderColorPassInstance:function(a,b,c,d){var e=a.node,f=a.material,g=a.matrix;a.flags&RI_IGNORE_VIEWPROJECTION?this._mvp_matrix.set(g):mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,g);var h=a._final_macros,l=a._final_uniforms,k=a._final_samplers;l.u_model=g;l.u_normal_model=
a.normal_matrix;l.u_mvp=this._mvp_matrix;this.enableInstanceFlags(a,d);f.blend_mode!==Blend.NORMAL?(gl.enable(gl.BLEND),gl.blendFunc(a.blend_func[0],a.blend_func[1])):gl.disable(gl.BLEND);g={};g.merge(c._samplers);g.merge(k);k=this.bindSamplers(g);g=d.default_shader_id;d.low_quality&&(g=d.default_low_shader_id);f.shader_name&&(g=f.shader_name);var m=b.length,n=e.flags.ignore_lights||a.flags&RI_IGNORE_LIGHTS||d.lights_disabled;if(!m||n){var p={FIRST_PASS:"",USE_AMBIENT_ONLY:""};p.merge(c._macros);
p.merge(h);n&&(p.USE_IGNORE_LIGHTS="");!d.clipping_plane||a.flags&RI_IGNORE_CLIPPING_PLANE||(p.USE_CLIPPING_PLANE="");if(f.onModifyMacros)f.onModifyMacros(p);p=ShadersManager.get(g,p);p.uniformsArray([k,c._uniforms,l]);a.render(p);this._rendercalls+=1}else for(n=0;n<m;n++){var q=b[n],p=null;if(!p){var r=q.getMacros(a,d),p={};0===n&&(p.FIRST_PASS="");n===m-1&&(p.LAST_PASS="");p.merge(c._macros);p.merge(h);p.merge(r);!d.clipping_plane||a.flags&RI_IGNORE_CLIPPING_PLANE||(p.USE_CLIPPING_PLANE="");if(f.onModifyMacros)f.onModifyMacros(p);
p=ShadersManager.get(g,p)}q=q.getUniforms(a,d);0<n&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthFunc(gl.LEQUAL),e.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));f.depth_func&&gl.depthFunc(gl[f.depth_func]);p.uniformsArray([k,c._uniforms,l,q]);a.render(p);this._rendercalls+=1;if(p.global&&!p.global.multipass)break}},renderShadowPassInstance:function(a,b){var c=this._current_scene,d=a.node,e=a.matrix;mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,
e);var f=a._final_macros,g=a._final_uniforms,h=a._final_samplers;g.u_model=e;g.u_normal_model=a.normal_matrix;g.u_mvp=this._mvp_matrix;this.enableInstanceFlags(a,b);e={};e.merge(c._macros);e.merge(f);this._current_target&&this._current_target.texture_type===gl.TEXTURE_CUBE_MAP&&(e.USE_LINEAR_DISTANCE="");!0==d.flags.alpha_shadows&&(e.USE_ALPHA_TEST="0.5");d=ShadersManager.get("depth",e);f={};f.merge(c._samplers);f.merge(h);h=this.bindSamplers(f,d);d.uniformsArray([h,c._uniforms,a._final_uniforms]);
a.render(d);this._rendercalls+=1},render2DInstance:function(a,b,c){var d=a.node,e=a.material,f=this._temp_matrix;mat4.identity(f);var g=vec3.create();if(a.pos2D)g.set(a.pos2D);else{mat4.projectVec3(g,this._viewprojection_matrix,a.center);if(0>g[2])return;g[2]=0}mat4.translate(f,f,g);g=vec3.fromValues(1,gl.canvas.width/gl.canvas.height,1);a.scale_2D&&(g[0]*=a.scale_2D[0],g[1]*=a.scale_2D[1]);mat4.scale(f,f,g);mat4.multiply(this._mvp_matrix,this._2Dviewprojection_matrix,f);d=d._uniforms;d.u_mvp=this._mvp_matrix;
d.u_model=f;d.u_normal_model=this._identity_matrix;this.enableInstanceFlags(a,c);e.blend_mode!=Blend.NORMAL?(gl.enable(gl.BLEND),gl.blendFunc(a.blend_func[0],a.blend_func[1])):(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE));c=ShadersManager.get("flat_texture");f={};f.merge(b._samplers);f.merge(a._final_samplers);b=this.bindSamplers(f,c);c.uniformsArray([b,d,e._uniforms,a.uniforms]);a.render(c);this._rendercalls+=1},renderPickingInstance:function(a,b){var c=this._current_scene,d=a.node,e=a.matrix;
mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,e);var d=LS.Picking.getNextPickingColor(d),f={};f.merge(c._macros);f.merge(a._final_macros);f=ShadersManager.get("flat",f);f.uniforms(c._uniforms);f.uniforms(a.uniforms);f.uniforms({u_model:e,u_pointSize:this.default_point_size,u_mvp:this._mvp_matrix,u_material_color:d});a.render(f)},fillSceneShaderMacros:function(a,b){var c={};b.current_camera.type==Camera.ORTHOGRAPHIC&&(c.USE_ORTHOGRAPHIC_CAMERA="");"color"==b&&(b.brightness_factor&&1!=
b.brightness_factor&&(c.USE_BRIGHTNESS_FACTOR=""),b.colorclip_factor&&(c.USE_COLORCLIP_FACTOR=""));b.current_renderframe&&b.current_renderframe.use_extra_texture&&(c.USE_DRAW_BUFFERS="");LEvent.trigger(a,"fillSceneMacros",c);a._macros=c},fillSceneShaderUniforms:function(a,b){var c=b.current_camera,c={u_camera_eye:c.getEye(),u_camera_front:c.getFront(),u_pointSize:this.default_point_size,u_camera_planes:[c.near,c.far],u_camera_perspective:c.type==Camera.PERSPECTIVE?[c.fov*DEG2RAD,512/Math.tan(c.fov*
DEG2RAD)]:[c._frustum_size,512/c._frustum_size],u_time:a._time||0.001*getTime(),u_brightness_factor:null!=b.brightness_factor?b.brightness_factor:1,u_colorclip_factor:null!=b.colorclip_factor?b.colorclip_factor:0,u_ambient_light:a.info.ambient_color,u_background_color:a.info.background_color.subarray(0,3),u_viewport:gl.viewport_data};b.clipping_plane&&(c.u_clipping_plane=b.clipping_plane);a._uniforms=c;a._samplers={};for(var d in a.info.textures)if((c=LS.getTexture(a.info.textures[d]))&&("environment"==
d||"irradiance"==d)){var e=c.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap";c.texture_type==gl.TEXTURE_2D&&(c.bind(0),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));a._samplers[d+e]=c;a._macros["USE_"+(d+e).toUpperCase()]="uvs_polar_reflected"}LEvent.trigger(a,"fillSceneUniforms",a._uniforms)},enableInstanceFlags:function(a,b){var c=a.flags;c&RI_CULL_FACE?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);c&RI_DEPTH_TEST?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);
c&RI_DEPTH_WRITE?gl.depthMask(!0):gl.depthMask(!1);var d=gl.CCW;c&RI_CW&&(d=gl.CW);b.reverse_backfacing&&(d=d==gl.CW?gl.CCW:gl.CW);gl.frontFace(d)},processVisibleData:function(a,b){0==this._frame%this._collect_frequency?a.collectData():a.updateCollectedData();LEvent.trigger(a,"afterCollectData",a);b.main_camera||(b.main_camera=a._cameras.length?a._cameras[0]:new LS.Camera);for(var c=[],d=[],e={},f=a._instances,g=b.main_camera.getEye(),h=0,l=f.length;h<l;++h){var k=f[h];if(k){k.material||(k.material=
this.default_material);e[k.material.uid]=k.material;k._dist=vec3.dist(k.center,g);b.force_wireframe&&k.primitive!=gl.LINES&&(k.primitive=gl.LINES,k.mesh&&(k.mesh.indexBuffers.wireframe||k.mesh.computeWireframe(),k.index_buffer=k.mesh.indexBuffers.wireframe));k.flags&RI_BLEND?d.push(k):c.push(k);var m=k.macros;k.flags&RI_ALPHA_TEST?m.USE_ALPHA_TEST="0.5":m.USE_ALPHA_TEST&&delete m.USE_ALPHA_TEST;k=k.vertex_buffers;"normals"in k||(m.NO_NORMALS="");"coords"in k||(m.NO_COORDS="");"coords1"in k&&(m.USE_COORDS1_STREAM=
"");"colors"in k&&(m.USE_COLOR_STREAM="");"tangents"in k&&(m.USE_TANGENT_STREAM="")}}b.sort_instances_by_distance&&(c.sort(this._sort_near_to_far_func),d.sort(this._sort_far_to_near_func));g=c.concat(d);b.sort_instances_by_priority&&g.sort(this._sort_by_priority_func);b.update_materials&&this._prepareMaterials(e,a);h=0;for(l=f.length;h<l;++h){var k=f[h],n=k.node,p=k.material,m=k._final_macros;wipeObject(m);m.merge(n._macros);m.merge(p._macros);m.merge(k.macros);m=k._final_uniforms;wipeObject(m);m.merge(n._uniforms);
m.merge(p._uniforms);m.merge(k.uniforms);m=k._final_samplers;wipeObject(m);m.merge(p._samplers);m.merge(k.samplers)}f=a._lights;this._blend_instances=d;this._opaque_instances=c;this._visible_instances=g;this._visible_lights=a._lights;this._visible_cameras=a._cameras;this._visible_materials=e;h=0;for(l=f.length;h<l;++h)f[h].prepare(b)},_prepareMaterials:function(a,b){for(var c in a){var d=a[c];d._macros||(d._macros={},d._uniforms={},d._samplers={});d.fillSurfaceShaderMacros(b);d.fillSurfaceUniforms(b)}},
_sort_far_to_near_func:function(a,b){return b._dist-a._dist},_sort_near_to_far_func:function(a,b){return a._dist-b._dist},_sort_by_priority_func:function(a,b){return b.priority-a.priority},renderInstancesToRT:function(a,b,c){function d(){var a=Renderer._current_scene;gl.clearColor(a.info.background_color[0],a.info.background_color[1],a.info.background_color[2],a.info.background_color[3]);!0!=c.ignore_clear&&gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.renderInstances(c)}c=c||this.default_render_options;
this._current_target=b;b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a,c),b.drawTo(d)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),b.width,b,c,a.near,a.far);this._current_target=null},renderToCubemap:function(a,b,c,d,e,f){b=b||256;e=e||1;f=f||1E3;c&&c.constructor==Texture||(c=null);var g=this._current_scene;this._current_target=c=c||new Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c.drawTo(function(b,c){var k=Camera.cubemap_camera_parameters;d.is_shadowmap||
!g.info?gl.clearColor(0,0,0,0):gl.clearColor(g.info.background_color[0],g.info.background_color[1],g.info.background_color[2],g.info.background_color[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);k=new Camera({eye:a,center:[a[0]+k[c].dir[0],a[1]+k[c].dir[1],a[2]+k[c].dir[2]],up:k[c].up,fov:90,aspect:1,near:e,far:f});Renderer.enableCamera(k,d,!0);Renderer.renderInstances(d)});this._current_target=null;return c},renderMaterialPreview:function(a,b,c){c=c||{};var d=this._material_scene;if(!d){d=
this._material_scene=new LS.SceneTree;d.info.background_color.set([0,0,0,0]);c.environment_texture&&(d.info.textures.environment=c.environment_texture);c=new LS.SceneNode("sphere");var e=new LS.Components.GeometricPrimitive({size:40,subdivisions:50,geometry:LS.Components.GeometricPrimitive.SPHERE});c.addComponent(e);d.root.addChild(c)}c=d.getNodeById("sphere");c.material=a;a=new GL.Texture(b,b);a.drawTo(function(){LS.Renderer.renderFrame(d.root.camera,{skip_viewport:!0},d)});return a.toCanvas(null,
!0)}};LS.Renderer=Renderer;
var Picking={_pickingMap:null,_picking_color:new Uint8Array(4),_picking_depth:0,_picking_next_color_id:0,_picking_nodes:{},_picking_render_options:new RenderOptions({is_picking:!0}),renderPickingBuffer:function(a,b,c,d){var e=this;if(null==this._pickingMap||this._pickingMap.width!=gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST}),LS.ResourcesManager.textures[":picking"]=this._pickingMap;this._picking_next_color_id=
0;this._current_target=this._pickingMap;this._pickingMap.drawTo(function(){LS.Renderer.enableCamera(b,e._picking_render_options);gl.scissor(c-1,d-1,2,2);gl.enable(gl.SCISSOR_TEST);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);e._picking_render_options.current_pass="picking";LS.Renderer.renderInstances(e._picking_render_options);LEvent.trigger(a,"renderPicking",[c,d]);gl.readPixels(c,d,1,1,gl.RGBA,gl.UNSIGNED_BYTE,e._picking_color);gl.disable(gl.SCISSOR_TEST)});this._current_target=
null;return this._picking_color},getNodeAtCanvasPosition:function(a,b,c,d){return(a=this.getInstanceAtCanvasPosition(a,b,c,d))?a.constructor==SceneNode?a:a._root&&a._root.constructor==SceneNode?a._root:a.node?a.node:null:null},getInstanceAtCanvasPosition:function(a,b,c,d){b=b||a.getCamera();this._picking_nodes={};this.renderPickingBuffer(a,b,c,d);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a},raycast:function(a,
b,c,d){d=d||Number.MAX_VALUE;a=a._instances;for(var e=[],f=vec3.create(),g=vec3.create(),h=0;h<a.length;++h){var l=a[h];if(l.flags&RI_RAYCAST_ENABLED&&!(l.flags&RI_BLEND)){var k=vec3.create();if(geo.testRayBBox(b,c,l.aabb,null,k,d)){var m=l.matrix,n=mat4.invert(mat4.create(),m);mat4.multiplyVec3(f,n,b);mat4.rotateVec3(g,n,c);if(geo.testRayBBox(f,g,l.oobb,null,k,d)){if(l.collision_mesh){var n=l.collision_mesh,p=n.octree;p||(p=n.octree=new Octree(n));n=p.testRay(f,g,0,d);if(!n)continue;mat4.multiplyVec3(k,
m,n.pos)}else vec3.transformMat4(k,k,m);m=vec3.distance(b,k);m<d&&e.push([l,k,m])}}}}e.sort(function(a,b){return a[2]-b[2]});return e},getNextPickingColor:function(a){this._picking_next_color_id+=10;var b=new Uint32Array(1);b[0]=this._picking_next_color_id;b=new Uint8Array(b.buffer);this._picking_nodes[this._picking_next_color_id]=a;return new Float32Array([b[0]/255,b[1]/255,b[2]/255,1])}};LS.Picking=Picking;
function PhysicsInstance(a,b){this.uid=LS.generateUId("PHSX");this.type=PhysicsInstance.BOX;this.mesh=null;this.node=a;this.component=b;this.matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create()}PhysicsInstance.BOX=1;PhysicsInstance.SPHERE=2;PhysicsInstance.PLANE=3;PhysicsInstance.CAPSULE=4;PhysicsInstance.MESH=5;PhysicsInstance.FUNCTION=6;PhysicsInstance.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};
PhysicsInstance.prototype.setMesh=function(a){this.mesh=a;this.type=PhysicsInstance.MESH;BBox.setCenterHalfsize(this.oobb,BBox.getCenter(a.bounding),BBox.getHalfsize(a.bounding))};LS.PhysicsInstance=PhysicsInstance;
var Physics={raycast:function(a,b,c){a=a._colliders;for(var d=[],e=vec3.create(),f=vec3.create(),g=0;g<a.length;++g){var h=a[g],l=vec3.create();if(geo.testRayBBox(b,c,h.aabb,null,l)){var k=h.matrix,m=mat4.invert(mat4.create(),k);mat4.multiplyVec3(e,m,b);mat4.rotateVec3(f,m,c);if(h.type==PhysicsInstance.SPHERE){if(!geo.testRaySphere(e,f,h.center,h.oobb[3],l))continue;vec3.transformMat4(l,l,k)}else{if(!geo.testRayBBox(e,f,h.oobb,null,l))continue;if(h.type==PhysicsInstance.MESH){m=h.mesh.octree;m||(m=
h.mesh.octree=new Octree(h.mesh));m=m.testRay(e,f,0,1E4);if(!m)continue;mat4.multiplyVec3(l,k,m.pos)}else vec3.transformMat4(l,l,k)}k=vec3.distance(b,l);d.push([h,l,k])}}d.sort(function(a,b){return a[2]-b[2]});return d}};LS.Physics=Physics;
var Parser={flipAxis:0,merge_smoothgroups:!1,safe_parsing:!1,image_extensions:["png","jpg"],nonative_image_extensions:["tga","dds"],mesh_extensions:"obj bin ase gr2 json jsmesh".split(" "),scene_extensions:["dae"],generic_extensions:["xml","js","json"],xml_extensions:["xml","dae"],json_extensions:["js","json"],binary_extensions:["bin","tga","dds"],parsers:{},registerParser:function(a){this.parsers[a.extension]=a},parse:function(a,b,c){c=c||{};var d=this.getFileFormatInfo(a);c.extension&&(d.extension=
c.extension);var e=this.parsers[d.extension];if(!e)return console.error("Parser Error: No parser found for "+d.extension+" format"),null;d=null;if(this.safe_parsing)try{d=e.parse(b,c,a)}catch(f){return console.error("Error parsing content",f),null}else d=e.parse(b,c,a);d&&(d.name=a);return d},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var e=0;e<b.width;++e)for(var f=
0;f<b.height;++f){var g=f*b.width*4+4*e,h=(b.height-f-1)*b.width*3+3*e;d.data[g+2]=a.pixels[h];d.data[g+1]=a.pixels[h+1];d.data[g+0]=a.pixels[h+2];d.data[g+3]=255}else for(e=0;e<b.width;++e)for(f=0;f<b.height;++f)g=f*b.width*4+4*e,h=(b.height-f-1)*b.width*4+4*e,d.data[g+0]=a.pixels[h+2],d.data[g+1]=a.pixels[h+1],d.data[g+2]=a.pixels[h+0],d.data[g+3]=a.pixels[h+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=
[a[0],a[1],a[2]],d=0;d<a.length;d+=3){var e=[a[d],a[d+1],a[d+2]];e[0]<b[0]?b[0]=e[0]:e[0]>c[0]&&(c[0]=e[0]);e[1]<b[1]?b[1]=e[1]:e[1]>c[1]&&(c[1]=e[1]);e[2]<b[2]?b[2]=e[2]:e[2]>c[2]&&(c[2]=e[2])}a=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return BBox.setCenterHalfsize(BBox.create(),a,b)},stringToTypedArray:function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c},typedArrayToString:function(a,b){for(var c="",d=0;d<
a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c},JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",TEXT_FORMAT:"text",MESH_DATA:"MESH",SCENE_DATA:"SCENE",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(a){var b=a.substr(a.lastIndexOf(".")+1).toLowerCase();a={filename:a,extension:b};a.format=Parser.TEXT_FORMAT;-1!=this.xml_extensions.indexOf(b)?a.format=Parser.XML_FORMAT:-1!=this.json_extensions.indexOf(b)?
a.format=Parser.JSON_FORMAT:-1!=this.binary_extensions.indexOf(b)&&(a.format=Parser.BINARY_FORMAT);-1!=this.image_extensions.indexOf(b)?a.type=Parser.IMAGE_DATA:-1!=this.mesh_extensions.indexOf(b)?a.type=Parser.MESH_DATA:-1!=this.scene_extensions.indexOf(b)?a.type=Parser.SCENE_DATA:-1!=this.nonative_image_extensions.indexOf(b)?a.type=Parser.NONATIVE_IMAGE_DATA:-1!=this.generic_extensions.indexOf(b)&&(a.type=Parser.GENERIC_DATA);return a}},parserASE={extension:"ase",data_type:"mesh",format:"text",
parse:function(a,b){b=b||{};var c=[],d=[],e=[],f=[],g=[],h=null,h=null,l=0,k=-1,m=null,n=[],p=Parser.flipAxis;null!=b.flipAxis&&(p=b.flipAxis);for(var q=p||b.flipNormals,r=a.split("\n"),s=0;s<r.length;++s)if(h=r[s].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==h[0]&&(h=h.substr(1,h.length)),""!=h)if(h=h.split(" "),"*MESH"==h[0]){if(l+=1,f=[],g=[],1<l)break}else if("*NODE_NAME"==h[0])h[1].substr(1,h[1].length-2);else if("*MESH_VERTEX"==h[0])p?f.push([-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])]):
f.push([parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])]);else if("*MESH_FACE"==h[0]){var u=parseInt(h[17]);k!=u&&(k=u,null!=m&&(m.length=c.length/3-m.start,0<m.length&&n.push(m)),m={name:"mat_"+u,start:c.length/3,length:-1,material:""});u=f[parseInt(h[3])];c.push(u[0],u[1],u[2]);u=f[parseInt(h[5])];c.push(u[0],u[1],u[2]);u=f[parseInt(h[7])];c.push(u[0],u[1],u[2])}else"*MESH_TVERT"==h[0]?g.push([parseFloat(h[2]),parseFloat(h[3])]):"*MESH_TFACE"==h[0]?(u=g[parseInt(h[2])],d.push(u[0],u[1]),u=g[parseInt(h[3])],
d.push(u[0],u[1]),u=g[parseInt(h[4])],d.push(u[0],u[1])):"*MESH_VERTEXNORMAL"==h[0]&&(q?e.push(-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])):e.push(parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])));f=c.length/3-m.start;m&&1<f&&(m.length=f,n.push(m));m={info:{}};m.vertices=new Float32Array(c);0<e.length&&(m.normals=new Float32Array(e));0<d.length&&(m.coords=new Float32Array(d));m.bounding=Parser.computeMeshBounding(m.vertices);1<n.length&&(m.info.groups=n);return m}};Parser.registerParser(parserASE);
(function(a){function b(a,b){var c=new XMLHttpRequest;c.onload=function(){200==this.status&&b&&b(this.response)};-1==a.indexOf("://")&&(a=Collada.dataPath+a);c.open("get",a,!0);c.send()}var c=void 0===a.document,d=2*Math.PI/360;c&&(a.console={log:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"log",params:b})},warn:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"warn",params:b})},error:function(a){var b=Array.prototype.slice.call(arguments,
0);self.postMessage({action:"error",params:b})}},a.alert=console.error);a.Collada={libsPath:"./",workerPath:"./",no_flip:!0,use_transferables:!0,onerror:null,verbose:!1,config:{forceParser:!1},init:function(a){a=a||{};for(var b in a)this[b]=a[b];this.config=a;if(c)try{importScripts(this.libsPath+"gl-matrix-min.js",this.libsPath+"tinyxml.js")}catch(d){Collada.throwException(Collada.LIBMISSING_ERROR)}mat4.create();vec3.create();vec3.create();vec3.create();quat.create();mat4.fromDAE=function(a){a=new Float32Array(JSON.parse("["+
a.split(" ").join(",")+"]"));mat4.transpose(a,a);return a};c&&console.log("Collada worker ready")},load:function(a,c){b(a,function(a){a?c(Collada.parse(a)):c(null)})},_xmlroot:null,_nodes_by_id:null,_transferables:null,safeString:function(a){return a?a.replace(/ /g,"_"):""},LIBMISSING_ERROR:"Libraries loading error, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath",NOXMLPARSER_ERROR:"TinyXML not found, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath (Workers do not allow to access the native XML DOMParser)",
throwException:function(a){if(c)self.postMessage({action:"exception",msg:a});else if(Collada.onerror)Collada.onerror(a);throw a;},getFilename:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));b=a.lastIndexOf("/");-1!=b&&(a=a.substr(b+1));return a},parse:function(b,c,d){d=d||"_dae_"+Date.now()+".dae";var h=null;c=null;this._transferables=[];this.verbose&&console.log(" - XML parsing...");if(a.DOMParser&&!this.config.forceParser)h=new DOMParser,c=h.parseFromString(b,"text/xml"),this.verbose&&
console.log(" - XML parsed");else{if(!a.DOMImplementation)return Collada.throwException(Collada.NOXMLPARSER_ERROR);try{h=new DOMImplementation}catch(l){return Collada.throwException(Collada.NOXMLPARSER_ERROR)}c=h.loadXML(b);this.verbose&&console.log(" - XML parsed");b=c._nodes_by_id={};for(var h=0,k=c.all.length;h<k;++h){var m=c.all[h];b[m.id]=m;m.getAttribute("sid")&&(b[m.getAttribute("sid")]=m)}this.extra_functions||(this.extra_functions=!0,DOMDocument.prototype.querySelector=DOMElement.prototype.querySelector=
function(a){a=a.split(" ");for(var b=this;a.length;){var c=a.shift().split("#"),d=c[0],c=c[1],d=d?b.getElementsByTagName(d):b.childNodes;if(c)for(var e=0;e<d.length;e++){if(d.item(e).getAttribute("id")==c){if(0==a.length)return d.item(e);b=d.item(e);break}}else{if(0==a.length)return d.item(0);b=d.item(0)}}return null},DOMDocument.prototype.querySelectorAll=DOMElement.prototype.querySelectorAll=function(a){function b(a,c){if(c){var e=c.shift(),e=a.getElementsByTagName(e);if(0==c.length)for(var f=0;f<
e.length;f++)d.push(e.item(f));else for(f=0;f<e.length;f++)b(e.item(f),c.concat())}}var c=a.split(" ");if(1==c.length)return this.getElementsByTagName(a);var d=[];b(this,c);a=new DOMNodeList(this.documentElement);a._nodes=d;a.length=d.length;return a},Object.defineProperty(DOMElement.prototype,"textContent",{get:function(){return this.getChildNodes().item(0).toString()},set:function(){}}))}this._xmlroot=c;if(b=c.querySelector("COLLADA"))this._current_DAE_version=b.getAttribute("version"),console.log("DAE Version:"+
this._current_DAE_version);h=c.getElementsByTagName("visual_scene").item(0);if(!h)throw"visual_scene XML node not found in DAE";this._nodes_by_id={};b={object_type:"SceneTree",light:null,materials:{},meshes:{},resources:{},root:{children:[]},external_files:{}};k=h.childNodes;for(h=0;h<k.length;h++)"node"==k.item(h).localName&&(m=this.readNodeTree(k.item(h),b,0,!1))&&b.root.children.push(m);for(h=0;h<k.length;h++)"node"==k.item(h).localName&&this.readNodeInfo(k.item(h),b,0,!1);if(h=this.readAnimations(c,
b))d="#animations_"+d.substr(0,d.indexOf(".")),b.resources[d]=h,b.root.animations=d;b.images=this.readImages(c);return b},readNodeTree:function(a,b,c,d){var l=this.safeString(a.getAttribute("id")),k=this.safeString(a.getAttribute("sid"));if(!l&&!k)return null;l={id:k||l,children:[],_depth:c};a.getAttribute("type");var m=a.getAttribute("name");m&&(l.name=m);this._nodes_by_id[l.id]=l;k&&(this._nodes_by_id[k]=l);l.model=this.readTransform(a,c,d);for(k=0;k<a.childNodes.length;k++)m=a.childNodes.item(k),
"node"==m.localName&&(m=this.readNodeTree(m,b,c+1,d))&&l.children.push(m);return l},readNodeInfo:function(a,b,c,d){var l=this.safeString(a.getAttribute("id")),k=this.safeString(a.getAttribute("sid"));if(!l&&!k)return null;l=this._nodes_by_id[l||k];for(k=0;k<a.childNodes.length;k++){var m=a.childNodes.item(k);if("node"==m.localName)this.readNodeInfo(m,b,c+1,d);else{if("instance_geometry"==m.localName){var n=m.getAttribute("url"),p=n.toString().substr(1);l.mesh=p;if(!b.meshes[n]){var q=this.readGeometry(n,
d);q&&(q.name=p,b.meshes[p]=q)}if(n=m.querySelectorAll("instance_material"))for(q=0;q<n.length;++q)if(p=n.item(q)){p=p.getAttribute("target").toString().substr(1);if(!b.meshes[p]){var r=this.readMaterial(p);r&&(r.id=p,b.materials[r.id]=r)}0==q?l.material=p:(l.materials||(l.materials=[]),l.materials.push(p))}else console.warn("instance_material not found: "+k)}if("instance_controller"==m.localName){n=m.getAttribute("url");q=this.readController(n,d,b);if(p=m.querySelector("bind_material"))l.materials=
this.readBindMaterials(p);q&&(p=q,"morph"==q.type&&(p=q.mesh,l.morph_targets=q.morph_targets),p.name=n.toString(),l.mesh=n.toString(),b.meshes[n]=p)}"instance_light"==m.localName&&(n=m.getAttribute("url"),this.readLight(l,n));"instance_camera"==m.localName&&(n=m.getAttribute("url"),this.readCamera(l,n))}}},material_translate_table:{},light_translate_table:{point:"omni"},camera_translate_table:{xfov:"fov",aspect_ratio:"aspect",znear:"near",zfar:"far"},querySelectorAndId:function(a,b,c){a=a.querySelectorAll(b);
for(b=0;b<a.length;b++){var d=a.item(b).getAttribute("id");if(d&&(d=d.toString(),d==c))return a.item(b)}return null},getFirstChildElement:function(a){a=a.childNodes;for(var b=0;b<a.length;++b)if(a.item(b).localName)return a.item(b);return null},readMaterial:function(a){a=this.querySelectorAndId(this._xmlroot,"library_materials material",a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url").substr(1);a=this.querySelectorAndId(this._xmlroot,"library_effects effect",
a);if(!a)return null;var b=a.querySelector("technique");if(!b)return null;a={};var c=b.querySelector("phong");c||(c=b.querySelector("blinn"));if(!c)return null;for(b=0;b<c.childNodes.length;++b){var d=c.childNodes.item(b);if(d.localName){var l=d.localName.toString();this.material_translate_table[l]&&(l=this.material_translate_table[l]);if(d=this.getFirstChildElement(d))if("color"==d.localName.toString())a[l]=this.readContentAsFloats(d).subarray(0,3);else if("float"==d.localName.toString())a[l]=this.readContentAsFloats(d)[0];
else if("texture"==d.localName.toString()){a.textures||(a.textures={});var k=d.getAttribute("texture");k&&(k={map_id:k},d=d.getAttribute("texcoord"),k.uvs=d,a.textures[l]=k)}}}a.object_type="Material";return a},readLight:function(a,b){var c={},d=this._xmlroot.querySelector("library_lights "+b);if(!d)return null;var l=[],k=d.querySelector("technique_common");if(k)for(var m=0;m<k.childNodes.length;m++)1==k.childNodes.item(m).nodeType&&l.push(k.childNodes.item(m));d=d.querySelectorAll("technique");for(m=
0;m<d.length;m++)for(var k=d.item(m),n=0;n<k.childNodes.length;n++)1==k.childNodes.item(n).nodeType&&l.push(k.childNodes.item(n));for(m=0;m<l.length;m++)switch(k=l[m],k.localName){case "point":case "spot":c.type=this.light_translate_table[k.localName];d=c;for(n=0;n<k.childNodes.length;n++){var p=k.childNodes.item(n);if(p&&1==p.nodeType)switch(p.localName){case "color":d.color=Collada.readContentAsFloats(p);break;case "falloff_angle":d.angle_end=Collada.readContentAsFloats(p)[0],d.angle=d.angle_end-
10}}break;case "intensity":c.intensity=this.readContentAsFloats(k)[0]}c.position=[0,0,0];c.target=[0,-1,0];a.light=c},readCamera:function(a,b){var c={},d=this._xmlroot.querySelector("library_cameras "+b);if(!d)return null;var l=[],k=d.querySelector("technique_common");if(k)for(d=0;d<k.childNodes.length;d++)1==k.childNodes.item(d).nodeType&&l.push(k.childNodes.item(d));for(d=0;d<l.length;d++)for(var k=c,m=l[d],n=0;n<m.childNodes.length;n++){var p=m.childNodes.item(n);p&&1==p.nodeType&&(k[Collada.camera_translate_table[p.localName]||
p.localName]=parseFloat(p.textContent))}a.camera=c},readTransform:function(a,b,c){for(var h=mat4.create(),l=mat4.create(),k=quat.create(),m=0;m<a.childNodes.length;m++){var n=a.childNodes.item(m);if("matrix"==n.localName){h=this.readContentAsFloats(n);this.transformMatrix(h,0==b);break}if("translate"==n.localName){var p=this.readContentAsFloats(n);c&&0<b&&(n=p[1],p[1]=p[2],p[2]=-n);mat4.translate(h,h,p)}else"rotate"==n.localName?(p=this.readContentAsFloats(n),4==p.length&&("jointOrientX"==n.getAttribute("sid")&&
(p[3]+=90),c&&(n=p[1],p[1]=p[2],p[2]=-n),0!=p[3]&&(quat.setAxisAngle(k,p.subarray(0,3),p[3]*d),mat4.fromQuat(l,k),mat4.multiply(h,h,l)))):"scale"==n.localName&&(p=this.readContentAsFloats(n),c&&(n=p[1],p[1]=p[2],p[2]=-n),mat4.scale(h,h,p))}return h},readTransform2:function(a,b,c){for(var h=mat4.create(),l=quat.create(),k=mat4.create(),m=quat.create(),n=vec3.create(),p=vec3.fromValues(1,1,1),q=0;q<a.childNodes.length;q++){var r=a.childNodes.item(q);if("matrix"==r.localName)return h=this.readContentAsFloats(r),
this.transformMatrix(h,0==b),h;if("translate"==r.localName){var s=this.readContentAsFloats(r);n.set(s)}else"rotate"==r.localName?(s=this.readContentAsFloats(r),4==s.length&&("jointOrientX"==r.getAttribute("sid")&&(s[3]+=90),c&&(r=s[1],s[1]=s[2],s[2]=-r),0!=s[3]&&(quat.setAxisAngle(m,s.subarray(0,3),s[3]*d),quat.multiply(l,l,m)))):"scale"==r.localName&&(s=this.readContentAsFloats(r),c&&(r=s[1],s[1]=s[2],s[2]=-r),p.set(s))}c&&0<b&&(r=n[1],n[1]=n[2],n[2]=-r);mat4.translate(h,h,n);mat4.fromQuat(k,l);
mat4.multiply(h,h,k);mat4.scale(h,h,p);return h},readGeometry:function(a,b){var d=this._xmlroot.getElementById(a.substr(1));if(!d)return console.warn("readGeometry: geometry not found: "+a),null;for(var h=d.querySelector("mesh"),l={},k=h.querySelectorAll("source"),d=0;d<k.length;d++){var m=k.item(d);if(m.querySelector){var n=m.querySelector("float_array");if(n){var n=this.readContentAsFloats(n),p=m.querySelector("accessor"),p=parseInt(p.getAttribute("stride"));l[m.getAttribute("id")]={stride:p,data:n}}}}d=
h.querySelector("vertices input");vertices_source=l[d.getAttribute("source").substr(1)];l[h.querySelector("vertices").getAttribute("id")]=vertices_source;m=[];n=!1;d=h.querySelector("polygons");if(!d&&(d=h.querySelector("polylist")))return console.error("Polylist not supported, please be sure to enable TRIANGULATE option in your exporter."),null;d||(d=h.querySelector("triangles"));if(!d)return console.log("no polygons or triangles in mesh: "+a),null;p=h.querySelectorAll("triangles");if(p.length)n=
!0;else return console.error("no triangles in mesh: "+a),null;for(var h=[],q=0,r={},s=[],k=[],u=0,A="",t=0;t<p.length;t++){var w=p.item(t),A=w.getAttribute("material"),C=w.querySelectorAll("input");if(0==t)for(d=0;d<C.length;d++){var B=C.item(d);if(B.getAttribute){var x=B.getAttribute("semantic").toUpperCase(),z=l[B.getAttribute("source").substr(1)],E=parseInt(B.getAttribute("offset")),H=0;B.getAttribute("set")&&(H=parseInt(B.getAttribute("set")));h.push([x,[],z.stride,z.data,E,H])}}B=w.querySelectorAll("p");
x=h.length;for(d=0;d<B.length;d++){w=B.item(d);if(!w||!w.textContent)break;for(var w=w.textContent.trim().split(" "),H=z=E=-1,G=0,C=w.length;G<C;G+=x){var D=w.slice(G,G+x).join(" "),H=z;if(r.hasOwnProperty(D))z=r[D];else{for(var F=0;F<h.length;++F){var J=h[F],K=parseInt(w[G+F]),z=J[1],L=J[3];0==F&&(s[z.length/x]=K);for(var K=K*J[2],I=0;I<J[2];++I)z.push(L[K+I])}z=q;q+=1;r[D]=z}n||(0==G&&(E=z),G>2*x&&(k.push(E),k.push(H)));k.push(z)}}d={name:"group"+t,start:u,length:k.length-u,material:A||""};u=k.length;
m.push(d)}l={vertices:new Float32Array(h[0][1]),info:{groups:m},_remap:new Uint32Array(s)};m={normal:"normals",texcoord:"coords"};for(d=1;d<h.length;++d)n=h[d][0].toLowerCase(),w=h[d][1],w.length&&(m[n]&&(n=m[n]),l[n]&&(n+=h[d][5]),l[n]=new Float32Array(w));k.length&&(l.triangles=65536<l.vertices.length?new Uint32Array(k):new Uint16Array(k));if(b&&!this.no_flip){h=0;z=l.vertices;d=0;for(C=z.length;d<C;d+=3)h=z[d+1],z[d+1]=z[d+2],z[d+2]=-h;z=l.normals;d=0;for(C=z.length;d<C;d+=3)h=z[d+1],z[d+1]=z[d+
2],z[d+2]=-h}if(c&&this.use_transferables)for(d in l)(w=l[d])&&w.buffer&&100<w.length&&this._transferables.push(w.buffer);l.filename=a;l.object_type="Mesh";return l},findXMLNodeById:function(a,b,c){if(this._xmlroot._nodes_by_id){var d=this._xmlroot._nodes_by_id[c];if(d&&d.localName==b)return d}else if(d=this._xmlroot.getElementById(c))return d;a=a.childNodes;for(d=0;d<a.length;++d){var l=a.item(d);if(1==l.nodeType&&l.localName==b&&l.getAttribute("id")==c)return l}return null},readImages:function(a){var b=
a.querySelector("library_images");if(!b)return null;a={};for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);if(1==d.nodeType){var l=d.querySelector("init_from");if(l&&l.textContent){var k=this.getFilename(l.textContent),m=d.getAttribute("id");a[m]={filename:k,map:m,name:d.getAttribute("name"),path:l.textContent}}}}return a},readAnimations:function(a,b){var d=a.querySelector("library_animations");if(!d)return null;for(var d=d.childNodes,h={object_type:"Animation",takes:{}},l={tracks:[]},k=
l.tracks,m=0;m<d.length;++m){var n=d.item(m);if(1==n.nodeType){var p=n.getAttribute("id");if(n=n.querySelector("animation")){var q=n.querySelector("channel");if(q){var r=q.getAttribute("source"),s=q.getAttribute("target");if(xmlsampler=this.findXMLNodeById(n,"sampler",r.substr(1))){for(var u={},A={},t={},w=xmlsampler.querySelectorAll("input"),r=null,q=0;q<w.length;q++){var C=w.item(q),B=C.getAttribute("source"),x=C.getAttribute("semantic"),z=this.findXMLNodeById(n,"source",B.substr(1));if(z){var E=
z.querySelector("param");E&&(C=E.getAttribute("type"),u[x]={source:B,type:C},x=null,"float"==C||"float4x4"==C)&&(z=z.querySelector("float_array"),z=this.readContentAsFloats(z),x=A[B]=z,B=E.getAttribute("name"),"TIME"==B&&(r=x),t[B||"OUTPUT"]=C)}}if(r){q=s.split("/");n={};n.nodename=this.safeString(q[0]);n.property=q[1];p=this._nodes_by_id[n.nodename];s=1;t=t.OUTPUT;switch(t){case "float":s=1;break;case "float3x3":s=9;break;case "float4x4":s=16}n.value_size=s;n.duration=r[r.length-1];if(A=A[u.OUTPUT.source]){w=
s+1;u=new Float32Array(r.length*w);for(q=0;q<r.length;++q)u[q*w]=r[q],B=A.subarray(q*s,(q+1)*s),"float4x4"==t&&this.transformMatrix(B,0==p._depth),u.set(B,q*w+1);c&&this.use_transferables&&(r=u)&&r.buffer&&100<r.length&&this._transferables.push(r.buffer);n.data=u;k.push(n)}}else console.error("Error DAE: no TIME info found in animation: "+p)}else console.error("Error DAE: Sampler not found in "+r)}}}}if(!k.length)return null;h.takes["default"]=l;return h},findNode:function(a,b){if(a.id==b)return a;
if(a.children)for(var c in a.children){var d=this.findNode(a.children[c],b);if(d)return d}return null},readController:function(a,b,c){var d=this._xmlroot.querySelector("controller"+a);if(!d)return null;a=null;var l=d.querySelector("skin");l&&(a=this.readSkinController(l,b,c));(d=d.querySelector("morph"))&&(a=this.readMorphController(d,b,c,a));return a},readSkinController:function(a,b,c){c=a.getAttribute("source");c=this.readGeometry(c,b);if(!c)return null;var d=this.readSources(a,b);if(!d)return null;
b=null;(b=a.querySelector("bind_shape_matrix"))?(b=this.readContentAsFloats(b),this.transformMatrix(b,!0,!0)):b=mat4.create();var l=[],k=a.querySelector("joints");if(k){for(var m=null,n=null,p=k.querySelectorAll("input"),k=0;k<p.length;k++){var q=p[k],r=q.getAttribute("semantic").toUpperCase(),q=q.getAttribute("source"),q=d[q.substr(1)];"JOINT"==r?m=q:"INV_BIND_MATRIX"==r&&(n=q)}if(!n||!m)return console.error("Error DAE: no joints or inv_bind sources found"),null;for(k in m)p=n.subarray(16*k,16*k+
16),r=m[k],(q=this._nodes_by_id[r])?(this.transformMatrix(p,0==q._depth,!0),l.push([r,p])):console.warn("Node "+r+" not found")}if(a=a.querySelector("vertex_weights")){for(var s=null,p=a.querySelectorAll("input"),k=0;k<p.length;k++)"WEIGHT"==p[k].getAttribute("semantic").toUpperCase()&&(s=d[p.item(k).getAttribute("source").substr(1)]);if(!s)throw"no weights found";var k=a.querySelector("vcount"),u=this.readContentAsUInt32(k),k=a.querySelector("v"),A=this.readContentAsUInt32(k);a=c.vertices.length/
3;for(var d=new Float32Array(4*a),m=new Uint8Array(4*a),t=0,n=c._remap,k=p=0;k<u.length;++k){for(var w=u[k],C=t,q=m.subarray(4*k,4*k+4),r=d.subarray(4*k,4*k+4),B=0,x=0;x<w&&4>x;++x)q[x]=A[C+2*x],q[x]>p&&(p=q[x]),r[x]=s[A[C+2*x+1]],B+=r[x];if(4<w&&1>B)for(q=1/B,x=0;4>x;++x)r[x]*=q;t+=2*w}s=new Float32Array(4*a);u=new Uint8Array(4*a);A=[];for(k=0;k<a;++k){q=4*n[k];r=d.subarray(q,q+4);q=m.subarray(q,q+4);for(t=0;3>t;++t){w=t;C=r[t];for(x=t+1;4>x;++x)r[x]<=C||(w=x,C=r[x]);w!=t&&(x=r[t],r[t]=r[w],r[w]=
x,x=q[t],q[t]=q[w],q[w]=x)}s.set(r,4*k);u.set(q,4*k);r[0]&&(A[q[0]]=!0);r[1]&&(A[q[1]]=!0);r[2]&&(A[q[2]]=!0);r[3]&&(A[q[3]]=!0)}p>=l.length&&console.warn("Mesh uses higher bone index than bones found");a=[];d={};for(k=0;k<A.length;++k)A[k]&&(d[k]=a.length,a.push(l[k]));if(a.length<l.length){for(k=0;k<u.length;k++)u[k]=d[u[k]];l=a}c.weights=s;c.bone_indices=u;c.bones=l;c.bind_matrix=b;delete c._remap}return c},readMorphController:function(a,b,c,d){d=a.getAttribute("source");d=this.readGeometry(d,
b);if(!d)return null;var l=this.readSources(a,b),k=[];a=a.querySelector("targets");if(!a)return null;for(var m=a.querySelectorAll("input"),n=a=null,p=0;p<m.length;p++){var q=m.item(p).getAttribute("semantic").toUpperCase(),r=l[m.item(p).getAttribute("source").substr(1)];"MORPH_TARGET"==q?a=r:"MORPH_WEIGHT"==q&&(n=r)}if(!a||!n)return null;for(p in a)l="#"+a[p],m=this.readGeometry(l,b),c.meshes[l]=m,k.push([l,n[p]]);d.morph_targets=k;return d},readBindMaterials:function(a,b){for(var c=[],d=a.querySelectorAll("technique_common"),
l=0;l<d.length;l++)for(var k=d.item(l).querySelectorAll("instance_material"),m=0;m<k.length;m++){var n=k.item(m);n&&c.push(n.getAttribute("symbol"))}return c},readSources:function(a,b){for(var c={},d=a.querySelectorAll("source"),l=0;l<d.length;l++){var k=d.item(l);if(k.querySelector)if(k.querySelector("float_array")){var m=this.readContentAsFloats(k);c[k.getAttribute("id")]=m}else(m=k.querySelector("Name_array"))&&(m=this.readContentAsStringsArray(m))&&(c[k.getAttribute("id")]=m)}return c},readContentAsUInt32:function(a){if(!a)return null;
a=a.textContent;a=a.replace(/\n/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" ");a=(a=a.getAttribute("count"))?parseInt(a):b.length;a=new Float32Array(a);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},readContentAsStringsArray:function(a){if(!a)return null;
for(var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" "),c=0;c<b.length;c++)b[c]=b[c].trim();if(a.getAttribute("count")&&parseInt(a.getAttribute("count"))!=b.length){var c=[],d="",l;for(l in b)d=d?d+(" "+b[l]):b[l],this._nodes_by_id[this.safeString(d)]&&(c.push(this.safeString(d)),d="");a=parseInt(a.getAttribute("count"));if(c.length==a)return c;console.error("Error: bone names have spaces, avoid using spaces in names");return null}return b},max3d_matrix_0:new Float32Array([0,
-1,0,0,0,0,-1,0,1,0,0,-0,0,0,0,1]),transformMatrix:function(a,b,c){mat4.transpose(a,a);if(this.no_flip)return a;b?(b=new Float32Array(a.subarray(4,8)),a.set(a.subarray(8,12),4),a.set(b,8),b=a.subarray(8,12),vec4.scale(b,b,-1)):(b=mat4.create(),b.set([a[0],a[2],-a[1]],0),b.set([a[8],a[10],-a[9]],4),b.set([-a[4],-a[6],a[5]],8),b.set([a[12],a[14],-a[13]],12),a.set(b));return a},debugMatrix:function(a,b){var c=new Float32Array(JSON.parse("["+a.split(" ").join(",")+"]"));return this.transformMatrix(c,
b)}};c?(Collada.loadInWorker=function(a,b){Collada.load(b,a)},Collada.parseInWorker=function(a,b){a(Collada.parse(b))}):(Collada.launchWorker=function(){var a=this.worker=new Worker(Collada.workerPath+"collada.js");a.callback_ids={};a.addEventListener("error",function(a){if(Collada.onerror)Collada.onerror(err)});a.addEventListener("message",function(a){if(a.data)switch(a=a.data,a.action){case "log":console.log.apply(console,a.params);break;case "warn":console.warn.apply(console,a.params);break;case "exception":console.error.apply(console,
a.params);if(Collada.onerror)Collada.onerror(a.msg);break;case "error":console.error.apply(console,a.params);break;case "result":var b=this.callback_ids[a.callback_id];if(!b)throw"callback not found";b(a.result);break;default:console.warn("Unknown action:",a.action)}});this.callback_ids={};this.last_callback_id=1;this.toWorker("init",[this.config])},Collada.toWorker=function(a,b,c){this.worker||this.launchWorker();var d=this.last_callback_id++;this.worker.callback_ids[d]=c;this.worker.postMessage({func:a,
params:b,callback_id:d})},Collada.loadInWorker=function(a,b){this.toWorker("loadInWorker",[a],b)},Collada.parseInWorker=function(a,b){this.toWorker("parseInWorker",[a],b)});c&&self.addEventListener("message",function(a){if("init"==a.data.func)return Collada.init.apply(Collada,a.data.params);var b=a.data.func,c=a.data.params,d=a.data.callback_id;a=function(a){self.postMessage({action:"result",callback_id:d,result:a},Collada._transferables);Collada._transferables=null};var l=Collada[b];if(void 0===
l)console.error("function not found:",b),a(null);else try{l.apply(Collada,c?[a].concat(c):[a])}catch(k){console.error("Error inside worker function call to "+b+" :: "+k),a(null)}},!1)})("undefined"!=typeof window?window:self);
var parserDAE={extension:"dae",data_type:"scene",format:"text",no_flip:!0,parse:function(a,b,c){function d(a){a.id&&(a.uid="@"+e+"::"+a.id,f[a.id]=a.uid);if(a.mesh){var b=e+"::"+a.mesh;f[a.mesh]=b;a.mesh=b}if(a.children)for(var c in a.children)d(a.children[c])}Collada.material_translate_table={transparency:"opacity",reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",emission:"emissive",diffuse:"color"};a=Collada.parse(a,b,c);console.log(a);if(b.skip_renaming)return a;
var e=c.substr(0,c.indexOf(".")),f={};d(a.root);b={};for(var g in a.meshes)if(c=a.meshes[g],c.bones){for(var h in c.bones){var l=f[c.bones[h][0]];l&&(c.bones[h][0]=l)}b[f[g]]=c}a.meshes=b;return a}};Parser.registerParser(parserDAE);
var parserDDS={extension:"dds",data_type:"image",format:"binary",parse:function(a,b){var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d,!0);return d}};Parser.registerParser(parserDDS);
var parserJSMesh={extension:"jsmesh",data_type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?
c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=Parser.computeMeshBounding(c.vertices));return c}};Parser.registerParser(parserJSMesh);
var parserOBJ={extension:"obj",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};for(var c=[],d=[],e=[],f=[],g=[],h=[],l=[],k={},m=0,n=null,p=null,q=0,r=0,s=p=0,u=0,A=0,t=null,w=!1,C=!1,B=!1,x=!1,z=0,E=b.noindex?b.noindex:1E7<a.length?!0:!1,H=Parser.flipAxis||b.flipAxis,G=H||b.flipNormals,D=null,F=[],J=a.split("\n"),K=J.length,L=0;L<K;++L)if(n=J[L].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=n[0]&&""!=n)if(t=n.split(" "),x&&"v"==t[0]&&(x=!1),"v"==t[0])H?g.push(-1*parseFloat(t[1]),parseFloat(t[3]),
parseFloat(t[2])):g.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));else if("vt"==t[0])h.push(parseFloat(t[1]),parseFloat(t[2]));else if("vn"==t[0])G?l.push(-parseFloat(t[2]),-parseFloat(t[3]),parseFloat(t[1])):l.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));else if("f"==t[0]){if(x=!0,!(4>t.length)){for(var I=[],n=1;n<t.length;++n){if(!(t[n]in k)||E){p=t[n].split("/");if(1==p.length)p=r=q=parseInt(p[0])-1;else if(2==p.length)q=parseInt(p[0])-1,r=parseInt(p[1])-1,p=-1;else if(3==
p.length)q=parseInt(p[0])-1,r=parseInt(p[1])-1,p=parseInt(p[2])-1;else return trace("Problem parsing: unknown number of values per face"),!1;3<n&&E&&(s=c.length,c.push(c[s-9*(n-3)],c[s-9*(n-3)+1],c[s-9*(n-3)+2]),c.push(c[s-3],c[s-2],c[s-1]),s=d.length,d.push(d[s-6*(n-3)],d[s-6*(n-3)+1]),d.push(d[s-2],d[s-1]),s=e.length,e.push(e[s-9*(n-3)],e[s-9*(n-3)+1],e[s-9*(n-3)+2]),e.push(e[s-3],e[s-2],e[s-1]));A=u=s=0;3*q+2<g.length&&(w=!0,s=g[3*q+0],u=g[3*q+1],A=g[3*q+2]);c.push(s,u,A);u=s=0;2*r+1<h.length&&
(C=!0,s=h[2*r+0],u=h[2*r+1]);d.push(s,u);u=s=0;A=1;-1!=p&&(3*p+2<l.length&&(B=!0,s=l[3*p+0],u=l[3*p+1],A=l[3*p+2]),e.push(s,u,A));E||(k[t[n]]=m++)}E||(q=k[t[n]],I.push(q),z<q&&(z=q))}if(!E)for(n=2;n<I.length;n++)f.push(I[0],I[n-1],I[n])}}else"g"==t[0]||"usemtl"==t[0]?1<t.length&&(n=f.length?f.length:c.length/3,null!=D&&(D.length=n-D.start,0<D.length&&F.push(D)),D={name:t[1],start:n,length:-1,material:""}):"usemtl"==t[0]?D&&(D.material=t[1]):"o"!=t[0]&&"s"!=t[0]&&trace("unknown code: "+n);D&&1<f.length-
D.start&&(D.length=f.length-D.start,F.push(D));if((65536<z||E)&&0<f.length){console.log("Deindexing mesh...");g=new Float32Array(3*f.length);h=e&&e.length?new Float32Array(3*f.length):null;l=d&&d.length?new Float32Array(2*f.length):null;for(n=0;n<f.length;n+=1)g.set(c.slice(3*f[n],3*f[n]+3),3*n),h&&h.set(e.slice(3*f[n],3*f[n]+3),3*n),l&&l.set(d.slice(2*f[n],2*f[n]+2),2*n);c=g;h&&(e=h);l&&(d=l);f=null}g={};w&&(g.vertices=new Float32Array(c));B&&0<e.length&&(g.normals=new Float32Array(e));C&&0<d.length&&
(g.coords=new Float32Array(d));f&&0<f.length&&(g.triangles=new Uint16Array(f));g.bounding=Mesh.computeBounding(g.vertices);c={};1<F.length&&(c.groups=F);g.info=c;(0==g.bounding.radius||isNaN(g.bounding.radius))&&console.log("no radius found in mesh");return g}};Parser.registerParser(parserOBJ);
var parserTGA={extension:"tga",data_type:"image",format:"binary",parse:function(a,b){a="string"==typeof a?Parser.stringToTypedArray(a):new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);for(e=0;e<c.imageSize;e+=c.bytesPerPixel)d=
c.pixels[e],c.pixels[e]=c.pixels[e+2],c.pixels[e+2]=d;c.flipY=!0;c.format=32==c.bpp?"BGRA":"BGR";return c}};Parser.registerParser(parserTGA);
function SceneTree(){this.uid=LS.generateUId("TREE-");this._root=new LS.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._in_tree=this;this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this._paths=[];LEvent.bind(this,"treeItemAdded",this.onNodeAdded,this);LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved,this);this.init()}
Object.defineProperty(SceneTree.prototype,"root",{enumerable:!0,get:function(){return this._root},set:function(a){throw"Root node cannot be replaced";}});
SceneTree.prototype.init=function(){this.id="";this.local_repository=null;this._root.removeAllComponents();this._root.uid=LS.generateUId("NODE-");this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this.info=new LS.Components.GlobalInfo;this._root.addComponent(this.info);this._root.addComponent(new LS.Camera);this.current_camera=this._root.camera;this._root.addComponent(new LS.Light({position:vec3.fromValues(100,100,100),
target:vec3.fromValues(0,0,0)}));this._frame=0;this._last_collect_frame=-1;this._start_time=this._global_time=this._time=0;this._last_dt=1/60;this._must_redraw=!0;this.selected_node&&delete this.selected_node;this.extra={};this._renderer=LS.Renderer};
SceneTree.prototype.clear=function(){for(;this._root._children&&this._root._children.length;)this._root.removeChild(this._root._children[0]);this._root.processActionInComponents("onRemovedFromNode",this);this._root.processActionInComponents("onRemovedFromScene",this);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};
SceneTree.prototype.configure=function(a){this._root.removeAllComponents();a.uid&&(this.uid=a.uid);"SceneTree"!=a.object_type&&console.warn("Warning: object set to scene doesnt look like a propper one.");a.local_repository&&(this.local_repository=a.local_repository);a.extra&&(this.extra=a.extra);a.root&&this.root.configure(a.root);a.nodes&&this.root.configure({children:a.nodes});a.components&&this._root.configureComponents(a);a.camera&&(this._root.camera?this._root.camera.configure(a.camera):this._root.addComponent(new Camera(a.camera)));
a.light?this._root.light?this._root.light.configure(a.light):this._root.addComponent(new Light(a.light)):a.hasOwnProperty("light")&&this._root.light&&(this._root.removeComponent(this._root.light),this._root.light=null);LEvent.trigger(this,"configure",a);LEvent.trigger(this,"change")};
SceneTree.prototype.serialize=function(){var a={};a.uid=this.uid;a.object_type=LS.getObjectClassName(this);a.local_repository=this.local_repository;a.extra=this.extra||{};a.root=this.root.serialize();LEvent.trigger(this,"serialize",a);return a};
SceneTree.prototype.load=function(a,b,c){function d(a){g.init();g.configure(a);g.loadResources(e);LEvent.trigger(g,"load")}function e(){b&&b(g,a);LEvent.trigger(g,"loadCompleted")}function f(b){console.warn("Error loading scene: "+a+" -> "+b);c&&c(a)}if(a){var g=this,h=LS.ResourcesManager.getNoCache(!0);h&&(a+=(-1==a.indexOf("?")?"?":"&")+h);LS.Network.request({url:a,dataType:"json",success:d,error:f});LEvent.trigger(this,"beforeLoad")}};
SceneTree.prototype.appendScene=function(a){a=a.root.childNodes;for(var b in a){var c=a[b],d=new LS.SceneNode(c.id);this.root.addChild(d);d.configure(c.constructor==LS.SceneNode?c.serialize():c)}};SceneTree.prototype.getCamera=function(){var a=this._root.camera;if(a)return a;if(this._cameras&&this._cameras.length)return this._cameras[0];this.collectData();return this._cameras[0]};SceneTree.prototype.getLight=function(){return this._root.light};
SceneTree.prototype.onNodeAdded=function(a,b){if(b._in_tree&&b._in_tree!=this)throw"Cannot add a node from other scene, clone it";b._name&&!this._nodes_by_name[b._name]&&(this._nodes_by_name[b._name]=b);b.uid||(b.uid=LS.generateUId("NODE-"));this._nodes_by_uid[b.uid]=b;this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);LEvent.trigger(this,"nodeAdded",b);LEvent.trigger(this,"change")};
SceneTree.prototype.onNodeRemoved=function(a,b){var c=this._nodes.indexOf(b);if(-1!=c)return this._nodes.splice(c,1),b._name&&this._nodes_by_name[b._name]==b&&delete this._nodes_by_name[b._name],b.uid&&delete this._nodes_by_uid[b.uid],b.processActionInComponents("onRemovedFromScene",this),LEvent.trigger(this,"nodeRemoved",b),LEvent.trigger(this,"change"),!0};SceneTree.prototype.getNodes=function(){return this._nodes};
SceneTree.prototype.getNode=function(a){return a?a.charAt(0)==LS._uid_prefix?this._nodes_by_uid[a]:this._nodes_by_name[a]:null};SceneTree.prototype.getNodeByName=function(a){return this._nodes_by_name[a]};SceneTree.prototype.getNodeByUId=function(a){return this._nodes_by_uid[a]};SceneTree.prototype.getNodeByIndex=function(a){return this._nodes[a]};SceneTree.prototype.getElementById=SceneTree.prototype.getNode;
SceneTree.prototype.filterNodes=function(a){for(var b=[],c=0;c<this._nodes.length;++c)a(this._nodes[c])&&b.push(this._nodes[c]);return b};SceneTree.prototype.findComponentByUId=function(a){for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponentByUId(a);if(c)return c}return null};SceneTree.prototype.getPropertyInfo=function(a){a=a.split("/");var b=this.getNode(a[0]);return b?b.getPropertyInfoFromPath(a):null};
SceneTree.prototype.setPropertyValue=function(a,b){var c=a.split("/"),d=this.getNode(c[0]);return d?d.setPropertyValueFromPath(c,b):null};SceneTree.prototype.setPropertyValueFromPath=function(a,b){var c=this.getNode(a[0]);return c?c.setPropertyValueFromPath(a,b):null};
SceneTree.prototype.loadResources=function(a){function b(){LEvent.unbind(LS.ResourcesManager,"end_loading_resources",b);a&&a()}var c={},d;for(d in this.textures)this.textures[d]&&(c[this.textures[d]]=Texture);this.light&&this.light.getResources(c);for(d in this._nodes)this._nodes[d].getResources(c);var e=0;for(d in c)++e;0==e?a&&a():(LEvent.bind(LS.ResourcesManager,"end_loading_resources",b),LS.ResourcesManager.loadResources(c))};
SceneTree.prototype.start=function(){"running"!=this._state&&(this._state="running",this._start_time=0.001*getTime(),LEvent.trigger(this,"start",this),this.triggerInNodes("start"))};SceneTree.prototype.stop=function(){"stopped"!=this._state&&(this._state="stopped",LEvent.trigger(this,"stop",this),this.triggerInNodes("stop"),this.purgeResidualEvents())};SceneTree.prototype.render=function(a){this._renderer.render(this,a)};
SceneTree.prototype.collectData=function(){for(var a=this.getNodes(),b=[],c=[],d=[],e=[],f=0,g=a.length;f<g;++f){var h=a[f];if(!1!=h.flags.visible){LEvent.trigger(h,"computeVisibility");h.transform&&h.transform.updateGlobalMatrix();var l={};LEvent.trigger(h,"computingShaderMacros",l);var k={};LEvent.trigger(h,"computingShaderUniforms",k);h._macros=l;h._uniforms=k;h._instances=[];LEvent.trigger(h,"collectRenderInstances",h._instances);LEvent.trigger(h,"collectPhysicInstances",e);LEvent.trigger(h,"collectLights",
c);LEvent.trigger(h,"collectCameras",d);b=b.concat(h._instances)}}LEvent.trigger(this,"collectRenderInstances",b);LEvent.trigger(this,"collectPhysicInstances",e);LEvent.trigger(this,"collectLights",c);LEvent.trigger(this,"collectCameras",d);f=0;for(g=b.length;f<g;++f)a=b[f],a.flags&RI_IGNORE_FRUSTUM||a.updateAABB();f=0;for(g=e.length;f<g;++f)e[f].updateAABB();this._instances=b;this._lights=c;this._cameras=d;this._colliders=e;this._last_collect_frame=this._frame};
SceneTree.prototype.updateCollectedData=function(){for(var a=this._nodes,b=this._instances,c=this._lights,d=this._cameras,e=this._colliders,f=0,g=a.length;f<g;++f)a[f].transform&&a[f].transform.updateGlobalMatrix();f=0;for(g=b.length;f<g;++f)a=b[f],a.flags&RI_IGNORE_AUTOUPDATE&&a.update(),a.flags&RI_IGNORE_FRUSTUM||a.updateAABB();f=0;for(g=c.length;f<g;++f);f=0;for(g=d.length;f<g;++f);f=0;for(g=e.length;f<g;++f)e[f].updateAABB()};
SceneTree.prototype.update=function(a){LEvent.trigger(this,"beforeUpdate",this);this._global_time=0.001*getTime();this._time=this._global_time-this._start_time;this._last_dt=a;LEvent.trigger(this,"update",a);this.triggerInNodes("update",a,!0);LEvent.trigger(this,"afterUpdate",this)};SceneTree.prototype.triggerInNodes=function(a,b){LEvent.triggerArray(this._nodes,a,b)};
SceneTree.prototype.generateUniqueNodeName=function(a){a=a||"node";var b=1,c=a.lastIndexOf("_");if(c){var d=a.substr(c+1);parseInt(d)&&(b=parseInt(d),a=a.substr(0,c))}for(c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};SceneTree.prototype.refresh=function(){this._must_redraw=!0};SceneTree.prototype.getTime=function(){return this._time};
SceneTree.prototype.purgeResidualEvents=function(){for(var a in this)if("__on_"==a.substr(0,5)){var b=this[a];if(b){for(var c=[],d=0;d<b.length;++d){var e=b[d][1];(!e||!LS.isClassComponent(e.constructor)||e._root&&e._root.scene===this)&&c.push(b[d])}this[a]=c}}};
function SceneNode(a){this._name=a||"node_"+(1E4*Math.random()).toFixed(0);this.uid=LS.generateUId("NODE-");this._classList={};this.flags={visible:!0,selectable:!0,two_sided:!1,flip_normals:!1,cast_shadows:!0,receive_shadows:!0,ignore_lights:!1,alpha_test:!1,alpha_shadows:!1,depth_test:!0,depth_write:!0};this._components=[];this.addComponent(new Transform);this._material=null;this.extra={}}LS.extendClass(SceneNode,ComponentContainer);LS.extendClass(SceneNode,CompositePattern);
Object.defineProperty(SceneNode.prototype,"name",{set:function(a){this.setName(a)},get:function(){return this._name},enumerable:!0});Object.defineProperty(SceneNode.prototype,"visible",{set:function(a){this.flags.visible=a},get:function(){return this.flags.visible},enumerable:!0});
Object.defineProperty(SceneNode.prototype,"material",{set:function(a){(this._material=a)&&a.constructor!==String&&(a._root&&a._root!=this?console.warn("Cannot assign a material of one SceneNode to another, you must clone it or register it"):a._root=this)},get:function(){return this._material},enumerable:!0});
SceneNode.prototype.setName=function(a){if(this._name==a)return!0;if(!LS.validateName(a))return!1;var b=this._in_tree;if(!b)return this._name=a,!0;this._name&&delete b._nodes_by_name[this._name];(this._name=a)&&!b._nodes_by_name[a]&&(b._nodes_by_name[this._name]=this);LEvent.trigger(this,"name_changed",a);b&&LEvent.trigger(b,"node_name_changed",this);return!0};Object.defineProperty(SceneNode.prototype,"classList",{get:function(){return this._classList},set:function(a){},enumerable:!1});
Object.defineProperty(SceneNode.prototype,"className",{get:function(){var a=null;if(Object.keys)a=Object.keys(this._classList);else{var a=[],b;for(b in this._classList)a.push(b)}return a.join(" ")},set:function(a){this._classList={};if(a){a=a.split(" ");for(var b in a)this._classList[a[b]]=!0}},enumerable:!0});
SceneNode.prototype.getPropertyInfoFromPath=function(a){var b=this,c=a[1];if(2<a.length&&("@"==a[1][0]?(c=a[2],b=this.getComponentByUId(a[1])):"material"==a[1]&&(b=this.getMaterial(),c=a[2]),!b))return null;var d=void 0;if(b.getPropertyInfoFromPath&&(a=b.getPropertyInfoFromPath(a)))return a;b.getPropertyValue&&(d=b.getPropertyValue(c));if(void 0===d&&void 0===b[c])return null;d=void 0!==d?d:b[c];a=b.constructor["@"+c];var e="";a&&(e=a.type);e||null===d||void 0===d||(d.constructor===String?e="string":
d.constructor===Boolean?e="boolean":d.length?e="vec"+d.length:d.constructor===Number&&(e="number"));return{node:this,target:b,name:c,value:d,type:e}};
SceneNode.prototype.setPropertyValueFromPath=function(a,b){var c=null,d=a[1];if(2<a.length){if("@"==a[1][0]?(d=a[2],c=this.getComponentByUId(a[1])):"material"==a[1]&&(c=this.getMaterial(),d=a[2]),!c)return null}else c=this;if(c.setPropertyValueFromPath&&!0===c.setPropertyValueFromPath(a,b)||c.setPropertyValue&&!0===c.setPropertyValue(d,b))return c;if(void 0!==c[d])return c[d]=b,c};
SceneNode.prototype.getResources=function(a,b){for(var c in this._components)this._components[c].getResources&&this._components[c].getResources(a);if(this.material)if("string"==typeof this.material)":"!=this.material[0]&&(a[this.material]=LS.Material);else{var d=this.getMaterial();d&&d.getResources(a)}this.prefab&&(a[this.prefab]=LS.Prefab);if(b)for(c in this._children)this._children[c].getResources(a,!0);return a};SceneNode.prototype.getTransform=function(){return this.transform};
SceneNode.prototype.getMesh=function(){var a=this.mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};SceneNode.prototype.getLight=function(){return this.light};SceneNode.prototype.getCamera=function(){return this.camera};SceneNode.prototype.getLODMesh=function(){var a=this.lod_mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.lod_mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};
SceneNode.prototype.setMesh=function(a,b){this.meshrenderer?"string"==typeof a?this.meshrenderer.configure({mesh:a,submesh_id:b}):this.meshrenderer.mesh=a:this.addComponent(new MeshRenderer({mesh:a,submesh_id:b}))};
SceneNode.prototype.loadAndSetMesh=function(a,b){b=b||{};if(LS.ResourcesManager.meshes[a]||!a){if(this.setMesh(a),b.on_complete)b.on_complete(LS.ResourcesManager.meshes[a],this)}else{var c=this;LS.ResourcesManager.load(a,b,function(a){c.setMesh(a.filename);c.loading-=1;0==c.loading&&(LEvent.trigger(c,"resource_loaded",c),delete c.loading);if(b.on_complete)b.on_complete(a,c)})||(this.loading?this.loading+=1:(this.loading=1,LEvent.trigger(this,"resource_loading")))}};
SceneNode.prototype.getMaterial=function(){return this.material?this.material.constructor===String?this._in_tree?LS.ResourcesManager.materials[this.material]:null:this.material:null};SceneNode.prototype.setPrefab=function(a){this._prefab_name=a};SceneNode.prototype.clone=function(){var a=this._in_tree,a=a?a.generateUniqueNodeName(this._name):this._name,a=new LS.SceneNode(a),b=this.serialize();LS.clearUIds(b);b.uid=LS.generateUId("NODE-");a.configure(b);return a};
SceneNode.prototype.configure=function(a){a.name?this.setName(a.name):a.id&&this.setName(a.id);a.uid&&(this._in_tree&&this._in_tree._nodes_by_uid[this.uid]&&delete this._in_tree._nodes_by_uid[this.uid],this.uid=a.uid,this._in_tree&&(this._in_tree._nodes_by_uid[this.uid]=this));a.className&&a.className.constructor==String&&(this.className=a.className);if(a.mesh){var b=a.mesh,c=LS.ResourcesManager.meshes[b],b={mesh:b};void 0!==a.submesh_id&&(b.submesh_id=a.submesh_id);void 0!==a.morph_targets&&(b.morph_targets=
a.morph_targets);c&&c.bones?this.addComponent(new LS.Components.SkinnedMeshRenderer(b)):this.addComponent(new LS.Components.MeshRenderer(b))}a.model&&this.transform.fromMatrix(a.model);a.material&&((c=a.material.material_class)||(c="Material"),this.material="string"==typeof a.material?a.material:new LS.MaterialClasses[c](a.material));if(a.flags)for(var d in a.flags)this.flags[d]=a.flags[d];a.prefab&&(this.prefab=a.prefab);a.animations&&(this.animations=a.animations,this.addComponent(new LS.Components.PlayAnimation({animation:this.animations})));
a.extra&&(this.extra=a.extra);a.comments&&(this.comments=a.comments);a.components&&this.configureComponents(a);this.configureChildren(a);LEvent.trigger(this,"configure",a)};
SceneNode.prototype.serialize=function(){var a={};this._name&&(a.name=this._name);this.uid&&(a.uid=this.uid);this.className&&(a.className=this.className);this.mesh&&"string"==typeof this.mesh&&(a.mesh=this.mesh);null!=this.submesh_id&&(a.submesh_id=this.submesh_id);this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());this.prefab&&(a.prefab=this.prefab);this.flags&&(a.flags=LS.cloneObject(this.flags));this.extra&&(a.extra=this.extra);this.comments&&(a.comments=
this.comments);this._children&&(a.children=this.serializeChildren());this.serializeComponents(a);LEvent.trigger(this,"serialize",a);return a};SceneNode.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c));a.transform.getGlobalMatrix()}this.transform&&(a.transform._parent=this.transform)};
SceneNode.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=this.transform.getGlobalMatrix(),d=a.transform.getGlobalMatrix();mat4.invert(d,d);this.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform&&(this.transform._parent=a.transform)};SceneNode.prototype._onChildRemoved=function(a,b){if(this.transform)if(b){var c=a.transform.getGlobalMatrix();a.transform._parent=null;a.transform.fromMatrix(c)}else a.transform._parent=null};LS.SceneTree=SceneTree;LS.SceneNode=SceneNode;
var Scene=LS.GlobalScene=new SceneTree;LS.newMeshNode=function(a,b){var c=new LS.SceneNode(a);c.addComponent(new LS.Components.MeshRenderer);c.setMesh(b);return c};LS.newLightNode=function(a){a=new LS.SceneNode(a);a.addComponent(new LS.Components.Light);return a};LS.newCameraNode=function(a){a=new LS.SceneNode(a);a.addComponent(new LS.Components.Camera);return a};function Prefab(a){a&&this.configure(a)}
Prefab.prototype.configure=function(a){var b=a["@resources_name"];this.prefab_json=a["@json"];if(b){var c={},d;for(d in b)c[b[d]]=a[b[d]];this.resources=c}this.processResources()};Prefab.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new Prefab(a)};
Prefab.prototype.processResources=function(){if(this.resources){var a=this.resources,b;for(b in a)LS.ResourcesManager.resources[b]||(LS.ResourcesManager.resources_being_processes[b]=!0);for(b in a)LS.ResourcesManager.resources[b]||LS.ResourcesManager.processResource(b,a[b])}};
Prefab.prototype.createObject=function(){if(!this.prefab_json)return null;var a=JSON.parse(this.prefab_json),b=new LS.SceneNode;b.configure(a);ResourcesManager.loadResources(b.getResources({},!0));this.fullpath&&(b.prefab=this.fullpath);return b};
Prefab.createPrefab=function(a,b,c){if(a){a=a.replace(/ /gi,"_");c=c||{};b.id=null;b.object_type="SceneNode";var d=new Prefab;d.filename=a+".wbin";d.resources=c;d.prefab_json=JSON.stringify(b);a=Prefab.packResources(c,{"@json":d.prefab_json});d._original_file=a;return d}};
Prefab.packResources=function(a,b){var c=b||{},d=[],e;for(e in a){var f=a[e],g=LS.ResourcesManager.resources[f];if(g){var h=null;(h=g._original_data?g._original_data:LS.ResourcesManager.computeResourceInternalData(g).data)?(d.push(f),c[f]=h):console.warning("Wrong data in resource")}}c["@resources_name"]=d;return WBin.create(c,"Prefab")};LS.Prefab=Prefab;
function Context(a){a=a||{};if(!a.canvas){var b=a.container;a.container_id&&(b=document.getElementById(a.container_id));if(b){var c=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;c.width||(c.width=a.width||1);c.height||(c.height=a.height||1);b.appendChild(c);a.canvas=c}}this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_options=new RenderOptions;this.scene=LS.GlobalScene;a.resources&&LS.ResourcesManager.setPath(a.resources);a.shaders&&LS.ShadersManager.init(a.shaders);
a.proxy&&LS.ResourcesManager.setProxy(a.proxy);if(a.filesystems)for(var d in a.filesystems)LS.ResourcesManager.registerFileSystem(d,a.filesystems[d]);a.autoresize&&window.addEventListener("resize",function(){this.canvas.width=c.parentNode.offsetWidth;this.canvas.height=c.parentNode.offsetHeight}.bind(this));LS.Renderer.init();this.force_redraw=a.redraw||!1;this.interactive=!0;this.state="playing";if(this.gl.ondraw)throw"There is already a litegl attached to this context";this.gl.ondraw=Context.prototype._ondraw.bind(this);
this.gl.onupdate=Context.prototype._onupdate.bind(this);this.gl.onmousedown=Context.prototype._onmouse.bind(this);this.gl.onmousemove=Context.prototype._onmouse.bind(this);this.gl.onmouseup=Context.prototype._onmouse.bind(this);this.gl.onmousewheel=Context.prototype._onmouse.bind(this);this.gl.onkeydown=Context.prototype._onkey.bind(this);this.gl.onkeyup=Context.prototype._onkey.bind(this);gl.captureMouse(!0);gl.captureKeys(!0);gl.animate()}
Context.prototype.loadScene=function(a,b){var c=this.scene;c.load(a,function(){c.start();b&&b();console.log("Scene playing")})};Context.prototype.setScene=function(a,b){var c=this.scene;"string"==typeof a&&(a=JSON.parse(a));c.configure(a);c.loadResources(function(){c.start();b&&b();c._must_redraw=!0;console.log("Scene playing")})};Context.prototype.pause=function(){this.state="paused"};Context.prototype.play=function(){this.state="playing"};
Context.prototype._ondraw=function(){if("playing"==this.state){if(this.onPreDraw)this.onPreDraw();var a=this.scene;(a._must_redraw||this.force_redraw)&&a.render(this.render_options);if(this.onDraw)this.onDraw()}};Context.prototype._onupdate=function(a){if("playing"==this.state){if(this.onPreUpdate)this.onPreUpdate(a);this.scene.update(a);if(this.onUpdate)this.onUpdate(a)}};
Context.prototype._onmouse=function(a){if("playing"==this.state){!this.interactive||"mousedown"!=a.eventType&&"mousewheel"!=a.eventType||(this._clicked_node=LS.Picking.getNodeAtCanvasPosition(this.scene,null,a.canvasx,a.canvasy));var b=null;this._clicked_node&&this._clicked_node.flags.interactive&&(a.scene_node=this._clicked_node,b=LEvent.trigger(this._clicked_node,a.eventType,a));b&&b.stop||LEvent.trigger(this.scene.root,a.eventType,a);"mouseup"==a.eventType&&(this._clicked_node=null);this.onMouse&&
(a.scene_node=this._clicked_node,this.onMouse(a))}};Context.prototype._onkey=function(a){"playing"!=this.state||this.onKey&&this.onKey(a)||LEvent.trigger(this.scene,a.eventType,a)};LS.Context=Context;
