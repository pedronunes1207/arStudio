(function(Wa){function x(){}function ca(){this.code="function update(dt) {\n\n}";this.exported_callbacks=["start","update"];this.extracode="";this.extra_methods=null;this.catch_exceptions=!0}function ya(a,b){this.name=a;this.macros={};this.hooks={};if(b)for(var c in b)this.macros[c]=b[c]}function m(a){this.name="";this.uid=e.generateUId("MAT-");this._dirty=!0;this._color=new Float32Array([1,1,1,1]);this.createProperty("diffuse",new Float32Array([1,1,1]),"color");this.shader_name="global";this.blend_mode=
e.Blend.NORMAL;this._specular_data=vec2.fromValues(0.1,10);this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.textures={};this._query=new ya;Object.defineProperty(this,"color",{get:function(){return this._color.subarray(0,3)},set:function(a){vec3.copy(this._color,a)},enumerable:!0});Object.defineProperty(this,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(this,"specular_factor",{get:function(){return this._specular_data[0]},
set:function(a){this._specular_data[0]=a},enumerable:!0});Object.defineProperty(this,"specular_gloss",{get:function(){return this._specular_data[1]},set:function(a){this._specular_data[1]=a},enumerable:!0});a&&this.configure(a)}function N(a){m.call(this,null);this.createProperty("ambient",new Float32Array([1,1,1]),"color");this.createProperty("emissive",new Float32Array(3),"color");this.backlight_factor=0;this.specular_ontop=!1;this.reflection_factor=0;this.reflection_fresnel=1;this.reflection_specular=
this.reflection_additive=!1;this.createProperty("velvet",new Float32Array([0.5,0.5,0.5]),"color");this.velvet_exp=0;this.velvet_additive=!1;this._velvet_info=vec4.create();this._detail=new Float32Array([0,10,10]);this._extra_data=vec4.create();this.normalmap_factor=1;this.displacementmap_factor=0.1;this.bumpmap_factor=1;this.use_scene_ambient=!0;this.extra_surface_shader_code="";this.extra_uniforms={};a&&this.configure(a)}function X(a){m.call(this,null);this.shader_name="base";this.vs_code="";this.code=
"void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = 0.0;\n\to.Alpha = IN.color.a;\n}\n";this._uniforms={};this.properties=[];a&&this.configure(a);this.flags=0;this.computeCode()}function R(a){m.call(this,null);this.shader_name="surface";this.vs_code="";this.code="void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = 0.0;\n\to.Alpha = IN.color.a;\n}\n";
this._uniforms={};this.properties=[];a&&this.configure(a);this.flags=0;this.computeCode()}function ja(){this._components=[]}function Z(){}function Da(a){a&&this.configure(a)}function t(a){this._position=vec3.create();this._rotation=quat.create();this._scaling=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;if(Object.observe){var b=function(a){this._must_update_matrix=!0}.bind(this);Object.observe(this._position,b);Object.observe(this._rotation,
b);Object.observe(this._scaling,b)}a&&this.configure(a)}function w(a){this.enabled=!0;this.layers=3;this.clear_depth=this.clear_color=!0;this._type=w.PERSPECTIVE;this._eye=vec3.fromValues(0,100,100);this._center=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._global_eye=vec3.fromValues(0,100,100);this._global_center=vec3.fromValues(0,0,0);this._global_up=vec3.fromValues(0,1,0);this._global_front=vec3.fromValues(0,0,-1);this._near=1;this._far=1E3;this._ortho=new Float32Array([-1,1,-1,
1]);this._aspect=1;this._fov=45;this._frustum_size=50;this._final_aspect=1;this._viewport=new Float32Array([0,0,1,1]);this._viewport_in_pixels=vec4.create();this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._must_update_projection_matrix=this._must_update_view_matrix=!0;this.render_to_texture=!1;this.texture_name="";this.texture_size=vec2.fromValues(0,0);this.texture_clone=this.texture_high=!1;a&&this.configure(a);
this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_camera_eye:this._global_eye,u_camera_front:this._global_front,u_camera_planes:vec2.fromValues(this.near,this.far),u_camera_perspective:vec3.create()}}function Q(a){this.use_viewport_size=this.enabled=!0;this.apply_fxaa=this.use_node_camera=this.use_high_precision=!1;this.fx=[];this._uniforms={u_aspect:1,u_viewport:vec2.create(),u_iviewport:vec2.create(),u_texture:0,u_texture_depth:1};a&&this.configure(a)}function u(a){this._position=
vec3.create();this._target=vec3.fromValues(0,0,1);this._up=vec3.fromValues(0,1,0);this.enabled=!0;this.near=1;this.far=500;this.angle=45;this.angle_end=60;this.constant_diffuse=!1;this.use_specular=!0;this.linear_attenuation=!1;this.range_attenuation=!0;this.att_start=0;this.att_end=1E3;this.offset=0;this.spot_cone=!0;this.projective_texture=null;this._attenuation_info=new Float32Array([this.att_start,this.att_end]);this.use_target=!1;this._color=vec3.fromValues(1,1,1);this.intensity=1;this.cast_shadows=
!1;this.shadow_bias=0.05;this.shadowmap_resolution=0;this.type=u.OMNI;this.frustum_size=50;this.extra_texture=this.extra_light_shader_code=null;this._front=vec3.clone(u.FRONT_VECTOR);this._right=vec3.clone(u.RIGHT_VECTOR);this._top=vec3.clone(u.UP_VECTOR);this._query=new ya;this._uniforms={};a&&(this.configure(a),void 0!==a.shadowmap_resolution&&(this.shadowmap_resolution=parseInt(a.shadowmap_resolution)))}function ka(a){this.test_visibility=this.enabled=!0;this.volume_visibility=0;this.glare_visibility=
this.volume_density=this.volume_radius=1;this.glare_size=vec2.fromValues(0.2,0.2);this.glare_texture=null;this._uniforms={};a&&this.configure(a)}function K(a){this.enabled=!0;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.material=null;this._primitive=-1;this.two_sided=!1;this.point_size=0.1;a&&this.configure(a);K._identity||(K._identity=mat4.create())}function I(a){this.apply_skinning=this.enabled=!0;this.cpu_skinning=!1;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.material=null;this._primitive=
-1;this.point_size=0.1;this.two_sided=!1;this.ignore_transform=!0;I.num_supported_uniforms||(I.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),I.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),I.num_supported_uniforms<3*I.MAX_BONES&&0==I.num_supported_textures&&(I.gpu_skinning_supported=!1));a&&this.configure(a);K._identity||(K._identity=mat4.create())}function P(a){this.enabled=!0;this.morph_targets=[];void 0===P.max_supported_vertex_attribs&&(P.max_supported_vertex_attribs=
gl.getParameter(gl.MAX_VERTEX_ATTRIBS));void 0===P.max_supported_morph_targets&&(P.max_supported_morph_targets=(gl.getParameter(gl.MAX_VERTEX_ATTRIBS)-6)/2);a&&this.configure(a)}function E(a){this.enabled=!0;this.search_bones_in_parent=!1;this.skeleton_root_node=null;this.cpu_skinning=!1;this.ignore_transform=!0;this._mesh=null;E.num_supported_uniforms||(E.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),E.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),
E.num_supported_uniforms<3*E.MAX_BONES&&0==E.num_supported_textures&&(E.gpu_skinning_supported=!1));a&&this.configure(a);K._identity||(K._identity=mat4.create())}function Ra(a){this.texture="";this.size=vec2.create();a&&this.configure(a)}function Ba(a){this.enabled=!0;this.texture=null;this.intensity=1;this.use_environment=!0;a&&this.configure(a)}function ua(a){this.enabled=!0;this.texture=null;this.createProperty("color",vec3.fromValues(1,1,1),"color");this.opacity=1;this.blend_mode=Ea.NORMAL;this.material_name=
null;a&&this.configure(a)}function qa(a){this.enabled=!0;this.shape=1;this.mesh=null;this.size=vec3.fromValues(0.5,0.5,0.5);this.center=vec3.create();this.use_mesh_bounding=!1;a&&this.configure(a)}function va(a){this.properties=[];a&&this.configure(a)}function da(a){this.text="";this.notes=[];this._screen_pos=vec3.create();this._selected=null;this.configure(a)}function Sa(a){this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45;a&&this.configure(a)}function S(a){this.enabled=
!0;this.speed=10;this.wheel_speed=this.rot_speed=1;this.smooth=!1;this.allow_panning=!0;this.mode=S.ORBIT;this.orbit_center=null;this._moving=vec3.fromValues(0,0,0);this._collision=vec3.create();this.configure(a)}function Ka(a){this.rot_speed=[1,1];this.smooth=!1;a&&this.configure(a)}function F(a){this.enabled=!0;this.node_id=null;this.cylindrical=this.face_camera=!1;this.front=F.NEGZ;this.up=F.POSY;this._target_position=vec3.create();a&&this.configure(a)}function $(a){this.enabled=!0;this.start=
100;this.end=1E3;this.density=0.001;this.type=$.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);a&&this.configure(a)}function Ta(a){this.node_name="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}function H(a){this.enabled=!0;this.subdivisions=this.size=10;this.point_size=0.1;this._geometry=H.CUBE;this._primitive=-1;this.align_z=!1;a&&this.configure(a)}function fa(a){this.createProperty("ambient_color",fa.DEFAULT_AMBIENT_COLOR,"color");this.createProperty("background_color",fa.DEFAULT_BACKGROUND_COLOR,
"color");this.linear_pipeline=!1;this._textures={};a&&this.configure(a)}function ga(a){this.enabled=!0;this.force_redraw=!1;this.on_event="update";if("undefined"==typeof LGraphTexture)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph=new LGraph;this._graph._scene=bb;this._graph.getScene=function(){return this._scene};a?this.configure(a):(a=LiteGraph.createNode("scene/node"),this._graph.add(a));LEvent.bind(this,"trigger",this.trigger,this)}function M(a){this.use_viewport_size=
this.enabled=!0;this.use_node_camera=this.use_extra_texture=this.use_antialiasing=this.use_high_precision=!1;if("undefined"==typeof LGraphTexture)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph=new LGraph;this._graph._scene=bb;this._graph.getScene=function(){return this._scene};a?this.configure(a):(this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame"),this._graph_frame_node.ignore_remove=!0,this._graph_frame_node.ignore_rename=!0,this._graph.add(this._graph_frame_node),
this._graph_viewport_node=LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=500,this._graph.add(this._graph_viewport_node),this._graph_frame_node.connect(0,this._graph_viewport_node));null==M.high_precision_format&&(M.high_precision_format=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.float_ext?gl.FLOAT:gl.UNSIGNED_BYTE)}function Xa(){this.id=0;this._pos=vec3.fromValues(0,0,0);this._vel=vec3.fromValues(0,0,0);this.life=1;this.angle=0;this.size=1;this.rot=0}function A(a){this.enabled=
!0;this.max_particles=1024;this.warm_up_time=0;this.point_particles=!1;this.emissor_type=A.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=vec3.fromValues(10,10,10);this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this._particle_start_color=vec3.fromValues(1,1,1);this._particle_end_color=vec3.fromValues(1,1,1);this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this._custom_update_code=this._custom_emissor_code=
null;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.stop_update=!1;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);
this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;this.createMesh()}function La(a){this.className=this.text="";this._world_pos=vec3.create();this._screen_pos=vec3.create();this.configure(a)}function V(a){this.enabled=!0;this.max_points=1024;this.mesh=null;this._points=[];this.texture_grid_size=this.size=1;this.texture=null;this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.sort_in_z=this.in_world_coordinates=
this.premultiplied_alpha=this.use_node_material=this.additive_blending=!1;a&&this.configure(a);this._last_id=0;this.createMesh()}function la(a){this.enabled=!0;this.max_lines=1024;this._lines=[];this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.in_world_coordinates=this.premultiplied_alpha=this.use_node_material=this.additive_blending=!1;a&&this.configure(a);this._last_id=0;this.createMesh()}function ra(a){this.animation="";this.take="default";this.playback_speed=1;this.mode="loop";this.play=
!0;this._last_time=this.current_time=0;this.disabled_tracks={};a&&this.configure(a)}function Fa(a){this.enabled=!0;this.texture_size=512;this.brightness_factor=1;this.colorclip_factor=0;this.clip_offset=0.5;this.texture_name="";this.all_cameras=this.use_cubemap=!1;this.blur=0;this.use_mesh_info=this.generate_mipmaps=!1;this.offset=vec3.create();this.ignore_this_mesh=!0;this.high_precision=!1;this.refresh_rate=1;this.layers=255;this._textures={};a&&this.configure(a)}function J(a){this.enabled=!0;this._name=
"Unnamed";this.code="this.update = function(dt)\n{\n\t//node.scene.refresh();\n}";this._script=new ca;this._script.extra_methods={getComponent:function(){return this}.bind(this),getLocator:function(){return this.getComponent().getLocator()+"/context"},createProperty:e.Component.prototype.createProperty};this._script.catch_exceptions=!1;this._script.onerror=this.onError.bind(this);this._script.exported_callbacks=[];this._last_error=null;a&&this.configure(a);if(this.code)try{this.processCode()}catch(b){console.error(b)}}
function ea(a){this.height=2;this.subdivisions=this.size=10;this.heightmap="";this._primitive=-1;this.auto_update=!0;this.action="Update";this._mesh=null;a&&this.configure(a)}function L(a){this.enabled=!0;this.createProperty("count",vec3.fromValues(10,1,1));this.createProperty("size",vec3.fromValues(100,100,100));this.material=this.lod_mesh=this.mesh=null;this.mode=L.GRID_MODE;a&&this.configure(a);L._identity||(L._identity=mat4.create())}function ha(a){this.enabled=!0;this._num_id=e._last_uid++;this.radius=
10;this.center=vec3.create();this.factor=0.5;this._uniforms_code=ha._uniforms_code.replaceAll({"@":this._num_id});this._code=ha._code.replaceAll({"@":this._num_id});a&&this.configure(a)}function za(a){this.enabled=!0;this.eye_distance=1;a&&this.configure(a)}function Ia(a){this.poses={};a&&this.configure(a)}function aa(a){this.enabled=!0;this.mode=aa.PICKING;this.self_trigger=this.send_trigger=!0;this.layers=3;a&&this.configure(a)}function Y(a){this.name="";this.takes={};a&&this.configure(a)}function wa(a){this.name=
null;this.tracks=[];this.duration=10;a&&this.configure(a)}function O(a){this.enabled=!0;this.name="";this.type=null;this.interpolation=e.NONE;this.packed_data=this.looped=!1;this.value_size=0;this.data_table=this.data=null;Object.defineProperty(this,"_property",{value:"",enumerable:!1,writable:!0});Object.defineProperty(this,"_property_path",{value:[],enumerable:!1,writable:!0});a&&this.configure(a)}function ia(){this.points=[];this.closed=!1;this.type=ia.LINE}function Aa(a){a&&this.configure(a)}
function cb(a){this.renderer=this.current_pass=this.current_camera=this.main_camera=null;this.default_shadowmap_resolution=u.DEFAULT_SHADOWMAP_RESOLUTION;this.keep_viewport=this.ignore_clear=this.ignore_viewports=!1;this.shadows_enabled=!0;this.low_quality=this.lights_disabled=this.force_wireframe=!1;this.sort_instances_by_priority=this.sort_instances_by_distance=this.render_fx=this.render_all_cameras=this.update_materials=this.update_shadowmaps=!0;this.z_pass=!1;this.in_player=this.frustum_culling=
!0;this.default_shader_id="global";this.default_low_shader_id="lowglobal";if(a)for(var b in a)this[b]=a[b]}function W(a,b){this._key="";this.uid=e.generateUId("RINS");this.layers=3;this.wireframe_index_buffer=this.index_buffer=this.vertex_buffers=null;this.range=new Int32Array([0,-1]);this.primitive=gl.TRIANGLES;this.lod_index_buffer=this.lod_vertex_buffers=this.lod_mesh=this.collision_mesh=this.mesh=null;this.node=a;this.component=b;this.priority=10;this.flags=sa;this.blend_func=e.BlendFunctions.normal;
this.matrix=mat4.create();this.normal_matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create();this.material=null;this.query=new e.ShaderQuery;this.uniforms={};this.samplers={};this._dist=0;this._final_query=new e.ShaderQuery;this._final_uniforms={};this._final_samplers={}}function pa(){this.width=pa.default_width;this.height=pa.default_height;this.use_high_precision=!1;this.use_depth_texture=!0;this.use_extra_texture=!1;this.camera=null}function Ya(a,b,c,d){this.position=
vec3.create();c&&this.position.set(c);this.node=a||null;this.instance=b||null;this.distance=d||0}function ma(a,b){this.uid=e.generateUId("PHSX");this.layers=3;this.type=ma.BOX;this.mesh=null;this.node=a;this.component=b;this.matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create()}function D(){this.uid=e.generateUId("TREE-");this._root=new e.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._in_tree=this;this._nodes=[this._root];
this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this.external_scripts=[];this._paths=[];this._local_resources={};this.animation=null;this.layer_names=["main","secondary"];LEvent.bind(this,"treeItemAdded",this.onNodeAdded,this);LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved,this);this.init()}function G(a){this._name=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=e.generateUId("NODE-");this.layers=3;this._classList={};this.flags=
{visible:!0,selectable:!0,two_sided:!1,flip_normals:!1,cast_shadows:!0,receive_shadows:!0,ignore_lights:!1,alpha_test:!1,alpha_shadows:!1,depth_test:!0,depth_write:!0};this._components=[];this.addComponent(new e.Transform);this._material=null;this.extra={}}function xa(a){this.options=a=a||{};if(!a.canvas){var b=a.container;a.container_id&&(b=document.getElementById(a.container_id));b||(console.log("No container specified in LS.Player, using BODY as container"),b=document.body);var c=document.createElement("canvas");
c.width=b.offsetWidth;c.height=b.offsetHeight;c.width||(c.width=a.width||1);c.height||(c.height=a.height||1);b.appendChild(c);a.canvas=c}this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_settings=new e.RenderSettings;this.scene=e.GlobalScene;this.autoplay=void 0!==a.autoplay?a.autoplay:!0;a.resources?e.ResourcesManager.setPath(a.resources):console.warn("LS: no resources path specified");e.ShadersManager.init(a.shaders||"data/shaders.xml");a.shaders||console.warn("LS: no shaders folder specified, using default file.");
a.proxy&&e.ResourcesManager.setProxy(a.proxy);if(a.filesystems)for(var d in a.filesystems)e.ResourcesManager.registerFileSystem(d,a.filesystems[d]);a.autoresize&&window.addEventListener("resize",function(){this.canvas.width=c.parentNode.offsetWidth;this.canvas.height=c.parentNode.offsetHeight}.bind(this));a.loadingbar&&(LEvent.bind(e.ResourcesManager,"start_loading_resources",function(a,b){this.loading_bar=0}.bind(this)),LEvent.bind(e.ResourcesManager,"loading_resources_progress",function(a,b){this.loading_bar<
b&&(this.loading_bar=b)}.bind(this)),LEvent.bind(e.ResourcesManager,"end_loading_resources",function(a,b){this.loading_bar=this._total_loading=void 0}.bind(this)));e.Renderer.init();this.force_redraw=a.redraw||!1;this.state="playing";if(this.gl.ondraw)throw"There is already a litegl attached to this context";this.gl.ondraw=e.Player.prototype._ondraw.bind(this);this.gl.onupdate=e.Player.prototype._onupdate.bind(this);this.gl.onmousedown=e.Player.prototype._onmouse.bind(this);this.gl.onmousemove=e.Player.prototype._onmouse.bind(this);
this.gl.onmouseup=e.Player.prototype._onmouse.bind(this);this.gl.onmousewheel=e.Player.prototype._onmouse.bind(this);this.gl.onkeydown=e.Player.prototype._onkey.bind(this);this.gl.onkeyup=e.Player.prototype._onkey.bind(this);gl.captureMouse(!0);gl.captureKeys(!0);gl.animate()}x.classes={};x.HEADER_SIZE=64;x.FOUR_CC="WBIN";x.VERSION=0.3;x.CLASSNAME_SIZE=32;x.LUMPNAME_SIZE=54;x.LUMPHEADER_SIZE=10+x.LUMPNAME_SIZE;x.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",
Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",String:"ST",WString:"WS",Number:"NU","null":"00"};x.REVERSE_CODES={};for(var C in x.CODES)x.REVERSE_CODES[x.CODES[C]]=C;x.FULL_BINARY=1;x.isWBin=function(a){a=a.subarray(0,4);for(var b=0;b<a.length;b++)if(0!=a[b]&&a[b]!=x.FOUR_CC.charCodeAt(b))return!1;return!0};x.create=function(a,b){if(!a)throw"WBin null origin passed";var c=new Uint8Array([0,0]),d=new Uint8Array((new Float32Array([x.VERSION])).buffer);b=b||"";if(a.toBinary){var f=
a.toBinary();if(!f)return null;if(f.constructor==ArrayBuffer){c[0]|=x.FULL_BINARY;var g=x.getObjectClassName(a),h=new Uint8Array(x.HEADER_SIZE+f.length);h.set(x.stringToUint8Array(x.FOUR_CC));h.set(d,4);h.set(c,8);h.set(x.stringToUint8Array(g,x.CLASSNAME_SIZE),14);h.set(f,x.HEADER_SIZE);return h}a=f}var q=x.HEADER_SIZE,f=[],e=0,k;for(k in a)if(h=a[k],null!=h){g=x.getObjectClassName(h);(g=x.CODES[g])||(g="OB");"NU"==g?h=new Float64Array([h]):"OB"==g&&(h=JSON.stringify(h));var l=0;"string"==typeof h&&
(h=x.stringToUint8Array(h));if(h.buffer&&h.buffer.constructor==ArrayBuffer)h=new Uint8Array(new Uint8Array(h.buffer,h.buffer.byteOffset,h.buffer.byteLength)),l=h.byteLength;else if(h.constructor==ArrayBuffer)l=h.byteLength;else throw"WBin: cannot be anything different to ArrayBuffer";var r=k.substring(0,x.LUMPNAME_SIZE);r.length<k.length&&console.error("Lump name is too long (max is "+x.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future");f.push({code:g,name:r,data:h,
start:e,size:l});e+=l;q+=x.LUMPHEADER_SIZE+l}h=new Uint8Array(q);h.set(x.stringToUint8Array(x.FOUR_CC));h.set(d,4);h.set(c,8);h.set(new Uint8Array((new Uint16Array([f.length])).buffer),10);b&&h.set(x.stringToUint8Array(b,x.CLASSNAME_SIZE),12);var c=x.HEADER_SIZE+f.length*x.LUMPHEADER_SIZE,d=x.HEADER_SIZE,n;for(n in f)k=f[n],q=new Uint8Array(x.LUMPHEADER_SIZE),q.set(new Uint8Array((new Uint32Array([k.start])).buffer),0),q.set(new Uint8Array((new Uint32Array([k.size])).buffer),4),q.set(x.stringToUint8Array(k.code,
2),8),q.set(x.stringToUint8Array(k.name,x.LUMPNAME_SIZE),10),h.set(q,d),d+=x.LUMPHEADER_SIZE,q=new Uint8Array(k.data),h.set(q,c+k.start);return h};x.load=function(a,b){if(!a||a.constructor!==Uint8Array&&a.constructor!==ArrayBuffer)throw"WBin data must be ArrayBuffer or Uint8Array";a=new Uint8Array(a);var c=x.getHeaderInfo(a);if(!c)return console.error("Wrong WBin Header"),null;c.version>(new Float32Array([x.VERSION]))[0]&&console.log("ALERT: WBin version is higher that code version");var d=null,f;
for(f in c.lumps){d||(d={});var g=c.lumps[f],h=c.lump_data.subarray(g.start,g.start+g.size);if(g.size!=h.length)throw"WBin: incorrect wbin lump size";var q=null,e=x.REVERSE_CODES[g.code];if(!e)throw"WBin: Incorrect data code";switch(e){case "null":break;case "String":q=x.Uint8ArrayToString(h);break;case "Number":q=0.3>c.version?parseFloat(x.Uint8ArrayToString(h)):(new Float64Array(h.buffer))[0];break;case "Object":q=JSON.parse(x.Uint8ArrayToString(h));break;case "ArrayBuffer":q=(new Uint8Array(h)).buffer;
break;default:h=new Uint8Array(h);q=window[e];if(!q)throw"ctor not found in WBin: "+e;if(0!=h.length/q.BYTES_PER_ELEMENT%1)throw"WBin: size do not match type";q=new q(h.buffer)}d[g.name]=q}if(!b&&c.classname){if((q=x.classes[c.classname]||window[c.classname])&&q.fromBinary)return q.fromBinary(d);if(q&&q.prototype.fromBinary)return c=new q,c.fromBinary(d),c;d["@classname"]=c.classname}return d};x.getHeaderInfo=function(a){for(var b=a.subarray(0,4),c=0;c<b.length;c++)if(0!=b[c]&&b[c]!=x.FOUR_CC.charCodeAt(c))return null;
for(var b=x.readFloat32(a,4),d=new Uint8Array(a.subarray(8,10)),f=x.readUint16(a,10),g=x.Uint8ArrayToString(a.subarray(12,12+x.CLASSNAME_SIZE)),h=[],c=0;c<f;++c){var q=x.HEADER_SIZE+c*x.LUMPHEADER_SIZE,q=a.subarray(q,q+x.LUMPHEADER_SIZE),e={};e.start=x.readUint32(q,0);e.size=x.readUint32(q,4);e.code=x.Uint8ArrayToString(q.subarray(8,10));e.name=x.Uint8ArrayToString(q.subarray(10));h.push(e)}a=a.subarray(x.HEADER_SIZE+f*x.LUMPHEADER_SIZE);return{version:b,flags:d,classname:g,numlumps:f,lumps:h,lump_data:a}};
x.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};x.stringToUint8Array=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=!1,f=0;f<a.length;f++){var g=a.charCodeAt(f);255<g&&(d=!0);c[f]=g}d&&console.warn("WBin: there are characters in the string that cannot be encoded in 1 byte.");return c};x.Uint8ArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);
else break;return c};x.readUint16=function(a,b){var c=new Uint16Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+2));return c[0]};x.readUint32=function(a,b){var c=new Uint32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};x.readFloat32=function(a,b){var c=new Float32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};ca.onerror=null;ca.show_errors_in_console=!0;ca.prototype.compile=function(a){var b=[],c=[];if(a)for(var d in a)b.push(d),c.push(a[d]);
b=b.join(",");a=this.code;a=ca.expandCode(a);var f="";for(d in this.exported_callbacks)var g=this.exported_callbacks[d],f=f+("\tif(typeof("+g+") != 'undefined' && "+g+' != window["'+g+'"] ) this.'+g+" = "+g+";\n");this._last_executed_code=a+=f;try{this._class=new Function(b,a),this._context=new (ca.applyToConstructor(this._class,c,this.extra_methods))}catch(h){this._context=this._class=null;ca.show_errors_in_console&&(console.error("Error in script\n"+h),console.error(this._last_executed_code));if(this.onerror)this.onerror(h,
this._last_executed_code);if(ca.onerror)ca.onerror(h,this._last_executed_code,this);return!1}return!0};ca.prototype.hasMethod=function(a){return this._context&&this._context[a]&&"function"==typeof this._context[a]?!0:!1};ca.prototype.callMethod=function(a,b,c){if(this._context&&this._context[a]){if(!this.catch_exceptions)return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b);try{return b&&b.constructor===Array&&c?this._context[a].apply(this._context,
b):this._context[a].call(this._context,b)}catch(d){if(console.error("Error in function\n"+d),this.onerror)this.onerror(d)}}};ca.applyToConstructor=function(a,b,c){b=[null].concat(b);if(c)for(var d in c)Object.defineProperty(a.prototype,d,{value:c[d],enumerable:!0});return a.bind.apply(a,b)};ca.cleanCode=function(a){if(!a)return"";a=a.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,"");a=a.split("\n");for(var b=[],c=0;c<a.length;++c){var d=a[c],f=d.indexOf("//");-1!=f&&(d=a[c].substr(0,
f));d=d.trim();d.length&&b.push(d)}return b.join("\n")};ca.expandCode=function(a){if(!a)return"";if(-1!=a.indexOf("'''")){var b=a.split("'''");a="";for(var c=0;c<b.length;c++)a=0==c%2?a+b[c]:a+('"'+b[c].split("\n").join("\\n\\\n")+'"')}return a};Wa.LScript=ca;var Ga=window.console?console.log.bind(console):function(){};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(a){a.prototype.toJSON=function(){return Array.prototype.slice.call(this)}});
var e={_last_uid:1,_uid_prefix:"@",Classes:{},generateUId:function(a,b){b=b||"";var c=this._uid_prefix+(a||"")+(window.navigator.userAgent.hashCode()%16777216).toString(16)+"-",c=c+((GL.getTime()|0).toString(16)+"-"),c=c+(Math.floor(16777216*(1+Math.random())).toString(16)+"-"),c=c+(this._last_uid++).toString(16);return c+b},validateName:function(a){return a.match(/^[a-z\s0-9-_.]+$/i)},catch_errors:!1,Components:{},registerComponent:function(a){for(var b in arguments){var c=arguments[b],d=e.getClassName(c);
this.Components[d]=c;c.is_component=!0;!!c.prototype.onAddedToNode==!!c.prototype.onRemovedFromNode&&!!c.prototype.onAddedToScene==!!c.prototype.onRemovedFromScene||console.warn("%c Component could have a bug, check events: "+d,"font-size: 2em");c.actions||(c.actions={});e.extendClass(c,e.Component);Da.addExtraMethods(c);LEvent.trigger(e,"component_registered",c)}},isClassComponent:function(a){a=this.getClassName(a);return!!this.Components[a]},safeCall:function(a,b,c){if(!e.catch_errors)return a.apply(c,
b);try{return a.apply(c,b)}catch(d){LEvent.trigger(e,"code_error",d),console.error(d.stack)}},setTimeout:function(a,b){if(!e.catch_errors)return setTimeout(a,b);try{return setTimeout(a,b)}catch(c){LEvent.trigger(e,"code_error",c)}},setInterval:function(a,b){if(!e.catch_errors)return setInterval(a,b);try{return setInterval(a,b)}catch(c){LEvent.trigger(e,"code_error",c)}},extendClass:function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(c in b.prototype)b.prototype.hasOwnProperty(c)&&
!a.prototype.hasOwnProperty(c)&&(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))},cloneObject:function(a,b,c){b=b||{};for(var d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){var f=a[d];if(null==f)b[d]=null;else if(!isFunction(f))if(f.constructor===Number||f.constructor===String||f.constructor===Boolean)b[d]=f;else if(f.constructor==
Float32Array)b[d]=Array.apply([],f);else if(isArray(f))b[d]&&b[d].set&&b[d].length>=f.length?b[d].set(f):b[d]=JSON.parse(JSON.stringify(f));else if(f.toJSON)b[d]=f.toJSON();else if(c)b[d]=e.cloneObject(f,null,!0);else if(e.catch_errors)try{b[d]=JSON.parse(JSON.stringify(f))}catch(g){console.error(g)}else b[d]=JSON.parse(JSON.stringify(f))}return b},clearUIds:function(a){a.uid&&delete a.uid;var b=a.components;!b&&a.getComponents&&(b=a.getComponents());if(b){if(b)for(var c in b){var d=b[c];d[1].uid&&
delete d[1].uid;d[1]._uid&&delete d[1]._uid}b=a.children;!b&&a.getChildren&&(b=a.getChildren());if(b)for(c in b)e.clearUIds(b[c])}},getObjectClassName:function(a){if(a){if(a.constructor.fullname)return a.constructor.fullname;if(a.constructor.name)return a.constructor.name;if((a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getClassName:function(a){if(a){if(a.name)return a.name;if(a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getObjectProperties:function(a){if(a.getProperties)return a.getProperties();
var b=a.constructor;if(b.properties)return b.properties;var c={},d;for(d in a)if("_"!=d[0]&&"@"!=d[0]&&"jQuery"!=d.substr(0,6)){if(b!=Object){var f=b["@"+d];if(f&&f.type){c[d]=f.type;continue}}f=a[d];null==f?c[d]=null:isFunction(f)||(c[d]=f.constructor===Boolean?"boolean":f.constructor===Number?"number":f.constructor===String?"string":f.buffer&&f.buffer.constructor===ArrayBuffer?2==f.length?"vec2":3==f.length?"vec3":4==f.length?"vec4":9==f.length?"mat3":16==f.length?"mat4":0:0)}return c},setObjectProperty:function(a,
b,c){if(a.setProperty)return a.setProperty(b,c);a[b]=c},queryString:function(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if("undefined"===typeof a[d[0]])a[d[0]]=decodeURIComponent(d[1]);else if("string"===typeof a[d[0]]){var f=[a[d[0]],decodeURIComponent(d[1])];a[d[0]]=f}else a[d[0]].push(decodeURIComponent(d[1]))}return a}(),MaterialClasses:{},registerMaterialClass:function(a){var b=e.getClassName(a);this.MaterialClasses[b]=a;this.Classes[b]=
a;e.extendClass(a,m);LEvent.trigger(e,"materialclass_registered",a);a.resource_type="Material"},getGUIElement:function(){if(e._gui_element)return e._gui_element;var a=document.createElement("div");a.className="litescene-gui";a.style.position="absolute";a.style.top="0";a.style.left="0";gl.canvas.parentNode.appendChild(a);return e._gui_element=a},removeGUIElement:function(){e._gui_element&&(e._gui_element.parentNode&&e._gui_element.parentNode.removeChild(e._gui_element),e._gui_element=null)},getScript:function(a){return e.Script.active_scripts[a]}};
Wa.LSQ={set:function(a,b){e.GlobalScene.setPropertyValue(a,b);e.GlobalScene.refresh()},get:function(a){if(a=e.GlobalScene.getPropertyInfo(a))return a.value},shortify:function(a){if(a){var b=a.split("/"),c=null;if(b[0][0]!=e._uid_prefix)return a;c=e.GlobalScene._nodes_by_uid[b[0]];if(!c)return a;b[0]=c.getPathName();b[1]&&b[1][0]==e._uid_prefix&&(a=c.getComponentByUId(b[1]))&&(b[1]=e.getObjectClassName(a));return b.join("/")}}};Wa.trace=Ga;var Ea={NORMAL:"normal",ALPHA:"alpha",ADD:"add",MULTIPLY:"multiply",
SCREEN:"screen",CUSTOM:"custom"};e.Blend=Ea;if("undefined"==typeof GL)throw"LiteSCENE requires to have litegl.js included before litescene.js";e.BlendFunctions={normal:[GL.ONE,GL.ZERO],alpha:[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA],add:[GL.SRC_ALPHA,GL.ONE],multiply:[GL.DST_COLOR,GL.ONE_MINUS_SRC_ALPHA],screen:[GL.SRC_ALPHA,GL.ONE],custom:[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA]};e.STOPPED=0;e.RUNNING=1;e.PAUSED=2;e.Network={request:function(a){if("string"===typeof a)throw"LS.Network.request expects object, not string. Use LS.Network.requestText or LS.Network.requestJSON";
var b=a.dataType||"text";if("json"==b)b="text";else if("xml"==b)b="text";else if("binary"==b)b="arraybuffer",a.mimeType="application/octet-stream";else if("image"==b)return b=new Image,b.onload=function(){a.success&&a.success.call(this)},b.onerror=a.error,b.src=a.url,b;var c=new XMLHttpRequest;c.open(a.data?"POST":"GET",a.url,!0);c.withCredentials=!0;b&&(c.responseType=b);a.mimeType&&c.overrideMimeType(a.mimeType);c.onload=function(b){b=this.response;if(200!=this.status)b="Error "+this.status,a.error&&
a.error(b);else{if("json"==a.dataType)try{b=JSON.parse(b)}catch(f){a.error&&a.error(f)}else if("xml"==a.dataType)try{b=(new DOMParser).parseFromString(b,"text/xml")}catch(g){a.error&&a.error(g)}if(e.catch_errors)try{a.success&&a.success.call(this,b),LEvent.trigger(c,"done",b)}catch(h){LEvent.trigger(e,"code_error",h)}else a.success&&a.success.call(this,b),LEvent.trigger(c,"done",b)}};c.onerror=function(b){a.error&&a.error(b);LEvent.trigger(this,"fail",b)};a.progress&&c.addEventListener("progress",
a.progress);c.send(a.data);return c},requestFile:function(a,b,c,d){"function"==typeof b&&(c=b=null);return e.Network.request({url:a,data:b,success:c,error:d})},requestJSON:function(a,b,c,d){"function"==typeof b&&(c=b=null);return e.Network.request({url:a,data:b,dataType:"json",success:c,error:d})},requestText:function(a,b,c,d){"function"==typeof b&&(c=null);return e.Network.request({url:a,dataType:"txt",success:c,success:c,error:d})},requestScript:function(a,b,c,d){"string"==typeof a&&(a=[a]);var f=
a.length,g;for(g in a){var h=document.createElement("script");h.num=g;h.type="text/javascript";h.src=a[g];h.async=!1;h.onload=function(a){f--;f?d&&d(this.src,this.num):b&&b()};c&&(h.onerror=function(a){c(a,this.src,this.num)});document.getElementsByTagName("head")[0].appendChild(h)}}};var ba={path:"",proxy:"",ignore_cache:!1,free_data:!1,keep_files:!1,resources:{},meshes:{},textures:{},materials:{},materials_by_uid:{},resources_not_found:{},resources_being_loaded:{},resources_being_processed:{},num_resources_being_loaded:0,
MAX_TEXTURE_SIZE:4096,resource_pre_callbacks:{},resource_post_callbacks:{},resource_once_callbacks:{},virtual_file_systems:{},skip_proxy_extensions:["mp3","wav","ogg"],getNoCache:function(a){return this.ignore_cache||a?"nocache="+getTime()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={}},registerResourcePreProcessor:function(a,b,c,d){a=a.split(",");for(var f in a)c=a[f].toLowerCase(),this.resource_pre_callbacks[c]=b},registerResourcePostProcessor:function(a,
b){this.resource_post_callbacks[a]=b},getExtension:function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));b=a.lastIndexOf(".");return-1==b?"":a.substr(b+1).toLowerCase()},getFilename:function(a){var b=a.lastIndexOf("/"),c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c)},getFolder:function(a){var b=a.lastIndexOf("/");return a.substr(0,b)},getBasename:function(a){a=this.getFilename(a);var b=a.indexOf(".");return-1==b?a:a.substr(0,b)},cleanFullpath:function(a){return-1==a.indexOf("://")?
a.split("/").filter(function(a){return!!a}).join("/"):a},loadResources:function(a,b){for(var c in a)"string"==typeof c&&":"!=c[0]&&this.load(c,b);this._total_resources_to_load=this.num_resources_being_loaded;LEvent.trigger(this,"start_loading_resources",this._total_resources_to_load)},setPath:function(a){this.path=a},setProxy:function(a){-1!=a.indexOf("@")?this.proxy="http://"+a.replace("@",window.location.host):this.proxy=a},getFullURL:function(a,b){var c=a.indexOf("://"),d="";-1!=c&&(d=a.substr(0,
c));var f=this.path;b&&b.force_local_url&&(f=".");b&&b.local_repository&&(f=b.local_repository);if(d)switch(d){case "http":case "https":return full_url=a,d=this.getExtension(a).toLowerCase(),this.proxy&&-1==this.skip_proxy_extensions.indexOf(d)?this.proxy+a.substr(c+3):full_url;case "blob":return a;case "":return a;default:return":"==a[0]?a:(this.virtual_file_systems[d]||f)+"/"+a.substr(c+1)}else return f+"/"+a},registerFileSystem:function(a,b){this.virtual_file_systems[a]=b},getResource:function(a){if(!a)return null;
a=a.split("/").filter(function(a){return!!a}).join("/");return this.resources[a]},resourceModified:function(a){a&&(delete a._original_data,delete a._original_file,a._modified=!0,LEvent.trigger(this,"resource_modified",a))},resourceSaved:function(a){a&&(delete a._modified,LEvent.trigger(this,"resource_saved",a))},load:function(a,b,c){if(null!=this.resources[a])return c&&c(this.resources[a]),!0;b=b||{};var d=this.getExtension(a);if(!d)return!1;if(!this.resources_not_found[a])if(this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,
callback:c});else if(!this.resources_being_processed[a]){this.resources_being_loaded[a]=[{options:b,callback:c}];LEvent.trigger(e.ResourcesManager,"resource_loading",a);this.num_resources_being_loaded++;c=this.getFullURL(a);var f=this.getNoCache();f&&(c+=(-1==c.indexOf("?")?"?":"&")+f);c={url:c,success:function(c){e.ResourcesManager.processResource(a,c,b,ba._resourceLoadedSuccess)},error:function(b){e.ResourcesManager._resourceLoadedError(a,b)},progress:function(b){LEvent.hasBind(e.ResourcesManager,
"resource_loading_progress")&&LEvent.trigger(e.ResourcesManager,"resource_loading_progress",{url:a,event:b,progress:b.loaded/b.total});LEvent.hasBind(e.ResourcesManager,"loading_resources_progress")&&LEvent.trigger(e.ResourcesManager,"loading_resources_progress",1-(e.ResourcesManager.num_resources_being_loaded-b.loaded/b.total)/e.ResourcesManager._total_resources_to_load)}};(d=e.Formats.supported[d])&&d.dataType&&(c.dataType=d.dataType);e.Network.request(c);return!1}},processResource:function(a,b,
c,d){function f(a,f){f.remote=!0;f.filename=a;c.filename&&(f.filename=c.filename);f.fullpath=a;e.ResourcesManager.resources_being_processed[a]&&delete e.ResourcesManager.resources_being_processed[a];!e.ResourcesManager.keep_files||b.constructor!=ArrayBuffer&&b.constructor!=String||(f._original_data=b);f.getResources&&ba.loadResources(f.getResources({}));e.ResourcesManager.registerResource(a,f);d&&d(a,f,c)}c=c||{};if(!b)throw"No data found when processing resource: "+a;var g=null,g=this.getExtension(a);
this.resources_being_processed[a]=!0;if(!g){"string"==typeof b&&(b=JSON.parse(b));if(b.constructor==ArrayBuffer){g=x.load(b);f(a,g);return}var h=b.object_type;if(h&&window[h]){var q=window[h],g=null;q.prototype.configure?(g=new window[h],g.configure(b)):g=new window[h](b);f(a,g);return}return!1}(g=this.resource_pre_callbacks[g.toLowerCase()])?(g=g(a,b,c,f),!0!==g&&(g?f(a,g):this._resourceLoadedError(a,"Resource couldnt be processed"))):f(a,{data:b})},registerResource:function(a,b){a=this.cleanFullpath(a);
if(this.resources[a]!=b){b.filename=a;b.object_type||(b.object_type=e.getObjectClassName(b));var c=b.object_type;b.constructor.resource_type&&(c=b.constructor.resource_type);(c=this.resource_post_callbacks[c])&&c(a,b);this.resources[a]=b;LEvent.trigger(this,"resource_registered",b);e.GlobalScene.refresh()}},unregisterResource:function(a){if(!this.resources[a])return!1;var b=this.resources[a];delete this.resources[a];this.meshes[a]&&delete this.meshes[a];this.textures[a]&&delete this.textures[a];LEvent.trigger(this,
"resource_unregistered",b);e.GlobalScene.refresh();return!0},computeResourceInternalData:function(a){if(!a)throw"Resource is null";var b=null,c="text",d="";a._original_file?(b=a._original_file,c="file"):a._original_data?b=a._original_data:a.toBinary?(b=a.toBinary(),c="binary",d="wbin"):a.toBlob?(b=a.toBlob(),c="file"):a.toBase64?(b=a.toBase64(),c="base64"):a.serialize?(a=a.serialize(),a.preview_url&&delete a.preview_url,b=JSON.stringify(a)):b=a.data?a.data:JSON.stringify(a);b.buffer&&b.buffer.constructor==
ArrayBuffer&&(b=b.buffer);return{data:b,encoding:c,extension:d}},getURLasFile:function(a,b){var c=new XMLHttpRequest;c.open("GET",this.getFullURL(a),!0);c.responseType="blob";c.onload=function(d){d=c.response;b&&b(d,a)};c.send()},renameResource:function(a,b,c){var d=this.resources[a];if(!d)return!1;d.filename=b;d.fullpath&&(d.fullpath=b);this.resources[b]=d;delete this.resources[a];c||this.sendResourceRenamedEvent(a,b,d);this.meshes[a]&&(delete this.meshes[a],this.meshes[b]=d);this.textures[a]&&(delete this.textures[a],
this.textures[b]=d);return!0},isLoading:function(){return 0<this.num_resources_being_loaded},clearNotFoundResources:function(){this.resources_not_found={}},computeImageMetadata:function(a){return{width:a.width,height:a.height}},getMesh:function(a){return a?a.constructor===String?this.meshes[a]:a.constructor===GL.Mesh?a:null:null},getTexture:function(a){return a?a.constructor===String?this.textures[a]:a.constructor===GL.Texture?a:null:null},sendResourceRenamedEvent:function(a,b,c){for(var d=e.GlobalScene,
f=0;f<d._nodes.length;f++){for(var g=d._nodes[f],h=0;h<g._components.length;h++){var q=g._components[h];if(q.onResourceRenamed)q.onResourceRenamed(a,b,c)}if((g=g.getMaterial())&&g.onResourceRenamed)g.onResourceRenamed(a,b,c)}},onceLoaded:function(a,b){var c=this.resource_once_callbacks[a];if(c){for(var d in c)if(c[d]==b)return;c.push(b)}else this.resource_once_callbacks[a]=[b]},_resourceLoadedSuccess:function(a,b){e.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+e.ResourcesManager.num_resources_being_loaded);
for(var c in e.ResourcesManager.resources_being_loaded[a])null!=e.ResourcesManager.resources_being_loaded[a][c].callback&&e.ResourcesManager.resources_being_loaded[a][c].callback(b);if(e.ResourcesManager.resource_once_callbacks[a]){var d=e.ResourcesManager.resource_once_callbacks[a];for(c in d)d[c](a,b);delete e.ResourcesManager.resource_once_callbacks[a]}e.ResourcesManager.resources_being_loaded[a]&&(delete e.ResourcesManager.resources_being_loaded[a],e.ResourcesManager.num_resources_being_loaded--,
LEvent.trigger(e.ResourcesManager,"resource_loaded",a),LEvent.trigger(e.ResourcesManager,"loading_resources_progress",1-e.ResourcesManager.num_resources_being_loaded/e.ResourcesManager._total_resources_to_load),0==e.ResourcesManager.num_resources_being_loaded&&(LEvent.trigger(e.ResourcesManager,"end_loading_resources",!0),e.ResourcesManager._total_resources_to_load=0))},_resourceLoadedError:function(a,b){console.log("Error loading "+a);delete e.ResourcesManager.resources_being_loaded[a];delete e.ResourcesManager.resource_once_callbacks[a];
e.ResourcesManager.resources_not_found[a]=!0;LEvent.trigger(e.ResourcesManager,"resource_not_found",a);e.ResourcesManager.num_resources_being_loaded--;0==e.ResourcesManager.num_resources_being_loaded&&LEvent.trigger(e.ResourcesManager,"end_loading_resources",!1)},require:function(a,b){function c(a){for(var b=a.shift(1);ba._required_files[b]&&b;)b=a.shift(1);ba._required_files[b]=!0;e.Network.request({url:b,success:function(d){eval(d);if(ba._waiting_callbacks[b])for(var q in ba._waiting_callbacks[b])ba._waiting_callbacks[b][q]();
c(a)}})}"string"==typeof a&&(a=[a]);var d=a[a.length-1];b&&(ba._waiting_callbacks[d]?ba._waiting_callbacks[d].push(b):ba._waiting_callbacks[d]=[b]);c(a)},_required_files:{},_waiting_callbacks:{}};e.RM=e.ResourcesManager=ba;e.getTexture=function(a){return e.ResourcesManager.getTexture(a)};e.ResourcesManager.registerResourcePostProcessor("Mesh",function(a,b){b.object_type="Mesh";b.metadata&&(b.metadata={},b.generateMetadata());b.bounding&&b.bounding.length==BBox.data_length||(b.bounding=null,b.updateBounding());
b.getBuffer("normals")||b.computeNormals();e.ResourcesManager.free_data&&b.freeData();e.ResourcesManager.meshes[a]=b});e.ResourcesManager.registerResourcePostProcessor("Texture",function(a,b){e.ResourcesManager.textures[a]=b});e.ResourcesManager.registerResourcePostProcessor("Material",function(a,b){e.ResourcesManager.materials[a]=b;e.ResourcesManager.materials_by_uid[b.uid]=b});e.ResourcesManager.registerResourcePreProcessor("wbin",function(a,b,c){return b=x.load(b)},"binary");e.ResourcesManager.registerResourcePreProcessor("json",
function(a,b,c){a=b;b.constructor===String&&(b=JSON.parse(b));b.object_type&&((c=e.Classes[b.object_type]||window[b.object_type])?c.prototype.configure?(a=new c,a.configure(b)):a=new c(b):console.warn("JSON object_type class not found: "+b.object_type));return a});e.ResourcesManager.processImage=function(a,b,c){if(b.width==b.height/6||-1!=a.indexOf("CUBECROSS"))c={wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR},-1!=a.indexOf("CUBECROSSL")&&(c.is_cross=1),c=Texture.cubemapFromImage(b,
c),c.img=b,console.log("Cubemap created");else{c=gl.LINEAR;var d=gl.REPEAT,f=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(f=gl.LINEAR,d=gl.CLAMP_TO_EDGE);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,{format:24==b.bpp?gl.RGB:gl.RGBA,no_flip:b.flipY,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:f}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:d,wrapT:d,magFilter:c,minFilter:f});c.img=b}c.filename=a;c.generateMetadata();return c};e.ResourcesManager.registerResourcePreProcessor("jpg,jpeg,png,webp,gif",
function(a,b,c,d){var f=e.ResourcesManager.getExtension(a),g="image/png";if("jpg"==f||"jpeg"==f)g="image/jpg";"webp"==f&&(g="image/webp");"gif"==f&&(g="image/gif");var f=new Blob([b],{type:g}),h=URL.createObjectURL(f),f=new Image;f.src=h;f.real_filename=a;f.onload=function(){var a=this.real_filename,f=e.ResourcesManager.processImage(a,this,c);f&&e.ResourcesManager.keep_files&&(f._original_data=b);URL.revokeObjectURL(h);f&&d&&d(a,f,c)};f.onerror=function(b){URL.revokeObjectURL(h);d&&d(a,null,c);throw"Error loading image: "+
a;};return!0},"binary","Texture");e.ResourcesManager.registerResourcePreProcessor("dds,tga",function(a,b,c){b=(new Uint8Array(b)).buffer;c=e.Formats.parse(a,b,c);return c.constructor==Texture?(c.filename=a,c):c=e.ResourcesManager.processImage(a,c)});e.ResourcesManager.processASCIIMesh=function(a,b,c){b=e.Formats.parse(a,b,c);return null==b?(console.error("Error parsing mesh: "+a),null):GL.Mesh.load(b)};e.ResourcesManager.registerResourcePreProcessor("obj,ase",e.ResourcesManager.processASCIIMesh,"text",
"Mesh");e.ResourcesManager.registerResourcePreProcessor("stl",e.ResourcesManager.processASCIIMesh,"binary","Mesh");e.ResourcesManager.processASCIIScene=function(a,b,c){b=e.Formats.parse(a,b,c);if(null==b)return console.error("Error parsing mesh: "+a),null;for(var d in b.meshes)e.ResourcesManager.processResource(d,b.meshes[d]);for(d in b.resources)e.ResourcesManager.processResource(d,b.resources[d]);a=new e.SceneNode;a.configure(b.root);e.GlobalScene.root.addChild(a);return a};e.ResourcesManager.registerResourcePreProcessor("dae",
e.ResourcesManager.processASCIIScene,"text","Scene");GL.Mesh.fromBinary=function(a){var b=null,b=a.constructor==ArrayBuffer?x.load(a):a;a={};for(var c in b.vertex_buffers)a[b.vertex_buffers[c]]=b[b.vertex_buffers[c]];var d={};for(c in b.index_buffers)d[b.index_buffers[c]]=b[b.index_buffers[c]];a=new GL.Mesh(a,d);a.info=b.info;a.bounding=b.bounding;if(b.bones){a.bones=b.bones;for(c=0;c<a.bones.length;++c)a.bones[c][1]=mat4.clone(a.bones[c][1]);b.bind_matrix&&(a.bind_matrix=mat4.clone(b.bind_matrix))}return a};
GL.Mesh.prototype.toBinary=function(){this.info||(this.info={});var a={object_type:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBounding();a.bounding=this.bounding;var b=[],d=[];for(c in this.vertexBuffers){var f=this.vertexBuffers[c];a[f.name]=f.data;b.push(f.name);"vertices"==f.name&&(a.info.num_vertices=
f.data.length/3)}for(c in this.indexBuffers)f=this.indexBuffers[c],a[c]=f.data,d.push(c);a.vertex_buffers=b;a.index_buffers=d;return x.create(a,"Mesh")};var Ma={default_xml_url:"data/shaders.xml",snippets:{},compiled_programs:{},compiled_shaders:{},global_shaders:{},default_shader:null,dump_compile_errors:!0,on_compile_error:null,init:function(a,b){this.default_shader=null;this.compiled_programs={};this.compiled_shaders={};this.global_shaders={};this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+
String.fromCharCode(10);this.createDefaultShaders();this.default_shader=this.get("flat");this.last_shaders_url=a=a||this.default_xml_url;this.loadFromXML(a,!1,b)},reloadShaders:function(a){this.loadFromXML(this.last_shaders_url,!0,!0,a)},resolve:function(a){return this.get(a.name,a.macros)},clearCache:function(){this.compiled_programs={};this.compiled_shaders={}},get:function(a,b){if(!a)return this.default_shader;if(!b){var c=this.compiled_programs[a];if(c)return c}var d=this.global_shaders[a];if(null==
d)return this.default_shader;var c=a+":",f="";if(0!=d.num_macros)for(var g in b)d.macros[g]&&(c+=g+"="+b[g]+":",f+=String.fromCharCode(10)+"#define "+g+" "+b[g]+String.fromCharCode(10));g=c.hashCode();if(null!=this.compiled_programs[g])return this.compiled_programs[g];var h=0;this.debug&&(h=getTime());var q=f+d.vs_code,f=f+d.fs_code;if(d.imports)var e={},k=function(a){a=a.split('"')[1];if(e[a])return"//already imported: "+a+"\n";var b=Ma.snippets[a];e[a]=!0;return b?b.code:"//snippet not found: "+
a+"\n"},q=q.replace(/#import\s+\"(\w+)\"\s*\n/g,k),e={},f=f.replace(/#import\s+\"(\w+)\"\s*\n/g,k);if(c=this.compileShader(q,f,c))c.global=d;this.debug&&console.log("Time creating shader:",(getTime()-h).toFixed(3),"ms");return this.registerCompiledShader(c,g,a)},getGlobalShaderInfo:function(a){return this.global_shaders[a]},compileShader:function(a,b,c){if(!c)throw"compileShader must have a name specified";if(!gl)return null;var d=null;try{a=this.global_extra_code+a;b=this.global_extra_code+b;var f=
this.compiled_shaders[c+":VS"];f||(f=this.compiled_shaders[c+":VS"]=GL.Shader.compileSource(gl.VERTEX_SHADER,a));var g=this.compiled_shaders[c+":FS"];g||(g=this.compiled_shaders[c+":FS"]=GL.Shader.compileSource(gl.FRAGMENT_SHADER,b));var h=getTime(),d=new GL.Shader(f,g);this.debug&&console.log("Shader compile time: ",(getTime()-h).toFixed(3),"ms");d.name=c}catch(q){if(this.dump_compile_errors){console.error("Error compiling shader: "+c);console.log(q);console.groupCollapsed("Vertex Shader Code");
a=(this.global_extra_code+a).split("\n");for(var e in a)console.log(e+": "+a[e]);console.groupEnd();console.groupCollapsed("Fragment Shader Code");a=(this.global_extra_code+b).split("\n");for(e in a)console.log(e+": "+a[e]);console.groupEnd();this.dump_compile_errors=!1}if(this.on_compile_error)this.on_compile_error(q);return null}return d},registerCompiledShader:function(a,b,c){if(null==a)return this.compiled_programs[b]=this.default_shader;a.id=c;a.key=b;return this.compiled_programs[b]=a},loadFromXML:function(a,
b,c,d){c=c?"?nocache="+getTime()+Math.floor(1E3*Math.random()):"";e.Network.request({url:a+c,dataType:"xml",success:function(c){console.log("Shaders XML loaded: "+a);b&&(e.ShadersManager.global_shaders={},e.ShadersManager.compiled_programs={},e.ShadersManager.compiled_shaders={});e.ShadersManager.processShadersXML(c);d&&d()},error:function(a){console.log("Error parsing Shaders XML: "+a);throw"Error parsing Shaders XML: "+a;}})},processShadersXML:function(a){var b=a.querySelectorAll("shader"),c;for(c in b){var d=
b[c];if(d&&d.attributes){var f=d.attributes.id;if(f){var f=f.value,g="",h="",q="";(g=d.attributes.macros)&&(q+=g.value);(g=d.querySelector("macros"))&&(q+=g.textContent);g=q.split(",");q={};for(c in g)q[g[c].trim()]=!0;g=d.querySelector("code[type='vertex_shader']").textContent;h=d.querySelector("code[type='pixel_shader']").textContent;if(g&&h){var s={},k=d.getAttribute("multipass");k&&(s.multipass="1"==k||"true"==k);if(k=d.getAttribute("imports"))s.imports="1"==k||"true"==k;if(d=d.getAttribute("events"))s.events=
"1"==d||"true"==d;e.ShadersManager.registerGlobalShader(g,h,f,q,s)}else console.log("no code in shader: "+f)}}}a=a.querySelectorAll("snippet");for(c=0;c<a.length;++c)b=a[c],f=b.getAttribute("id"),this.registerSnippet(f,b.textContent);this.ready=!0},registerGlobalShader:function(a,b,c,d,f){var g=0,h;for(h in d)g+=1;d={vs_code:a,fs_code:b,macros:d,num_macros:g};if(f){for(h in f)d[h]=f[h];f.events&&(f=function(a){a.split('"');return""},d.vs_code=a.replace(/#event\s+\"(\w+)\"\s*\n/g,f),d.fs_code=b.replace(/#event\s+\"(\w+)\"\s*\n/g,
f))}this.global_shaders[c]=d;LEvent.trigger(e.ShadersManager,"newShader");return d},registerSnippet:function(a,b){this.snippets[a]={id:a,code:b}},getSnippet:function(a){return this.snippets[a]},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_mvp;\n\t",common_fscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.registerGlobalShader(this.common_vscode+"\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
this.common_fscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t","flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_fscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t",
"texture_flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",this.common_fscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen")}};e.SM=e.ShadersManager=Ma;ya.prototype.clear=function(){this.macros={};this.hooks={}};ya.prototype.add=function(a){if(a)for(var b in a.macros)this.macros[b]=
a.macros[b]};ya.prototype.setMacro=function(a,b){this.macros[a]=a||""};ya.prototype.resolve=function(){return e.ShadersManager.query(this)};e.ShaderQuery=ya;e.ShaderPart=function(){this.uid=0;this.fragment_code=this.fragment_uniforms=this.vertex_code=this.vertex_uniforms=this.imports=null};var ta={ready:!1,images:{},image_last_id:1,onRequestFrame:null,init:function(){!this.ready&&gl&&(this.color=new Float32Array(4),this.color[3]=1,this.mvp_matrix=mat4.create(),this.temp_matrix=mat4.create(),this.point_size=
2,this.stack=new Float32Array(512),this.model_matrix=new Float32Array(this.stack.buffer,0,16),mat4.identity(this.model_matrix),this.camera=null,this.camera_position=vec3.create(),this.view_matrix=mat4.create(),this.projection_matrix=mat4.create(),this.viewprojection_matrix=mat4.create(),this.camera_stack=[],this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]}),this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t"),
this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:""}),this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_TEXTURE:""}),this.shader_points=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_POINTS:""}),this.shader_points_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_POINTS:""}),this.shader_points_color_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_SIZE:"",USE_POINTS:""}),this.shader_image=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t"),
this.shader_points_color_texture_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tattribute float a_extra;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size * a_extra;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * v_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t"),
this.shader_phong=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_vertex + a_normal,1.0)).xyz - v_pos;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\t\t"),
this.shader_phong.uniforms({u_ambient_color:[0.1,0.1,0.1],u_light_color:[0.8,0.8,0.8],u_light_dir:[0,1,0]}),this.shader_depth=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tvarying vec4 v_pos;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = u_model * vec4(a_vertex,1.0);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec4 v_pos;\n\t\t\t\n\t\t\tvec4 PackDepth32(float depth)\n\t\t\t{\n\t\t\t\tconst vec4 bitSh  = vec4(   256*256*256, 256*256,   256,         1);\n\t\t\t\tconst vec4 bitMsk = vec4(   0,      1.0/256.0,    1.0/256.0,    1.0/256.0);\n\t\t\t\tvec4 comp;\n\t\t\t\tcomp\t= depth * bitSh;\n\t\t\t\tcomp\t= fract(comp);\n\t\t\t\tcomp\t-= comp.xxyz * bitMsk;\n\t\t\t\treturn comp;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = (v_pos.z / v_pos.w) * 0.5 + 0.5;\n\t\t\t\tgl_FragColor = PackDepth32(depth);\n\t\t\t}\t\t"),
this.ready=!0)},createSurfaceShader:function(a,b){-1==a.indexOf("surface_function")&&(a="vec4 surface_function( vec3 pos, vec3 normal, vec2 coord ) { "+a+"\n } ");return new GL.Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform mat4 u_model;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec3 u_camera_position;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+a+"\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = surface_function(v_pos,v_normal,v_coord);\n\t\t\t}\t\t",b)},reset:function(a){this.ready||this.init();a&&(this.images={});this.model_matrix=new Float32Array(this.stack.buffer,0,16);mat4.identity(this.model_matrix)},setColor:function(a){for(var b=
0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setPointSize:function(a){this.point_size=a},setCamera:function(a){this.camera=a;a.updateMatrices();vec3.copy(this.camera_position,a.getEye());mat4.copy(this.view_matrix,a._view_matrix);mat4.copy(this.projection_matrix,a._projection_matrix);mat4.copy(this.viewprojection_matrix,a._viewprojection_matrix)},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},
popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},setViewProjectionMatrix:function(a,b,c){mat4.copy(this.view_matrix,a);mat4.copy(this.projection_matrix,b);c?mat4.copy(this.viewprojection_matrix,c):mat4.multiply(this.viewprojection_matrix,a,c)},setMatrix:function(a){mat4.copy(this.model_matrix,a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b,c){if(a&&a.length){var d=
null,d=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=d.length/3&&(b=null);a=this.toGlobalMesh({vertices:d,colors:b});return this.renderMesh(a,c?gl.LINE_STRIP:gl.LINES,b?this.shader_color:this.shader,void 0,0,d.length/3)}},renderPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&b.constructor!=Float32Array&&(b=b.constructor===Array&&b[0].constructor===
Number?new Float32Array(b):this.linearize(b));a=this.toGlobalMesh({vertices:d,colors:b});c||(c=b?this.shader_color:this.shader);return this.renderMesh(a,gl.POINTS,c,void 0,0,d.length/3)}},renderRoundPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));a=this.toGlobalMesh({vertices:d,colors:b});c||(c=b?this.shader_points_color:this.shader_points);return this.renderMesh(a,
gl.POINTS,c,void 0,0,d.length/3)}},renderPointsWithSize:function(a,b,c,d,f){if(a&&a.length){var g=null,g=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);if(!b)throw"colors required in Draw.renderPointsWithSize";b=b.constructor==Float32Array?b:this.linearize(b);if(!c)throw"sizes required in Draw.renderPointsWithSize";c=c.constructor==Float32Array?c:this.linearize(c);a=this.toGlobalMesh({vertices:g,colors:b,extra:c});f=f||(d?this.shader_points_color_texture_size:this.shader_points_color_size);
return this.renderMesh(a,gl.POINTS,f,void 0,0,g.length/3)}},createRectangleMesh:function(a,b,c,d){var f=new Float32Array(12);c?f.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):f.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);return d?this.toGlobalMesh({vertices:f}):GL.Mesh.load({vertices:f})},renderRectangle:function(a,b,c){a=this.createRectangleMesh(a,b,c,!0);return this.renderMesh(a,gl.LINE_LOOP,void 0,void 0,0,this._global_mesh_last_size)},createCircleMesh:function(a,
b,c,d){b=b||32;quat.create();for(var f=vec3.create(),g=new Float32Array(3*b),h=2*Math.PI/b,q=0;q<b;q++)f[0]=Math.sin(h*q)*a,c?(f[1]=0,f[2]=Math.cos(h*q)*a):(f[2]=0,f[1]=Math.cos(h*q)*a),g.set(f,3*q);return d?this.toGlobalMesh({vertices:g}):GL.Mesh.load({vertices:g})},renderCircle:function(a,b,c,d){a=this.createCircleMesh(a,b,c,!0);return this.renderMesh(a,d?gl.TRIANGLE_FAN:gl.LINE_LOOP,void 0,void 0,0,this._global_mesh_last_size)},renderSolidCircle:function(a,b,c){return this.renderCircle(a,b,c,!0)},
createSphereMesh:function(a,b,c){b=b||100;quat.create();for(var d=vec3.create(),f=new Float32Array(18*b),g=1/b*Math.PI*2,h=0;h<b;h++)d.set([Math.sin(h*g)*a,Math.cos(h*g)*a,0]),f.set(d,18*h),d.set([Math.sin((h+1)*g)*a,Math.cos((h+1)*g)*a,0]),f.set(d,18*h+3),d.set([Math.sin(h*g)*a,0,Math.cos(h*g)*a]),f.set(d,18*h+6),d.set([Math.sin((h+1)*g)*a,0,Math.cos((h+1)*g)*a]),f.set(d,18*h+9),d.set([0,Math.sin(h*g)*a,Math.cos(h*g)*a]),f.set(d,18*h+12),d.set([0,Math.sin((h+1)*g)*a,Math.cos((h+1)*g)*a]),f.set(d,
18*h+15);return c?this.toGlobalMesh({vertices:f}):GL.Mesh.load({vertices:f})},renderWireSphere:function(a,b){var c=this.createSphereMesh(a,b,!0);return this.renderMesh(c,gl.LINES,void 0,void 0,0,this._global_mesh_last_size)},createWireBoxMesh:function(a,b,c,d){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);return d?this.toGlobalMesh({vertices:a},b):GL.Mesh.load({vertices:a,
lines:b})},renderWireBox:function(a,b,c){a=this.createWireBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.LINES,void 0,"indices",0,this._global_mesh_last_size)},createSolidBoxMesh:function(a,b,c,d){a*=0.5;b*=0.5;c*=0.5;a=[-a,b,-c,-a,-b,+c,-a,b,c,-a,b,-c,-a,-b,-c,-a,-b,+c,a,b,-c,a,b,c,a,-b,+c,a,b,-c,a,-b,+c,a,-b,-c,-a,b,c,a,-b,c,a,b,c,-a,b,c,-a,-b,c,a,-b,c,-a,b,-c,a,b,-c,a,-b,-c,-a,b,-c,a,-b,-c,-a,-b,-c,-a,b,-c,a,b,c,a,b,-c,-a,b,-c,-a,b,c,a,b,c,-a,-b,-c,a,-b,-c,a,-b,c,-a,-b,-c,a,-b,c,-a,-b,c];return d?
this.toGlobalMesh({vertices:a}):GL.Mesh.load({vertices:a})},renderSolidBox:function(a,b,c){a=this.createSolidBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.TRIANGLES,void 0,void 0,0,this._global_mesh_last_size)},renderWireCube:function(a){return this.renderWireBox(a,a,a)},renderSolidCube:function(a){return this.renderSolidCube(a,a,a)},renderPlane:function(a,b,c,d){this.push();this.translate(a);this.scale(b[0],b[1],1);c&&c.bind(0);!d&&c&&(d=this.shader_texture);this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,
d);c&&c.unbind(0);this.pop()},createGridMesh:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,f=-b;f<=b;f++)c.set([f*a,0,a*b],d),c.set([f*a,0,-a*b],d+3),c.set([a*b,0,f*a],d+6),c.set([-a*b,0,f*a],d+9),d+=12;return GL.Mesh.load({vertices:c})},renderGrid:function(a,b){var c=this.createGridMesh(a,b);return this.renderMesh(c,gl.LINES)},createConeMesh:function(a,b,c,d,f){var g=[0,1,0];c=c||100;var h=quat.create(),q=vec3.create(),e=new Float32Array(3*(c+2));e.set(d?[0,0,b]:[0,b,0],
0);for(b=0;b<=c;b++)quat.setAxisAngle(h,g,b/c*Math.PI*2),vec3.transformQuat(q,[0,0,a],h),d&&vec3.set(q,q[0],q[2],q[1]),e.set(q,3*b+3);return f?this.toGlobalMesh({vertices:e}):GL.Mesh.load({vertices:e})},renderCone:function(a,b,c,d){a=this.createConeMesh(a,b,c,d,!0);return this.renderMesh(a,gl.TRIANGLE_FAN,void 0,void 0,0,this._global_mesh_last_size)},createCylinderMesh:function(a,b,c,d,f){d=[0,1,0];c=c||100;for(var g=quat.create(),h=vec3.create(),q=new Float32Array(6*(c+1)),e=0;e<=c;e++)quat.setAxisAngle(g,
d,e/c*Math.PI*2),vec3.transformQuat(h,[0,0,a],g),q.set(h,6*e+3),h[1]=b,q.set(h,6*e);return f?this.toGlobalMesh({vertices:q}):GL.Mesh.load({vertices:q})},renderCylinder:function(a,b,c,d){a=this.createCylinderMesh(a,b,c,d,!0);return this.renderMesh(a,gl.TRIANGLE_STRIP,void 0,void 0,0,this._global_mesh_last_size)},renderImage:function(a,b,c,d){c=c||10;var f=null;if("string"==typeof b){f=this.images[b];if(null==f){ta.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);
ta.images[b]=a;if(ta.onRequestFrame)ta.onRequestFrame()};return}if(1==f)return}else b.constructor==Image?(b.texture||(b.texture=GL.Texture.fromImage(this)),f=b.texture):b.constructor==Texture&&(f=b);f&&(d?(this.setPointSize(c),f.bind(0),this.renderPoints(a,null,this.shader_image)):(this.push(),this.billboard(a),this.scale(c,c,c),f.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture),this.pop()))},renderMesh:function(a,b,c,d,f,g){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";
c||(c=a===this._global_mesh&&this._global_mesh_ignore_colors?this.shader:a.vertexBuffers.colors?this.shader_color:this.shader);mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms({u_model:this.model_matrix,u_mvp:this.mvp_matrix,u_color:this.color,u_camera_position:this.camera_position,u_point_size:this.point_size,u_texture:0});void 0===f?c.draw(a,void 0===b?gl.TRIANGLES:b,d):c.drawRange(a,void 0===b?gl.TRIANGLES:b,f,g,d);this._last_mesh=a;this._last_primitive=b;
this._last_shader=c;this._last_indices=d;this._last_range_start=f;this._last_range_length=g;return this.last_mesh=a},repeatLastRender:function(){this.renderMesh(this._last_mesh,this._last_primitive,this._last_shader,this._last_indices,this._last_range_start,this._last_range_length)},renderText:function(a){ta.font_atlas||this.createFontAtlas();for(var b=this.font_atlas,c=a.length,d=b.atlas.char_size,f=b.atlas.spacing,g=0,h=0;h<c;++h)null!=b.atlas[a.charCodeAt(h)]&&g++;for(var e=new Float32Array(18*
g),g=new Float32Array(12*g),s=0,k=0,h=y=0;h<c;++h){var l=b.atlas[a.charCodeAt(h)];l?(e.set([k,y,0],18*s),e.set([k,y+d,0],18*s+3),e.set([k+d,y+d,0],18*s+6),e.set([k+d,y,0],18*s+9),e.set([k,y,0],18*s+12),e.set([k+d,y+d,0],18*s+15),g.set([l[0],l[1]],12*s),g.set([l[0],l[3]],12*s+2),g.set([l[2],l[3]],12*s+4),g.set([l[2],l[1]],12*s+6),g.set([l[0],l[1]],12*s+8),g.set([l[2],l[3]],12*s+10),k+=f,++s):10==a.charCodeAt(h)?(k=0,y-=d):k+=d}a=this.toGlobalMesh({vertices:e,coords:g});b.bind(0);return this.renderMesh(a,
gl.TRIANGLES,this.shader_texture,void 0,0,e.length/3)},createFontAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";d.textAlign="center";for(var f=0,g=0,b=-0.3*b,h={char_size:c,spacing:0.6*c},e=6;100>e;e++){var s=String.fromCharCode(e+27);h[e+27]=[f/a.width,1-(g+c)/a.height,(f+c)/a.width,1-g/a.height];d.fillText(s,Math.floor(f+0.5*c),Math.floor(g+c+b),c);f+=c;f+c>a.width&&(f=0,g+=c)}this.font_atlas=GL.Texture.fromImage(a,
{magFilter:gl.NEAREST,minFilter:gl.LINEAR});this.font_atlas.atlas=h},linearize:function(a){for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,f=0;f<d;++f)c.set(a[f],f*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset+64,16);mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";
this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,16)},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,b,c){3==arguments.length?mat4.scale(this.model_matrix,this.model_matrix,[a,b,c]):a.length?mat4.scale(this.model_matrix,this.model_matrix,a):mat4.scale(this.model_matrix,this.model_matrix,[a,a,a])},translate:function(a,b,c){3==arguments.length?mat4.translate(this.model_matrix,this.model_matrix,[a,b,c]):mat4.translate(this.model_matrix,this.model_matrix,
a)},rotate:function(a,b,c,d){4==arguments.length?mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d]):mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},billboard:function(a){mat4.invert(this.model_matrix,this.view_matrix);mat4.setTranslation(this.model_matrix,a)},fromTranslationFrontTop:function(a,b,c){mat4.fromTranslationFrontTop(this.model_matrix,a,b,c)},project:function(a,
b){b=b||vec3.create();return mat4.multiplyVec3(b,this.mvp_matrix,a)},getPhongShader:function(a,b,c){this.shader_phong.uniforms({u_ambient_color:a,u_light_color:b,u_light_dir:c});return this.shader_phong},getDepthShader:function(){return this.shader_depth},toGlobalMesh:function(a,b){this._global_mesh||(this._global_mesh_max_vertices=1024,this._global_mesh=new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*
this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM}));for(var c in a){var d=this._global_mesh.getBuffer(c);if(d){var f=a[c];f&&(f.buffer||(f=new Float32Array(f)),f.length>d.data.length&&(console.warn("Draw: data is too big, resizing"),this.resizeGlobalMesh(),d=this._global_mesh.getBuffer(c),f=f.subarray(0,d.data.length)),
d.setData(f))}else console.warn("Draw: global mesh lacks one buffer: "+c)}this._global_mesh_ignore_colors=!a.colors;b?(d=this._global_mesh.getIndexBuffer("indices"),d.setData(b),this._global_mesh_last_size=b.length):this._global_mesh_last_size=a.vertices.length/3;return this._global_mesh},resizeGlobalMesh:function(){if(!this._global_mesh)throw"No global mesh to resize";this._global_mesh_max_vertices*=2;this._global_mesh.deleteBuffers();this._global_mesh=new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),
normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM})}};"undefined"!=typeof e&&(e.Draw=ta);m["@color"]={type:"color"};m["@blend_mode"]={type:"enum",values:e.Blend};m.icon="mini-icon-material.png";m.COLOR="color";m.OPACITY="opacity";
m.BLEND_MODE="blend_mode";m.SPECULAR_FACTOR="specular_factor";m.SPECULAR_GLOSS="specular_gloss";m.OPACITY_TEXTURE="opacity";m.COLOR_TEXTURE="color";m.AMBIENT_TEXTURE="ambient";m.SPECULAR_TEXTURE="specular";m.EMISSIVE_TEXTURE="emissive";m.ENVIRONMENT_TEXTURE="environment";m.COORDS_UV0="0";m.COORDS_UV1="1";m.COORDS_UV_TRANSFORMED="transformed";m.COORDS_SCREEN="screen";m.COORDS_SCREENCENTERED="screen_centered";m.COORDS_FLIPPED_SCREEN="flipped_screen";m.COORDS_POLAR="polar";m.COORDS_POLAR_REFLECTED="polar_reflected";
m.COORDS_POLAR_VERTEX="polar_vertex";m.COORDS_WORLDXZ="worldxz";m.COORDS_WORLDXY="worldxy";m.COORDS_WORLDYZ="worldyz";m.TEXTURE_COORDINATES=[m.COORDS_UV0,m.COORDS_UV1,m.COORDS_UV_TRANSFORMED,m.COORDS_SCREEN,m.COORDS_SCREENCENTERED,m.COORDS_FLIPPED_SCREEN,m.COORDS_POLAR,m.COORDS_POLAR_REFLECTED,m.COORDS_POLAR_VERTEX,m.COORDS_WORLDXY,m.COORDS_WORLDXZ,m.COORDS_WORLDYZ];m.DEFAULT_UVS={normal:m.COORDS_UV0,displacement:m.COORDS_UV0,environment:m.COORDS_POLAR_REFLECTED,irradiance:m.COORDS_POLAR};m.available_shaders=
"default global lowglobal phong_texture flat normal phong flat_texture cell_outline".split(" ");m.texture_channels=[m.COLOR_TEXTURE,m.OPACITY_TEXTURE,m.AMBIENT_TEXTURE,m.SPECULAR_TEXTURE,m.EMISSIVE_TEXTURE,m.ENVIRONMENT_TEXTURE];m.prototype.applyToRenderInstance=function(a){this.blend_mode!=e.Blend.NORMAL&&(a.flags|=Na);a.blend_func=this.blend_mode==e.Blend.CUSTOM&&this.blend_func?this.blend_func:e.BlendFunctions[this.blend_mode]};m.prototype.fillShaderQuery=function(a){a=this._query;a.clear();for(var b in this.textures){var c=
this.getTextureSampler(b);if(c){var d=c.uvs||m.DEFAULT_UVS[b]||"0";(c=m.getTextureFromSampler(c))&&(a.macros["USE_"+b.toUpperCase()+(c.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+d)}}if(this.extra_macros)for(var f in this.extra_macros)a.macros[f]=this.extra_macros[f]};m.prototype.fillUniforms=function(a,b){var c={},d={};c.u_material_color=this._color;c.u_ambient_color=a.info?a.info.ambient_color:this._diffuse;c.u_diffuse_color=this._diffuse;c.u_specular=this._specular_data;c.u_texture_matrix=
this.uvs_matrix;c.u_reflection=this.reflection_factor;for(var f in this.textures){var g=this.getTextureSampler(f);if(g){var h=m.getTextureFromSampler(g);h&&(d[f+(h.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=g)}}for(f in this.extra_uniforms)c[f]=this.extra_uniforms[f];this._uniforms=c;this._samplers=d};m.prototype.configure=function(a){for(var b in a)this.setProperty(b,a[b])};m.prototype.serialize=function(){var a=e.cloneObject(this);a.material_class=e.getObjectClassName(this);return a};m.prototype.clone=
function(){var a=this.serialize();a.uid&&delete a.uid;return new this.constructor(JSON.parse(JSON.stringify(a)))};m.prototype.loadAndSetTexture=function(a,b,c){c=c||{};var d=this;if("string"===typeof b)":"!=b[0]?e.ResourcesManager.load(b,c,function(b){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};m.prototype.getProperties=function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",
specular_factor:"number",specular_gloss:"number",uvs_matrix:"mat3"},b=this.getTextureChannels(),c;for(c in b)a["tex_"+b[c]]="Texture";return a};m.prototype.getProperty=function(a){return"tex_"==a.substr(0,4)?this.textures[a.substr(4)]:this[a]};m.prototype.setProperty=function(a,b){if("tex_"==a.substr(0,4))return(!b||b.constructor!==String&&b.constructor!==GL.Texture)&&b||this.setTexture(a.substr(4),b),!0;switch(a){case "opacity":case "specular_factor":case "specular_gloss":case "reflection":case "blend_mode":case "shader_name":this[a]=
b;break;case "uvs_matrix":case "color":this[a].length==b.length&&this[a].set(b);break;case "textures":for(var c in b){var d=b[c];"string"==typeof d&&(d={texture:d,uvs:"0",wrap:0,minFilter:0,magFilter:0});this.textures[c]=d}break;case "transparency":this.opacity=1-b;break;default:return!1}return!0};m.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){a=a[0];var b=null;switch(a){case "opacity":case "transparency":case "specular_factor":case "specular_gloss":case "reflection":case "blend_mode":b=
"number";break;case "shader_name":b="string";break;case "uvs_matrix":b="mat3";break;case "color":b="vec3";break;case "textures":b="Texture";break;default:return null}return{node:this._root,target:this,name:a,value:this[a],type:b}}};m.prototype.getTextureChannels=function(){return this.constructor.texture_channels?this.constructor.texture_channels:[]};m.prototype.setTexture=function(a,b,c){if(!a)throw"Material.prototype.setTexture channel must be specified";if(b){var d=this.textures[a];if(d){if(d.texture==
b)return d;d.texture=b}else this.textures[a]=d={texture:b,uvs:m.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0};if(c)for(var f in c)d[f]=c[f];b.constructor===String&&":"!=b[0]&&e.ResourcesManager.load(b);return d}delete this.textures[a]};m.prototype.setTextureProperty=function(a,b,c){var d=this.textures[a];d?d[b]=c:"texture"==b&&(this.textures[a]={texture:c,uvs:m.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0})};m.prototype.getTexture=function(a){a=a||m.COLOR_TEXTURE;a=this.textures[a];return a?
a.constructor===String?e.ResourcesManager.textures[a]:(a=a.texture)?a.constructor===String?e.ResourcesManager.textures[a]:a.constructor==Texture?a:null:null:null};m.prototype.getTextureSampler=function(a){return this.textures[a]};m.getTextureFromSampler=function(a){a=a.constructor===String?a:a.texture;if(!a)return null;a.constructor===String&&(a=e.ResourcesManager.textures[a]);return a&&a.constructor==Texture?a:null};m.prototype.setTextureSampler=function(a,b){if(!a)throw"Cannot call Material setTextureSampler without channel";
b?this.textures[a]=b:delete this.textures[a]};m.prototype.getResources=function(a){for(var b in this.textures){var c=this.textures[b];c&&"string"==typeof c.texture&&(a[c.texture]=GL.Texture)}return a};m.prototype.onResourceRenamed=function(a,b,c){for(var d in this.textures)(c=this.textures[d])&&c.texture==a&&(c.texture=b)};m.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)e.ResourcesManager.load(b)};m.prototype.registerMaterial=function(a){this.name=a;e.ResourcesManager.registerResource(a,
this);this.material=a};m.prototype.getCategory=function(){return this.category||"Material"};m.prototype.updatePreview=function(a,b){b=b||{};var c={};this.getResources(c);for(var d in c)if(!e.ResourcesManager.resources[d])return console.warn("Cannot generate preview with resources missing."),null;e.GlobalScene.info.textures.environment&&(b.environment=e.GlobalScene.info.textures.environment);this.preview=c=e.Renderer.renderMaterialPreview(this,a||256,b);c.toDataURL&&(this.preview_url=c.toDataURL("image/png"))};
m.prototype.getLocator=function(){return this._root?this._root.uid+"/material":this.uid};m.processShaderCode=function(a){a=a.split("\n");for(var b in a)a[b]=a[b].split("//")[0];return(a=a.join(""))?a:null};m.prototype.createProperty=function(a,b,c){c&&(this.constructor["@"+a]={type:c});b.constructor===Number||b.constructor===String||b.constructor===Boolean?this[a]=b:b.constructor===Float32Array&&(c="_"+a,b=new Float32Array(b),this[c]=b,Object.defineProperty(this,a,{get:function(){return b},set:function(a){b.set(a)},
enumerable:!0}))};e.registerMaterialClass(m);e.Material=m;Object.defineProperty(N.prototype,"detail_factor",{get:function(){return this._detail[0]},set:function(a){this._detail[0]=a},enumerable:!0});Object.defineProperty(N.prototype,"detail_scale",{get:function(){return this._detail.subarray(1,3)},set:function(a){this._detail[1]=a[0];this._detail[2]=a[1]},enumerable:!0});Object.defineProperty(N.prototype,"extra_factor",{get:function(){return this._extra_data[3]},set:function(a){this._extra_data[3]=
a},enumerable:!0});Object.defineProperty(N.prototype,"extra_color",{get:function(){return this._extra_data.subarray(0,3)},set:function(a){this._extra_data.set(a)},enumerable:!0});N.DETAIL_TEXTURE="detail";N.NORMAL_TEXTURE="normal";N.DISPLACEMENT_TEXTURE="displacement";N.BUMP_TEXTURE="bump";N.REFLECTIVITY_TEXTURE="reflectivity";N.IRRADIANCE_TEXTURE="irradiance";N.EXTRA_TEXTURE="extra";N.texture_channels=[m.COLOR_TEXTURE,m.OPACITY_TEXTURE,m.AMBIENT_TEXTURE,m.SPECULAR_TEXTURE,m.EMISSIVE_TEXTURE,N.DETAIL_TEXTURE,
N.NORMAL_TEXTURE,N.DISPLACEMENT_TEXTURE,N.BUMP_TEXTURE,N.REFLECTIVITY_TEXTURE,m.ENVIRONMENT_TEXTURE,N.IRRADIANCE_TEXTURE,N.EXTRA_TEXTURE];N.available_shaders="default lowglobal phong_texture flat normal phong flat_texture".split(" ");N.coding_help="Input IN -> info about the mesh\nSurfaceOutput o -> info about the surface properties of this pixel\n\nstruct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Ambient;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";
N.prototype.fillShaderQuery=function(a){a=this._query;a.clear();for(var b in this.textures){var c=this.getTextureSampler(b);if(c){var d=c.uvs||m.DEFAULT_UVS[b]||"0";if(c=m.getTextureFromSampler(c))"normal"==b?0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.macros.USE_NORMAL_TEXTURE="uvs_"+d,0!=this.normalmap_factor&&(a.macros.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.macros.USE_TANGENT_NORMALMAP="")):"displacement"==
b?0!=this.displacementmap_factor&&gl.derivatives_supported&&(a.macros.USE_DISPLACEMENT_TEXTURE="uvs_"+d,1!=this.displacementmap_factor&&(a.macros.USE_DISPLACEMENTMAP_FACTOR="")):"bump"==b?0!=this.bump_factor&&gl.derivatives_supported&&(a.macros.USE_BUMP_TEXTURE="uvs_"+d,1!=this.bumpmap_factor&&(a.macros.USE_BUMP_FACTOR="")):a.macros["USE_"+b.toUpperCase()+(c.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+d}}this.velvet&&this.velvet_exp&&(a.macros.USE_VELVET="");this.emissive_material&&
(a.macros.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(a.macros.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(a.macros.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(a.macros.USE_SPECULAR_IN_REFLECTION="");0.001<this.backlight_factor&&(a.macros.USE_BACKLIGHT="");0<this.reflection_factor&&(a.macros.USE_REFLECTION="");this.extra_surface_shader_code&&(b=null,this._last_extra_surface_shader_code!=this.extra_surface_shader_code?this._last_processed_extra_surface_shader_code=b=m.processShaderCode(this.extra_surface_shader_code):
b=this._last_processed_extra_surface_shader_code,b&&(a.macros.USE_EXTRA_SURFACE_SHADER_CODE=b));if(this.extra_macros)for(var f in this.extra_macros)a.macros[f]=this.extra_macros[f]};N.prototype.fillUniforms=function(a,b){var c={},d={};c.u_material_color=this._color;c.u_ambient_color=this.use_scene_ambient&&a.info?vec3.fromValues(a.info.ambient_color[0]*this.ambient[0],a.info.ambient_color[1]*this.ambient[1],a.info.ambient_color[2]*this.ambient[2]):this.ambient;c.u_emissive_color=this.emissive||vec3.create();
c.u_specular=this._specular_data;c.u_reflection_info=[this.reflection_additive?-this.reflection_factor:this.reflection_factor,this.reflection_fresnel];c.u_backlight_factor=this.backlight_factor;c.u_normalmap_factor=this.normalmap_factor;c.u_displacementmap_factor=this.displacementmap_factor;c.u_bumpmap_factor=this.bumpmap_factor;this._velvet_info.set(this.velvet);this._velvet_info[3]=this.velvet_additive?this.velvet_exp:-this.velvet_exp;c.u_velvet_info=this._velvet_info;c.u_detail_info=this._detail;
c.u_extra_data=this._extra_data;c.u_texture_matrix=this.uvs_matrix;for(var f in this.textures){var g=this.getTextureSampler(f);if(g){var h=g.texture;if(h){if(h.constructor===String)h=e.ResourcesManager.textures[h];else if(h.constructor!=Texture)continue;h&&(d[f+(h.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=g);h&&"irradiance"==f&&h.type==gl.TEXTURE_2D&&(h.bind(0),h.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),h.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),h.setParameter(gl.TEXTURE_WRAP_T,
gl.CLAMP_TO_EDGE))}}}for(f in this.extra_uniforms)c[f]=this.extra_uniforms[f];this._uniforms=c;this._samplers=d};N.prototype.setProperty=function(a,b){if(m.prototype.setProperty.call(this,a,b))return!0;switch(a){case "backlight_factor":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "normalmap_tangent":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "detail_factor":case "specular_ontop":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "extra_surface_shader_code":this[a]=
b;break;case "ambient":case "emissive":case "velvet":case "detail_scale":case "extra_color":this[a].length==b.length&&this[a].set(b);break;case "extra_uniforms":this.extra_uniforms=e.cloneObject(b);break;default:return!1}return!0};N.prototype.getProperties=function(){var a=m.prototype.getProperties.call(this);a.merge({backlight_factor:"number",reflection_factor:"number",reflection_fresnel:"number",velvet_exp:"number",normalmap_factor:"number",displacementmap_factor:"number",extra_factor:"number",
extra_surface_shader_code:"string",ambient:"vec3",emissive:"vec3",velvet:"vec3",extra_color:"vec3",detail_factor:"number",detail_scale:"vec2",specular_ontop:"boolean",normalmap_tangent:"boolean",reflection_specular:"boolean",use_scene_ambient:"boolean",velvet_additive:"boolean"});return a};R.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=m.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];switch(a){case "backlight_factor":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "detail_factor":type=
"number";break;case "extra_surface_shader_code":type="string";break;case "ambient":case "emissive":case "velvet":case "extra_color":type="vec3";break;case "detail_scale":type="vec2";break;case "specular_ontop":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "velvet_additive":type="boolean";break;default:return null}return{node:this._root,target:this,name:a,value:this[a],type:type}}};e.registerMaterialClass(N);e.StandardMaterial=N;X.icon="mini-icon-material.png";X.coding_help=
"struct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo; /*store the color output here*/\n\tvec3 Normal;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";X.prototype.onCodeChange=function(){this.computeCode()};X.prototype.getCode=function(){return this.code};X.prototype.computeCode=
function(){for(var a="",b=0,c=this.properties.length;b<c;++b){var d="uniform ",f=this.properties[b];switch(f.type){case "number":d+="float ";break;case "vec2":d+="vec2 ";break;case "color":case "vec3":d+="vec3 ";break;case "color4":case "vec4":d+="vec4 ";break;case "texture":d+="sampler2D ";break;case "cubemap":d+="samplerCube ";break;default:continue}d+=f.name+";";a+=d}d=this.code.split("\n");b=0;for(c=d.length;b<c;++b)d[b]=d[b].split("//")[0];this.surf_code=a+d.join("")};X.prototype.onModifyQuery=
function(a){this._ps_uniforms_code&&(a.macros.USE_PIXEL_SHADER_UNIFORMS=a.macros.USE_PIXEL_SHADER_UNIFORMS?a.macros.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code);this._ps_functions_code&&(a.macros.USE_PIXEL_SHADER_FUNCTIONS=a.macros.USE_PIXEL_SHADER_FUNCTIONS?a.macros.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code);this._ps_code&&(a.macros.USE_PIXEL_SHADER_CODE=a.macros.USE_PIXEL_SHADER_CODE?a.macros.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code);
a.macros.USE_SURFACE_SHADER=this.surf_code};X.prototype.fillShaderQuery=function(a){a=this._query;a.clear();if(this.textures.environment){var b=this.textures.environment,c=e.getTexture(b.texture);c&&(a.macros["USE_ENVIRONMENT_"+(c.type==gl.TEXTURE_2D?"TEXTURE":"CUBEMAP")]=b.uvs)}};X.prototype.fillUniforms=function(a,b){for(var c={},d=0,f=this.properties.length;d<f;++d){var g=this.properties[d];if("texture"==g.type||"cubemap"==g.type||"sampler"==g.type){if(g.value){var h=e.getTexture("sampler"==g.type?
g.value.texture:g.value);h||(h=":missing");c[g.name]=h}}else this._uniforms[g.name]=g.value}this._uniforms.u_material_color=this._color;this.textures.environment&&(d=this.textures.environment,(h=e.getTexture(d.texture))&&(c["environment"+(h.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=d));this._samplers=c};X.prototype.configure=function(a){e.cloneObject(a,this);this.computeCode()};X.prototype.onResourceRenamed=function(a,b,c){m.prototype.onResourceRenamed.call(this,a,b,c);c=0;for(var d=this.properties.length;c<
d;++c){var f=this.properties[c];f.value==a&&(f.value=b)}};X.prototype.getProperties=function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",code:"string"},b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};X.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return(a=this.textures[a.substr(4)])?a.texture:null;for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return d.value}return null};
X.prototype.setProperty=function(a,b){if(m.prototype.setProperty.call(this,a,b))return!0;for(var c=0,d=this.properties.length;c<d;++c){var f=this.properties[c];if(f.name==a)return f.value=b,!0}return!1};X.prototype.setPropertyValueFromPath=function(a,b){if(!(1>a.length))return this.setProperty(a[0],b)};X.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){a=a[0];for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return{node:this._root,target:this,name:d.name,
value:d.value,type:d.type}}}};X.prototype.getTextureChannels=function(){for(var a=[],b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||a.push(d.name)}return a};X.prototype.setTexture=function(a,b,c){if(!a)throw"CustomMaterial.prototype.setTexture channel must be specified";var d=null;if("environment"==a)return m.prototype.setTexture.call(this,a,b,c);for(var f=0;f<this.properties.length;++f){var g=this.properties[f];if("texture"==
g.type||"cubemap"==g.type||"sampler"==g.type)if(!a||g.name==a){(d=this.textures[a])||(d=this.textures[a]={texture:b,uvs:"0",wrap:0,minFilter:0,magFilter:0});if(c)for(f in c)d[f]=c[f];g.value="sampler"==g.type?d:b;break}}b&&b.constructor==String&&":"!=b[0]&&e.ResourcesManager.load(b);return d};X.prototype.getResources=function(a){for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||!d.value||(d="sampler"==d.type?d.value.texture:
d.value,"string"==typeof d&&(a[d]=GL.Texture))}return a};e.registerMaterialClass(X);e.CustomMaterial=X;R.icon="mini-icon-material.png";R.coding_help="struct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";R.prototype.onCodeChange=
function(){this.computeCode()};R.prototype.getCode=function(){return this.code};R.prototype.computeCode=function(){for(var a="",b=0,c=this.properties.length;b<c;++b){var d="uniform ",f=this.properties[b];switch(f.type){case "number":d+="float ";break;case "vec2":d+="vec2 ";break;case "color":case "vec3":d+="vec3 ";break;case "color4":case "vec4":d+="vec4 ";break;case "texture":d+="sampler2D ";break;case "cubemap":d+="samplerCube ";break;default:continue}d+=f.name+";";a+=d}d=this.code.split("\n");
b=0;for(c=d.length;b<c;++b)d[b]=d[b].split("//")[0];this.surf_code=a+d.join("")};R.prototype.onModifyQuery=function(a){this._ps_uniforms_code&&(a.macros.USE_PIXEL_SHADER_UNIFORMS=a.macros.USE_PIXEL_SHADER_UNIFORMS?a.macros.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code);this._ps_functions_code&&(a.macros.USE_PIXEL_SHADER_FUNCTIONS=a.macros.USE_PIXEL_SHADER_FUNCTIONS?a.macros.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code);this._ps_code&&(a.macros.USE_PIXEL_SHADER_CODE=
a.macros.USE_PIXEL_SHADER_CODE?a.macros.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code);a.macros.USE_SURFACE_SHADER=this.surf_code};R.prototype.fillShaderQuery=function(a){a=this._query;a.clear();if(this.textures.environment){var b=this.textures.environment,c=e.getTexture(b.texture);c&&(a.macros["USE_ENVIRONMENT_"+(c.type==gl.TEXTURE_2D?"TEXTURE":"CUBEMAP")]=b.uvs)}};R.prototype.fillUniforms=function(a,b){for(var c={},d=0,f=this.properties.length;d<f;++d){var g=this.properties[d];if("texture"==
g.type||"cubemap"==g.type||"sampler"==g.type){if(g.value){var h=e.getTexture("sampler"==g.type?g.value.texture:g.value);h||(h=":missing");c[g.name]=h}}else this._uniforms[g.name]=g.value}this._uniforms.u_material_color=this._color;this.textures.environment&&(d=this.textures.environment,(h=e.getTexture(d.texture))&&(c["environment"+(h.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=d));this._samplers=c};R.prototype.configure=function(a){e.cloneObject(a,this);this.computeCode()};R.prototype.getProperties=
function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",code:"string"},b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};R.prototype.onResourceRenamed=function(a,b,c){m.prototype.onResourceRenamed.call(this,a,b,c);c=0;for(var d=this.properties.length;c<d;++c){var f=this.properties[c];f.value==a&&(f.value=b)}};R.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return(a=this.textures[a.substr(4)])?a.texture:
null;for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return d.value}return null};R.prototype.setProperty=function(a,b){if(m.prototype.setProperty.call(this,a,b))return!0;for(var c=0,d=this.properties.length;c<d;++c){var f=this.properties[c];if(f.name==a)return f.value=b,!0}return!1};R.prototype.setPropertyValueFromPath=function(a,b){if(!(1>a.length))return this.setProperty(a[0],b)};R.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=m.prototype.getPropertyInfoFromPath.call(this,
a);if(b)return b;a=a[0];for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return{node:this._root,target:this,name:d.name,value:d.value,type:d.type}}}};R.prototype.getTextureChannels=function(){for(var a=[],b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||a.push(d.name)}return a};R.prototype.setTexture=function(a,b,c){if(!a)throw"SurfaceMaterial.prototype.setTexture channel must be specified";var d=
null;if("environment"==a)return m.prototype.setTexture.call(this,a,b,c);for(var f=0;f<this.properties.length;++f){var g=this.properties[f];if("texture"==g.type||"cubemap"==g.type||"sampler"==g.type)if(!a||g.name==a){(d=this.textures[a])||(d=this.textures[a]={texture:b,uvs:"0",wrap:0,minFilter:0,magFilter:0});if(c)for(f in c)d[f]=c[f];g.value="sampler"==g.type?d:b;break}}b&&b.constructor==String&&":"!=b[0]&&e.ResourcesManager.load(b);return d};R.prototype.getResources=function(a){for(var b=0,c=this.properties.length;b<
c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||!d.value||(d="sampler"==d.type?d.value.texture:d.value,"string"==typeof d&&(a[d]=GL.Texture))}return a};e.registerMaterialClass(R);e.SurfaceMaterial=R;ja.prototype.configureComponents=function(a){if(a.components)for(var b=0,c=a.components.length;b<c;++b){var d=a.components[b],f=d[0];"Transform"==f&&0==b?this.transform.configure(d[1]):e.Components[f]?(d=new e.Components[f](d[1]),this.addComponent(d)):console.error("Unknown component found: "+
f)}};ja.prototype.serializeComponents=function(a){if(this._components){a.components=[];for(var b=0,c=this._components.length;b<c;++b){var d=this._components[b];if(d.serialize){var f=d.serialize();d.hasOwnProperty("uid")&&!f.uid&&(f.uid=d.uid);a.components.push([e.getObjectClassName(d),f])}}}};ja.prototype.getComponents=function(){return this._components};ja.prototype.addComponent=function(a,b){if(!a)return console.error("addComponent cannot receive null");a._root=this;if(this.constructor==e.SceneNode&&
a.onAddedToNode)a.onAddedToNode(this);if((this._in_tree||this.constructor==e.SceneTree)&&a.onAddedToScene)a.onAddedToScene(this.constructor==e.SceneTree?this:this._in_tree);this._components||Object.defineProperty(this,"_components",{value:[],enumerable:!1});if(-1!=this._components.indexOf(a))throw"inserting the same component twice";void 0!==b&&b<=this._components.length?this._components.splice(b,0,a):this._components.push(a);a.uid||(a.uid=e.generateUId("COMP-"));return a};ja.prototype.removeComponent=
function(a){if(!a)return console.error("removeComponent cannot receive null");a._root=null;if(this.constructor==e.SceneNode&&a.onRemovedFromNode)a.onRemovedFromNode(this);if((this._in_tree||this.constructor==e.SceneTree)&&a.onRemovedFromScene)a.onRemovedFromScene(this.constructor==e.SceneTree?this:this._in_tree);LEvent.unbindAll(this,a);a=this._components.indexOf(a);-1!=a&&this._components.splice(a,1)};ja.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};
ja.prototype.hasComponent=function(a){if(!this._components)return!1;if(a.constructor===String){for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].constructor.name==a)return!0;return!1}b=0;for(c=this._components.length;b<c;++b)if(this._components[b].constructor===a)return!0;return!1};ja.prototype.getComponent=function(a){if(!this._components)return null;if(a.constructor===String){for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].constructor.name==a)return this._components[b];
return null}b=0;for(c=this._components.length;b<c;++b)if(this._components[b].constructor==a)return this._components[b];return null};ja.prototype.getComponentByUId=function(a){if(!this._components)return null;for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].uid==a)return this._components[b];return null};ja.prototype.getIndexOfComponent=function(a){return this._components?this._components.indexOf(a):-1};ja.prototype.getComponentByIndex=function(a){return this._components?this._components[a]:
null};ja.prototype.setComponentIndex=function(a,b){if(!this._components)return null;0>b&&(b=0);var c=this._components.indexOf(a);-1!=c&&(this._components.splice(c,1),b>=this._components.length?this._components.push(a):this._components.splice(b,0,a))};ja.prototype.processActionInComponents=function(a,b){if(this._components)for(var c=0,d=this._components.length;c<d;++c){var f=this._components[c];f[a]&&f[a].constructor===Function&&(b&&b.constructor===Array?f[a].apply(f,b):f[a].call(f,b))}};Z.prototype.compositeCtor=
function(){};Z.prototype.addChild=function(a,b,c){function d(a){if(a._children)for(var b in a._children){var c=a._children[b];c._in_tree||(LEvent.trigger(g,"treeItemAdded",c),c._in_tree=g);d(c)}}for(var f=this;f._parentNode;){if(f==a)throw"addChild: Cannot insert a node as his own child";f=f._parentNode}a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):this._children.splice(b,0,a):this._children=[a];var g=this._in_tree;if(g&&a._in_tree&&
a._in_tree!=g)throw"Cannot add a node that belongs to another scene tree";a._in_tree=g;this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);g&&(LEvent.trigger(g,"treeItemAdded",a),d(a))};Z.prototype.removeChild=function(a,b,c){function d(a){if(a._children)for(var b=0,c=a._children.length;b<c;++b){var f=a._children[b];f._in_tree&&(LEvent.trigger(f._in_tree,"treeItemRemoved",f),f._in_tree=null);d(f)}}if(!this._children||a._parentNode!=this||a._parentNode!=this)return!1;var f=
this._children.indexOf(a);if(-1==f)return!1;this._children.splice(f,1);this._onChildRemoved&&this._onChildRemoved(a,b,c);LEvent.trigger(this,"childRemoved",a);a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemRemoved",a),d(a));a._in_tree=null;return!0};Z.prototype.destroy=function(){this._parentNode&&this._parentNode.removeChild(this)};Z.prototype.serializeChildren=function(){var a=[];if(this._children)for(var b in this._children)a.push(this._children[b].serialize());return a};Z.prototype.configureChildren=
function(a){if(a.children)for(var b in a.children){var c=a.children[b],d=new this.constructor(c.id);c.uid&&(d.uid=c.uid);this.addChild(d);d.configure(c)}};Z.prototype.getParent=function(){return this._parentNode};Z.prototype.getChildren=function(){return this._children||[]};Z.prototype.getChildIndex=function(a){return this._children?this._children.indexOf(a):-1};Z.prototype.getChildByIndex=function(a){return this._children&&this._children.length>a?this._children[a]:null};Z.prototype.getChildByName=
function(a){if(!this._children)return null;for(var b=0;b<this._children.length;++b)if(this._children[b].name==a)return this._children[b]};Z.prototype.getPathName=function(){if(!this._in_tree)return null;if(this===this._in_tree.root)return"";for(var a=this.name,b=this.parentNode;b;){if(b===this._in_tree.root)return a;a=b.name+"|"+a;b=b.parentNode}return null};Object.defineProperty(Z.prototype,"childNodes",{enumerable:!0,get:function(){return this._children||[]},set:function(a){}});Object.defineProperty(Z.prototype,
"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){}});Object.defineProperty(Z.prototype,"scene",{enumerable:!0,get:function(){return this._in_tree},set:function(a){throw"Scene cannot be set, you must use addChild in parent";}});Z.prototype.getDescendants=function(){if(!this._children||0==this._children.length)return[];for(var a=this._children.concat(),b=0;b<this._children.length;++b)a=a.concat(this._children[b].getDescendants());return a};Z.prototype.findChildNodeByName=
function(a){if(!a)return null;if(this.name==a)return this;var b=this._children;if(b)for(var c=0;c<b.length;++c){var d=b[c];if(d.name==a||d._children&&(d=d.findChildNodeByName(a)))return d}return null};Da.prototype.configure=function(a){a&&(a.uid&&(this.uid=a.uid),e.cloneObject(a,this))};Da.prototype.serialize=function(){var a=e.cloneObject(this);this.uid&&(a.uid=this.uid);return a};Da.prototype.clone=function(){var a=this.serialize();a.uid=null;return new this.constructor(a)};Da.prototype.createProperty=
function(a,b,c,d,f){if(c){if("String"==c||"Number"==c||"Boolean"==c)console.warn("createProperty: Basic types must be in lowercase -> "+c),c=c.toLowerCase();this.constructor["@"+a]="object"==typeof c?c:{type:c}}if(b.constructor!==Number&&b.constructor!==String&&b.constructor!==Boolean||d||f){var g="_"+a;b.constructor===Float32Array?(b=new Float32Array(b),this[g]=b,Object.defineProperty(this,a,{get:f||function(){return b},set:d||function(a){b.set(a)},enumerable:!0})):(Object.defineProperty(this,g,
{value:b,enumerable:!1}),Object.defineProperty(this,a,{get:f||function(){return this[g]},set:d||function(a){this[g]=a},enumerable:!0}))}else this[a]=b};Da.prototype.getLocator=function(){return this._root?this._root.uid+"/"+this.uid:""};Da.addExtraMethods=function(a){Object.defineProperty(a.prototype,"uid",{set:function(a){a&&(a[0]!=e._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=e._uid_prefix+a),a!=this._uid&&(this._uid=a))},get:function(){return this._uid},enumerable:!1});Object.defineProperty(a.prototype,
"root",{set:function(a){throw"root cannot be set, call addComponent to the root";},get:function(){return this._root},enumerable:!1})};e.Component=Da;t.temp_matrix=mat4.create();t.icon="mini-icon-gizmo.png";t.ZERO=vec3.create();t.UP=vec3.fromValues(0,1,0);t.RIGHT=vec3.fromValues(1,0,0);t.FRONT=vec3.fromValues(0,0,-1);t["@position"]={type:"position"};t["@rotation"]={type:"quat"};t.properties={position:"vec3",scaling:"vec3",rotation:"quat"};t.prototype.onAddedToNode=function(a){a.transform||(a.transform=
this)};t.prototype.onRemovedFromNode=function(a){a.transform==this&&delete a.transform};t.prototype.mustUpdate=function(){this._must_update_matrix=!0};Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(t.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(t.prototype,
"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(t.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(t.prototype,"scaling",{get:function(){return this._scaling},
set:function(a){a.constructor===Number?this._scaling[0]=this._scaling[1]=this._scaling[2]=a:this._scaling.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(t.prototype,"matrix",{get:function(){this._must_update_matrix&&this.updateMatrix();return this._local_matrix},set:function(a){this.fromMatrix(a)},enumerable:!0});Object.defineProperty(t.prototype,"globalPosition",{get:function(){return this.getGlobalPosition()},set:function(a){},enumerable:!0});Object.defineProperty(t.prototype,
"globalMatrix",{get:function(){this.updateGlobalMatrix();return this._global_matrix},set:function(a){},enumerable:!0});t.prototype.getProperties=function(a){return"output"==a?{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4",globalPosition:"vec3",globalMatrix:"mat4"}:{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4"}};t.prototype.copyFrom=function(a){this.configure(a.serialize())};t.prototype.configure=function(a){a.uid&&(this.uid=a.uid);a.position&&this._position.set(a.position);
a.scaling&&this._scaling.set(a.scaling);a.rotation&&4==a.rotation.length&&this._rotation.set(a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._must_update_matrix=
!0;this.updateGlobalMatrix();this._on_change()};t.prototype.serialize=function(){return{uid:this.uid,position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scaling:[this._scaling[0],this._scaling[1],this._scaling[2]],matrix:Array.apply([],this._local_matrix)}};t.prototype.identity=function(){vec3.copy(this._position,[0,0,0]);quat.copy(this._rotation,[0,0,0,1]);vec3.copy(this._scaling,[1,1,1]);mat4.identity(this._local_matrix);
mat4.identity(this._global_matrix);this._must_update_matrix=!1};t.prototype.reset=t.prototype.identity;t.prototype.getPosition=function(a){a=a||vec3.create();a.set(this._position);return a};t.prototype.getGlobalPosition=function(a){a=a||vec3.create();return this._parent?mat4.multiplyVec3(a,this.getGlobalMatrix(),t.ZERO):vec3.copy(a,this._position)};t.prototype.getRotation=function(a){a=a||quat.create();return vec3.copy(a,this._rotation)};t.prototype.getGlobalRotation=function(a){a=a||quat.create();
if(!this._parent)return quat.copy(a,this._rotation),a;var b=this._parent;for(quat.copy(a,this._rotation);b;)quat.multiply(a,b._rotation,a),b=b._parent;return a};t.prototype.getScale=function(a){a=a||vec3.create();return vec3.copy(a,this._scaling)};t.prototype.getGlobalScale=function(a){a=a||vec3.create();if(this._parent){var b=this;for(vec3.copy(a,this._scaling);b._parent;)vec3.multiply(a,a,b._scaling),b=b._parent;return a}return vec3.copy(a,this._scaling)};t.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,
this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scaling);this._must_update_matrix=!1};t.prototype.updateLocalMatrix=t.prototype.updateMatrix;t.prototype.updateGlobalMatrix=function(a){this._must_update_matrix&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):this._global_matrix.set(this._local_matrix)};t.prototype.getMatrix=function(a){a=a||mat4.create();this._must_update_matrix&&
this.updateMatrix();return mat4.copy(a,this._local_matrix)};t.prototype.getLocalMatrix=t.prototype.getMatrix;t.prototype.getLocalMatrixRef=function(){this._must_update_matrix&&this.updateMatrix();return this._local_matrix};t.prototype.getGlobalMatrix=function(a,b){this._must_update_matrix&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,b?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):mat4.copy(this._global_matrix,this._local_matrix);
return mat4.copy(a,this._global_matrix)};t.prototype.getGlobalMatrixRef=function(){this.updateGlobalMatrix();return this._global_matrix};t.prototype.getAncestors=function(){for(var a=[this],b=this;b=b._parent;)a.unshift(b);return a};t.prototype.getGlobalTranslationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1)};t.prototype.getGlobalRotationMatrix=function(a){a=a||mat4.create();if(!this._parent)return mat4.fromQuat(a,this._rotation);
for(var b=mat4.create(),c=this;c;)mat4.fromQuat(b,c._rotation),mat4.multiply(a,a,b),c=c._parent;return a};t.prototype.getGlobalTranslationRotationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromRotationTranslation(mat4.create(),this.getGlobalRotation(),a)};t.prototype.getGlobalMatrixWithoutScale=t.prototype.getGlobalTranslationRotationMatrix;t.prototype.getNormalMatrix=function(a){this._must_update_matrix&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,
this._parent.getGlobalMatrix(),this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};t.prototype.fromMatrix=function(a,b){if(b&&this._parent){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();this._scaling[0]=vec3.length(mat4.rotateVec3(d,c,[1,0,0]));this._scaling[1]=vec3.length(mat4.rotateVec3(d,c,[0,1,0]));
this._scaling[2]=vec3.length(mat4.rotateVec3(d,c,[0,0,1]));mat4.scale(mat4.create(),c,[1/this._scaling[0],1/this._scaling[1],1/this._scaling[2]]);vec3.normalize(c.subarray(0,3),c.subarray(0,3));vec3.normalize(c.subarray(4,7),c.subarray(4,7));vec3.normalize(c.subarray(8,11),c.subarray(8,11));c=mat3.fromMat4(mat3.create(),c);mat3.transpose(c,c);quat.fromMat3(this._rotation,c);quat.normalize(this._rotation,this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=
!1;this._on_change(!0)};t.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._must_update_matrix=!0;this._on_change()};t.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._must_update_matrix=!0;this._on_change()};t.prototype.setRotation=function(a){quat.copy(this._rotation,a);this._must_update_matrix=!0;this._on_change()};t.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scaling,
a,b,c):vec3.set(this._scaling,a,a,a);this._must_update_matrix=!0;this._on_change()};t.prototype.translate=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._must_update_matrix=!0;this._on_change()};t.prototype.translateLocal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,this.transformVector([a,b,c])):vec3.add(this._position,this._position,this.transformVector(a));this._must_update_matrix=
!0;this._on_change()};t.prototype.rotate=function(){var a=quat.create();return function(b,c){quat.setAxisAngle(a,c,0.0174532925*b);quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0;this._on_change()}}();t.prototype.rotateX=function(a){quat.rotateX(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};t.prototype.rotateY=function(a){quat.rotateY(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};
t.prototype.rotateZ=function(a){quat.rotateZ(this._rotation,this._rotation,0.0174532925*a);this._must_update_matrix=!0;this._on_change()};t.prototype.rotateGlobal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._must_update_matrix=!0;this._on_change()};t.prototype.rotateQuat=function(a){quat.multiply(this._rotation,this._rotation,a);this._must_update_matrix=!0;this._on_change()};t.prototype.rotateQuatGlobal=function(a){quat.multiply(this._rotation,
a,this._rotation);this._must_update_matrix=!0;this._on_change()};t.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scaling,this._scaling,[a,b,c]):vec3.multiply(this._scaling,this._scaling,a);this._must_update_matrix=!0;this._on_change()};t.interpolate=function(a,b,c,d){vec3.lerp(d._scaling,a._scaling,b._scaling,c);vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._must_update_matrix=!0;this._on_change()};t.prototype.lookAt=
function(){var a=mat4.create(),b=mat4.create(),c=vec3.create(),d=vec3.create(),f=vec3.create();return function(g,h,e,s){s&&this._parent?(this._parent.getGlobalMatrix(a),s=mat4.invert(a,a),mat4.multiplyVec3(c,s,g),mat4.multiplyVec3(d,s,h),mat4.rotateVec3(f,s,e)):(c.set(g),d.set(h),f.set(e));mat4.lookAt(b,c,d,f);quat.fromMat4(this._rotation,b);this._position.set(c);this._must_update_matrix=!0}}();t.prototype._on_change=function(a){a||(this._must_update_matrix=!0);LEvent.trigger(this,"changed",this);
this._root&&LEvent.trigger(this._root,"transformChanged",this)};t.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),t.FRONT,this.getGlobalRotation())};t.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),t.UP,this.getGlobalRotation())};t.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),t.RIGHT,this.getGlobalRotation())};t.prototype.transformPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();return mat4.multiplyVec3(b,
this._local_matrix,a)};t.prototype.transformPointGlobal=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrixRef(),a)};t.prototype.localToGlobal=t.prototype.transformPointGlobal;t.prototype.globalToLocal=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateMatrix();var c=mat4.invert(mat4.create(),this.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};t.prototype.transformVector=function(a,b){return vec3.transformQuat(b||
vec3.create(),a,this._rotation)};t.prototype.transformVectorGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getGlobalRotation())};t.prototype.localVectorToGlobal=t.prototype.transformVectorGlobal;t.prototype.globalVectorToLocal=function(a,b){var c=this.getGlobalRotation();quat.invert(c,c);return vec3.transformQuat(b||vec3.create(),a,c)};t.prototype.applyTransform=function(a,b,c){vec3.add(this._position,this._position,a._position);quat.multiply(this._rotation,this._rotation,
a._rotation);vec3.multiply(this._scaling,this._scaling,a._scaling);this._must_update_matrix=!0};t.prototype.applyTransformMatrix=function(){var a=mat4.create(),b=vec3.create(),c=mat4.create();mat4.create();var d=mat4.create();return function(f,g,h){g&&(mat4.setTranslation(a,g),vec3.scale(b,g,-1),mat4.setTranslation(c,b),mat4.multiply(f,a,f),mat4.multiply(f,f,c));this._parent?(g=this.getGlobalMatrix(),h=this._parent._global_matrix,mat4.multiply(this._global_matrix,f,g),mat4.invert(d,h),mat4.multiply(this._local_matrix,
d,this._global_matrix),this.fromMatrix(this._local_matrix)):this.applyLocalTransformMatrix(f)}}();t.prototype.applyLocalTransformMatrix=function(a){var b=vec3.create();vec3.transformMat4(this._position,this._position,a);mat4.rotateVec3(b,a,[1,0,0]);this._scaling[0]*=vec3.length(b);mat4.rotateVec3(b,a,[0,1,0]);this._scaling[1]*=vec3.length(b);mat4.rotateVec3(b,a,[0,0,1]);this._scaling[2]*=vec3.length(b);a=mat4.invert(mat4.create(),a);mat4.transpose(a,a);a=mat3.fromMat4(mat3.create(),a);a=quat.fromMat3(quat.create(),
a);quat.normalize(a,a);quat.multiply(this._rotation,a,this._rotation);this._must_update_matrix=!0};e.registerComponent(t);e.Transform=t;w.icon="mini-icon-camera.png";w.PERSPECTIVE=1;w.ORTHOGRAPHIC=2;w.ORTHO2D=3;w["@type"]={type:"enum",values:{perspective:w.PERSPECTIVE,orthographic:w.ORTHOGRAPHIC,ortho2D:w.ORTHO2D}};w["@eye"]={type:"vec3",widget:"position"};w["@center"]={type:"vec3",widget:"position"};w["@texture_name"]={type:"texture"};w["@layers"]={type:"layers"};w.cubemap_camera_parameters=[{dir:vec3.fromValues(1,
0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];w.prototype.getResources=function(a){return a};Object.defineProperty(w.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._must_update_projection_matrix=
this._must_update_view_matrix=!0);this._type=a},enumerable:!0});Object.defineProperty(w.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(w.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(w.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_view_matrix=
!0},enumerable:!0});Object.defineProperty(w.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._must_update_projection_matrix=!0);this._near=a},enumerable:!0});Object.defineProperty(w.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._must_update_projection_matrix=!0);this._far=a},enumerable:!0});Object.defineProperty(w.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._must_update_projection_matrix=
!0);this._aspect=a},enumerable:!0});Object.defineProperty(w.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._must_update_projection_matrix=!0);this._fov=a},enumerable:!0});Object.defineProperty(w.prototype,"frustum_size",{get:function(){return this._frustum_size},set:function(a){this._frustum_size!=a&&(this._must_update_projection_matrix=this._must_update_view_matrix=!0);this._frustum_size=a},enumerable:!0});Object.defineProperty(w.prototype,"viewport",{get:function(){return this._viewport},
set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(w.prototype,"viewport_offset",{get:function(){return this._viewport.subarray(0,2)},set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(w.prototype,"viewport_size",{get:function(){return this._viewport.subarray(2,4)},set:function(a){this._viewport.set(a,2)},enumerable:!0});w.prototype.onAddedToNode=function(a){a.camera||(a.camera=this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};w.prototype.onRemovedFromNode=
function(a){a.camera==this&&delete a.camera;this._texture&&(this._renderbuffer=this._fbo=this._texture=null)};w.prototype.isRenderedToTexture=function(){return this.enabled&&this.render_to_texture&&this.texture_name};w.prototype.onCollectCameras=function(a,b){this.enabled&&(this.isRenderedToTexture()?b.unshift(this):b.push(this),this.render_to_texture&&this.texture_name?this._binded_render_frame||(LEvent.bind(this,"beforeRenderFrame",this.startFBO,this),LEvent.bind(this,"afterRenderFrame",this.endFBO,
this),this._binded_render_frame=!0):this._binded_render_frame&&(LEvent.unbind(this,"beforeRenderFrame",this.startFBO,this),LEvent.unbind(this,"afterRenderFrame",this.endFBO,this)))};w.prototype.lookAt=function(a,b,c){vec3.copy(this._eye,a);vec3.copy(this._center,b);vec3.copy(this._up,c);this._must_update_view_matrix=!0};w.prototype.updateMatrices=function(){this.type==w.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this._frustum_size*this._final_aspect*0.5,this._frustum_size*this._final_aspect*
0.5,0.5*-this._frustum_size,0.5*this._frustum_size,this._near,this._far):this.type==w.ORTHO2D?mat4.ortho(this._projection_matrix,this._ortho[0],this._ortho[1],this._ortho[2],this._ortho[3],this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._final_aspect,this._near,this._far);this._root&&this._root._is_root?mat4.lookAt(this._view_matrix,this._eye,this._center,this._up):mat4.lookAt(this._view_matrix,this.getEye(this._global_eye),this.getCenter(this._global_center),
this.getUp(this._global_up));mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_projection_matrix=this._must_update_view_matrix=!1};w.prototype.getModelMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};w.prototype.getViewMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,
this._view_matrix)};w.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._must_update_projection_matrix&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};w.prototype.getViewProjectionMatrix=function(a){a=a||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};w.prototype.getModelViewProjectionMatrix=function(a,b){b=b||mat4.create();(this._must_update_view_matrix||
this._must_update_projection_matrix)&&this.updateMatrices();return mat4.multiply(b,this._viewprojection_matrix,a)};w.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};w.prototype.getLocalPoint=function(a,b){b=b||vec3.create();
this._must_update_view_matrix&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};w.prototype.getLocalVector=function(a,b){b=b||vec3.create();this._must_update_view_matrix&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.rotateVec3(b,c,a)};w.prototype.getEye=function(a){a=
a||vec3.create();a.set(this._eye);return this._root&&this._root.transform?this._root.transform.getGlobalPosition(a):a};w.prototype.getCenter=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),a);a.set(this._center);return a};w.prototype.getFront=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),
a);vec3.sub(a,this._center,this._eye);return vec3.normalize(a,a)};w.prototype.getUp=function(a){a=a||vec3.create();a.set(this._up);return this._root&&this._root.transform?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};w.prototype.getTop=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye),c=vec3.cross(vec3.create(),this._up,b);a=vec3.cross(a,b,c);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),
a):a};w.prototype.getRight=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye);a=vec3.cross(a,this._up,b);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};w.prototype.setEye=function(a){this._eye.set(a);this._must_update_view_matrix=!0};w.prototype.setCenter=function(a){this._center.set(a);this._must_update_view_matrix=!0};w.prototype.setPerspective=function(a,b,c,d){this._fov=
a;this._aspect=b;this._near=c;this._far=d;this._type=w.PERSPECTIVE;this._must_update_projection_matrix=!0};w.prototype.setOrthographic=function(a,b,c,d,f,g){this._near=f;this._far=g;this._ortho.set([a,b,c,d]);this._type=w.ORTHO2D;this._must_update_projection_matrix=!0};w.prototype.move=function(a){vec3.add(this._center,this._center,a);vec3.add(this._eye,this._eye,a);this._must_update_view_matrix=!0};w.prototype.rotate=function(a,b,c){c&&this.getLocalVector(b,b);a=quat.setAxisAngle(quat.create(),b,
0.0174532925*a);b=vec3.subtract(vec3.create(),this._center,this._eye);vec3.transformQuat(b,b,a);vec3.add(this._center,this._eye,b);this._must_update_view_matrix=!0};w.prototype.orbit=function(a,b,c){c=c||this._center;a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._eye,c);vec3.transformQuat(b,b,a);vec3.add(this._eye,c,b);this._must_update_view_matrix=!0};w.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,
b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._must_update_view_matrix=!0};w.prototype.setDistanceToCenter=function(a,b){if(this._root)console.warn("cannot use setDistanceToCenter in a camera attached to a node");else{var c=vec3.sub(vec3.create(),this._center,this._eye),d=vec3.length(c);b?vec3.scaleAndAdd(this._eye,this._center,c,-a/d):vec3.scaleAndAdd(this._center,this._eye,c,a/d);this._must_update_view_matrix=!0}};w.prototype.setOrientation=function(a,b){var c=this.getCenter(),d=this.getEye(),
f=[0,1,0],c=vec3.sub(vec3.create(),c,d),c=vec3.length(c),g=null,g=vec3.fromValues(0,0,-c);b&&(vec3.rotateY(g,g,-0.5*Math.PI),vec3.rotateY(f,f,-0.5*Math.PI));vec3.transformQuat(g,g,a);vec3.transformQuat(f,f,a);b&&(vec3.rotateY(g,g,0.5*Math.PI),vec3.rotateY(f,f,0.5*Math.PI));this.center=vec3.add(vec3.create(),d,g);this.up=f;this._must_update_view_matrix=!0};w.prototype.setEulerAngles=function(a,b,c){var d=quat.create();quat.fromEuler(d,[a,b,c]);this.setOrientation(d)};w.prototype.fromViewmatrix=function(a){a=
mat4.invert(mat4.create(),a);this.eye=vec3.transformMat4(vec3.create(),vec3.create(),a);this.center=vec3.transformMat4(vec3.create(),[0,0,-1],a);this.up=mat4.rotateVec3(vec3.create(),a,[0,1,0]);this._must_update_view_matrix=!0};w.prototype.setViewportInPixels=function(a,b,c,d){this._viewport[0]=a/gl.canvas.width;this._viewport[1]=b/gl.canvas.height;this._viewport[2]=c/gl.canvas.width;this._viewport[3]=d/gl.canvas.height};w.prototype.project=function(a,b,c,d){c=c||vec3.create();b=this.getLocalViewport(b);
(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();vec3.project(c,a,this._viewprojection_matrix,b);d||(c[1]=b[3]-c[1]+2*b[1]);return c};w.prototype.unproject=function(a,b,c){b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};w.prototype.getLocalViewport=function(a,b){b=b||vec4.create();if(!a)return b[0]=gl.canvas.width*
this._viewport[0],b[1]=gl.canvas.height*this._viewport[1],b[2]=gl.canvas.width*this._viewport[2],b[3]=gl.canvas.height*this._viewport[3],b;b[0]=Math.floor(a[2]*this._viewport[0]+a[0]);b[1]=Math.floor(a[3]*this._viewport[1]+a[1]);b[2]=Math.ceil(a[2]*this._viewport[2]);b[3]=Math.ceil(a[3]*this._viewport[3]);return b};w.prototype.getRayInPixel=function(a,b,c,d){d||(c=this.getLocalViewport(c,this._viewport_in_pixels));(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();
d=this.getEye();var f=vec3.unproject(vec3.create(),[a,b,1],this._viewprojection_matrix,c);this.type==w.ORTHOGRAPHIC&&(d=vec3.unproject(d,[a,b,0],this._viewprojection_matrix,c));a=vec3.subtract(f,f,d);vec3.normalize(a,a);return{start:d,direction:a}};w.prototype.isPointInCamera=function(a,b,c){c=this.getLocalViewport(c,this._viewport_in_pixels);return a<c[0]||a>c[0]+c[2]||b<c[1]||b>c[1]+c[3]?!1:!0};w.prototype.configure=function(a){void 0!==a.uid&&(this.uid=a.uid);void 0!==a.layers&&(this.layers=a.layers);
void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.type&&(this._type=a.type);void 0!==a.eye&&this._eye.set(a.eye);void 0!==a.center&&this._center.set(a.center);void 0!==a.up&&this._up.set(a.up);void 0!==a.near&&(this._near=a.near);void 0!==a.far&&(this._far=a.far);void 0!==a.fov&&(this._fov=a.fov);void 0!==a.aspect&&(this._aspect=a.aspect);void 0!==a.final_aspect&&(this._final_aspect=a.final_aspect);void 0!==a.frustum_size&&(this._frustum_size=a.frustum_size);void 0!==a.viewport&&this._viewport.set(a.viewport);
void 0!==a.render_to_texture&&(this.render_to_texture=a.render_to_texture);void 0!==a.texture_name&&(this.texture_name=a.texture_name);a.texture_size&&2==a.texture_size.length&&this.texture_size.set(a.texture_size);void 0!==a.texture_high&&(this.texture_high=a.texture_high);void 0!==a.texture_clone&&(this.texture_clone=a.texture_clone);this.updateMatrices()};w.prototype.serialize=function(){return{uid:this.uid,layers:this.layers,enabled:this.enabled,type:this._type,eye:vec3.toArray(this._eye),center:vec3.toArray(this._center),
up:vec3.toArray(this._up),near:this._near,far:this._far,fov:this._fov,aspect:this._aspect,frustum_size:this._frustum_size,viewport:Array.apply([],this._viewport),render_to_texture:this.render_to_texture,texture_name:this.texture_name,texture_size:Array.apply([],this.texture_size),texture_high:this.texture_high,texture_clone:this.texture_clone}};w.prototype.checkLayersVisibility=function(a){return 0!==(this.layers&a)};w.prototype.getLayers=function(){for(var a=[],b=0;32>b;++b)this.layers&1<<b&&a.push(this._root.scene.layer_names[b]||
"layer"+b);return a};w.prototype.setLayer=function(a,b){var c=1<<a;this.layers&=~c;b&&(this.layers|=c)};w.prototype.isInLayer=function(a){return 0!==(this.layers&1<<a)};w.prototype.getTransformMatrix=function(a){if(this._root&&this._root.transform)return null;var b=null,b="center"==a?this._center:this._eye;a=mat4.create();mat4.setTranslation(a,b);return a};w.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="center"==c?this._center:this._eye;mat4.multiplyVec3(b,
a,b);return!0};w.prototype.startFBO=function(){if(this.render_to_texture&&this.texture_name){var a=this.texture_size[0]||gl.canvas.width,b=this.texture_size[1]||gl.canvas.height,c=this.texture_high?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;if(!this._texture||this._texture.width!=a||this._texture.height!=b||this._texture.type!=c){var d=isPowerOfTwo(a)&&isPowerOfTwo(b);this._texture=new GL.Texture(a,b,{format:gl.RGB,wrap:d?gl.REPEAT:gl.CLAMP_TO_EDGE,filter:d?gl.LINEAR:gl.NEAREST,type:c})}c=this._texture;
this._old_fbo=gl.getParameter(gl.FRAMEBUFFER_BINDING);this._old_viewport||(this._old_viewport=vec4.create());this._old_viewport.set(gl.viewport_data);this._fbo=this._fbo||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo);gl.viewport(0,0,a,b);e.Renderer._full_viewport.set([0,0,a,b]);e.Renderer.global_aspect=gl.canvas.width/gl.canvas.height/(c.width/c.height);d=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer();if(d.width!=a||d.height!=b)d.width=a,d.height=b;gl.bindRenderbuffer(gl.RENDERBUFFER,
d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,c.handler,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d)}};w.prototype.endFBO=function(){if(this.render_to_texture&&this.texture_name){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo);e.Renderer.global_aspect=1;this._old_fbo=null;gl.NEAREST_MIPMAP_NEAREST<=this._texture.minFilter&&this._texture.minFilter<=gl.LINEAR_MIPMAP_LINEAR&&
(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type));var a=this._old_viewport;gl.viewport(a[0],a[1],a[2],a[3]);e.Renderer._full_viewport.set(a);this.texture_name&&(a=this._texture,this.texture_clone&&(this._texture_clone&&this._texture_clone.width==a.width&&this._texture_clone.height==a.height&&this._texture_clone.type==a.type||(this._texture_clone=new GL.Texture(a.width,a.height,{format:gl.RGB,filter:gl.LINEAR,type:a.type})),a.copyTo(this._texture_clone),a=this._texture_clone),e.ResourcesManager.registerResource(this.texture_name,
a))}};w.prototype.fillCameraShaderUniforms=function(a){a=this._uniforms;a.u_camera_planes[0]=this.near;a.u_camera_planes[1]=this.far;this.type==w.PERSPECTIVE?a.u_camera_perspective.set([this.fov*DEG2RAD,512/Math.tan(this.fov*DEG2RAD)]):a.u_camera_perspective.set([this._frustum_size,512/this._frustum_size]);a.u_camera_perspective[2]=this._projection_matrix[5];this.getEye(a.u_camera_eye);this.getFront(a.u_camera_front);return a};e.registerComponent(w);e.Camera=w;Q.icon="mini-icon-fx.png";Q.available_fx=
{brightness_contrast:{name:"Brightness & Contrast",uniforms:{brightness:{name:"u_brightness",type:"float",value:1,min:0,max:2,step:0.01},contrast:{name:"u_contrast",type:"float",value:1,min:0,max:2,step:0.01}},code:"color.xyz = (color.xyz * u_brightness@ - vec3(0.5)) * u_contrast@ + vec3(0.5);"},invert:{name:"Invert color",code:"color.xyz = vec3(1.0) - color.xyz;"},threshold:{name:"Threshold",uniforms:{threshold:{name:"u_threshold",type:"float",value:0.5,min:0,max:2,step:0.01},threshold_width:{name:"u_threshold_width",
type:"float",value:0.01,min:0,max:1,step:0.001}},code:"color.xyz = vec3( smoothstep( u_threshold@ - u_threshold_width@ * 0.5, u_threshold@ + u_threshold_width@ * 0.5,  length(color.xyz) ));"},colorize:{name:"Colorize",uniforms:{colorize:{name:"u_colorize",type:"color3",value:[1,1,1]},vibrance:{name:"u_vibrance",type:"float",value:0,min:0,max:2,step:0.01}},code:"color.xyz = color.xyz * (u_colorize@ + vec3(u_vibrance@ * 0.1)) * (1.0 + u_vibrance@);"},halftone:{name:"Halftone",uniforms:{"Halftone angle":{name:"u_halftone_angle",
type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.x = ( (color.x * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );color.y = ( (color.y * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.167, u_halftone_size@ ) );color.z = ( (color.z * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.333, u_halftone_size@ ) );"},halftoneBN:{name:"Halftone B/N",uniforms:{"Halftone angle":{name:"u_halftone_angle",type:"float",
value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.xyz = vec3( (length(color.xyz) * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );"},lens:{name:"Lens Distortion",uniforms:{lens_k:{name:"u_lens_k",type:"float",value:-0.15},lens_kcube:{name:"u_lens_kcube",type:"float",value:0.8},lens_scale:{name:"u_lens_scale",type:"float",value:1}},uv_code:"float r2 = u_aspect * u_aspect * (uv.x-0.5) * (uv.x-0.5) + (uv.y-0.5) * (uv.y-0.5); float distort@ = 1. + r2 * (u_lens_k@ + u_lens_kcube@ * sqrt(r2)); uv = vec2( u_lens_scale@ * distort@ * (uv.x-0.5) + 0.5, u_lens_scale@  * distort@ * (uv.y-0.5) + 0.5 );"},
warp:{name:"Warp",uniforms:{warp_freq:{name:"u_warp_freq",type:"float",value:50},warp_amp:{name:"u_warp_amp",type:"float",value:0.01}},uv_code:"uv = uv + u_warp_amp@ * (vec2(0.5) + 0.5 * vec2( sin(uv.x * u_warp_freq@) * sin(uv.y * u_warp_freq@)));"},pixelate:{name:"Pixelate",uniforms:{width:{name:"u_width",type:"float",value:256,step:1,min:1},height:{name:"u_height",type:"float",value:256,step:1,min:1}},uv_code:"uv = vec2( floor(uv.x * u_width@) / u_width@, floor(uv.y * u_height@) / u_height@ );"},
quantize:{name:"Quantize",uniforms:{levels:{name:"u_levels",type:"float",value:8,step:1,min:1}},code:"color.xyz = floor(color.xyz * u_levels@) / u_levels@;"},edges:{name:"Edges",uniforms:{"Edges factor":{name:"u_edges_factor",type:"float",value:1}},code:"vec4 color@ = texture2D(u_texture, uv );\n\t\t\t\tvec4 color_up@ = texture2D(u_texture, uv + vec2(0., u_iviewport.y));\n\t\t\t\tvec4 color_right@ = texture2D(u_texture, uv + vec2(u_iviewport.x,0.));\n\t\t\t\tvec4 color_down@ = texture2D(u_texture, uv + vec2(0., -u_iviewport.y));\n\t\t\t\tvec4 color_left@ = texture2D(u_texture, uv + vec2(-u_iviewport.x,0.));\n\t\t\t\tcolor = u_edges_factor@ * (abs(color@ - color_up@) + abs(color@ - color_down@) + abs(color@ - color_left@) + abs(color@ - color_right@));"},
depth:{name:"Depth",uniforms:{near:{name:"u_near",type:"float",value:0.01,step:0.1},far:{name:"u_far",type:"float",value:1E3,step:1}},code:"color.xyz = vec3( (2.0 * u_near@) / (u_far@ + u_near@ - texture2D(u_texture_depth, uv ).x * (u_far@ - u_near@)) );"},logarithmic:{name:"Logarithmic",uniforms:{"Log. A Factor":{name:"u_logfactor_a",type:"float",value:2,step:0.01},"Log. B Factor":{name:"u_logfactor_b",type:"float",value:2,step:0.01}},code:"color.xyz = log( color.xyz * u_logfactor_a@ ) * u_logfactor_b@;"},
ditherBN:{name:"dither B/N",functions:["dither"],uniforms:{},code:"color.xyz = vec3( dither( color.x ) );"},dither:{name:"Dither",functions:["dither"],uniforms:{},code:"color.xyz = vec3( dither( color.x ), dither( color.y ), dither( color.z ) );"},gamma:{name:"Gamma",uniforms:{Gamma:{name:"u_gamma",type:"float",value:2.2,step:0.01}},code:"color.xyz = pow( color.xyz, vec3( 1.0 / u_gamma@) );"}};Q.available_functions={pattern:"float pattern(float angle, float size) {\n\t\t\t\tfloat s = sin(angle * 3.1415), c = cos(angle * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_viewport.xy;\n\t\t\t\tvec2 point = vec2( c * tex.x - s * tex.y , s * tex.x + c * tex.y ) * size;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t",
dither:"float dither(float v) {\n\t\t\t\tvec2 pixel = v_coord * u_viewport;\n\t\t\t\tint i = int(floor(v * 16.0 + 0.5));\n\t\t\t\tif(i < 1)\n\t\t\t\t\treturn 0.0;\n\t\t\t\tif(i >= 15)\n\t\t\t\t\treturn 1.0;\n\t\t\t\tfloat x = floor(pixel.x);\n\t\t\t\tfloat y = floor(pixel.y);\n\t\t\t\tbool xmod4 = mod(x, 4.0) == 0.0;\n\t\t\t\tbool ymod4 = mod(y, 4.0) == 0.0;\n\t\t\t\tbool xmod2 = mod(x, 2.0) == 0.0;\n\t\t\t\tbool ymod2 = mod(y, 2.0) == 0.0;\n\t\t\t\tbool xmod4_2 = mod(x + 2.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_2 = mod(y + 2.0, 4.0) == 0.0;\n\t\t\t\tbool xmod2_1 = mod(x + 1.0, 2.0) == 0.0;\n\t\t\t\tbool ymod2_1 = mod(y + 1.0, 2.0) == 0.0;\n\t\t\t\tbool xmod4_1 = mod(x + 1.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_1 = mod(y + 1.0, 4.0) == 0.0;\n\t\t\t\tbool xmod4_3 = mod(x + 3.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_3 = mod(y + 3.0, 4.0) == 0.0;\n\t\t\t\t\n\t\t\t\tif(i < 9)\n\t\t\t\t{\n\t\t\t\t\tif(i >= 1 && xmod4 && ymod4 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 2 && xmod4_2 && ymod4_2)\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 3 && xmod4_2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 4 && xmod2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 5 && xmod4_1 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 6 && xmod4_3 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 7 && xmod4_1 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 8 && xmod4_3 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif(i < 15 && xmod4_1 && ymod4 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 14 && xmod4_3 && ymod4_2)\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 13 && xmod4_3 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 12 && xmod2_1 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 11 && xmod4_2 && ymod4_1 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 10 && xmod4 && ymod4_3 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\treturn 1.0;\n\t\t\t\t}\n\t\t\t}\n\t\t"};
Q.prototype.configure=function(a){this.enabled=!!a.enabled;this.use_viewport_size=!!a.use_viewport_size;this.use_high_precision=!!a.use_high_precision;a.fx&&(this.fx=a.fx.concat())};Q.prototype.serialize=function(){return{enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_viewport_size:this.use_viewport_size,fx:this.fx.concat()}};Q.prototype.getResources=function(a){return a};Q.prototype.addFX=function(a){a&&(Q.available_fx[a]?this.fx.push({name:a}):
console.warn("CameraFX not found: "+a))};Q.prototype.getFX=function(a){return this.fx[a]};Q.prototype.moveFX=function(a,b){b=b||-1;var c=this.fx.indexOf(a);-1!=c&&(this.fx.splice(c,1),c+=b,0<=c&&c<this.fx.length?this.fx.splice(c,0,a):this.fx.push(a))};Q.prototype.removeFX=function(a){for(var b=0;b<this.fx.length;b++)if(this.fx[b]===a){this.fx.splice(b,1);break}};Q.prototype.onAddedToScene=function(a){LEvent.bind(a,"enableFrameBuffer",this.onBeforeRender,this);LEvent.bind(a,"showFrameBuffer",this.onAfterRender,
this)};Q.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"enableFrameBuffer",this.onBeforeRender,this);LEvent.unbind(a,"showFrameBuffer",this.onAfterRender,this)};Q.prototype.onBeforeRender=function(a,b){if(this.enabled)if(this.use_node_camera){var c=this._root.camera;c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameBuffer",this.enableCameraFBO,this),LEvent.bind(c,"showFrameBuffer",this.showCameraFBO,this));this._binded_camera=
c}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null),this.enableGlobalFBO(b);else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};Q.prototype.onAfterRender=function(a,b){this.enabled&&(this.use_node_camera||this.showFBO())};Q.prototype.enableCameraFBO=function(a,b){if(this.enabled){var c=this._renderFrameContainer;c||(c=this._renderFrameContainer=new e.RenderFrameContainer);var d=this._viewport=this._binded_camera.getLocalViewport(null,
this._viewport);c.setSize(d[2],d[3]);c.use_high_precision=this.use_high_precision;c.preRender(b);b.ignore_viewports=!0}};Q.prototype.showCameraFBO=function(a,b){this.enabled&&(b.ignore_viewports=!1,this.showFBO())};Q.prototype.enableGlobalFBO=function(a){if(this.enabled){var b=this._renderFrameContainer;b||(b=this._renderFrameContainer=new e.RenderFrameContainer);this.use_viewport_size&&b.useCanvasSize();b.use_high_precision=this.use_high_precision;b.preRender(a)}};Q.prototype.showFBO=function(){this.enabled&&
(this._renderFrameContainer.endFBO(),this.use_node_camera&&this._viewport?(gl.setViewport(this._viewport),this.applyFX(),gl.setViewport(this._renderFrameContainer._fbo._old_viewport)):this.applyFX())};Q.prototype.applyFX=function(){for(var a=this._renderFrameContainer,b=a.color_texture,a=a.depth_texture,c=this.fx,d="",f=!0,g=0;g<c.length;g++)d+=c[g].name+"|";d==this._last_shader_key&&(f=!1);this._last_shader_key=d;var h=d="",e={},s="",k=this._uniforms;k.u_viewport[0]=b.width;k.u_viewport[1]=b.height;
k.u_iviewport[0]=1/b.width;k.u_iviewport[1]=1/b.height;k.u_aspect=b.width/b.height;for(var l=0,g=0;g<c.length;g++){var r=c[g],l=g,n=Q.available_fx[r.name];if(n){if(f){if(n.functions)for(var p in n.functions)e[n.functions[p]]=!0;n.code&&(h+=n.code.split("@").join(l)+";\n");n.uv_code&&(d+=n.uv_code.split("@").join(l)+";\n")}if(n.uniforms)for(var z in n.uniforms){var U=n.uniforms[z],m=U.name+l;f&&(s+="uniform "+U.type+" "+m+";\n");k[m]=void 0!==r[z]?r[z]:U.value}}}var t=null;if(f){p="";for(g in e)(z=
Q.available_functions[g])?p+=z+"\n":console.error("CameraFX: Function not found: "+g);this._last_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_OES_standard_derivatives : enable\n\t\t\tprecision highp float;\n\t\t\t#define color3 vec3\n\t\t\t#define color4 vec4\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_depth;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_iviewport;\n\t\t\tuniform float u_aspect;\n\t\t\tvec2 uv;\n\t\t\t"+
s+"\n\t\t\t"+p+"\n\t\t\tvoid main() {\n\t\t\t\tuv = v_coord;\n\t\t\t\t"+d+"\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\tfloat temp = 0.0;\n\t\t\t\t"+h+"\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t")}t=this._last_shader;t.hasUniform("u_texture_depth")&&a.bind(1);this.apply_fxaa?(this.temp_tex&&this.temp_tex.width==gl.viewport_data[2]&&this.temp_tex.height==gl.viewport_data[3]||(this.temp_tex=new GL.Texture(gl.viewport_data[2],gl.viewport_data[3])),this.temp_tex.drawTo(function(){b.toViewport(t,
k)}),a=GL.Shader.getFXAAShader(),a.setup(),this.temp_tex.toViewport(a)):(this.temp_tex=null,b.toViewport(t,k))};e.registerComponent(Q);u["@projective_texture"]={type:"Texture"};u["@extra_texture"]={type:"Texture"};Object.defineProperty(u.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a)},enumerable:!0});Object.defineProperty(u.prototype,
"up",{get:function(){return this._up},set:function(a){this._up.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});u.FRONT_VECTOR=new Float32Array([0,0,-1]);u.RIGHT_VECTOR=new Float32Array([1,0,0]);u.UP_VECTOR=new Float32Array([0,1,0]);u.OMNI=1;u.SPOT=2;u.DIRECTIONAL=3;u.DEFAULT_SHADOWMAP_RESOLUTION=1024;u.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;u.coding_help="LightInfo LIGHT -> light info before applying equation\nInput IN -> info about the mesh\nSurfaceOutput o -> info about the surface properties of this pixel\n\nstruct LightInfo {\n\tvec3 Color;\n\tvec3 Ambient;\n\tfloat Diffuse; //NdotL\n\tfloat Specular; //RdotL\n\tvec3 Emission;\n\tvec3 Reflection;\n\tfloat Attenuation;\n\tfloat Shadow; //1.0 means fully lit\n};\n\nstruct Input {\n\tvec4 color;\n\tvec3 vertex;\n\tvec3 normal;\n\tvec2 uv;\n\tvec2 uv1;\n\t\n\tvec3 camPos;\n\tvec3 viewDir;\n\tvec3 worldPos;\n\tvec3 worldNormal;\n\tvec4 screenPos;\n};\n\nstruct SurfaceOutput {\n\tvec3 Albedo;\n\tvec3 Normal;\n\tvec3 Ambient;\n\tvec3 Emission;\n\tfloat Specular;\n\tfloat Gloss;\n\tfloat Alpha;\n\tfloat Reflectivity;\n};\n";
u.prototype.onAddedToNode=function(a){a.light||(a.light=this);LEvent.bind(a,"collectLights",this.onCollectLights,this)};u.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light;delete ba.textures[":shadowmap_"+this.uid]};u.prototype.onCollectLights=function(a,b){this.enabled&&b.push(this)};u._temp_matrix=mat4.create();u._temp2_matrix=mat4.create();u._temp3_matrix=mat4.create();u._temp_position=vec3.create();u._temp_target=vec3.create();u._temp_up=vec3.create();u._temp_front=vec3.create();
u.prototype.updateLightCamera=function(){this._light_camera||(this._light_camera=new w);var a=this._light_camera;a.eye=this.getPosition(u._temp_position);a.center=this.getTarget(u._temp_target);var b=this.getUp(u._temp_up),c=this.getFront(u._temp_front);0.999<Math.abs(vec3.dot(c,b))&&vec3.set(b,0,0,1);a.up=b;a.type=this.type==u.DIRECTIONAL?w.ORTHOGRAPHIC:w.PERSPECTIVE;b=this.computeShadowmapFar();a._frustum_size=this.frustum_size||u.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;a.near=this.near;a.far=b;a.fov=
this.angle_end||45;a.updateMatrices();this._light_matrix=a._viewprojection_matrix;return a};u.prototype.getLightCamera=function(){this._light_camera||this.updateLightCamera();return this._light_camera};u.prototype.updateVectors=function(){var a=vec3.create();return function(){if(this._root&&this._root.transform){var b=this._root.transform.getGlobalMatrixRef();mat4.getTranslation(this._position,b);this.use_target||mat4.multiplyVec3(this._target,b,u.FRONT_VECTOR);mat4.multiplyVec3(this._up,b,u.UP_VECTOR);
mat4.rotateVec3(this._front,b,u.FRONT_VECTOR);mat4.rotateVec3(this._right,b,u.RIGHT_VECTOR);vec3.copy(this._top,this.up)}else vec3.subtract(this._front,this._target,this._position),vec3.normalize(this._front,this._front),vec3.normalize(a,this._up),vec3.cross(this._right,this._front,a),vec3.cross(this._top,this._right,this._front)}}();u.prototype.getPosition=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.getGlobalPosition(a);a.set(this._position);return a};
u.prototype.getTarget=function(a){a=a||vec3.create();if(this._root&&this._root.transform&&!this.use_target)return this._root.transform.transformPointGlobal(u.FRONT_VECTOR,a);a.set(this._target);return a};u.prototype.getUp=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.transformVector(u.UP_VECTOR,a);a.set(this._up);return a};u.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this.getPosition(),this.getTarget());vec3.normalize(a,a);return a};
u.prototype.getLightRotationMatrix=function(){};u.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=GL.Texture);this.extra_texture&&(a[this.extra_texture]=GL.Texture);return a};u.prototype.onResourceRenamed=function(a,b,c){this.projective_texture==a&&(this.projective_texture=b);this.extra_texture==a&&(this.extra_texture=b)};u.prototype.checkLayersVisibility=function(a){return this._root?0!==(this._root.layers&a):!1};u.prototype.isInLayer=function(a){return this._root?
0!==(this._root.layers&1<<a):!1};u.prototype.prepare=function(a){var b=this._uniforms,c=this._query;c.clear();(this.projective_texture||this.cast_shadows)&&this.updateLightCamera();a.shadows_enabled&&this.cast_shadows||!this._shadowmap||(this._shadowmap=null,delete e.ResourcesManager.textures[":shadowmap_"+this.uid]);this.updateVectors();this.type==u.DIRECTIONAL?c.macros.USE_DIRECTIONAL_LIGHT="":this.type==u.SPOT?c.macros.USE_SPOT_LIGHT="":c.macros.USE_OMNI_LIGHT="";this.spot_cone&&(c.macros.USE_SPOT_CONE=
"");this.linear_attenuation&&(c.macros.USE_LINEAR_ATTENUATION="");this.range_attenuation&&(c.macros.USE_RANGE_ATTENUATION="");0.001<this.offset&&(c.macros.USE_LIGHT_OFFSET="");if(this.projective_texture){var d=this.projective_texture.constructor===String?e.ResourcesManager.textures[this.projective_texture]:this.projective_texture;d&&(d.texture_type==gl.TEXTURE_CUBE_MAP?c.macros.USE_LIGHT_CUBEMAP="":c.macros.USE_LIGHT_TEXTURE="")}this.extra_texture&&(d=this.extra_texture.constructor===String?e.ResourcesManager.textures[this.extra_texture]:
this.extra_texture)&&(d.texture_type==gl.TEXTURE_CUBE_MAP?c.macros.USE_EXTRA_LIGHT_CUBEMAP="":c.macros.USE_EXTRA_LIGHT_TEXTURE="");if(this.type==u.DIRECTIONAL||this.type==u.SPOT)b.u_light_front=this._front;this.type==u.SPOT&&(b.u_light_angle=[this.angle*DEG2RAD,this.angle_end*DEG2RAD,Math.cos(this.angle*DEG2RAD*0.5),Math.cos(this.angle_end*DEG2RAD*0.5)]);b.u_light_position=this.position;b.u_light_color=vec3.scale(b.u_light_color||vec3.create(),this.color,this.intensity);this._attenuation_info[0]=
this.att_start;this._attenuation_info[1]=this.att_end;b.u_light_att=this._attenuation_info;b.u_light_offset=this.offset;this.extra_light_shader_code?(c=null,this._last_extra_light_shader_code!=this.extra_light_shader_code&&(this._last_processed_extra_light_shader_code=c=e.Material.processShaderCode(this.extra_light_shader_code))):this._last_processed_extra_light_shader_code=null;a.update_shadowmaps&&a.shadows_enabled&&!a.lights_disabled&&!a.low_quality&&this.generateShadowmap(a);this._shadowmap&&
!this.cast_shadows&&(this._shadowmap=null);this._uniforms=b};u.prototype.getQuery=function(a,b){var c=this._query,d=this.cast_shadows&&this._shadowmap&&null!=this._light_matrix&&!b.shadows_disabled;this.constant_diffuse||a.material.constant_diffuse?delete c.macros.USE_DIFFUSE_LIGHT:c.macros.USE_DIFFUSE_LIGHT="";this.use_specular&&0<a.material.specular_factor?c.macros.USE_SPECULAR_LIGHT="":delete c.macros.USE_SPECULAR_LIGHT;d&&a.flags&Ua?(c.macros.USE_SHADOW_MAP="",this._shadowmap&&this._shadowmap.texture_type==
gl.TEXTURE_CUBE_MAP&&(c.macros.USE_SHADOW_CUBEMAP=""),this.hard_shadows&&(c.macros.USE_HARD_SHADOWS=""),c.macros.SHADOWMAP_OFFSET=""):delete c.macros.USE_SHADOW_MAP;!this._last_processed_extra_light_shader_code||this.extra_texture&&!e.ResourcesManager.getTexture(this.extra_texture)?delete c.macros.USE_EXTRA_LIGHT_SHADER_CODE:c.macros.USE_EXTRA_LIGHT_SHADER_CODE=this._last_processed_extra_light_shader_code;return c};u.prototype.getUniforms=function(a,b){var c=this._uniforms,d=this.cast_shadows&&a.flags&
Ua&&this._shadowmap&&null!=this._light_matrix&&!b.shadows_disabled;this._light_matrix&&(c.u_lightMatrix=mat4.multiply(c.u_lightMatrix||mat4.create(),this._light_matrix,a.matrix));if(this.projective_texture){var f=this.projective_texture.constructor===String?ba.textures[this.projective_texture]:this.projective_texture;f&&(f.texture_type==gl.TEXTURE_CUBE_MAP?c.light_cubemap=f.bind(11):c.light_texture=f.bind(11))}else delete c.light_texture,delete c.light_cubemap;if(this.extra_texture){if(f=this.extra_texture.constructor===
String?e.ResourcesManager.textures[this.extra_texture]:this.extra_texture)f.texture_type==gl.TEXTURE_CUBE_MAP?c.extra_light_cubemap=f.bind(12):c.extra_light_texture=f.bind(12)}else delete c.extra_light_texture,delete c.extra_light_cubemap;d?(d=this.computeShadowmapFar(),c.u_shadow_params=[1/this._shadowmap.width,this.shadow_bias,this.near,d],c.shadowmap=this._shadowmap.bind(10)):(delete c.u_shadow_params,delete c.shadowmap);return c};u.prototype.computeShadowmapFar=function(){var a=this.far;this.type==
u.OMNI?this.range_attenuation&&this.att_end*Math.SQRT2<a&&(a=this.att_end*Math.SQRT2):this.range_attenuation&&this.att_end<a&&(a=this.att_end);return a};u.prototype.computeLightIntensity=function(){var a=Math.max(this.color[0],this.color[1],this.color[2]);return Math.max(0,a*this.intensity)};u.prototype.computeLightRadius=function(){return this.range_attenuation?this.type==u.OMNI?this.att_end*Math.SQRT2:this.att_end:-1};u.prototype.generateShadowmap=function(a){if(this.cast_shadows&&!(1E-4>this.computeLightIntensity())){var b=
a.current_renderer,c=this.shadowmap_resolution;0==c&&(c=a.default_shadowmap_resolution);var d=this.type==u.OMNI?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;if(null==this._shadowmap||this._shadowmap.width!=c||this._shadowmap.texture_type!=d)this._shadowmap=new GL.Texture(c,c,{texture_type:d,format:gl.RGBA,magFilter:gl.NEAREST,minFilter:gl.NEAREST}),e.ResourcesManager.textures[":shadowmap_"+this.uid]=this._shadowmap;this.type==u.OMNI?(d=this.computeShadowmapFar(),a.current_pass="shadow",a.is_shadowmap=!0,this._shadowmap.unbind(),
b.renderToCubemap(this.getPosition(),c,this._shadowmap,a,this.near,d),a.is_shadowmap=!1):(c=this.getLightCamera(),b.enableCamera(c,a,!0),this._shadowmap.unbind(),b._current_target=this._shadowmap,this._shadowmap.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);a.current_pass="shadow";a.is_shadowmap=!0;b.renderInstances(a);a.is_shadowmap=!1}),b._current_target=null)}};u.prototype.getTransformMatrix=function(a,b){if(this._root&&this._root.transform)return null;
var c=null,c="target"==a?this.target:this.position,d=b||mat4.create();mat4.setTranslation(d,c);return d};u.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="target"==c?this.target:this.position;mat4.multiplyVec3(b,a,b);return!0};e.registerComponent(u);e.Light=u;ka["@glare_texture"]={type:"texture"};ka["@glare_size"]={type:"vec2",step:0.001};ka["@glare_visibility"]={type:"number",step:0.001};ka.icon="mini-icon-lightfx.png";ka.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};ka.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ka.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this._root.light;if(!c||c.enabled)this.volume_visibility&&c&&b.push(this.getVolumetricRenderInstance(c)),this.glare_visibility&&(c=this.getGlareRenderInstance(c))&&b.push(c)}};ka.prototype.getVolumetricRenderInstance=function(){this._volumetric_mesh||
(this._volumetric_mesh=GL.Mesh.sphere());var a=this._volumetric_render_instance;a||(this._volumetric_render_instance=a=new W(this._root,this));a.flags=W.ALPHA;var b=this._volumetric_material;b||(b=this._volumetric_material=new m({shader_name:"volumetric_light",blending:m.ADDITIVE_BLENDING}));vec3.copy(b.color,light.color);b.opacity=this.volume_visibility;a.material=b;a.matrix.set(this._root.transform._global_matrix);mat4.multiplyVec3(a.center,a.matrix,light.position);mat4.scale(a.matrix,a.matrix,
[this.volume_radius,this.volume_radius,this.volume_radius]);b=vec4.create();b.set(a.center);b[3]=0.5*this.volume_radius;a.uniforms.u_volume_info=b;a.uniforms.u_volume_density=this.volume_density;a.setMesh(this._mesh,gl.TRIANGLES);a.flags=Ca|Na|Ja;return a};ka.prototype.getGlareRenderInstance=function(a){if(!this.glare_texture)return null;var b=this._glare_render_instance;b||(this._glare_render_instance=b=new W(this._root,this),b.setMesh(GL.Mesh.plane({size:1}),gl.TRIANGLES),b.priority=1,b.onPreRender=
ka.onGlarePreRender);b.flags=fb;a?vec3.copy(b.center,a.getPosition()):vec3.copy(b.center,this._root.transform.getGlobalPosition());b.pos2D=vec3.create();b.scale_2D=this.glare_size;b.test_visibility=this.test_visibility;var c=this._glare_material;c||(c=this._glare_material=new m({blending:m.ADDITIVE_BLENDING}));a&&(vec3.scale(c.color,a.color,this.glare_visibility*a.intensity),c.setTexture("color",this.glare_texture));b.setMaterial(c);b.flags|=Na;return b};ka.onGlarePreRender=function(a){if("color"==
a.current_pass){mat4.projectVec3(this.pos2D,e.Renderer._viewprojection_matrix,this.center);this.pos2D[0]=2*this.pos2D[0]-1;this.pos2D[1]=2*this.pos2D[1]-1;this.pos2D[2]=0;a=this.center;var b=Oa._current_camera.getEye(),b=vec3.sub(vec3.create(),b,a),c=vec3.length(b);vec3.scale(b,b,1/c);var d=0;this.test_visibility&&(d=e.Picking.raycast(a,b,c));d.length?(this.material.opacity-=0.05,0>this.material.opacity&&(this.material.opacity=0)):(this.material.opacity+=0.05,1<this.material.opacity&&(this.material.opacity=
1))}};ka.prototype.getResources=function(a){this.glare_texture&&(a[this.glare_texture]=Texture);return a};ka.prototype.onResourceRenamed=function(a,b,c){this.glare_texture==a&&(this.glare_texture=b)};e.registerComponent(ka);e.LightFX=ka;Object.defineProperty(K.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;-1>a||10<a||(this._primitive=a)},enumerable:!0});K.icon="mini-icon-teapot.png";K["@mesh"]={type:"mesh"};K["@lod_mesh"]={type:"mesh"};
K["@primitive"]={type:"enum",values:{Default:-1,Points:0,Lines:1,LineLoop:2,LineStrip:3,Triangles:4,TriangleStrip:5,TriangleFan:6,Wireframe:10}};K["@submesh_id"]={type:"enum",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};K.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this)};K.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};K.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=a.enabled);this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new m(a.material))};K.prototype.serialize=function(){var a={enabled:this.enabled,
mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());-1!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};K.prototype.getMesh=function(){return"string"===typeof this.mesh?e.ResourcesManager.meshes[this.mesh]:this.mesh};K.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?e.ResourcesManager.meshes[this.lod_mesh]:
this.low_mesh};K.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=GL.Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=GL.Mesh);return a};K.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b);if(this.morph_targets)for(var d in this.morph_targets)this.morph_targets[d].mesh==a&&(this.morph_targets[d].mesh=b)};K.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getMesh();if(!c)return null;if(this._root){var d=
this._RI;d||(this._RI=d=new e.RenderInstance(this._root,this));d.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.flags=sa|$a;d.applyNodeFlags();this.two_sided&&(d.flags&=~Ca);d.setMaterial(this.material||this._root.getMaterial());d.setMesh(c,this.primitive);if(-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups){var f=c.info.groups[this.submesh_id];f&&d.setRange(f.start,f.length)}else d.setRange(0,-1);this.lod_mesh?(d.collision_mesh=
"string"===typeof this.lod_mesh?e.ResourcesManager.resources[this.lod_mesh]:this.lod_mesh,d.setLODMesh(d.collision_mesh)):d.collision_mesh=c;this.primitive==gl.POINTS&&(d.uniforms.u_point_size=this.point_size,d.query.macros.USE_POINTS="");b.push(d)}}};e.registerComponent(K);e.MeshRenderer=K;Object.defineProperty(I.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});I.MAX_BONES=
64;I.gpu_skinning_supported=!0;I.icon="mini-icon-stickman.png";I["@mesh"]={widget:"mesh"};I["@lod_mesh"]={widget:"mesh"};I["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};I["@submesh_id"]={widget:"combo",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};I.prototype.onAddedToNode=function(a){a.meshrenderer||
(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};I.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};I.prototype.configure=function(a){null!=a.enabled&&(this.enabled=!!a.enabled);this.cpu_skinning=!!a.cpu_skinning;this.ignore_transform=!!a.ignore_transform;this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=
!!a.two_sided;void 0!==a.point_size&&(this.point_size=a.point_size);a.material&&(this.material="string"==typeof a.material?a.material:new m(a.material))};I.prototype.serialize=function(){var a={enabled:this.enabled,apply_skinning:this.apply_skinning,cpu_skinning:this.cpu_skinning,ignore_transform:this.ignore_transform,mesh:this.mesh,lod_mesh:this.lod_mesh,primitive:this.primitive,submesh_id:this.submesh_id,two_sided:this.two_sided,point_size:this.point_size};this.material&&(a.material="string"==typeof this.material?
this.material:this.material.serialize());return a};I.prototype.getMesh=function(){return e.ResourcesManager.getMesh(this.mesh)};I.prototype.getLODMesh=function(){return e.ResourcesManager.getMesh(this.lod_mesh)};I.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};I.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b)};I.prototype.getNodeMatrix=function(a){var b=
this._root.scene;if(!b)return null;a=b.getNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};I.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();for(c=0;c<a.bones.length;++c){var d=b[c],f=a.bones[c],g=this.getNodeMatrix(f[0]);g?(mat4.multiply(d,g,f[1]),a.bind_matrix&&mat4.multiply(d,d,a.bind_matrix)):mat4.identity(d)}return b};
I.prototype.onCollectInstances=function(a,b,c){if(this.enabled){c=this.getMesh();if(!c)return null;if(this._root&&(a=this._render_instance,a||(this._render_instance=a=new e.RenderInstance(this._root,this)),c.getBuffer("vertices")&&c.getBuffer("bone_indices"))){if(this.apply_skinning)if(I.gpu_skinning_supported&&!this.cpu_skinning){a.setMesh(c,this.primitive);a.query.macros.USE_SKINNING="";var d=this.getBoneMatrices(c),f=12*d.length,g=this._u_bones;g&&g.length==f||(this._u_bones=g=new Float32Array(f));
for(var h=0;h<d.length;h++)mat4.transpose(d[h],d[h]),g.set(d[h].subarray(0,12),12*h,12*(h+1));I.num_supported_uniforms>=f?(a.uniforms.u_bones=g,d.length>I.MAX_BONES&&(a.query.macros.MAX_BONES=d.length.toString()),delete a.samplers.u_bones):0<I.num_supported_textures?(h=this._bones_texture,h||(h=this._bones_texture=new GL.Texture(1,3*d.length,{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),h._data=new Float32Array(h.width*h.height*4)),h._data.set(g),h.uploadData(h._data,{no_flip:!0}),e.RM.textures[":bones"]=
h,a.query.macros.USE_SKINNING_TEXTURE="",a.samplers.u_bones=h,delete a.uniforms.u_bones):console.error("impossible to get here")}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=c){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=c;d=c.getBuffer("vertices");g=c.getBuffer("normals");for(h in c.vertexBuffers)this._skinned_mesh.vertexBuffers[h]=c.vertexBuffers[h];for(h in c.indexBuffers)this._skinned_mesh.indexBuffers[h]=c.indexBuffers[h];this._skinned_mesh.createVertexBuffer("vertices",
"a_vertex",3,new Float32Array(d.data),gl.STREAM_DRAW);g&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(g.data),gl.STREAM_DRAW)}this.applySkin(c,this._skinned_mesh);a.setMesh(this._skinned_mesh,this.primitive);delete a.query.macros.USE_SKINNING;delete a.query.macros.USE_SKINNING_TEXTURE;delete a.samplers.u_bones}else a.setMesh(c,this.primitive),delete a.query.macros.USE_SKINNING,delete a.query.macros.USE_SKINNING_TEXTURE,delete a.samplers.u_bones;this.ignore_transform?
mat4.identity(a.matrix):this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,vec3.create());-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups?(h=c.info.groups[this.submesh_id])&&a.setRange(h.start,h.length):a.setRange(0,-1);a.material=this.material||this._root.getMaterial();a.flags=sa;a.applyNodeFlags();this.two_sided&&(a.flags&=~Ca);this.apply_skinning&&(a.flags|=na);this.primitive==gl.POINTS&&(a.uniforms.u_point_size=this.point_size,a.query.macros.USE_POINTS=
"");b.push(a)}}};I.zero_matrix=new Float32Array(16);I.prototype.applySkin=function(a,b){var c=a.getBuffer("vertices").data,d=null;a.getBuffer("normals")&&(d=a.getBuffer("normals").data);var f=a.getBuffer("weights").data,g=a.getBuffer("bone_indices").data,h=b.getBuffer("vertices"),e=h.data,s=null,k=null;d&&(s=b.getBuffer("normals"),k=s.data);var l=this.getBoneMatrices(a);if(0==l.length)return null;vec3.create();vec3.create();for(var r=mat4.create(),n=0,p=e.length/3;n<p;++n){c.subarray(3*n,3*n+3);var z=
g.subarray(4*n,4*n+4),U=f.subarray(4*n,4*n+4),m=e.subarray(3*n,3*n+3),z=[l[z[0]],l[z[1]],l[z[2]],l[z[3]]];r.set(I.zero_matrix);mat4.scaleAndAdd(r,r,z[0],U[0]);0<U[1]&&mat4.scaleAndAdd(r,r,z[1],U[1]);0<U[2]&&mat4.scaleAndAdd(r,r,z[2],U[2]);0<U[3]&&mat4.scaleAndAdd(r,r,z[3],U[3]);mat4.multiplyVec3(m,r,c.subarray(3*n,3*n+3));k&&(U=k.subarray(3*n,3*n+3),mat4.rotateVec3(U,r,d.subarray(3*n,3*n+3)))}h.upload(gl.STREAM_DRAW);s&&s.upload(gl.STREAM_DRAW)};I.prototype.extractSkeleton=function(){};e.registerComponent(I);
e.SkinnedMeshRenderer=I;P.icon="mini-icon-teapot.png";P.force_apply=!0;P.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};P.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};P.prototype.getResources=function(a){if(this.morph_targets.length)for(var b=0;b<this.morph_targets.length;++b)this.morph_targets[b].mesh&&(a[this.morph_targets[b].mesh]=GL.Mesh)};P.prototype.onResourceRenamed=
function(a,b,c){if(this.morph_targets.length)for(c=0;c<this.morph_targets.length;++c)this.morph_targets[c].mesh==a&&(this.morph_targets[c].mesh=b)};P.prototype.onCollectInstances=function(a,b){if(b.length&&!(16>P.max_supported_vertex_attribs)){var c=b[b.length-1];this.enabled?this.applyMorphTargets(c):this.disableMorphing(c)}};P.prototype.applyMorphTargets=function(a){var b=a.mesh;if((this.morph_targets.length||P.force_apply)&&a.mesh){var c=b.vertexBuffers.vertices,d={},f=[],g=0,h=this.morph_targets.concat();
h.sort(function(a,b){return Math.abs(b.weight)-Math.abs(a.weight)});for(var q=0;q<h.length;++q){var s=h[q];if(s.mesh&&0!=s.weight){var k=e.ResourcesManager.resources[s.mesh];if(k&&k.constructor===GL.Mesh){var l=k.vertexBuffers.vertices;if(l&&l.data.length==c.data.length&&(k=k.vertexBuffers.normals)&&(l=l.clone(!0),k=k.clone(!0),l.attribute=null,k.attribute=null,d["a_vertex_morph"+g]=l,d["a_normal_morph"+g]=k,f.push(s.weight),g+=1,4<=g))break}}}if(g||P.force_apply){a.vertex_buffers={};for(q in b.vertexBuffers)a.vertex_buffers[q]=
b.vertexBuffers[q];for(q in d)a.vertex_buffers[q]=d[q];a.query.macros.USE_MORPHING="";b=new Float32Array(4);b.set(f);a.uniforms.u_morph_weights=b}else this.disableMorphing(a)}else this.disableMorphing(a)};P.prototype.disableMorphing=function(a){a.query&&void 0!==a.query.macros.USE_MORPHING&&(delete a.query.macros.USE_MORPHING,delete a.uniforms.u_morph_weights)};P.prototype.setMorphMesh=function(a,b){a>=this.morph_targets.length||(this.morph_targets[a].mesh=b)};P.prototype.setMorphWeight=function(a,
b){a>=this.morph_targets.length||(this.morph_targets[a].weight=b)};P.prototype.getPropertyInfoFromPath=function(a){if("morphs"==a[0]){if(1==a.length)return{node:this._root,target:this.morph_targets,type:"object"};var b=parseInt(a[1]);if(!(b>=this.morph_targets.length)&&(a=a[2],"mesh"==a||"weight"==a))return{node:this._root,target:this.morph_targets,name:a,value:void 0!==this.morph_targets[b][a]?this.morph_targets[b][a]:null,type:"mesh"==a?"mesh":"number"}}};P.prototype.setPropertyValueFromPath=function(a,
b){if(!(1>a.length)&&"morphs"==a[0]){var c=parseInt(a[1]);c>=this.morph_targets.length||(this.morph_targets[c][a[2]]=b)}};P.prototype.setProperty=function(a,b){if("enabled"==a)this.enabled=b;else if("morph"==a.substr(0,5)){a=a.substr(5);var c=a.split("_"),d=parseInt(c[0]);d<this.morph_targets.length&&("weight"==c[1]?this.morph_targets[d].weight=b:"mesh"==c[1]&&(this.morph_targets[d].mesh=b))}};P.prototype.getProperties=function(){for(var a={enabled:"boolean"},b=0;b<this.morph_targets.length;b++)a["morph"+
b+"_weight"]="number",a["morph"+b+"_mesh"]="Mesh";return a};e.registerComponent(P);e.MorphDeformer=P;E.icon="mini-icon-stickman.png";E.MAX_BONES=64;E.gpu_skinning_supported=!0;E.icon="mini-icon-stickman.png";E["@skeleton_root_node"]={type:"node"};E.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};E.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};E.prototype.getBoneNode=function(a){var b=
this._root,c=b.scene;if(!c)return null;if(this.skeleton_root_node){if(b=c.getNode(this.skeleton_root_node))return b.findChildNodeByName(a)}else return this.search_bones_in_parent?b.parentNode.findChildNodeByName(a):c.getNode(a);return null};E.prototype.getBoneMatrix=function(a){a=this.getBoneNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};E.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=
this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();for(c=0;c<a.bones.length;++c){var d=b[c],f=a.bones[c],g=this.getBoneMatrix(f[0]);g?(mat4.multiply(d,g,f[1]),a.bind_matrix&&mat4.multiply(d,d,a.bind_matrix)):mat4.identity(d)}return b};E.prototype.onCollectInstances=function(a,b){if(b.length){var c=b[b.length-1];this.enabled?this.applySkinning(c):this.disableSkinning(c)}};E.prototype.applySkinning=function(a){var b=a.mesh;this._mesh=b;if(b.getBuffer("vertices")&&b.getBuffer("bone_indices")){if(E.gpu_skinning_supported&&
!this.cpu_skinning){a.query.macros.USE_SKINNING="";var b=this.getBoneMatrices(b),c=12*b.length,d=this._u_bones;d&&d.length==c||(this._u_bones=d=new Float32Array(c));for(var f=0;f<b.length;f++)mat4.transpose(b[f],b[f]),d.set(b[f].subarray(0,12),12*f,12*(f+1));E.num_supported_uniforms>=c?(a.uniforms.u_bones=d,b.length>E.MAX_BONES&&(a.query.macros.MAX_BONES=b.length.toString()),delete a.samplers.u_bones):0<E.num_supported_textures?(f=this._bones_texture,f||(f=this._bones_texture=new GL.Texture(1,3*b.length,
{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),f._data=new Float32Array(f.width*f.height*4)),f._data.set(d),f.uploadData(f._data,{no_flip:!0}),e.RM.textures[":bones"]=f,a.query.macros.USE_SKINNING_TEXTURE="",a.samplers.u_bones=f,delete a.uniforms.u_bones):console.error("impossible to get here")}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=b){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=b;d=b.getBuffer("vertices");c=b.getBuffer("normals");for(f in b.vertexBuffers)this._skinned_mesh.vertexBuffers[f]=
b.vertexBuffers[f];for(f in b.indexBuffers)this._skinned_mesh.indexBuffers[f]=b.indexBuffers[f];this._skinned_mesh.createVertexBuffer("vertices","a_vertex",3,new Float32Array(d.data),gl.STREAM_DRAW);c&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(c.data),gl.STREAM_DRAW)}this.applySoftwareSkinning(b,this._skinned_mesh);a.setMesh(this._skinned_mesh,this.primitive);delete a.query.macros.USE_SKINNING;delete a.query.macros.USE_SKINNING_TEXTURE;delete a.samplers.u_bones}this.ignore_transform?
(mat4.identity(a.matrix),a.normal_matrix.set(a.matrix)):this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags|=na}};E.prototype.disableSkinning=function(a){this._mesh=null;void 0!==a.query.macros.USE_SKINNING&&(delete a.query.macros.USE_SKINNING,delete a.query.macros.USE_SKINNING_TEXTURE,delete a.samplers.u_bones)};E.prototype.getMesh=function(){return this._mesh};E.prototype.applySoftwareSkinning=function(a,b){var c=a.getBuffer("vertices").data,
d=null;a.getBuffer("normals")&&(d=a.getBuffer("normals").data);var f=a.getBuffer("weights").data,g=a.getBuffer("bone_indices").data,h=b.getBuffer("vertices"),e=h.data,s=null,k=null;E.zero_matrix||(E.zero_matrix=new Float32Array(16));var l=E.zero_matrix;d&&(s=b.getBuffer("normals"),k=s.data);var r=this.getBoneMatrices(a);if(0==r.length)return null;vec3.create();vec3.create();for(var n=mat4.create(),p=0,z=e.length/3;p<z;++p){c.subarray(3*p,3*p+3);var U=g.subarray(4*p,4*p+4),m=f.subarray(4*p,4*p+4),
t=e.subarray(3*p,3*p+3),U=[r[U[0]],r[U[1]],r[U[2]],r[U[3]]];n.set(l);mat4.scaleAndAdd(n,n,U[0],m[0]);0<m[1]&&mat4.scaleAndAdd(n,n,U[1],m[1]);0<m[2]&&mat4.scaleAndAdd(n,n,U[2],m[2]);0<m[3]&&mat4.scaleAndAdd(n,n,U[3],m[3]);mat4.multiplyVec3(t,n,c.subarray(3*p,3*p+3));k&&(m=k.subarray(3*p,3*p+3),mat4.rotateVec3(m,n,d.subarray(3*p,3*p+3)))}h.upload(gl.STREAM_DRAW);s&&s.upload(gl.STREAM_DRAW)};E.prototype.extractSkeleton=function(){};E.prototype.convertBonesToRelative=function(){var a=this.getBones();
if(a&&a.length)for(var b=0;b<a.length;++b);};E.prototype.getBones=function(){var a=this._mesh;if(!a&&!a.bones)return null;var b=[],c;for(c in a.bones){var d=this.getBoneNode(a.bones[c][0]);d&&b.push(d)}return b};e.registerComponent(E);e.SkinDeformer=E;Ra.icon="mini-icon-teapot.png";Ra["@texture"]={type:"texture"};Ra.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Ra.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",
this.onCollectInstances,this)};Ra.prototype.onCollectInstances=function(a,b){if(this._root){var c=this._mesh;this._mesh||(c=this._mesh=GL.Mesh.plane());var d=this._render_instance;d||(this._render_instance=d=new W(this._root,this));this._root.transform&&d.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.setMesh(c,gl.TRIANGLES);d.material=this._root.getMaterial();d.flags=sa;d.applyNodeFlags();b.push(d)}};Ba.icon="mini-icon-dome.png";Ba["@texture"]=
{widget:"texture"};Ba.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Ba.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Ba.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};Ba.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};Ba.prototype.onCollectInstances=function(a,b){if(this._root&&this.enabled){var c=
null;if(c=this.use_environment?e.Renderer._current_scene.info.textures.environment:this.texture)if(c.constructor===String&&(c=e.ResourcesManager.textures[c]),c){var d=this._mesh;d||(d=this._mesh=GL.Mesh.cube({size:10}));var f=this._render_instance;f||(this._render_instance=f=new e.RenderInstance(this._root,this),f.priority=100,f.onPreRender=function(a){a=a.current_camera.getEye();mat4.identity(this.matrix);mat4.setTranslation(this.matrix,a);if(this.node.transform){var b=this.node.transform.getGlobalRotationMatrix();
mat4.multiply(this.matrix,this.matrix,b)}vec3.copy(this.center,a)});var g=this._material;g||(g=this._material=new e.Material({use_scene_ambient:!1}));vec3.copy(g.color,[this.intensity,this.intensity,this.intensity]);var h=g.setTexture(e.Material.COLOR,c);c&&c.texture_type==gl.TEXTURE_2D?(h.uvs="polar_vertex",c.bind(0),c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR)):h.uvs="0";f.setMesh(d);f.flags=sa;f.applyNodeFlags();f.enableFlag(Va|Za|na|ab);f.disableFlag(Pa|
Qa|Ja);f.setMaterial(g);b.push(f)}}};e.registerComponent(Ba);e.Skybox=Ba;ua.icon="mini-icon-bg.png";ua["@texture"]={type:"texture"};ua["@material_name"]={type:"material"};ua["@blend_mode"]={type:"enum",values:e.Blend};ua["@opacity"]={type:"number",step:0.01};ua.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};ua.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ua.prototype.getResources=
function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};ua.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};ua.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=null;this.material_name&&(c=e.ResourcesManager.materials[this.material_name]);if(!c){var d=this.texture;if(!d)return;d.constructor===String&&(d=e.ResourcesManager.textures[d]);c=this._material?this._material:this._material=new e.Material({use_scene_ambient:!1});c.setTexture("color",
d);c.color.set(this.color);c.opacity=this.opacity;c.blend_mode=this.blend_mode}d=this._mesh;d||(d=this._mesh=GL.Mesh.plane({size:2}));var f=this._render_instance;f||(this._render_instance=f=new e.RenderInstance(this._root,this),f.priority=100);f.setMesh(d);f.setMaterial(c);f.flags=sa;f.applyNodeFlags();f.disableFlag(Pa);f.enableFlag(Za);f.enableFlag(Va);f.disableFlag(Qa);f.disableFlag(Ja);f.disableFlag(Ca);f.enableFlag(na);f.enableFlag(db);b.push(f)}};e.registerComponent(ua);qa.icon="mini-icon-collider.png";
qa["@size"]={type:"vec3",step:0.01};qa["@center"]={type:"vec3",step:0.01};qa["@mesh"]={type:"mesh"};qa["@shape"]={type:"enum",values:{Box:1,Sphere:2,Mesh:5}};qa.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectPhysicInstances",this.onGetColliders,this)};qa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectPhysicInstances",this.onGetColliders,this)};qa.prototype.getMesh=function(){return"string"===typeof this.mesh?e.ResourcesManager.meshes[this.mesh]:this.mesh};qa.prototype.getResources=
function(a){if(this.mesh)return"string"==typeof this.mesh&&(a[this.mesh]=Mesh),a};qa.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b)};qa.prototype.onGetColliders=function(a,b){if(this.enabled){var c=this._PI;c||(this._PI=c=new e.PhysicsInstance(this._root,this));this._root.transform&&c.matrix.set(this._root.transform._global_matrix);c.type=this.shape;c.layers=this._root.layers;var d=null;if(c.type===e.PhysicsInstance.MESH||this.use_mesh_bounding)d=this.getMesh();c.type===e.PhysicsInstance.SPHERE?
d?BBox.copy(c.oobb,d.bounding):BBox.setCenterHalfsize(c.oobb,this.center,[this.size[0],this.size[0],this.size[0]]):c.type===e.PhysicsInstance.BOX&&(d?BBox.copy(c.oobb,d.bounding):BBox.setCenterHalfsize(c.oobb,this.center,this.size));d?vec3.copy(c.center,BBox.getCenter(d.bounding)):vec3.copy(c.center,this.center);if(c.type===e.PhysicsInstance.MESH){if(!d)return;c.setMesh(d)}b.push(c)}};e.registerComponent(qa);va.icon="mini-icon-bg.png";va.prototype.getResources=function(a){return a};va.prototype.addProperties=
function(a){this.properties.push(a)};va.prototype.getProperty=function(a){for(var b=0;b<this.properties.length;b++)if(this.properties[b].name==a)return this.properties[b];return null};va.prototype.getProperties=function(){return this.properties};va.prototype.updateProperty=function(a){};va.prototype.getPropertyInfoFromPath=function(a){};va.prototype.setPropertyValueFromPath=function(a,b){};va.prototype.onResourceRenamed=function(a,b,c){};e.registerComponent(va);e.CustomData=va;da.editor_color=[0.33,
0.874,0.56,0.9];da.onShowMainAnnotation=function(a){"undefined"!=typeof AnnotationModule&&AnnotationModule.editAnnotation(a)};da.onShowPointAnnotation=function(a,b){function c(a){this.text=a}var d=a.getComponent(da);d&&"undefined"!=typeof AnnotationModule&&AnnotationModule.showDialog(b.text,{item:b,on_close:c.bind(b),on_delete:function(a){d.removeAnnotation(a.item);e.GlobalScene.refresh()},on_focus:function(a){AnnotationModule.focusInAnnotation(a.item);d._selected=a.item}})};da.prototype.addAnnotation=
function(a){this._selected=null;this.notes.push(a)};da.prototype.getAnnotation=function(a){return this.nodes[a]};da.prototype.removeAnnotation=function(a){this._selected=null;a=this.notes.indexOf(a);-1!=a&&this.notes.splice(a,1)};da.prototype.setStartTransform=function(){this.start_position=this.getObjectCenter()};da.prototype.getObjectCenter=function(){var a=vec3.create(),b=this._root.getMesh();b&&b.bounding&&vec3.copy(a,BBox.getCenter(b.bounding));return this._root.transform.transformPointGlobal(a,
vec3.create())};da.prototype.serialize=function(){var a={text:this.text,notes:[],start_position:this.start_position},b;for(b in this.notes){var c=this.notes[b],d;for(d in c)c[d].constructor==Float32Array&&Array.prototype.slice.call(c[d]);a.notes.push(c)}return a};da.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousedown",this.onMouse.bind(this),this)};da.prototype.onRemovedFromNode=function(a){};da.prototype.onMouse=function(a,b){if("mousedown"==b.eventType){this._screen_pos[2]=0;var c=vec3.dist(this._screen_pos,
[b.canvasx,gl.canvas.height-b.canvasy,0]);if(30>c)da.onShowMainAnnotation(this._root);for(var d in this.notes){var f=this.notes[d],c=vec2.dist(f._end_screen,[b.mousex,gl.canvas.height-b.mousey]);if(30>c)return this._selected=f,da.onShowPointAnnotation(this._root,f),!0}}};da.prototype.renderEditor=function(a){if(this.text||this.notes.length){a=vec3.create();var b=this._root.getMesh();b&&vec3.copy(a,BBox.getCenter(b.bounding));var c=e.Renderer._current_camera,d=this._root.transform.getGlobalPosition(),
f=this.getObjectCenter(),g=c.getEye(),h=c.getLocalVector([1,0,0]);a=c.getLocalVector([0,1,0]);var b=c.getLocalVector([0,0,1]),g=Math.tan(c.fov*DEG2RAD)*vec3.dist(d,g),q=vec3.scale(vec3.create(),a,0.2*g),h=vec3.scale(vec3.create(),h,0.2*g),s=vec3.add(vec3.create(),d,q);vec3.add(s,h,s);c.project(s,null,this._screen_pos);gl.enable(gl.BLEND);gl.enable(gl.DEPTH_TEST);e.Draw.setColor([1,1,1,1]);var h=[],q=[],k=[],l=[];this.text&&(h.push(d,s),q.push([1,1,1,0],[1,1,1,1]),window.EditorModule&&e.Draw.renderImage(s,
EditorModule.icons_path+"/mini-icon-script.png",0.03*g));var s=this._root.transform.getGlobalMatrix(),r;for(r in this.notes){var n=this.notes[r],d=mat4.multiplyVec3(vec3.create(),s,n.start),p=mat4.multiplyVec3(vec3.create(),s,n.end);n.end_world=p;k.push(p);h.push(d,p);this._selected==n?(l.push([1,1,1,1]),q.push([1,1,1,0.2],[1,1,0.8,1])):(l.push(e.Components.AnnotationComponent.editor_color),q.push([0,0,0,0.2],e.Components.AnnotationComponent.editor_color));n._end_screen=c.project(p)}if((d=this.start_position)&&
1<vec3.dist(d,f))for(c=vec3.dist(d,f)/20,f=vec3.subtract(vec3.create(),f,d),vec3.normalize(f,f),r=0;20>r;r+=2)s=vec3.scale(vec3.create(),f,r*c),vec3.add(s,s,d),h.push(s),s=vec3.scale(vec3.create(),f,(r+1)*c),vec3.add(s,s,d),h.push(s),q.push([0,1,0,0.2],[0,1,0,1]);e.Draw.setPointSize(12);e.Draw.renderPoints(k,l);e.Draw.setColor([0,0,0,0.5]);e.Draw.setPointSize(10);e.Draw.renderPoints(k,l);e.Draw.setColor([1,1,1,1]);e.Draw.renderLines(h,q);gl.depthFunc(gl.GREATER);e.Draw.setAlpha(0.1);e.Draw.renderPoints(k,
l);e.Draw.renderLines(h,q);gl.depthFunc(gl.LESS);gl.disable(gl.CULL_FACE);e.Draw.setColor(e.Components.AnnotationComponent.editor_color);for(r in this.notes)n=this.notes[r],e.Draw.push(),e.Draw.fromTranslationFrontTop(n.end_world,b,a),e.Draw.translate([-1,-1,0]),e.Draw.scale([-4E-4*g,4E-4*g,4E-4*g]),f=n.text.split("\n")[0],e.Draw.renderText(f),e.Draw.pop();gl.disable(gl.BLEND)}};e.registerComponent(da);Sa.icon="mini-icon-rotator.png";Sa.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",
this.onUpdate,this)};Sa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};Sa.prototype.onUpdate=function(a,b){if(this._root){var c=this._root.scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var d=quat.setAxisAngle(quat.create(),this.axis,Math.sin(this.speed*c._global_time*2*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,d,this._default);this._root.transform._dirty=
!0}else this.local_space?this._root.transform.rotate(this.speed*b,this.axis):this._root.transform.rotateGlobal(this.speed*b,this.axis);c&&c.refresh()}};e.registerComponent(Sa);S.ORBIT=1;S.FIRSTPERSON=2;S.PLANE=3;S.icon="mini-icon-cameracontroller.png";S["@mode"]={type:"enum",values:{Orbit:S.ORBIT,FirstPerson:S.FIRSTPERSON,Plane:S.PLANE}};S.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"mousewheel",this.onMouse,
this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};S.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};S.prototype.onUpdate=function(a){if(this._root&&this.enabled){if(!this._root.transform&&this._root.camera&&(a=this._root.camera,this.mode==S.FIRSTPERSON&&(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]))){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.speed*(this._move_fast?10:1));
a.move(b);a.updateMatrices()}this.smooth&&this._root.scene.refresh()}};S.prototype.onMouse=function(a,b){if(this._root&&this.enabled){var c=this._root.camera;if(c)if(b||(b=a),"mousewheel"==b.eventType)c.orbitDistanceFactor(1+-0.05*(0<b.wheel?1:-1)*this.wheel_speed,this.orbit_center),c.updateMatrices(),this._root.scene.refresh();else if("mousedown"==b.eventType&&(this.mode==S.PLANE?this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,this._collision):this.testPerpendicularPlane(b.canvasx,gl.canvas.height-
b.canvasy,c.getCenter(),this._collision),this._button=b.button),b.dragging){var d=!1;if(!this._root.transform)if(this.mode==S.FIRSTPERSON){c.rotate(-b.deltax*this.rot_speed,[0,1,0]);c.updateMatrices();var f=c.getLocalVector([1,0,0]);c.rotate(-b.deltay*this.rot_speed,f);c.updateMatrices();d=!0}else if(this.mode==S.ORBIT)if(this.allow_panning&&(b.ctrlKey||1==b.button))d=vec3.create(),this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,c.getCenter(),d),d=vec3.sub(vec3.create(),this._collision,
d),c.move(d),c.updateMatrices(),d=!0;else{var f=b.deltax*this.rot_speed,g=-b.deltay*this.rot_speed;1E-4<Math.abs(f)&&(c.orbit(-f,[0,1,0],this.orbit_center),c.updateMatrices(),d=!0);var f=c.getRight(),h=c.getFront(),e=c.getUp(),h=vec3.dot(e,h);0.99<h&&0<g||-0.99>h&&0>g||(c.orbit(-g,f,this.orbit_center),d=!0)}else this.mode==S.PLANE&&(2==this._button?c.orbit(-b.deltax*this.rot_speed,[0,1,0],c.target):(d=vec3.create(),this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,d),d=vec3.sub(vec3.create(),
this._collision,d),c.move(d),c.updateMatrices()),d=!0);d&&this._root.scene.refresh()}}};S.prototype.testOriginPlane=function(a,b,c){a=this._root.camera.getRayInPixel(a,gl.canvas.height-b);c=c||vec3.create();return geo.testRayPlane(a.start,a.direction,[0,0,0],[0,1,0],c)?!0:!1};S.prototype.testPerpendicularPlane=function(a,b,c,d){var f=this._root.camera;a=f.getRayInPixel(a,gl.canvas.height-b);b=f.getFront();c=c||f.getCenter();d=d||vec3.create();return geo.testRayPlane(a.start,a.direction,c,b,d)?!0:
!1};S.prototype.onKey=function(a,b){this._root&&this.enabled&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode?this._moving[0]="keydown"==b.type?1:0:16==b.keyCode&&(this._move_fast="keydown"==b.type?!0:!1))};e.registerComponent(S);Ka.icon="mini-icon-rotator.png";Ka.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"update",this.onUpdate,
this)};Ka.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"mousemove",this.onMouse,this);LEvent.unbind(a,"update",this.onUpdate,this)};Ka.prototype.onUpdate=function(a){};Ka.prototype.onMouse=function(a,b){if(this._root&&this._root.transform&&b.dragging){var c=this._root.scene,d=c.getCamera().getLocalVector(e.Components.Transform.RIGHT);this._root.transform.rotateGlobal(b.deltax*this.rot_speed[0],e.Components.Transform.UP);this._root.transform.rotateGlobal(b.deltay*this.rot_speed[1],d);c.refresh()}};
e.registerComponent(Ka);F.icon="mini-icon-billboard.png";F.POSX=1;F.NEGX=2;F.POSY=3;F.NEGY=4;F.POSZ=5;F.NEGZ=6;F["@node_id"]={type:"node"};F["@front"]={type:"enum",values:{"-Z":F.NEGZ,"+Z":F.POSZ,"-Y":F.NEGY,"+Y":F.POSY,"-X":F.NEGX,"+X":F.POSX}};F["@up"]={type:"enum",values:{"-Z":F.NEGZ,"+Z":F.POSZ,"-Y":F.NEGY,"+Y":F.POSY,"-X":F.NEGX,"+X":F.POSX}};F.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updateOrientation,this)};F.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,
"computeVisibility",this.updateOrientation,this)};F.prototype.updateOrientation=function(a){if(this.enabled&&this._root&&this._root.transform){var b=this._root.scene;a=this._root.transform;var c=null,d=null,f=a.getGlobalPosition();switch(this.up){case F.NEGX:d=vec3.fromValues(-1,0,0);break;case F.POSX:d=vec3.fromValues(1,0,0);break;case F.NEGZ:d=vec3.fromValues(0,0,-1);break;case F.POSZ:d=vec3.fromValues(0,0,1);break;case F.NEGY:d=vec3.fromValues(0,-1,0);break;default:d=vec3.fromValues(0,1,0)}if(this.node_id){b=
b.getNode(this.node_id);if(!b||b==this._root)return;c=b.transform.getGlobalPosition(this._target_position)}else if(this.face_camera){b=e.Renderer._main_camera||e.Renderer._current_camera;if(!b)return;c=b.getEye()}else return;this.cylindrical&&(c[1]=f[1]);a.lookAt(f,c,d,!0);switch(this.front){case F.POSY:quat.rotateX(a._rotation,a._rotation,-0.5*Math.PI);break;case F.NEGY:quat.rotateX(a._rotation,a._rotation,0.5*Math.PI);break;case F.POSX:quat.rotateY(a._rotation,a._rotation,0.5*Math.PI);break;case F.NEGX:quat.rotateY(a._rotation,
a._rotation,-0.5*Math.PI);break;case F.POSZ:quat.rotateY(a._rotation,a._rotation,Math.PI)}}};e.registerComponent(F);$.icon="mini-icon-fog.png";$.LINEAR=1;$.EXP=2;$.EXP2=3;$["@color"]={type:"color"};$["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};$["@type"]={type:"enum",values:{linear:$.LINEAR,exponential:$.EXP,"exponential 2":$.EXP2}};$.prototype.onAddedToScene=function(a){LEvent.bind(a,"fillSceneQuery",this.fillSceneQuery,this);LEvent.bind(a,"fillSceneUniforms",this.fillSceneUniforms,
this)};$.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"fillSceneQuery",this.fillSceneQuery,this);LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};$.prototype.fillSceneQuery=function(a,b){if(this.enabled)switch(b.macros.USE_FOG="",this.type){case $.EXP:b.macros.USE_FOG_EXP="";break;case $.EXP2:b.macros.USE_FOG_EXP2=""}};$.prototype.fillSceneUniforms=function(a,b){this.enabled&&(b.u_fog_info=[this.start,this.end,this.density],b.u_fog_color=this.color)};e.registerComponent($);
Ta.icon="mini-icon-follow.png";Ta.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updatePosition,this)};Ta.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"computeVisibility",this.updatePosition,this)};Ta.prototype.updatePosition=function(a,b){if(this._root){var c=null,c=this._root.scene,d=c.getCamera();if(this.follow_camera)c=d.getEye();else{c=c.getNode(this.node_name);if(!c)return;c=c.transform.getPosition()}this.fixed_y&&(c[1]=this._root.transform._position[1]);
this._root.transform.setPosition(c)}};e.registerComponent(Ta);Object.defineProperty(H.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});Object.defineProperty(H.prototype,"geometry",{get:function(){return this._geometry},set:function(a){a=void 0===a||null===a?-1:a|0;0>a||7<a||(this._geometry=a)},enumerable:!0});H.CUBE=1;H.PLANE=2;H.CYLINDER=3;H.SPHERE=4;H.CIRCLE=5;H.HEMISPHERE=
6;H.ICOSAHEDRON=7;H.icon="mini-icon-cube.png";H["@geometry"]={type:"enum",values:{Cube:H.CUBE,Plane:H.PLANE,Cylinder:H.CYLINDER,Sphere:H.SPHERE,Icosahedron:H.ICOSAHEDRON,Circle:H.CIRCLE,Hemisphere:H.HEMISPHERE}};H["@primitive"]={widget:"enum",values:{Default:-1,Points:0,Lines:1,Triangles:4,Wireframe:10}};H["@subdivisions"]={type:"number",step:1,min:0};H.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};H.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,
"collectRenderInstances",this.onCollectInstances,this)};H.prototype.updateMesh=function(){var a=Math.max(0,this.subdivisions|0),b=""+this.geometry+"|"+this.size+"|"+a+"|"+this.align_z;switch(this.geometry){case H.CUBE:this._mesh=GL.Mesh.cube({size:this.size,normals:!0,coords:!0});break;case H.PLANE:this._mesh=GL.Mesh.plane({size:this.size,detail:a,xz:this.align_z,normals:!0,coords:!0});break;case H.CYLINDER:this._mesh=GL.Mesh.cylinder({size:this.size,subdivisions:a,normals:!0,coords:!0});break;case H.SPHERE:this._mesh=
GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0});break;case H.CIRCLE:this._mesh=GL.Mesh.circle({size:this.size,slices:a,xz:this.align_z,normals:!0,coords:!0});break;case H.HEMISPHERE:this._mesh=GL.Mesh.sphere({size:this.size,slices:a,xz:this.align_z,normals:!0,coords:!0,hemi:!0});break;case H.ICOSAHEDRON:this._mesh=GL.Mesh.icosahedron({size:this.size,subdivisions:a})}this._key=b};H.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root){var c=Math.max(0,this.subdivisions|
0),c=""+this.geometry+"|"+this.size+"|"+c+"|"+this.align_z;this._mesh&&this._key==c||this.updateMesh();c=this._render_instance;c||(this._render_instance=c=new e.RenderInstance(this._root,this));this._root.transform&&this._root.transform.getGlobalMatrix(c.matrix);c.setMatrix(c.matrix);mat4.getTranslation(c.center,c.matrix);c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;c.flags=sa|$a;c.applyNodeFlags();c.setMaterial(this.material||this._root.getMaterial());this.primitive==gl.POINTS&&
(c.uniforms.u_point_size=this.point_size,c.query.macros.USE_POINTS="");b.push(c)}};e.registerComponent(H);Object.defineProperty(fa.prototype,"textures",{set:function(a){if("object"==typeof a)for(var b in a)if(null===a[b]||a[b].constructor===String||a[b]===GL.Texture)this._textures[b]=a[b]},get:function(){return this._textures},enumerable:!0});fa.icon="mini-icon-bg.png";fa.DEFAULT_BACKGROUND_COLOR=new Float32Array([0,0,0,1]);fa.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);fa.prototype.onAddedToScene=
function(a){a.info=this};fa.prototype.onRemovedFromScene=function(a){};fa.prototype.getResources=function(a){for(var b in this._textures)"string"==typeof this._textures[b]&&(a[this._textures[b]]=GL.Texture);return a};fa.prototype.getProperties=function(){return{ambient_color:"color",background_color:"color","textures/background":"texture","textures/foreground":"texture","textures/environment":"texture","textures/irradiance":"texture",linear_pipeline:"boolean"}};fa.prototype.setProperty=function(a,
b){if("textures/"==a.substr(0,9)&&(!b||b.constructor===String||b.constructor===GL.Texture))return this._textures[a.substr(9)]=b,!0};fa.prototype.getPropertyInfoFromPath=function(a){if("textures"==a[0]){if(1==a.length)return{node:this._root,target:this._textures,type:"object"};a=a[1];return{node:this._root,target:this._textures,name:a,value:this._textures[a]||null,type:"texture"}}};fa.prototype.setPropertyValueFromPath=function(a,b){1>a.length||"textures"==a[0]&&(this._textures[a[1]]=b)};fa.prototype.onResourceRenamed=
function(a,b,c){for(var d in this._textures)this._textures[d]==a&&(this._texture[d]=b)};e.registerComponent(fa);e.GlobalInfo=fa;"undefined"!=typeof LGraphTexture&&(LGraphTexture.getTexturesContainer=function(){return e.ResourcesManager.textures},LGraphTexture.loadTexture=e.ResourcesManager.load.bind(e.ResourcesManager));ga["@on_event"]={type:"enum",values:["start","render","update","trigger"]};ga.icon="mini-icon-graph.png";ga.prototype.configure=function(a){this.uid=a.uid;this.enabled=!!a.enabled;
if(a.graph_data)try{var b=JSON.parse(a.graph_data);this._graph.configure(b)}catch(c){console.error("Error configuring Graph data: "+c)}a.on_event&&(this.on_event=a.on_event);a.force_redraw&&(this.force_redraw=a.force_redraw)};ga.prototype.serialize=function(){return{uid:this.uid,enabled:this.enabled,force_redraw:this.force_redraw,graph_data:JSON.stringify(this._graph.serialize()),on_event:this.on_event}};ga.prototype.onAddedToNode=function(a){this._graph._scenenode=a};ga.prototype.onRemovedFromNode=
function(a){this._graph._scenenode=null};ga.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onEvent,this);LEvent.bind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.bind(a,"update",this.onEvent,this)};ga.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"start",this.onEvent,this);LEvent.unbind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.unbind(a,"update",this.onEvent,this)};ga.prototype.onResourceRenamed=function(a,b,c){this._graph.sendEventToAllNodes("onResourceRenamed",
[a,b,c])};ga.prototype.onEvent=function(a,b){"beforeRenderMainPass"==a&&(a="render");this.on_event==a&&this.runGraph()};ga.prototype.trigger=function(a){"trigger"==this.on_event&&this.runGraph()};ga.prototype.runGraph=function(){this._root._in_tree&&this.enabled&&(this._graph&&this._graph.runStep(1),this.force_redraw&&this._root.scene.refresh())};ga.prototype.getGraph=function(){return this._graph};ga.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=
0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};ga.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var d=0;d<c.length;++d){var f=c[d];if(f.properties.name==a)return f.properties.value&&f.properties.value.set?f.properties.value.set(b):f.properties.value=b,!0}};e.registerComponent(ga);M.icon="mini-icon-graph.png";M.buffer_size=[1024,512];M.prototype.configure=function(a){if(a.graph_data&&(this.uid=a.uid,this.enabled=
!!a.enabled,this.use_viewport_size=!!a.use_viewport_size,this.use_high_precision=!!a.use_high_precision,this.use_antialiasing=!!a.use_antialiasing,this.use_extra_texture=!!a.use_extra_texture,this.use_node_camera=!!a.use_node_camera,this._graph.configure(JSON.parse(a.graph_data)),this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0],this._graph_viewport_node=this._graph.findNodesByType("texture/toviewport")[0],!this._graph_frame_node)){console.log("CONVERTING LEGACY DATA TO NEW FORMAT");
this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame");this._graph_frame_node.ignore_remove=!0;this._graph_frame_node.ignore_rename=!0;this._graph.add(this._graph_frame_node);a=["Color Buffer","Depth Buffer","Extra Buffer"];for(var b=0;b<a.length;++b){var c=this._graph.findNodesByTitle(a[b])[0];if(c){var d=c.getOutputInfo(0);if(d.links){var d=d.links.concat(),f;for(f in d){var g=this._graph.links[d[f]];g&&this._graph_frame_node.connect(b,g.target_id,g.target_slot)}this._graph.remove(c)}}}}};
M.prototype.serialize=function(){return{uid:this.uid,enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_extra_texture:this.use_extra_texture,use_viewport_size:this.use_viewport_size,use_node_camera:this.use_node_camera,graph_data:JSON.stringify(this._graph.serialize())}};M.prototype.getResources=function(a){var b=this._graph.findNodesByType("texture/texture"),c;for(c in b)b[c].properties.name&&(a[b[c].properties.name]=Texture);return a};M.prototype.getPropertyValue=
function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};M.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var d=0;d<c.length;++d){var f=c[d];if(f.properties.name==a)return f.properties.value&&f.properties.value.set?f.properties.value.set(b):f.properties.value=b,!0}};M.prototype.getGraph=function(){return this._graph};M.prototype.onResourceRenamed=
function(a,b,c){this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};M.prototype.onAddedToNode=function(a){this._graph._scenenode=a};M.prototype.onRemovedFromNode=function(a){this._graph._scenenode=null};M.prototype.onAddedToScene=function(a){LEvent.bind(a,"enableFrameBuffer",this.onBeforeRender,this);LEvent.bind(a,"showFrameBuffer",this.onAfterRender,this)};M.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"enableFrameBuffer",this.onBeforeRender,this);LEvent.unbind(a,"showFrameBuffer",
this.onAfterRender,this);e.ResourcesManager.unregisterResource(":color_"+this.uid);e.ResourcesManager.unregisterResource(":depth_"+this.uid);e.ResourcesManager.unregisterResource(":extra_"+this.uid)};M.prototype.onBeforeRender=function(a,b){this._last_camera=e.Renderer._current_camera;if(this.enabled)if(this.use_node_camera){var c=this._root.camera;c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameBuffer",this.enableCameraFBO,this),
LEvent.bind(c,"showFrameBuffer",this.showCameraFBO,this));this._binded_camera=c}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null),this.enableGlobalFBO(b);else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};M.prototype.onAfterRender=function(a,b){this.enabled&&(this.use_node_camera||this.showFBO())};M.prototype.enableCameraFBO=function(a,b){if(this.enabled){this._renderFrameContainer||(this._renderFrameContainer=
new e.RenderFrameContainer);var c=this._viewport=this._binded_camera.getLocalViewport(null,this._viewport);this._renderFrameContainer.setSize(c[2],c[3]);this._renderFrameContainer.use_high_precision=this.use_high_precision;this._renderFrameContainer.preRender(b);b.ignore_viewports=!0}};M.prototype.showCameraFBO=function(a,b){this.enabled&&(b.ignore_viewports=!1,this.showFBO())};M.prototype.enableGlobalFBO=function(a){if(this.enabled){var b=this._renderFrameContainer;b||(b=this._renderFrameContainer=
new e.RenderFrameContainer);this.use_viewport_size&&b.useCanvasSize();b.use_high_precision=this.use_high_precision;b.use_extra_texture=this.use_extra_texture;b.preRender(a)}};M.prototype.showFBO=function(){if(this.enabled){var a=this._renderFrameContainer;a.endFBO();e.ResourcesManager.textures[":color_"+this.uid]=a.color_texture;e.ResourcesManager.textures[":depth_"+this.uid]=a.depth_texture;this.extra_texture&&(e.ResourcesManager.textures[":extra_"+this.uid]=a.extra_texture);this.use_node_camera&&
this._viewport?(gl.setViewport(this._viewport),this.applyGraph(),gl.setViewport(a._fbo._old_viewport)):this.applyGraph()}};M.prototype.applyGraph=function(){this._graph&&(this._graph_frame_node||(this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0]),this._graph_frame_node._color_texture=":color_"+this.uid,this._graph_frame_node._depth_texture=":depth_"+this.uid,this._graph_frame_node._extra_texture=":extra_"+this.uid,this._graph_frame_node._camera=this._last_camera,this._graph_viewport_node&&
(this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1))};e.registerComponent(M);(function(){function a(a){this.value=0;this.delta=0.01;this.min_value=this.steps=0;this.max_value=1;this.min_angle=-120;this.max_angle=120;this.axis=vec3.fromValues(0,0,1);a&&this.configure(a)}a.icon="mini-icon-knob.png";a.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousemove",this.onmousemove,this);this.updateKnob()};a.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,
this)};a.prototype.updateKnob=function(){this._root&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+this.value/(this.max_value-this.min_value)*(this.max_angle-this.min_angle))*DEG2RAD),this._root.transform._dirty=!0)};a.prototype.onmousemove=function(a,c){this.value-=c.deltay*this.delta;this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value);this.updateKnob();LEvent.trigger(this,"change",this.value);this._root&&LEvent.trigger(this._root,
"knobChange",this.value);return!1};e.registerComponent(a)})();Object.defineProperty(Xa.prototype,"pos",{get:function(){return this._pos},set:function(a){this._pos.set(a)},enumerable:!0});Object.defineProperty(Xa.prototype,"vel",{get:function(){return this._vel},set:function(a){this._vel.set(a)},enumerable:!0});A.BOX_EMISSOR=1;A.SPHERE_EMISSOR=2;A.MESH_EMISSOR=3;A.CUSTOM_EMISSOR=10;A["@emissor_type"]={type:"enum",values:{Box:A.BOX_EMISSOR,Sphere:A.SPHERE_EMISSOR,Mesh:A.MESH_EMISSOR,Custom:A.CUSTOM_EMISSOR}};
A.icon="mini-icon-particles.png";Object.defineProperty(A.prototype,"particle_start_color",{get:function(){return this._particle_start_color},set:function(a){a&&this._particle_start_color.set(a)},enumerable:!0});Object.defineProperty(A.prototype,"particle_end_color",{get:function(){return this._particle_end_color},set:function(a){a&&this._particle_end_color.set(a)},enumerable:!0});Object.defineProperty(A.prototype,"custom_emissor_code",{get:function(){return this._custom_emissor_code},set:function(a){this._custom_emissor_code=
a=ca.cleanCode(a);try{this._custom_emissor_func=a&&a.length?new Function("p",a):null}catch(b){console.error("Error in ParticleEmissor custom emissor code: ",b)}},enumerable:!0});Object.defineProperty(A.prototype,"custom_update_code",{get:function(){return this._custom_update_code},set:function(a){this._custom_update_code=a=ca.cleanCode(a);try{this._custom_update_func=a&&a.length?new Function("p","dt",a):null}catch(b){console.error("Error in ParticleEmissor custom emissor code: ",b)}},enumerable:!0});
A.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCameraEnabled",this.onAfterCamera,this)};A.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};A.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};A.prototype.onResourceRenamed=function(a,b,c){this.emissor_mesh==
a&&(this.emissor_mesh=b);this.texture==a&&(this.texture=b)};A.prototype.onAfterCamera=function(a,b){this.enabled&&this.align_always&&this.updateMesh(b)};A.prototype.createParticle=function(a){a=a||new Xa;switch(this.emissor_type){case A.BOX_EMISSOR:a._pos.set([this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5)]);break;case A.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a._pos.set([Math.sin(c)*Math.cos(b),
Math.sin(c)*Math.sin(b),Math.cos(c)]);vec3.multiply(a.pos,a.pos,this.emissor_size);break;case A.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor==String&&(b=e.ResourcesManager.getMesh(this.emissor_mesh)),b&&b.vertices?(c=3*Math.floor(Math.random()*b.vertices.length/3),a._pos.set([b.vertices[c],b.vertices[c+1],b.vertices[c+2]])):a._pos.set([0,0,0])}a._vel.set([Math.random()-0.5,Math.random()-0.5,Math.random()-0.5]);a.life=this.particle_life;a.id=this._last_id;a.angle=0;a.size=1;a.rot=this.particle_rotation+
0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a._vel,a._vel,this.particle_speed);this.emissor_type==A.CUSTOM_EMISSOR&&this._custom_emissor_func&&this._custom_emissor_func.call(this,a);this.follow_emitter||vec3.add(a._pos,a._pos,this._emissor_pos);return a};A.prototype.onStart=function(a){if(this.enabled&&!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};A.prototype.onUpdate=
function(a,b,c){if(this.enabled){if(!this._root.scene)throw"update without scene? impossible";this._root.transform&&this._root.transform.getGlobalPosition(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),f=this.physics_friction;a=[];for(var g=vec3.create(),h=0,q=this._particles.length;h<q;++h){var s=this._particles[h];vec3.copy(g,s._vel);vec3.add(g,d,g);vec3.scale(g,g,b);f&&(g[0]-=g[0]*f,g[1]-=g[1]*f,g[2]-=g[2]*f);vec3.add(s._pos,
g,s._pos);s.angle+=s.rot*b;s.life-=b;this._custom_update_func&&this._custom_update_func.call(this,s,b);0<s.life&&a.push(s)}if(0!=this.emissor_rate)for(b=(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),h=0;h<b;h++)s=this.createParticle(),a.length<this.max_particles&&a.push(s);this._particles=a}this.align_always||c||this.updateMesh(e.Renderer._current_camera);LEvent.trigger(this._root.scene,"change")}};A.prototype.createMesh=
function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);this._extra2=new Float32Array(2*this.max_particles);for(var a=[1,1,0,1,1,0,0,1,0,0,1,0],b=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c=0;c<this.max_particles;c++)this._coords.set(a,12*c),this._colors.set(b,24*c),this._extra2[2*c]=1,this._extra2[2*c+1]=c;this._computed_grid_size=
1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,coords:this._coords,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_maxparticles=this.max_particles}};A.prototype.updateMesh=function(a){if(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),f=a.getLocalVector([1,0,0]),g=a.getLocalVector([0,1,0]);a=vec3.create();var h=vec3.fromValues(-1,0,-1),q=vec3.fromValues(1,0,-1),
s=vec3.fromValues(-1,0,1),k=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(h,g,f),vec3.add(q,g,f),vec3.scale(s,q,-1),vec3.scale(k,h,-1));var f=vec3.create(),g=vec3.create(),l=vec3.create(),r=vec3.create(),n=this._particles;if(this.sort_in_z){for(var n=this._particles.concat(),p=geo.createPlane(b,d),z=1/Math.sqrt(p[0]*p[0]+p[1]*p[1]+p[2]*p[2]),b=0;b<n.length;++b)n[b]._dist=Math.abs(vec3.dot(n[b]._pos,p)+p[3])*z;n.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0});this._particles=
n}0==this.particle_life&&(this.particle_life=1E-4);var p=new Float32Array([1,1,1,1]),z=this._particle_start_color,m=this._particle_end_color,t=!1;if(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size||this.point_particles)t=!0,this._computed_grid_size=this.texture_grid_size;for(var w=1/this.texture_grid_size,T=0,B=0,x=this.texture_grid_size<<2,u=this.animated_texture,C=this.loop_animation,D=this._root.scene.getTime()*this.animation_fps,F=new Float32Array(60*this.particle_life<<
0),I=new Float32Array(60*this.particle_life<<0),J=this.particle_size,G=1/(60*this.particle_life),b=0;b<F.length;b+=1)F[b]=e.getCurveValueAt(this.particle_opacity_curve,0,1,0,b*G),I[b]=e.getCurveValueAt(this.particle_size_curve,0,1,0,b*G);for(var G=this.point_particles,E=this._vertices.length,A=this._vertices,H=this._colors,L=this._extra2,N=this._coords,O=quat.create(),P=T=b=0,Q=n.length;P<Q;++P)if(B=n[P],!(0>=B.life)){var T=1-B.life/this.particle_life,K=F[T*F.length<<0];this.independent_color&&B.c?
vec3.clone(p,B.c):vec3.lerp(p,z,m,T);this.premultiplied_alpha?(vec3.scale(p,p,K),p[3]=1):p[3]=K;if(!(0.001>K||(K=B.size*I[T*I.length<<0],Math.abs(K*J)<c)))if(G){if(A.set(B._pos,3*b),H.set(p,4*b),t&&(T=(u?(C?D:T)*x<<0:B.id)%x,T*=w,B=1-(T<<0)*w-w,T%=1,N[2*b]=T,N[2*b+1]=B),L[2*b]=K,L[2*b+1]=b,++b,3*b>=E)break}else if(K*=J,vec3.scale(l,s,K),vec3.scale(g,q,K),vec3.scale(f,h,K),vec3.scale(r,k,K),0!=B.angle&&(quat.setAxisAngle(O,d,B.angle*DEG2RAD),vec3.transformQuat(l,l,O),vec3.transformQuat(g,g,O),vec3.transformQuat(f,
f,O),vec3.transformQuat(r,r,O)),vec3.add(a,B._pos,g),A.set(a,18*b),vec3.add(a,B._pos,f),A.set(a,18*b+3),vec3.add(a,B._pos,r),A.set(a,18*b+6),vec3.add(a,B._pos,f),A.set(a,18*b+9),vec3.add(a,B._pos,l),A.set(a,18*b+12),vec3.add(a,B._pos,r),A.set(a,18*b+15),H.set(p,24*b),H.set(p,24*b+4),H.set(p,24*b+8),H.set(p,24*b+12),H.set(p,24*b+16),H.set(p,24*b+20),t&&(T=(u?(C?D:T)*x<<0:B.id)%x,T*=w,B=1-(T<<0)*w-w,T%=1,N.set([T+w,B+w,T,B+w,T+w,B,T,B+w,T,B,T+w,B],12*b)),++b,18*b>=E)break}this._visible_particles=b;
this._mesh.vertexBuffers.vertices.data=this._vertices;this._mesh.vertexBuffers.vertices.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.colors.data=this._colors;this._mesh.vertexBuffers.colors.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.extra2.data=this._extra2;this._mesh.vertexBuffers.extra2.upload(gl.STREAM_DRAW);t&&(this._mesh.vertexBuffers.coords.data=this._coords,this._mesh.vertexBuffers.coords.upload(gl.STREAM_DRAW))}};A._identity=mat4.create();A.prototype.onCollectInstances=function(a,
b,c){if(this._root&&this.enabled){this._material||(this._material=new m({shader_name:"lowglobal"}));this._material.opacity=this.opacity-0.01;this._material.setTexture(m.COLOR,this.texture);this._material.blend_mode=this.additive_blending?Ea.ADD:Ea.ALPHA;this._material.soft_particles=this.soft_particles;this._material.constant_diffuse=!0;this._material.uvs_matrix[0]=this._material.uvs_matrix[4]=1/this.texture_grid_size;if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=
new e.RenderInstance(this._root,this));this.follow_emitter?mat4.translate(a.matrix,A._identity,this._root.transform._position):mat4.copy(a.matrix,A._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=sa|na;a.applyNodeFlags();a.setMaterial(c);this.point_particles?(a.setMesh(this._mesh,gl.POINTS),a.uniforms.u_point_size=this.particle_size,a.query.macros.USE_POINTS="",a.query.macros.USE_POINT_CLOUD=
"",a.query.macros.USE_TEXTURED_POINTS="",a.setRange(0,this._visible_particles)):(a.setMesh(this._mesh,gl.TRIANGLES),a.setRange(0,6*this._visible_particles),delete a.query.macros.USE_POINTS,delete a.query.macros.USE_POINT_CLOUD,delete a.query.macros.USE_TEXTURED_POINTS,delete a.uniforms.u_point_size);b.push(a)}};e.Particle=Xa;e.registerComponent(A);La.icon="mini-icon-text.png";La.CSS_classname="LS3D_label";La.prototype.onAddedToScene=function(a){LEvent.bind(a,"beforeRender",this.render,this);a=document.createElement("div");
a.innerHTML=this.text;var b=a.style;b.className=this.constructor.CSS_classname;b.position="absolute";b.top=0;b.left=0;b.fontSize="20px";b.padding="10px";b.color="white";b.pointerEvents="none";b.backgroundColor="rgba(0,0,0,0.5)";b.borderRadius="2px";gl&&gl.canvas&&gl.canvas.parentNode&&gl.canvas.parentNode.appendChild(a);this._element=a};La.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"beforeRender",this.render,this);this._element&&(this._element.parentNode&&this._element.parentNode.removeChild(this._element),
this._element=null)};La.prototype.render=function(a,b){if(this._element){var c=this._root;this._element.innerHTML!=this.text&&(this._element.innerHTML=this.text);this._element.style.display=!1===c.flags.visible?"none":"block";if(this.text){var d=this.constructor.CSS_classname+" "+this.className;this._element.className!=d&&(this._element.className=d);d=b.main_camera;c.transform.getGlobalPosition(this._world_pos);d.project(this._world_pos,null,this._screen_pos);this._element.style.left=this._screen_pos[0].toFixed(0)+
"px";this._element.style.top=gl.canvas.height-(this._screen_pos[1]|0)-10+"px"}else this._element.style.display="none"}};e.registerComponent(La);V.icon="mini-icon-points.png";V["@texture"]={widget:"texture"};V["@color"]={widget:"color"};V.default_color=vec4.fromValues(1,1,1,1);V.prototype.addPoint=function(a,b,c,d){var f=new Float32Array(10);f.set(a,0);b?f.set(b,3):f.set(V.default_color,3);f[7]=void 0!==c?c:1;f[8]=void 0!=d?d:0;this._points.push(f);this._dirty=!0;return this._points.length-1};V.prototype.clear=
function(){this._points.length=0};V.prototype.setPoint=function(a,b,c,d,f){if(a=this._points[a])b&&a.set(b,0),c&&a.set(c,3),void 0!==d&&(a[7]=d),void 0!==f&&(a[8]=f),this._dirty=!0};V.prototype.setPointsFromMesh=function(a){};V.prototype.removePoint=function(a){this._points.splice(a,1);this._dirty=!0};V.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};V.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,
this)};V.prototype.getResources=function(a){this.mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};V.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.texture==a&&(this.texture=b)};V.prototype.createMesh=function(){if(this._mesh_max_points!=this.max_points){this._vertices=new Float32Array(3*this.max_points);this._colors=new Float32Array(4*this.max_points);this._extra2=new Float32Array(2*this.max_points);for(var a=0;a<this.max_points;a++)this._colors.set(V.default_color,
4*a),this._extra2[2*a]=1;this._mesh&&this._mesh.deleteBuffers();this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_max_points=this.max_points}};V.prototype.updateMesh=function(a){this._mesh_max_points!=this.max_points&&this.createMesh();var b=this._points;if(this.sort_in_z&&a){var c=a.getEye();a=a.getFront();b=this._points.concat();c=geo.createPlane(c,a);a=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);for(var d=
0;d<b.length;++d)b[d][9]=Math.abs(vec3.dot(b[d].subarray(0,3),c)+c[3])/a;b.sort(function(a,b){return a[9]<b[9]?1:a[9]>b[9]?-1:0})}d=0;c=this._vertices;a=this._colors;for(var d=this._extra2,f=this.premultiplied_alpha,g=0;g<b.length&&!(3*g>=c.length);++g){var h=b[g];c.set(h.subarray(0,3),3*g);var e=h.subarray(3,7);f&&vec3.scale(e,e,e[3]);a.set(e,4*g);d.set(h.subarray(7,9),2*g)}this._mesh.vertexBuffers.vertices.data=c;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=a;
this._mesh.vertexBuffers.colors.upload();this._mesh.vertexBuffers.extra2.data=d;this._mesh.vertexBuffers.extra2.upload()};V._identity=mat4.create();V.prototype.onCollectInstances=function(a,b,c){if(this._root&&0!=this._points.length&&this.enabled){a=e.Renderer._current_camera;this._last_premultiply!==this.premultiplied_alpha&&(this._dirty=!0);this._dirty&&this.updateMesh(a);this._material||(this._material=new e.Material({shader_name:"lowglobal"}),this._material.extra_macros={USE_POINT_CLOUD:"",USE_TEXTURED_POINTS:""});
c=this._material;c.color.set(this.color);c.opacity=this.premultiplied_alpha?0.99:this.global_opacity-0.01;this._last_premultiply=this.premultiplied_alpha;c.setTexture(e.Material.COLOR,this.texture);c.blend_mode=this.additive_blending?e.Blend.ADD:e.Blend.ALPHA;c.constant_diffuse=!0;if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new e.RenderInstance(this._root,this));this.in_world_coordinates?a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,V._identity);
c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=sa|na;a.applyNodeFlags();a.uniforms.u_point_size=this.size;a.setMaterial(c);a.setMesh(this._mesh,gl.POINTS);c=this._points.length;c>this._vertices.length/3&&(c=this._vertices.length/3);a.setRange(0,c);b.push(a)}};e.registerComponent(V);la.icon="mini-icon-lines.png";la["@color"]={widget:"color"};la.prototype.clear=function(){this._lines.length=0};la.prototype.addLine=
function(a,b,c,d){var f=new Float32Array(14);f.set(a,0);f.set(b,3);c?f.set(c,6):f.set([1,1,1,1],6);d?f.set(d,10):c?f.set(c,10):f.set([1,1,1,1],10);this._lines.push(f);this._dirty=!0;return this._lines.length-1};la.prototype.setLine=function(a,b,c,d,f){a=this._lines[a];b&&a.set(b,0);c&&a.set(c,3);d&&a.set(d,6);f&&a.set(f,10);this._dirty=!0};la.prototype.removeLine=function(a){this._lines.splice(a,1);this._dirty=!0};la.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this)};la.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};la.prototype.onResourceRenamed=function(a,b,c){};la.prototype.createMesh=function(){this._mesh_max_lines!=this.max_lines&&(this._vertices=new Float32Array(6*this.max_lines),this._colors=new Float32Array(8*this.max_lines),this._mesh=new GL.Mesh,this._mesh.addBuffers({vertices:this._vertices,colors:this._colors},null,gl.STREAM_DRAW),this._mesh_max_lines=this.max_lines)};la.prototype.updateMesh=
function(){this._mesh_max_lines!=this.max_lines&&this.createMesh();for(var a=0,b=this._vertices,c=this._colors,d=this._lines,f=this._lines.length,g=b.length,a=0;a<f&&!(6*a>=g);++a){var h=d[a];b.set(h.subarray(0,6),6*a);c.set(h.subarray(6,14),8*a)}this._mesh.vertexBuffers.vertices.data=b;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=c;this._mesh.vertexBuffers.colors.upload()};la._identity=mat4.create();la.prototype.onCollectInstances=function(a,b,c){if(this._root&&
0!=this._lines.length&&this.enabled){this._dirty&&this.updateMesh();this._material||(this._material=new m({shader_name:"lowglobal"}));c=this._material;c.color.set(this.color);c.opacity=this.global_opacity-0.01;c.blend_mode=this.additive_blending?Ea.ADD:Ea.ALPHA;c.constant_diffuse=!0;if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new W(this._root,this));this.in_world_coordinates?a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,la._identity);c=this._root.material&&
this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=sa|na;a.applyNodeFlags();a.setMaterial(c);a.setMesh(this._mesh,gl.LINES);c=2*this._lines.length;c>this._vertices.length/3&&(c=this._vertices.length/3);a.setRange(0,c);b.push(a)}};e.registerComponent(la);ra["@animation"]={widget:"resource"};ra["@mode"]={type:"enum",values:["loop","pingpong","once"]};ra.prototype.configure=function(a){a.animation&&(this.animation=a.animation);a.take&&
(this.take=a.take);null!=a.playback_speed&&(this.playback_speed=parseFloat(a.playback_speed))};ra.icon="mini-icon-clock.png";ra.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};ra.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};ra.prototype.getAnimation=function(){return this.animation&&"@scene"!=this.animation?e.ResourcesManager.getResource(this.animation):this._root.scene.animation};ra.prototype.onUpdate=function(a,b){var c=
this.getAnimation();if(c&&(this.play&&(this.current_time+=b*this.playback_speed),c=c.takes[this.take])){var d=this.current_time;if(d>c.duration)switch(this.mode){case "once":d=c.duration;break;case "loop":d=this.current_time%c.duration;break;case "pingpong":d=0==(d/c.duration|0)%2?this.current_time%c.duration:c.duration-this.current_time%c.duration}c.applyTracks(d,this._last_time);this._last_time=d;(c=this._root.scene)&&c.refresh()}};ra.prototype._processSample=function(a,b,c,d){if(d=this._root.scene)if(a=
d.getNode(a)){d=a.transform;switch(b){case "translate.X":d&&(d.position[0]=c);break;case "translate.Y":d&&(d.position[1]=c);break;case "translate.Z":d&&(d.position[2]=c);break;case "matrix":d&&d.fromMatrix(c)}a.transform&&a.transform.updateMatrix()}};ra.prototype.getResources=function(a){this.animation&&(a[this.animation]=e.Animation)};ra.prototype.onResourceRenamed=function(a,b,c){this.animation==a&&(this.animation=b)};e.registerComponent(ra);Fa.icon="mini-icon-reflector.png";Fa["@texture_size"]=
{type:"enum",values:["viewport",64,128,256,512,1024,2048]};Fa["@layers"]={type:"layers"};Fa.prototype.onAddedToScene=function(a){LEvent.bind(a,"renderReflections",this.onRenderReflection,this);LEvent.bind(a,"afterCameraEnabled",this.onCameraEnabled,this)};Fa.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this);for(var b in this._textures)e.ResourcesManager.unregisterResource(":reflection_"+b);this._textures={}};Fa.prototype.onRenderReflection=function(a,b){if(this.enabled&&this._root){var c=
this._root.scene;if(c&&(this.refresh_rate<<=0,0!=c._frame&&0==c._frame%this.refresh_rate||!this._rt)){var d=c=parseInt(this.texture_size),f=c,g=this._root.flags.visible;this.ignore_this_mesh&&(this._root.flags.seen_by_reflections=!1);b.is_rt=!0;b.is_reflection=!0;b.brightness_factor=this.brightness_factor;b.colorclip_factor=this.colorclip_factor;b.layers=this.layers;for(var h=e.Renderer._visible_cameras,q=0;q<h.length;q++){var s=h[q];isNaN(c)&&"viewport"==this.texture_size&&(c=512,f=s.getLocalViewport(null,
s._viewport_in_pixels),d=f[2],f=f[3]);this.use_cubemap&&(d=f=c);var k=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D,l=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,r=this._textures[s.uid];r&&r.width==d&&r.height==f&&r.type==l&&r.texture_type==k&&r.minFilter==(this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)||(r=new GL.Texture(d,f,{type:l,texture_type:k,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR}),r.has_mipmaps=this.generate_mipmaps,this._textures[s.uid]=
r);var k=this._root.transform.getGlobalPosition(),l=this._root.transform.getTop(),n=s.getEye(),p=s.getCenter(),z=s.getUp();if(this.use_mesh_info){var m=this._root.getMesh();m&&(k=this._root.transform.transformPointGlobal(BBox.getCenter(m.bounding)),l=this._root.transform.transformVectorGlobal([0,1,0]))}vec3.add(k,k,this.offset);this._reflected_camera=m=this._reflected_camera||new e.Camera;m.configure(s.serialize());this.use_cubemap?m.eye=k:(m.fov=s.fov,m.aspect=s.aspect,m.eye=geo.reflectPointInPlane(n,
k,l),m.center=geo.reflectPointInPlane(p,k,l),m.up=geo.reflectPointInPlane(z,[0,0,0],l),vec3.add(k,k,vec3.scale(vec3.create(),l,-this.clip_offset)),k=[l[0],l[1],l[2],vec3.dot(k,l)],b.clipping_plane=k);e.Renderer.renderInstancesToRT(m,r,b);this.blur&&((k=this._textures["blur_"+s.uid])&&(Texture.compareFormats(r,k)||k.minFilter!=r.minFilter)&&(k=null),r.applyBlur(this.blur,this.blur,1,k));this.generate_mipmaps&&isPowerOfTwo(d)&&isPowerOfTwo(f)&&(r.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),
gl.generateMipmap(r.texture_type),r.unbind());this.texture_name&&e.ResourcesManager.registerResource(this.texture_name,r);e.ResourcesManager.registerResource(":reflection_"+s.uid,r);if(!this.all_cameras)break}delete b.clipping_plane;delete b.is_rt;delete b.is_reflection;delete b.brightness_factor;delete b.colorclip_factor;delete b.layers;this._root.flags.visible=g}}};Fa.prototype.onCameraEnabled=function(a,b){if(this.enabled&&this._root&&this._root.material&&this._textures[b.uid]){var c=this._root.getMaterial();
c&&(c.setTexture(m.ENVIRONMENT_TEXTURE,":reflection_"+b.uid).uvs=m.COORDS_FLIPPED_SCREEN)}};e.registerComponent(Fa);J.secure_module=!1;J.block_execution=!1;J.catch_important_exceptions=!0;J.icon="mini-icon-script.png";J["@code"]={type:"script"};J.exported_callbacks="start update trigger sceneRender render afterRender renderGUI finish collectRenderInstances".split(" ");J.translate_events={sceneRender:"beforeRender",beforeRender:"sceneRender",render:"renderInstances",renderInstances:"render",afterRender:"afterRenderInstances",
afterRenderInstances:"afterRender"};J.coding_help="\nGlobal vars:\n + node : represent the node where this component is attached.\n + component : represent the component.\n + this : represents the script context\n\nExported functions:\n + start: when the Scene starts\n + update: when updating\n + trigger : if this node is triggered\n + render : before rendering the node\n + getRenderInstances: when collecting instances\n + afterRender : after rendering the node\n + finish : when the scene finished (mostly used for editor stuff)\n\nRemember, all basic vars attached to this will be exported as global.\n";
J.active_scripts={};Object.defineProperty(J.prototype,"name",{set:function(a){e.Script.active_scripts[this._name]&&delete e.Script.active_scripts[this._name];(this._name=a)&&!e.Script.active_scripts[this._name]&&(e.Script.active_scripts[this._name]=this)},get:function(){return this._name},enumerable:!0});Object.defineProperty(J.prototype,"context",{set:function(a){console.error("Script: context cannot be assigned")},get:function(){return this._script?this._script._context:null},enumerable:!1});J.prototype.getContext=
function(){return this._script?this._script._context:null};J.prototype.getCode=function(){return this.code};J.prototype.setCode=function(a,b){this.code=a;this.processCode(b)};J.prototype.processCode=function(a){this._script.code=this.code;if(this._root&&!J.block_execution){var b=this._script.compile({component:this,node:this._root,scene:this._root.scene});a||this.hookEvents();return b}return!0};J.prototype.setProperty=function(a,b){var c=this.getContext();if(c&&void 0!==c[a])if(c[a].set)c[a](b);else c[a]=
b;else this[a]&&(this[a]=b)};J.prototype.getProperties=function(){var a=this.getContext();if(!a)return{enabled:"boolean"};a=e.getObjectProperties(a);a.enabled="boolean";return a};J.prototype.getPropertyInfoFromPath=function(a){if("context"==a[0]){var b=this.getContext();if(1==a.length)return{node:this._root,target:b,type:"object"};a=a[1];if(b&&void 0!==b[a]){var c=b[a],d=b["@"+a],f="";d&&(f=d.type);f||null===c||void 0===c||(c.constructor===String?f="string":c.constructor===Boolean?f="boolean":c.length?
f="vec"+c.length:c.constructor===Number&&(f="number"));return{node:this._root,target:b,name:a,value:c,type:f}}}};J.prototype.setPropertyValueFromPath=function(a,b){if(!(1>a.length)&&"context"==a[0]){var c=this.getContext(),d=a[1];c&&void 0!==c[d]&&void 0!==c[d]&&(c[d]&&c[d].set?c[d].set(b):c[d]=b)}};J.prototype.hookEvents=function(){var a=e.Script.exported_callbacks,b=this._root,c=b.scene;c||(c=e.GlobalScene);var d=this.getContext();if(d)for(var f in a){var g=a[f],h=e.Script.translate_events[g]||
g,q="trigger"==h?b:c;d[g]&&d[g].constructor===Function?LEvent.isBind(q,h,this.onScriptEvent,this)||LEvent.bind(q,h,this.onScriptEvent,this):LEvent.unbind(q,h,this.onScriptEvent,this)}};J.prototype.onAddedToNode=function(a){a.script&&(a.script=this)};J.prototype.onRemovedFromNode=function(a){a.script==this&&delete a.script};J.prototype.onAddedToScene=function(a){this._name&&!e.Script.active_scripts[this._name]&&(e.Script.active_scripts[this._name]=this);if(this.constructor.catch_important_exceptions)try{this.processCode()}catch(b){console.error(b)}else this.processCode()};
J.prototype.onRemovedFromScene=function(a){this._name&&e.Script.active_scripts[this._name]&&delete e.Script.active_scripts[this._name];this._context&&LEvent.unbindAll(a,this._context,this);LEvent.unbindAll(a,this)};J.prototype.onAddedToProject=function(a){try{this.processCode()}catch(b){console.error(b)}};J.prototype.onRemovedFromProject=function(a){this._context&&LEvent.unbindAll(a,this._context,this);LEvent.unbindAll(a,this)};J.prototype.onScriptEvent=function(a,b){this.enabled&&this._script.callMethod(e.Script.translate_events[a]||
a,b)};J.prototype.runStep=function(a,b){this._script.callMethod(a,b)};J.prototype.onError=function(a){var b=this._root.scene;b&&(LEvent.trigger(this,"code_error",a),LEvent.trigger(b,"code_error",[this,a]),LEvent.trigger(J,"code_error",[this,a]),console.log("app finishing due to error in script"),b.finish())};J.prototype.onCodeChange=function(a){this.processCode()};J.prototype.getResources=function(a){var b=this.getContext();b&&b.getResources&&b.getResources(a)};e.registerComponent(J);e.Script=J;Object.defineProperty(ea.prototype,
"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});ea.icon="mini-icon-terrain.png";ea["@subdivisions"]={type:"number",min:1,max:255,step:1};ea["@heightmap"]={type:"texture"};ea["@action"]={widget:"button",callback:function(){this.options.instance&&this.options.instance.updateMesh()}};ea["@primitive"]={type:"enum",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};ea.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};ea.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._root.mesh==this._mesh&&delete this._root.mesh};ea.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};ea.prototype.onResourceRenamed=function(a,b,c){this.heightmap==a&&(this.heightmap=b)};ea.prototype.updateMesh=function(){Ga("updating terrain mesh...");if(this.heightmap){var a=
e.ResourcesManager.textures[this.heightmap];if(a){var b=a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&(this.subdivisions=255);var a=0.5*this.size,c=this.subdivisions<<0,d=this.height,f=createCanvas(c,c),g=f.getContext("2d");g.drawImage(b,0,0,b.width,b.height,0,0,f.width,f.height);for(var b=g.getImageData(0,0,f.width,f.height).data,f=[],g=[],h=[],q=[],s=[],k=detailX=c-1,l,r=a/(c-1),n=0;n<=k;n++)for(var p=
n/k,z=0;z<=detailX;z++){var m=z/detailX;l=b[n*c*4+4*z]/255;h.push(a*(2*m-1),l*d,a*(2*p-1));s.push(m,1-p);0==z||0==n||z==detailX-1||n==k-1?q.push(0,1,0):(l=[-(b[n*c*4+4*(z+1)]/255-b[n*c*4+4*(z-1)]/255)*d,2*r,-(b[(n+1)*c*4+4*z]/255-b[(n-1)*c*4+4*z]/255)*d],vec3.normalize(l,l),q.push(l[0],l[1],l[2]));z<detailX&&n<k&&(l=z+n*(detailX+1),f.push(l+1,l,l+detailX+1),f.push(l+1,l+detailX+1,l+detailX+2),g.push(l+1,l,l,l+detailX+1))}c=new GL.Mesh({vertices:h,normals:q,coords:s},{triangles:f,wireframe:g});c.setBounding([0,
0.5*this.height,0],[a,0.5*this.height,a]);this._mesh=c;this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};ea.PLANE=null;ea.prototype.onCollectInstances=function(a,b){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());var c=this._render_instance;c||(this._render_instance=c=new W(this._root,
this));if(!this._mesh)return ea.PLANE||(ea.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),c.mesh=ea.PLANE,c;c.material=this._root.getMaterial();c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());c.flags=sa;c.applyNodeFlags();b.push(c)};e.registerComponent(ea);L.GRID_MODE=1;L.RADIAL_MODE=2;L.MESH_MODE=3;L.icon="mini-icon-cloner.png";L["@mesh"]={type:"mesh"};L["@lod_mesh"]={type:"mesh"};
L["@mode"]={type:"enum",values:{Grid:L.GRID_MODE,Radial:L.RADIAL_MODE,Mesh:L.MESH_MODE}};L["@count"]={type:"vec3",min:1,step:1};L.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCollectData",this.onUpdateInstances,this)};L.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.unbind(a,"afterCollectData",this.onUpdateInstances,this)};L.prototype.getMesh=function(){return"string"===
typeof this.mesh?ba.meshes[this.mesh]:this.mesh};L.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ba.meshes[this.lod_mesh]:this.low_mesh};L.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};L.generateTransformKey=function(a,b,c){var d=new Float32Array(9);d.set(a);d.set(b,3);d.set(c,6);return d};L.compareKeys=function(a,b){for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0};
L.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getMesh();if(!c)return null;if(this._root){this.updateRenderInstancesArray();var d=this._RIs,f=this.material||this._root.getMaterial(),g=0,h=b.length;b.length=h+d.length;for(var e=0,s=d.length;e<s;++e){var k=d[e];0==e?(k.flags=sa|eb,k.applyNodeFlags(),g=k.flags):k.flags=g;k.setMesh(c);if(this.lod_mesh){var l=this.getLODMesh();l&&k.setLODMesh(l)}k.setMaterial(f);b[h+e]=k}}}};L.prototype.updateRenderInstancesArray=function(){var a=
0;this.mode===L.GRID_MODE?a=(this.count[0]|0)*(this.count[1]|0)*(this.count[2]|0):this.mode===L.RADIAL_MODE?a=this.count[0]|0:this.mode===L.MESH_MODE&&(a=0);if(!a)this._RIs.length=0;else if(!this._RIs||this._RIs.length!=a){this._RIs?this._RIs.length=a:this._RIs=Array(a);for(var b=0;b<a;++b)this._RIs[b]||(this._RIs[b]=new e.RenderInstance(this._root,this))}};L.prototype.onUpdateInstances=function(a,b){if(this.enabled){var c=this._RIs;if(c&&c.length){var d=this._root.transform.getGlobalMatrix(mat4.create()),
f=this._count[0]|0,g=this._count[1]|0,h=this._count[2]|0;if(this.mode==L.GRID_MODE){var e=vec3.scale(vec3.create(),this.size,0.5),s=vec3.create();1<f?s[0]=this.size[0]/(f-1):e[0]=0;1<g?s[1]=this.size[1]/(g-1):e[1]=0;1<h?s[2]=this.size[2]/(h-1):e[2]=0;for(var k=0,l=vec3.create(),r=vec3.create(),n=0;n<f;++n)for(var p=0;p<g;++p)for(var z=0;z<h;++z){var m=c[k];if(!m)return;l[0]=n*s[0]-e[0];l[1]=p*s[1]-e[1];l[2]=z*s[2]-e[2];mat4.translate(m.matrix,d,l);mat4.multiplyVec3(m.center,m.matrix,r);++k}}else if(this.mode==
L.RADIAL_MODE)for(s=2*Math.PI/c.length,l=vec3.create(),r=vec3.create(),k=0,f=c.length;k<f;++k){m=c[k];if(!m)break;l[0]=Math.sin(s*k)*this.size[0];l[1]=0;l[2]=Math.cos(s*k)*this.size[0];m.matrix.set(d);mat4.translate(m.matrix,m.matrix,l);mat4.rotateY(m.matrix,m.matrix,s*k);mat4.multiplyVec3(m.center,m.matrix,r)}}}};e.registerComponent(L);ha["@factor"]={type:"number",step:0.001};ha["@center"]={type:"position",step:0.001};ha.icon="mini-icon-circle.png";ha.prototype.onAddedToNode=function(a){LEvent.bind(a,
"computingShaderQuery",this.onShaderQuery,this);LEvent.bind(a,"computingShaderUniforms",this.onUniforms,this)};ha.prototype.onRemovedFromNode=function(a){LEvent.unbindAll(a,this)};ha._uniforms_code="uniform vec3 u_spherize_center@; uniform float u_spherize_radius@; uniform float u_spherize_factor@;";ha._code="\tvec3 off@ = vertex4.xyz - u_spherize_center@;    float dist@ = length(off@);\tvec3 vn@ = off@ / dist@;\tfloat factor@ = max(0.0, u_spherize_factor@ / dist@ );\tvertex4.xyz = mix(vertex4.xyz, vn@ * u_spherize_radius@, factor@);\tv_normal = (mix(v_normal, vn@, clamp(0.0,1.0,factor@)));";
ha.prototype.onShaderQuery=function(a,b){this.enabled&&(b.macros.USE_VERTEX_SHADER_UNIFORMS=b.macros.USE_VERTEX_SHADER_UNIFORMS?b.macros.USE_VERTEX_SHADER_UNIFORMS+this._uniforms_code:this._uniforms_code,b.macros.USE_VERTEX_SHADER_CODE=b.macros.USE_VERTEX_SHADER_CODE?b.macros.USE_VERTEX_SHADER_CODE+this._code:this._code)};ha.prototype.onUniforms=function(a,b){this.enabled&&(b["u_spherize_center"+this._num_id]=this.center,b["u_spherize_radius"+this._num_id]=this.radius,b["u_spherize_factor"+this._num_id]=
this.factor)};ha.prototype.renderEditor=function(a,b){if(this.enabled&&a&&this.enabled){ta.setPointSize(6);ta.setColor([0.33,0.874,0.56,b?0.8:0.5]);var c=vec3.clone(this.center);this._root&&this._root.transform&&vec3.transformMat4(c,c,this._root.transform._global_matrix);ta.renderRoundPoints(c)}};ha.prototype.getTransformMatrix=function(a){if(!this._root||!this._root.transform)return null;var b=null;if("center"==a)b=this.center;else return!1;a=mat4.clone(this._root.transform._global_matrix);mat4.translate(a,
a,b);return a};ha.prototype.renderPicking=function(a){a=vec3.clone(this.center);this._root&&this._root.transform&&vec3.transformMat4(a,a,this._root.transform._global_matrix);EditorView.addPickingPoint(a,4,{instance:this,info:"center"})};ha.prototype.applyTransformMatrix=function(a,b,c){if(!this._root||!this._root.transform||"center"!=c)return!1;b=this.center;mat4.multiplyVec3(b,a,b);return!0};e.registerComponent(ha);za.icon="mini-icon-graph.png";za.rift_server_url="http://tamats.com/uploads/RiftServer_0_3.zip";
za.prototype.onAddedToNode=function(a){var b=a.scene;LEvent.bind(b,"start",this.onStart,this);LEvent.bind(b,"finish",this.onStop,this);LEvent.bind(b,"beforeRender",this.onBeforeRender,this);LEvent.bind(b,"afterRender",this.onAfterRender,this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};za.prototype.onRemovedFromNode=function(a){var b=this._root.scene;LEvent.unbind(b,"start",this.onStart,this);LEvent.unbind(b,"finish",this.onStop,this);LEvent.unbind(b,"beforeRender",this.onBeforeRender,
this);LEvent.unbind(b,"afterRender",this.onAfterRender,this);LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);Oa.color_rendertarget=null};za.prototype.onCollectCameras=function(a,b){var c=Oa.main_camera;this._orientation&&c.setOrientation(this._orientation,!0);var d=c.getLocalVector([0.5*this.eye_distance,0,0]),f=vec3.scale(vec3.create(),d,-1);this._left_camera||(this._left_camera=new e.Camera,this._right_camera=new e.Camera);var g=c.serialize();this._left_camera.configure(g);this._right_camera.configure(g);
this._left_camera.eye=vec3.add(vec3.create(),c.eye,f);this._right_camera.eye=vec3.add(vec3.create(),c.eye,d);this._left_camera._viewport.set([0,0,0.5,1]);this._right_camera._viewport.set([0.5,0,0.5,1]);this._right_camera._ignore_clear=!0;b.push(this._left_camera,this._right_camera)};za.prototype.onStart=function(a){a=new WebSocket("ws://localhost:1981");a.onopen=function(){console.log("VR connection stablished")};a.onmessage=this.onMessage.bind(this);a.onclose=function(){console.log("OVR connection lost")};
a.onerror=function(){console.error("Oculus Server not found in your machine. To run an app using Oculus Rift you need to use a client side app, you can download it from: "+OculusController.rift_server_url)};this._ws=a};za.prototype.onMessage=function(a){var b=a.data,b=JSON.parse("["+b+"]");a=quat.create();a.set(b);b=quat.fromValues(-1,0,0,0);quat.multiply(a,b,a);this._orientation=a;this._root.scene&&this._root.scene.refresh()};za.prototype.onStop=function(a){this._ws&&(this._ws.close(),this._ws=null)};
za.prototype.onBeforeRender=function(a,b){var c=1024,d=512,c=v[2],d=v[3];this._color_texture&&this._color_texture.width==c&&this._color_texture.height==d||(this._color_texture=new GL.Texture(c,d,{format:gl.RGB,filter:gl.LINEAR}),e.ResourcesManager.textures[":vr_color_buffer"]=this._color_texture);e.Renderer.color_rendertarget=this.enabled?this._color_texture:null};za.prototype.onAfterRender=function(a,b){this._color_texture&&this._color_texture.toViewport()};Ia.prototype.configure=function(a){};Ia.icon=
"mini-icon-clock.png";Ia.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Ia.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};Ia.prototype.onUpdate=function(a,b){var c=this._root.scene;c||c.refresh()};Ia.prototype.getResources=function(a){};Ia.prototype.onResourceRenamed=function(a,b,c){};aa.icon="mini-icon-cursor.png";aa.PICKING=1;aa.BOUNDING=2;aa.COLLIDERS=3;aa["@mode"]={type:"enum",values:{Picking:aa.PICKING,Bounding:aa.BOUNDING,
Colliders:aa.COLLIDERS}};aa["@layers"]={type:"layers"};aa.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this._onMouse,this);LEvent.bind(a,"mousemove",this._onMouse,this);LEvent.bind(a,"mouseup",this._onMouse,this)};aa.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};aa.prototype.getNodeUnderMouse=function(a){var b=this.layers;if(this.mode==aa.PICKING)return e.Picking.getNodeAtCanvasPosition(a.canvasx,a.canvasy,null,b);if(this.mode==aa.BOUNDING){var c=e.Renderer.getCameraAtPosition(a.canvasx,
a.canvasy);if(!c)return null;a=c.getRayInPixel(a.canvasx,a.canvasy);return(b=e.Picking.raycast(a.start,a.direction,null,b))&&b.length?b[0].node:null}if(this.mode==aa.COLLIDERS){c=e.Renderer.getCameraAtPosition(a.canvasx,a.canvasy);if(!c)return null;a=c.getRayInPixel(a.canvasx,a.canvasy);return(b=e.Physics.raycast(a.start,a.direction,null,b))&&b.length?b[0].node:null}return null};aa.prototype._onMouse=function(a,b){this.enabled&&(("mousedown"==b.eventType||"mousewheel"==b.eventType)&&(this._clicked_node=
this.getNodeUnderMouse(b))&&"mousedown"==b.eventType&&0==b.button&&(this.send_trigger&&LEvent.trigger(this._clicked_node,"trigger",b),this.self_trigger&&LEvent.trigger(this._root,"trigger",this._clicked_node)),this._clicked_node&&(b.scene_node=this._clicked_node,LEvent.trigger(this._clicked_node,b.eventType,b)),"mouseup"==b.eventType&&(this._clicked_node=null))};e.registerComponent(aa);if("undefined"!=typeof LiteGraph){var Ha=function(){this.addOutput("Time","number")};Ha.title="Scene";Ha.desc="Scene";
Ha.getComponents=function(a,b){b=b||[];var c=a.getComponents();if(!c)return b;for(var d=0;d<c.length;++d){var f=e.getClassName(c[d].constructor);b.push([f,f])}return b};Ha.prototype.onExecute=function(){var a=this.graph.getScene();if(this.inputs)for(var b=0;b<this.inputs.length;++b)this.getInputData(b);if(this.outputs)for(b=0;b<this.outputs.length;++b){var c=this.outputs[b];if(c.links&&c.links.length){var d=null;switch(c.name){case "Time":d=a.getTime();break;case "Elapsed":d=null!=a._last_dt?a._last_dt:
0;break;case "Frame":d=null!=a._frame?a._frame:0;break;default:d=a.root.getComponent(c.name)}this.setOutputData(b,d)}}};Ha.prototype.onGetOutputs=function(){return Ha.getComponents(this.graph.getScene().root,[["Elapsed","number"],["Frame","number"]])};LiteGraph.registerNodeType("scene/scene",Ha);window.LGraphScene=Ha;var oa=function(){this.properties={node_id:""};this.size=[100,20];this.addInput("node_id","string",{locked:!0});oa._current_node_id&&(this.properties.node_id=oa._current_node_id)};oa.title=
"SceneNode";oa.desc="Node on the scene";oa.prototype.getNode=function(){var a=null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));a&&(this.properties.node_id=a);var b=this.graph.getScene(),c=null;!a&&this.properties.node_id&&(a=this.properties.node_id);a&&(c=b.getNode(a));c||(c=this.graph._scenenode);return c};oa.prototype.onExecute=function(){var a=this.getNode();if(this.inputs)for(var b=1;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==d)switch(c.name){case "Transform":a.transform.copyFrom(d);
break;case "Material":a.material=d;break;case "Visible":a.flags.visible=d}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Material":this.setOutputData(b,a.getMaterial());break;case "Transform":this.setOutputData(b,a.transform);break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible);break;default:d=a.getComponentByUId(c.name);if(!d){var f=a.scene.findComponentByUId(c.name);f&&
(d=e.getObjectClassName(f),d=a.getComponent(d))&&(c.name=d.uid)}this.setOutputData(b,d)}};oa.prototype.getComponents=function(a){a=a||[];var b=this.getNode();if(!b)return a;b=b.getComponents();if(!b)return a;for(var c=0;c<b.length;++c){var d=e.getClassName(b[c].constructor);a.push([b[c].uid,d,{label:d}])}return a};oa.prototype.onDropItem=function(a){if(a=a.dataTransfer.getData("node_id"))return this.properties.node_id=a,this.onExecute(),!0};oa.prototype.onGetInputs=function(){return this.getComponents([["Visible",
"boolean"],["Material","Material"]])};oa.prototype.onGetOutputs=function(){return this.getComponents([["Visible","boolean"],["Material","Material"]])};LiteGraph.registerNodeType("scene/node",oa);window.LGraphSceneNode=oa;C=function(){this.properties={node_id:""};oa._current_node_id&&(this.properties.node=oa._current_node_id);this.addInput("Transform","Transform",{locked:!0});this.addOutput("Position","vec3")};C.title="Transform";C.desc="Transform info of a node";C.prototype.onExecute=function(){var a=
null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));if(!a){a=this.graph.getScene();if(!a)return;var b=this._node;if(this.properties.node&&(b=a.getNode(this.properties.node),!b))return;b||(b=this.graph._scenenode);a=b.transform}if(a){if(this.inputs)for(b=1;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==d)switch(c.name){case "x":a.x=d;break;case "y":a.y=d;break;case "z":a.z=d;break;case "Position":a.setPosition(d);break;case "Rotation":a.setRotation(d);break;
case "Scale":a.setScale(d);break;case "Matrix":a.fromMatrix(d);break;case "Translate":a.translate(d);break;case "Translate Local":a.translateLocal(d);break;case "RotateY":a.rotateY(d)}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length){d=void 0;switch(c.name){case "x":d=a.x;break;case "y":d=a.y;break;case "z":d=a.z;break;case "Position":d=a.position;break;case "Global Position":d=a.getGlobalPosition();break;case "Rotation":d=a.rotation;break;case "Global Rotation":d=
a.getGlobalRotation();break;case "Scale":d=a.scaling;break;case "Matrix":d=a.getMatrix()}void 0!==d&&this.setOutputData(b,d)}}};C.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"],["Translate","vec3"],["Translate Local","vec3"],["RotateY","number"]]};C.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale",
"number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"]]};LiteGraph.registerNodeType("scene/transform",C);window.LGraphTransform=C;C=function(){this.properties={mat_name:""};this.addInput("Material","Material");this.size=[100,20]};C.title="Material";C.desc="Material of a node";C.prototype.onExecute=function(){var a=this.getMaterial();if(a){for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);void 0!==
d&&"Material"!=c.name&&a.setProperty(c.name,d)}if(this.outputs)for(b=0;b<this.outputs.length;++b)c=this.outputs[b],c.links&&c.links.length&&(d=a.getProperty(c.name),this.setOutputData(b,d))}};C.prototype.getMaterial=function(){var a=this.findInputSlot("Material");return-1!=a?this.getInputData(a):this.properties.mat_name?e.RM.materials[this.properties.mat_name]:null};C.prototype.onGetInputs=function(){var a=this.getMaterial();if(a){var a=a.getProperties(),b=[["Material","Material"]],c;for(c in a)b.push([c,
a[c]]);return b}};C.prototype.onGetOutputs=function(){var a=this.getMaterial();if(a){var a=a.getProperties(),b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}};LiteGraph.registerNodeType("scene/material",C);window.LGraphMaterial=C;C=function(){this.properties={node:"",component:""};this.addInput("Component",void 0,{locked:!0});this._component=null};C.title="Component";C.desc="A component from a node";C.prototype.onConnectInput=function(a,b){if(0==a&&!e.Components[b])return!1};C.prototype.onExecute=
function(){var a=this.getComponent();if(a){for(var b=1;b<this.inputs.length;b++){var c=this.inputs[b],d=this.getInputData(b);void 0!==d&&e.setObjectProperty(a,c.name,d)}for(b in this.outputs)c=this.outputs[b],c.links&&c.links.length&&this.setOutputData(b,a[c.name])}};C.prototype.onDrawBackground=function(){var a=this.getComponent();a&&(this.title=e.getClassName(a.constructor))};C.prototype.getComponent=function(){var a=this.getInputData(0);if(a)return a;a=this.graph._scene;if(!a)return null;var b=
this.properties.node;if(b){a=a.getNode(b);if(!a)return null;var b=this.properties.component,c=null;if("@"==b.charAt(0))c=a.getComponentByUId(b);else if(e.Components[b])c=a.getComponent(e.Components[b]);else return null;return c&&!c.constructor.is_component?null:this._component=c}};C.prototype.getComponentProperties=function(a){var b=this.getComponent();if(!b)return null;var c=null,c=b.getProperties?b.getProperties(a):e.getObjectProperties(b);a=[];for(var d in c)a.push([d,c[d]]);return a};C.prototype.onGetInputs=
function(){return this.getComponentProperties("input")};C.prototype.onGetOutputs=function(){return this.getComponentProperties("output")};LiteGraph.registerNodeType("scene/component",C);window.LGraphComponent=C;C=function(){this.properties={mat_name:""};this.addInput("Light","Light");this.addOutput("Intensity","number");this.addOutput("Color","color")};C.title="Light";C.desc="Light from a scene";C.prototype.onExecute=function(){var a=this.graph.getScene();if(a){var b=this._node;this.properties.node_id&&
(b=a.getNode(this.properties.node_id));b||(b=this.graph._scenenode);a=null;b&&(a=b.getLight());b=this.findInputSlot("Light");-1!=b&&(a=this.getInputData(b));if(a){for(b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==d)switch(c.name){case "Intensity":a.intensity=d;break;case "Color":vec3.copy(a.color,d);break;case "Eye":vec3.copy(a.eye,d);break;case "Center":vec3.copy(a.center,d)}}for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Light":this.setOutputData(b,
a);break;case "Intensity":this.setOutputData(b,a.intensity);break;case "Color":this.setOutputData(b,a.color);break;case "Eye":this.setOutputData(b,a.eye);break;case "Center":this.setOutputData(b,a.center)}}}};C.prototype.onGetInputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};C.prototype.onGetOutputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LiteGraph.registerNodeType("scene/light",
C);window.LGraphLight=C;C=function(){this.addOutput("Value");this.properties={name:"myvar",value:0,type:"number",min:0,max:1}};C.title="Global";C.desc="Global var for the graph";C["@type"]={type:"enum",values:"number string node vec2 vec3 vec4 color texture".split(" ")};C.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)};C.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.name};LiteGraph.registerNodeType("scene/global",C);window.LGraphGlobal=
C;C=function(){this.addOutput("Color","Texture");this.addOutput("Depth","Texture");this.addOutput("Extra","Texture");this.addOutput("Camera","Camera");this.properties={}};C.title="Frame";C.desc="One frame rendered from the scene renderer";C.prototype.onExecute=function(){this.setOutputData(0,LGraphTexture.getTexture(this._color_texture));this.setOutputData(1,LGraphTexture.getTexture(this._depth_texture));this.setOutputData(2,LGraphTexture.getTexture(this._extra_texture));this.setOutputData(3,this._camera)};
C.prototype.onDrawBackground=function(a){if(!(this.flags.collapsed||20>=this.size[1])&&this._color_texture){if(this._last_preview_tex!=this._last_tex||!this._last_preview_tex)if(a.webgl&&this._canvas&&this._canvas.constructor===GL.Texture)this._canvas=this._last_tex;else{var b=LGraphTexture.getTexture(this._color_texture);if(!b)return;b=LGraphTexture.generateLowResTexturePreview(b);if(!b)return;this._last_preview_tex=this._last_tex;this._canvas=cloneCanvas(b)}if(this._canvas){a.save();if(!a.webgl){if(this._canvas.constructor===
GL.Texture){this._canvas=null;return}a.translate(0,this.size[1]);a.scale(1,-1)}a.drawImage(this._canvas,0,0,this.size[0],this.size[1]);a.restore()}}};LiteGraph.registerNodeType("scene/frame",C);window.LGraphFrame=C}e.NONE=0;e.LINEAR=1;e.TRIGONOMETRIC=2;e.BEZIER=3;e.SPLINE=4;Y.DEFAULT_SCENE_NAME="@scene";Y.prototype.createTake=function(a,b){var c=new Y.Take;c.name=a;c.duration=b||0;this.addTake(c);return c};Y.prototype.addTake=function(a){return this.takes[a.name]=a};Y.prototype.getTake=function(a){return this.takes[a]};
Y.prototype.addTrackToTake=function(a,b){var c=this.takes[a];c||(c=this.createTake(a));c.addTrack(b)};Y.prototype.configure=function(a){a.name&&(this.name=a.name);if(a.takes){this.takes={};for(var b in a.takes){var c=new e.Animation.Take(a.takes[b]);this.addTake(c);c.loadResources()}}};Y.prototype.serialize=function(){return e.cloneObject(this,null,!0)};Y.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=x.load(a,!0));var b=a["@json"],c;for(c in b.takes){var d=b.takes[c],f;for(f in d.tracks){var g=
d.tracks[f],h="@take_"+c+"_track_"+f;a[h]&&(g.data=a[h])}}return new e.Animation(b)};Y.prototype.toBinary=function(){var a={},b=[],c;for(c in this.takes){var d=this.takes[c],f;for(f in d.tracks){var g=d.tracks[f];g.packData();if(g.packed_data){var h=g.data,q="@take_"+c+"_track_"+f;a[q]=h;g.data=null;b.push(h)}}}a["@json"]=e.cloneObject(this,null,!0);b=x.create(a,"Animation");for(c in this.takes)for(f in d=this.takes[c],d.tracks)g=d.tracks[f],q="@take_"+c+"_track_"+f,a[q]&&(g.data=a[q]);return b};
e.Classes.Animation=e.Animation=Y;wa.prototype.configure=function(a){a.name&&(this.name=a.name);if(a.tracks){this.tracks=[];for(var b in a.tracks){var c=new e.Animation.Track(a.tracks[b]);this.addTrack(c)}}a.duration&&(this.duration=a.duration)};wa.prototype.serialize=function(){return e.cloneObject(this,null,!0)};wa.prototype.createTrack=function(a){if(!a)throw"Data missing when creating track";var b=this.getTrack(a.property);if(b)return b;b=new e.Animation.Track(a);this.addTrack(b);return b};wa.prototype.applyTracks=
function(a,b,c){for(var d=0;d<this.tracks.length;++d){var f=this.tracks[d];if(!1!==f.enabled&&f.data)if("events"==f.type){var g=f.getKeyframeByTime(a);if(!g||g[0]<b||g[0]>a)break;f=e.GlobalScene.getPropertyInfoFromPath(f._property_path);if(!f)break;f.node&&f.target&&f.target[g[1][0]]&&f.target[g[1][0]].call(f.target,g[1][1])}else g=f.getSample(a,!c),void 0!==g&&(f._target=e.GlobalScene.setPropertyValueFromPath(f._property_path,g))}};wa.prototype.addTrack=function(a){this.tracks.push(a)};wa.prototype.getTrack=
function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].property==a)return this.tracks[b];return null};wa.prototype.removeTrack=function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b]==a){this.tracks.splice(b,1);break}};wa.prototype.getPropertiesSample=function(a,b){b=b||[];for(var c=0;c<this.tracks.length;++c){var d=this.tracks[c],f=d.getSample(a);b.push([d.property,f])}return b};wa.prototype.actionPerSample=function(a,b,c){for(var d=0;d<this.tracks.length;++d){var f=this.tracks[d],
g=f.getSample(a,!0);c.disabled_tracks&&c.disabled_tracks[f.property]||b(f.property,g,c)}};wa.prototype.loadResources=function(){for(var a=0;a<this.tracks.length;++a){var b=this.tracks[a];if("texture"==b.type)for(var c=b.getNumberOfKeyframes(),d=0;d<c;++d){var f=b.getKeyframe(d);f&&f[1]&&":"!=f[1][0]&&e.ResourcesManager.load(f[1])}}};Y.Take=wa;O.FRAMERATE=30;Object.defineProperty(O.prototype,"property",{set:function(a){this._property=a.trim();this._property_path=this._property.split("/")},get:function(){return this._property},
enumerable:!0});O.prototype.configure=function(a){a.property||console.warn("Track with property name");void 0!==a.enabled&&(this.enabled=a.enabled);a.name&&(this.name=a.name);a.property&&(this.property=a.property);a.type&&(this.type=a.type);a.looped&&(this.looped=a.looped);this.interpolation=void 0!==a.interpolation?a.interpolation:e.LINEAR;a.data_table&&(this.data_table=a.data_table);a.value_size&&(this.value_size=a.value_size);a.data&&(this.data=a.data,this.packed_data=void 0===a.packed_data&&this.data.constructor!==
Array?!0:!!a.packed_data,a.data.constructor==Array&&this.packed_data&&(this.data=new Float32Array(a.data)));a.interpolation&&!this.value_size&&(a.interpolation=e.NONE)};O.prototype.serialize=function(){var a={enabled:this.enabled,name:this.name,property:this.property,type:this.type,interpolation:this.interpolation,looped:this.looped,value_size:this.value_size,packed_data:this.packed_data,data_table:this.data_table};this.data&&(1>=this.value_size?a.data=this.data.concat():(this.packData(),a.data=new Float32Array(this.data),
a.packed_data=this.packed_data));return a};O.prototype.toJSON=O.prototype.serialize;O.prototype.clear=function(){this.data=[];this.packed_data=!1};O.prototype.addKeyframe=function(a,b,c){1<this.value_size&&(b=new Float32Array(b));this.packed_data&&this.unpackData();this.data||(this.data=[]);for(var d=0;d<this.data.length;++d)if(!(this.data[d][0]<a))return this.data[d][0]!=a||c?this.data.splice(d,0,[a,b]):this.data[d][1]=b,d;this.data.push([a,b]);return this.data.length-1};O.prototype.getKeyframe=
function(a){return 0>a||a>=this.data.length?(console.warn("keyframe index out of bounds"),null):this.packed_data?(a*=1+this.value_size,a>this.data.length-this.value_size?null:[this.data[a],this.data.subarray(a+1,a+this.value_size+1)]):this.data[a]};O.prototype.getKeyframeByTime=function(a){a=this.findTimeIndex(a);if(-1!=a)return this.getKeyframe(a)};O.prototype.moveKeyframe=function(a,b){if(this.packed_data)return console.warn("Cannot move keyframes if packed"),-1;if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),
-1;var c=this.findTimeIndex(b),d=this.data[a],f=d[0];if(f==b)return a;d[0]=b;f>b&&(c+=1);if(a==c)return a;this.data.splice(a,1);a=this.addKeyframe(d[0],d[1],!0);this.sortKeyframes();return a};O.prototype.sortKeyframes=function(){this.packed_data&&(this.unpackData(),this.sortKeyframes(),this.packData());this.data.sort(function(a,b){return a[0]-b[0]})};O.prototype.removeKeyframe=function(a){this.packed_data&&this.unpackData();0>a||a>=this.data.length?console.warn("keyframe index out of bounds"):this.data.splice(a,
1)};O.prototype.getNumberOfKeyframes=function(){return this.data&&0!=this.data.length?this.packed_data?this.data.length/(1+this.value_size):this.data.length:0};O.prototype.computeDuration=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){var a=this.data[this.data.length-2-this.value_size];return this.duration=a}return(a=this.data[this.data.length-1])?a[0]:0};O.prototype.isInterpolable=function(){return 0<this.value_size||e.Interpolators[this.type]?!0:!1};O.prototype.packData=
function(){if(!this.data||0==this.data.length)return 0;if(!this.packed_data&&0!=this.value_size){for(var a=this.value_size+1,b=this.data,c=new Float32Array(b.length*a),d=0;d<b.length;++d)c[d*a]=b[d][0],1==this.value_size?c[d*a+1]=b[d][1]:c.set(b[d][1],d*a+1);this.data=c;this.packed_data=!0}};O.prototype.unpackData=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){for(var a=this.value_size+1,b=this.data,c=Array(b.length/a),d=0;d<b.length;d+=a)c[d/a]=[b[d],b.subarray(d+1,d+
a)];this.data=c;this.packed_data=!1}};O.prototype.findTimeIndex=function(a){if(!this.data||0==this.data.length)return-1;var b=this.data,c=this.data.length;if(!c)return-1;var d=0;if(this.packed_data){for(var f=this.value_size+1,g=-1,d=0;d<c;d+=f)if(b[d]<a)g=d;else break;return-1==g?-1:g/f}g=-1;for(d=0;d<c;++d)if(a>b[d][0])g=d;else{if(a==b[d][0])return d;break}return-1==g?-1:g};O.prototype.getSample=function(a,b,c){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,b,c):
this.getSampleUnpacked(a,b,c):void 0};O.prototype.getSampleUnpacked=function(a,b,c){a=Math.clamp(a,0,this.duration);var d=this.findTimeIndex(a);-1===d&&(d=0);var f=d,g=d+1,h=this.data;b=b&&this.interpolation&&(0<this.value_size||e.Interpolators[this.type]);if(!b||1==h.length||g==h.length||0==f&&this.data[0][0]>a)return this.data[d][1];b=h[f];g=h[g];a=(g[0]-a)/(g[0]-b[0]);if(this.interpolation===e.LINEAR){if(0===this.value_size&&e.Interpolators[this.type])return c=e.Interpolators[this.type],this._last_value=
c=c(b[1],g[1],a,this._last_value);if(1==this.value_size)return b[1]*a+g[1]*(1-a);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));for(d=0;d<this.value_size;d++)c[d]=b[1][d]*a+g[1][d]*(1-a);"quat"==this.type&&quat.normalize(c,c);return c}if(this.interpolation===e.BEZIER){if(0===this.value_size&&e.Interpolators[this.type])return c=e.Interpolators[this.type],this._last_value=c=c(b[1],g[1],a,this._last_value);f=0<d?h[d-1]:b;d=d<h.length-2?h[d+2]:g;if(1===
this.value_size)return Y.EvaluateHermiteSpline(b[1],g[1],f[1],d[1],1-a);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));c=c||this._result;c=Y.EvaluateHermiteSplineVector(b[1],g[1],f[1],d[1],1-a,c);"quat"==this.type&&quat.normalize(c,c);return c}return null};O.prototype.getSamplePacked=function(a,b,c){a=Math.clamp(a,0,this.duration);var d=this.findTimeIndex(a);-1==d&&(d=0);var f=this.value_size+1,g=d,h=d+1,q=this.data,s=q.length/f;b=b&&this.interpolation&&
(0<this.value_size||e.Interpolators[this.type]);if(!b||1==s||h==s||0==g&&this.data[0]>a)return this.getKeyframe(d)[1];b=q.subarray(g*f,(g+1)*f);g=q.subarray(h*f,(h+1)*f);a=(g[0]-a)/(g[0]-b[0]);if(this.interpolation===e.LINEAR){if(1==this.value_size)return b[1]*a+g[1]*(1-a);if(e.Interpolators[this.type])return this._last_v=c=(0,e.Interpolators[this.type])(b[1],g[1],a,this._last_v);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));for(f=0;f<this.value_size;f++)c[f]=
b[1+f]*a+g[1+f]*(1-a);"quat"==this.type&&quat.normalize(c,c);return c}if(this.interpolation===e.BEZIER){if(0===this.value_size)return b[1];d=0<d?q.subarray((d-1)*f,d*f):b;h=h<s-1?q.subarray((h+1)*f,(h+2)*f):g;if(1===this.value_size)return Y.EvaluateHermiteSpline(b[1],g[1],d[1],h[1],1-a);c=c||this._result;c&&c.length==this.value_size||(c=this._result=new Float32Array(this.value_size));c=c||this._result;c=Y.EvaluateHermiteSplineVector(b.subarray(1,f),g.subarray(1,f),d.subarray(1,f),h.subarray(1,f),
1-a,c);"quat"==this.type&&quat.normalize(c,c);return c}return null};O.prototype.getPropertyInfo=function(){return e.GlobalScene.getPropertyInfo(this.property)};O.prototype.getSampledData=function(a,b,c){b=(b-a)/c;if(0>=b)return null;for(var d=[],f=0;f<c;++f){var g=this.getSample(f*b+a,!0);1<this.value_size&&(g=new g.constructor(g));d.push(g)}return d};Y.Track=O;Y.EvaluateHermiteSpline=function(a,b,c,d,f){var g=f*f,h=g*f;return(2*h-3*g+1)*a+(-2*h+3*g)*b+(h-2*g+f)*(b-c)+(h-g)*(d-a)};Y.EvaluateHermiteSplineVector=
function(a,b,c,d,f,g){g=g||new Float32Array(g.length);var h=f*f,e=h*f,s=2*e-3*h+1,k=-2*e+3*h;f=e-2*h+f;h=e-h;for(e=0;e<g.length;++e)g[e]=s*a[e]+k*b[e]+f*(b[e]-c[e])+h*(d[e]-a[e]);return g};e.Interpolators={};e.Interpolators.texture=function(a,b,c,d){var f=a?e.getTexture(a):null,g=b?e.getTexture(b):null;a&&!f&&":"!=a[0]&&e.ResourcesManager.load(a);b&&!g&&":"!=b[0]&&e.ResourcesManager.load(b);a=f||g;(b=gl.textures[":black"])||(b=gl.textures[":black"]=new GL.Texture(1,1,{format:gl.RGB,pixel_data:[0,
0,0],filter:gl.NEAREST}));if(!a)return b;var h=a?a.width:256,q=a?a.height:256;f||(f=b);g||(g=b);d&&d.width==h&&d.height==q&&d.format==a.format||(d=new GL.Texture(h,q,{format:a.format,type:a.type,filter:gl.LINEAR}));var s=gl.shaders[":interpolate_texture"];s||(s=gl.shaders[":interpolate_texture"]=GL.Shader.createFX("color = mix( texture2D( u_texture_b, uv ), color , u_factor );","uniform sampler2D u_texture_b; uniform float u_factor;"));gl.disable(gl.DEPTH_TEST);d.drawTo(function(){gl.clearColor(0,
0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);g.bind(1);f.toViewport(s,{u_texture_b:1,u_factor:c})});return d};ia.LINE=1;ia.SPLINE=2;ia.BEZIER=3;ia.prototype.addPoint=function(a){var b=vec3.create();b[0]=a[0];b[1]=a[1];2<a.length&&(b[2]=a[2]);this.points.push(b)};ia.prototype.getSegments=function(){var a=this.points.length;switch(this.type){case ia.LINE:if(2>a)break;return a-1;case ia.SPLINE:if(3>a)break;return(a-1)/3|0}return 0};ia.prototype.computePoint=function(a,b){switch(this.type){case ia.LINE:return this.getLinearPoint(a,
b);default:return this.getSplinePoint(a,b)}};ia.prototype.getLinearPoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(2>c)return b;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[c-1]);var c=(c-1)*a,d=c|0;return vec3.lerp(b,this.points[d],this.points[d+1],c-d)};ia.prototype.getSplinePoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(4>c)return b;c=3*((c-1)/3|0)+1;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,
this.points[c-1]);var c=(c-1)/3*a,d=c|0,f=c-d,c=this.points[d],g=this.points[d+1],h=this.points[d+2],d=this.points[d+3],e=(1-f)*(1-f)*(1-f),s=3*f*(1-f)*(1-f),k=3*f*f*(1-f),f=f*f*f;b[0]=c[0]*e+g[0]*s+h[0]*k+d[0]*f;b[1]=c[1]*e+g[1]*s+h[1]*k+d[1]*f;b[2]=c[2]*e+g[2]*s+h[2]*k+d[2]*f;return b};ia.prototype.samplePoints=function(a){0>=a&&(a=this.getSegments(),a=this.type==e.Path.LINE?a+1:20*a);for(var b=Array(a),c=0;c<a;c++)b[c]=this.computePoint(c/(a-1));return b};ia.prototype.serialize=function(){for(var a=
{},b=Array(3*this.points.length),c=0;c<this.points.length;c++){var d=this.points[c];b[3*c]=d[0];b[3*c+1]=d[1];b[3*c+2]=d[2]}a.points=b;a.type=this.type;a.closed=this.closed;return a};ia.prototype.configure=function(a){this.type=a.type;this.closed=a.closed;if(a.points){this.points.length=a.points.length/3;a=a.points;for(var b=0;b<this.points.length;b++)this.points[b]=vec3.fromValues(a[3*b],a[3*b+1],a[3*b+2])}};e.Path=ia;Aa.version="0.1";Aa.prototype.configure=function(a){var b=a["@resources_name"],
c=a["@version"];this.prefab_json=a["@json"];if(b){var d={},f;for(f in b)d[b[f]]=c?a["@RES_"+f]:a[b[f]];this.resources=d}this.processResources()};Aa.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=x.load(a,!0));return new e.Prefab(a)};Aa.prototype.processResources=function(){if(this.resources){var a=this.resources,b;for(b in a)e.ResourcesManager.resources[b]||(e.ResourcesManager.resources_being_processed[b]=!0);for(b in a)if(!e.ResourcesManager.resources[b]){var c=a[b];c?e.ResourcesManager.processResource(b,
c):console.warn("resource data in prefab is undefined, skipping it:"+b)}}};Aa.prototype.createObject=function(){if(!this.prefab_json)return null;var a=JSON.parse(this.prefab_json),b=new e.SceneNode;b.configure(a);ba.loadResources(b.getResources({},!0));this.fullpath&&(b.prefab=this.fullpath);return b};Aa.createPrefab=function(a,b,c){if(a){a=a.replace(/ /gi,"_");c=c||{};b.id=null;b.object_type="SceneNode";var d=new e.Prefab;d.filename=a+".wbin";d.resources=c;d.prefab_json=JSON.stringify(b);a=Aa.packResources(c,
{"@json":d.prefab_json,"@version":Aa.version});d._original_data=a;return d}};Aa.packResources=function(a,b){var c=b||{},d=[],f;for(f in a){var g=a[f],h=e.ResourcesManager.resources[g];if(h){var q=null;(q=h._original_data?h._original_data:e.ResourcesManager.computeResourceInternalData(h).data)?(c["@RES_"+d.length]=q,d.push(g)):console.warning("Wrong data in resource")}}c["@resources_name"]=d;return x.create(c,"Prefab")};e.Classes.Prefab=e.Prefab=Aa;e.RenderSettings=cb;var Ca=1,Va=2,Ja=4,Qa=8,Na=32,
Pa=256,Ua=512,Za=1024,na=2048,db=8192,ab=16384,$a=65536,eb=131072,sa=Ca|Ja|Qa|Pa|Ua,fb=4096|Ca|Na|Za|na;W.prototype.setMatrix=function(a,b){this.matrix.set(a);b?this.normal_matrix.set(b):this.computeNormalMatrix()};W.prototype.computeNormalMatrix=function(){var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)};W.prototype.setMaterial=function(a){(this.material=a)&&a.applyToRenderInstance(this)};W.prototype.setMesh=function(a,b){if(-1==b||void 0===b)b=gl.TRIANGLES;
this.mesh=a;this.primitive=b;this.vertex_buffers=a.vertexBuffers;switch(b){case gl.TRIANGLES:this.index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.index_buffer=a.indexBuffers.lines;break;case 10:this.primitive=gl.LINES;a.indexBuffers.wireframe||a.computeWireframe();this.index_buffer=a.indexBuffers.wireframe;break;default:this.index_buffer=null}a.bounding?(this.oobb.set(a.bounding),this.flags&=~na):this.flags|=na};W.prototype.setLODMesh=function(a){if(a)switch(this.lod_mesh=a,this.lod_vertex_buffers=
a.vertexBuffers,this.primitive){case gl.TRIANGLES:this.lod_index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.lod_index_buffer=a.indexBuffers.lines;break;case 10:a.indexBuffers.wireframe||a.computeWireframe();this.lod_index_buffer=a.indexBuffers.wireframe;break;default:this.lod_index_buffer=null}else this.lod_index_buffer=this.lod_vertex_buffers=this.lod_mesh=null};W.prototype.setRange=function(a,b){this.range[0]=a;this.range[1]=b};W.prototype.applyNodeFlags=function(){var a=this.node.flags;
this.layers=this.node.layers;this.flags=!0==a.two_sided?this.flags&~Ca:this.flags|Ca;this.flags=!0==a.flip_normals?this.flags|Va:this.flags&~Va;this.flags=!1==a.depth_test?this.flags&~Ja:this.flags|Ja;this.flags=!1==a.depth_write?this.flags&~Qa:this.flags|Qa;this.flags=!0==a.alpha_test?this.flags|16:this.flags&-17;this.flags=!1==a.cast_shadows?this.flags&~Pa:this.flags|Pa;this.flags=!1==a.receive_shadows?this.flags&~Ua:this.flags|Ua};W.prototype.enableFlag=function(a){this.flags|=a};W.prototype.disableFlag=
function(a){this.flags&=~a};W.prototype.isFlag=function(a){return this.flags&a};W.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};W.prototype.update=function(){this.node&&this.node.transform&&this.setMatrix(this.node.transform._global_matrix)};W.prototype.render=function(a){this.lod_mesh&&0.1>this.oobb[12]/Math.max(0.1,this._dist)?a.drawBuffers(this.lod_vertex_buffers,this.lod_index_buffer,this.primitive):a.drawBuffers(this.vertex_buffers,this.index_buffer,this.primitive,
this.range[0],this.range[1])};W.prototype.overlapsSphere=function(a,b){return this.flags&na?!0:geo.testSphereBBox(a,b,this.aabb)};e.RenderInstance=W;pa.default_width=1024;pa.default_height=512;pa.prototype.useDefaultSize=function(){this.width=e.RenderFrameContainer.default_width;this.height=e.RenderFrameContainer.default_height};pa.prototype.useCanvasSize=function(){this.width=gl.canvas.width;this.height=gl.canvas.height};pa.prototype.setSize=function(a,b){1>a&&(a=1);1>b&&(b=1);this.width=a;this.height=
b};pa.prototype.preRender=function(a){a=e.Renderer._current_camera;this.startFBO();this.depth_texture&&a&&(this.depth_texture.near_far_planes||(this.depth_texture.near_far_planes=vec2.create()),this.depth_texture.near_far_planes[0]=a.near,this.depth_texture.near_far_planes[1]=a.far)};pa.prototype.postRender=function(a){this.endFBO()};pa.prototype.startFBO=function(){var a=gl.RGBA,b=this.use_high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,c=this.width,d=this.height;this.color_texture&&this.color_texture.width==
c&&this.color_texture.height==d&&this.color_texture.type==b||(this.color_texture=new GL.Texture(c,d,{filter:gl.LINEAR,format:a,type:b}));!this.use_extra_texture||this.extra_texture&&this.extra_texture.width==c&&this.extra_texture.height==d&&this.extra_texture.type==b?this.use_extra_texture||(this.extra_texture=null):this.extra_texture=new GL.Texture(c,d,{filter:gl.LINEAR,format:a,type:b});!this.use_depth_texture||this.depth_texture&&this.depth_texture.width==c&&this.depth_texture.height==d?this.use_depth_texture||
(this.depth_texture=null):this.depth_texture=new GL.Texture(c,d,{filter:gl.NEAREST,format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT});this._fbo||(this._fbo=new GL.FBO);this._fbo.setTextures([this.color_texture],this.depth_texture,!0);this._fbo.bind();e.Renderer._full_viewport.set(gl.viewport_data);this._old_aspect=e.Renderer.global_aspect};pa.prototype.endFBO=function(){this._fbo.unbind();e.Renderer._full_viewport.set(this._fbo._old_viewport);e.Renderer.global_aspect=this._old_aspect};pa.prototype.renderToViewport=
function(a,b){if(b){var c=GL.Shader.getFXAAShader(),d=gl.getViewport(),f=Mesh.getScreenQuad();a.bind(0);c.uniforms({u_texture:0,uViewportSize:d.subarray(2,4),inverseVP:[1/tex.width,1/tex.height]}).draw(f)}else a.toViewport()};e.RenderFrameContainer=pa;var Oa={default_render_settings:new e.RenderSettings,default_material:new N,global_aspect:1,default_point_size:1,_global_viewport:vec4.create(),_full_viewport:vec4.create(),_current_scene:null,_current_render_settings:null,_current_camera:null,_current_target:null,
_visible_cameras:null,_visible_lights:null,_visible_instances:null,_rendercalls:0,_rendered_instances:0,_frame:0,_collect_frequency:1,_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),_2Dviewprojection_matrix:mat4.create(),_mvp_matrix:mat4.create(),_temp_matrix:mat4.create(),_identity_matrix:mat4.create(),init:function(){this._missing_texture=new GL.Texture(1,1,{pixel_data:[128,128,128,255]});e.Draw.init();e.Draw.onRequestFrame=function(){e.GlobalScene.refresh()}},
reset:function(){},setFullViewport:function(a,b,c,d){a.constructor===Number?(this._full_viewport[0]=a,this._full_viewport[1]=b,this._full_viewport[2]=c,this._full_viewport[3]=d):a.length&&this._full_viewport.set(a)},render:function(a,b,c){e.ShadersManager.ready&&(b=b||this.default_render_settings,b.current_renderer=this,b.current_scene=a,this._current_render_settings=b,this._current_scene=a,this._main_camera=c?c[0]:null,b.main_camera=this._main_camera,a._frame+=1,this._frame+=1,a._must_redraw=!1,
this._rendered_instances=this._rendercalls=0,b.keep_viewport?this.setFullViewport(gl.viewport_data):(gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),this.setFullViewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight)),this._global_viewport.set(gl.viewport_data),LEvent.trigger(a,"beforeRender",b),a.triggerInNodes("beforeRender",b),this.processVisibleData(a,b),this._visible_cameras=c=c||this._visible_cameras,b.main_camera=c[0],LEvent.trigger(a,"renderShadows",b),a.triggerInNodes("renderShadows",
b),a.triggerInNodes("afterVisibility",b),LEvent.trigger(a,"renderReflections",b),a.triggerInNodes("renderReflections",b),LEvent.trigger(a,"beforeRenderMainPass",b),a.triggerInNodes("beforeRenderMainPass",b),b.render_fx&&LEvent.trigger(a,"enableFrameBuffer",b),this.renderFrameCameras(c,b),b.keep_viewport&&gl.setViewport(this._global_viewport),b.render_fx&&LEvent.trigger(a,"showFrameBuffer",b),LEvent.trigger(a,"renderGUI",b),LEvent.trigger(a,"afterRender",b),a.triggerInNodes("afterRender",b))},renderFrameCameras:function(a,
b,c){c=this._current_scene;for(var d=0;d<a.length;++d){var f=a[d];LEvent.trigger(c,"beforeRenderFrame",b);LEvent.trigger(f,"beforeRenderFrame",b);LEvent.trigger(f,"enableFrameBuffer",b);this.renderFrame(f,b);LEvent.trigger(f,"showFrameBuffer",b);LEvent.trigger(f,"afterRenderFrame",b);LEvent.trigger(c,"afterRenderFrame",b)}},renderFrame:function(a,b,c){c&&this.processVisibleData(c,b);c=c||this._current_scene;this.enableCamera(a,b,b.skip_viewport);gl.scissor(gl.viewport_data[0],gl.viewport_data[1],
gl.viewport_data[2],gl.viewport_data[3]);gl.enable(gl.SCISSOR_TEST);var d=c.info;d?gl.clearColor(d.background_color[0],d.background_color[1],d.background_color[2],d.background_color[3]):gl.clearColor(0,0,0,0);!0!=b.ignore_clear&&(a.clear_color||a.clear_depth)&&gl.clear((a.clear_color?gl.COLOR_BUFFER_BIT:0)|(a.clear_depth?gl.DEPTH_BUFFER_BIT:0));gl.disable(gl.SCISSOR_TEST);b.current_pass="color";LEvent.trigger(c,"beforeRenderScene",a);c.triggerInNodes("beforeRenderScene",a);LEvent.trigger(this,"beforeRenderScene",
a);this.renderInstances(b);LEvent.trigger(c,"afterRenderScene",a);c.triggerInNodes("afterRenderScene",a);LEvent.trigger(this,"afterRenderScene",a)},enableCamera:function(a,b,c){var d=this._current_scene;LEvent.trigger(a,"beforeEnabled",b);LEvent.trigger(d,"beforeCameraEnabled",a);var f=this._full_viewport[2],g=this._full_viewport[3],h=Math.floor(f*a._viewport[0]+this._full_viewport[0]),e=Math.floor(g*a._viewport[1]+this._full_viewport[1]),s=Math.ceil(f*a._viewport[2]),k=Math.ceil(g*a._viewport[3]);
c||(b&&b.ignore_viewports?(a._final_aspect=f/g*a._aspect*this.global_aspect,gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3])):(a._final_aspect=s/k*a._aspect*this.global_aspect,gl.viewport(h,e,s,k)));a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);mat4.ortho(this._2Dviewprojection_matrix,-1,1,-1,1,1,-1);this._current_camera=
a;b&&(b.current_camera=a);a.fillCameraShaderUniforms(d);ta.reset();ta.setCameraPosition(a.getEye());ta.setViewProjectionMatrix(this._view_matrix,this._projection_matrix,this._viewprojection_matrix);LEvent.trigger(a,"afterEnabled",b);LEvent.trigger(d,"afterCameraEnabled",a)},renderInstances:function(a,b){var c=this._current_scene;if(!c)return console.warn("Renderer.renderInstances: no scene found");var d=this._current_camera,f=geo.extractPlanes(this._viewprojection_matrix,this.frustum_planes);this.frustum_planes=
f;var g=a.frustum_culling,h=d.layers;void 0!==a.layers&&(h=a.layers);var q=!a.is_shadowmap&&!a.is_picking;LEvent.trigger(c,"beforeRenderInstances",a);c.triggerInNodes("beforeRenderInstances",a);this.fillSceneShaderQuery(c,a);this.fillSceneShaderUniforms(c,a);if(q&&c.info.textures.background){var s=c.info.textures.background;s&&(s.constructor===String&&(s=e.ResourcesManager.textures[c.info.textures.background]),s&&s.constructor===GL.Texture&&(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),s.toViewport()))}this.resetGLState();
var s=this._visible_lights,k=s.length,l=b||this._visible_instances;LEvent.trigger(c,"renderInstances",a);this.resetGLState();for(var r=0,n=l.length;r<n;++r){var p=l[r],z=p.node.flags;p._in_camera=!1;a.is_rt&&!1==z.seen_by_reflections||a.is_shadowmap&&!(p.flags&Pa)||!1==z.seen_by_camera&&q&&!a.is_reflection||!1==z.seen_by_picking&&a.is_picking||!1==z.selectable&&a.is_picking||0===(h&p.layers)||p.onPreRender&&!1===p.onPreRender(a)||0>=p.material.opacity||g&&!(p.flags&na)&&geo.frustumTestBox(f,p.aabb)==
CLIP_OUTSIDE||(p._in_camera=!0)}f=[];r=0;for(n=l.length;r<n;++r)if(p=l[r],p._in_camera){if(p.flags&4096)this.render2DInstance(p,c,a);else if(this._rendered_instances+=1,a.is_shadowmap)this.renderShadowPassInstance(p,a);else if(a.is_picking)this.renderPickingInstance(p,a);else{if(q)for(g=f.length=0;g<k;g++)if(h=s[g],0!=(h._root.layers&p.layers)&&0!=(h._root.layers&d.layers)&&!(1E-4>h.computeLightIntensity())){var z=h.computeLightRadius(),m=h.position;(-1==z||p.overlapsSphere(m,z))&&f.push(h)}this.renderColorPassInstance(p,
f,c,a)}if(p.onPostRender)p.onPostRender(a)}LEvent.trigger(c,"renderScreenSpace",a);q&&c.info.textures.foreground&&(s=c.info.textures.foreground)&&(s.constructor===String&&(s=e.ResourcesManager.textures[c.info.textures.foreground]),s&&s.constructor===GL.Texture&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.disable(gl.DEPTH_TEST),s.toViewport(),gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)));this.resetGLState();LEvent.trigger(c,"afterRenderInstances",a);c.triggerInNodes("afterRenderInstances",
a);this.resetGLState()},resetGLState:function(){gl.enable(gl.CULL_FACE);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.depthFunc(gl.LESS);gl.depthMask(!0);gl.frontFace(gl.CCW);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)},bindSamplers:function(a,b){var c={},d=0,f;for(f in a){var g=a[f];if(!g)throw"Samplers should always be valid values";var h=null;if(g.constructor===String||g.constructor===Texture)h=g,g=null;else if(g.texture)h=g.texture;else continue;h.constructor===String&&(h=e.ResourcesManager.textures[h]);
h||(h=this._missing_texture);c[f]=h.bind(d++);g&&(g.minFilter&&gl.texParameteri(h.texture_type,gl.TEXTURE_MIN_FILTER,g.minFilter),g.magFilter&&gl.texParameteri(h.texture_type,gl.TEXTURE_MAG_FILTER,g.magFilter),g.wrap&&(gl.texParameteri(h.texture_type,gl.TEXTURE_WRAP_S,g.wrap),gl.texParameteri(h.texture_type,gl.TEXTURE_WRAP_T,g.wrap)))}return c},renderColorPassInstance:function(a,b,c,d){var f=this._current_camera,g=a.node,h=a.material,q=a.matrix;a.flags&db?this._mvp_matrix.set(q):mat4.multiply(this._mvp_matrix,
this._viewprojection_matrix,q);var s=a._final_query,k=a._final_uniforms,l=a._final_samplers;k.u_model=q;k.u_normal_model=a.normal_matrix;k.u_mvp=this._mvp_matrix;this.enableInstanceFlags(a,d);h.blend_mode!==Ea.NORMAL?(gl.enable(gl.BLEND),gl.blendFunc(a.blend_func[0],a.blend_func[1])):gl.disable(gl.BLEND);q={};q.merge(c._samplers);q.merge(l);l=this.bindSamplers(q);q=d.default_shader_id;d.low_quality&&(q=d.default_low_shader_id);h.shader_name&&(q=h.shader_name);var r=b.length,n=g.flags.ignore_lights||
a.flags&Za||d.lights_disabled;if(!r||n){var p=new e.ShaderQuery(q,{FIRST_PASS:"",LAST_PASS:"",USE_AMBIENT_ONLY:""});p.add(c._query);p.add(s);n&&p.setMacro("USE_IGNORE_LIGHTS");!d.clipping_plane||a.flags&ab||p.setMacro("USE_CLIPPING_PLANE");if(h.onModifyQuery)h.onModifyQuery(p);p=Ma.resolve(p);p.uniformsArray([l,c._uniforms,f._uniforms,k]);a.render(p);this._rendercalls+=1}else for(n=0;n<r;n++){var z=b[n],p=new e.ShaderQuery(q),m=z.getQuery(a,d);0===n&&p.setMacro("FIRST_PASS");n===r-1&&p.setMacro("LAST_PASS");
p.add(c._query);p.add(s);p.add(m);!d.clipping_plane||a.flags&ab||p.setMacro("USE_CLIPPING_PLANE");if(h.onModifyQuery)h.onModifyQuery(p);p=e.ShadersManager.resolve(p);z=z.getUniforms(a,d);0<n&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthFunc(gl.LEQUAL),g.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));h.depth_func&&gl.depthFunc(gl[h.depth_func]);p.uniformsArray([l,c._uniforms,f._uniforms,k,z]);a.render(p);this._rendercalls+=1;if(p.global&&!p.global.multipass)break}},
renderShadowPassInstance:function(a,b){var c=this._current_scene,d=this._current_camera,f=a.node,g=a.material,h=a.matrix;mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,h);var e=a._final_query,s=a._final_uniforms,k=a._final_samplers;s.u_model=h;s.u_normal_model=a.normal_matrix;s.u_mvp=this._mvp_matrix;this.enableInstanceFlags(a,b);h=new ya("depth");h.add(c._query);h.add(e);if(!0==f.flags.alpha_shadows){h.setMacro("USE_ALPHA_TEST","0.5");if(e=g.getTexture("color"))h.setMacro("USE_COLOR_TEXTURE",
"uvs_"+(g.textures.color_uvs||m.DEFAULT_UVS.color||"0")),e.bind(0);if(e=g.getTexture("opacity"))h.setMacro("USE_OPACITY_TEXTURE","uvs_"+(g.textures.opacity_uvs||m.DEFAULT_UVS.opacity||"0")),e.bind(1)}!0==f.flags.alpha_shadows&&h.setMacro("USE_ALPHA_TEST","0.5");f=Ma.resolve(h);g={};g.merge(c._samplers);g.merge(k);k=this.bindSamplers(g,f);f.uniformsArray([k,c._uniforms,d._uniforms,a._final_uniforms]);a.render(f);this._rendercalls+=1},render2DInstance:function(a,b,c){var d=a.node,f=a.material,g=this._temp_matrix;
mat4.identity(g);var h=vec3.create();if(a.pos2D)h.set(a.pos2D);else{mat4.projectVec3(h,this._viewprojection_matrix,a.center);if(0>h[2])return;h[2]=0}mat4.translate(g,g,h);h=vec3.fromValues(1,gl.canvas.clientWidth/gl.canvas.clientHeight,1);a.scale_2D&&(h[0]*=a.scale_2D[0],h[1]*=a.scale_2D[1]);mat4.scale(g,g,h);mat4.multiply(this._mvp_matrix,this._2Dviewprojection_matrix,g);d=d._uniforms;d.u_mvp=this._mvp_matrix;d.u_model=g;d.u_normal_model=this._identity_matrix;this.enableInstanceFlags(a,c);f.blend_mode!=
Ea.NORMAL?(gl.enable(gl.BLEND),gl.blendFunc(a.blend_func[0],a.blend_func[1])):(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE));c=Ma.get("flat_texture");g={};g.merge(b._samplers);g.merge(a._final_samplers);b=this.bindSamplers(g,c);c.uniformsArray([b,d,f._uniforms,a.uniforms]);a.render(c);this._rendercalls+=1},renderPickingInstance:function(a,b){var c=this._current_scene,d=this._current_camera,f=a.node,g=a.matrix;mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,g);var f=e.Picking.getNextPickingColor(f),
h=new e.ShaderQuery("flat");h.add(c._query);h.add(a._final_query);h=Ma.resolve(h);h.uniforms(c._uniforms);h.uniforms(d._uniforms);h.uniforms(a.uniforms);h.uniforms({u_model:g,u_mvp:this._mvp_matrix,u_material_color:f});a.render(h)},fillSceneShaderQuery:function(a,b){var c=new ya;b.current_camera.type==w.ORTHOGRAPHIC&&c.setMacro("USE_ORTHOGRAPHIC_CAMERA");"color"==b.current_pass&&(a.info&&a.info.linear_pipeline&&c.setMacro("USE_LINEAR_PIPELINE"),b.brightness_factor&&1!=b.brightness_factor&&c.setMacro("USE_BRIGHTNESS_FACTOR"),
b.colorclip_factor&&c.setMacro("USE_COLORCLIP_FACTOR"));b.current_renderframe&&b.current_renderframe.use_extra_texture&&c.setMacro("USE_DRAW_BUFFERS");LEvent.trigger(a,"fillSceneQuery",c);a._query=c},fillSceneShaderUniforms:function(a,b){var c={u_point_size:this.default_point_size,u_time:a._time||0.001*getTime(),u_brightness_factor:null!=b.brightness_factor?b.brightness_factor:1,u_colorclip_factor:null!=b.colorclip_factor?b.colorclip_factor:0,u_ambient_light:a.info.ambient_color,u_background_color:a.info.background_color.subarray(0,
3),u_viewport:gl.viewport_data};b.clipping_plane&&(c.u_clipping_plane=b.clipping_plane);"color"==b.current_pass&&a.info&&a.info.linear_pipeline&&(c.u_gamma=2.2);a._uniforms=c;a._samplers={};for(var d in a.info.textures)if((c=e.getTexture(a.info.textures[d]))&&("environment"==d||"irradiance"==d)){var f=c.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap";c.texture_type==gl.TEXTURE_2D&&(c.bind(0),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));a._samplers[d+f]=c;a._query.macros["USE_"+(d+f).toUpperCase()]=
"uvs_polar_reflected"}LEvent.trigger(a,"fillSceneUniforms",a._uniforms)},enableInstanceFlags:function(a,b){var c=a.flags;c&Ca?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);c&Ja?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);c&Qa?gl.depthMask(!0):gl.depthMask(!1);var d=gl.CCW;c&Va&&(d=gl.CW);b.reverse_backfacing&&(d=d==gl.CW?gl.CCW:gl.CW);gl.frontFace(d)},processVisibleData:function(a,b){0==this._frame%this._collect_frequency?a.collectData():a.updateCollectedData();LEvent.trigger(a,
"afterCollectData",a);b.main_camera||(b.main_camera=a._cameras.length?a._cameras[0]:new e.Camera);for(var c=[],d=[],f={},g=a._instances,h=b.main_camera.getEye(),q=0,s=g.length;q<s;++q){var k=g[q];if(k){k.material||(k.material=this.default_material);f[k.material.uid]=k.material;k._dist=vec3.dist(k.center,h);b.force_wireframe&&k.primitive!=gl.LINES&&(k.primitive=gl.LINES,k.mesh&&(k.mesh.indexBuffers.wireframe||k.mesh.computeWireframe(),k.index_buffer=k.mesh.indexBuffers.wireframe));k.flags&Na?d.push(k):
c.push(k);var l=k.query;k.flags&16?l.macros.USE_ALPHA_TEST="0.5":l.macros.USE_ALPHA_TEST&&delete l.macros.USE_ALPHA_TEST;k=k.vertex_buffers;"normals"in k||(l.macros.NO_NORMALS="");"coords"in k||(l.macros.NO_COORDS="");"coords1"in k&&(l.macros.USE_COORDS1_STREAM="");"colors"in k&&(l.macros.USE_COLOR_STREAM="");"tangents"in k&&(l.macros.USE_TANGENT_STREAM="")}}b.sort_instances_by_distance&&(c.sort(this._sort_near_to_far_func),d.sort(this._sort_far_to_near_func));h=c.concat(d);b.sort_instances_by_priority&&
h.sort(this._sort_by_priority_func);b.update_materials&&this._prepareMaterials(f,a);q=0;for(s=g.length;q<s;++q){var k=g[q],r=k.node,n=k.material,l=k._final_query;l.clear();l.add(r._query);l.add(n._query);l.add(k.query);l=k._final_uniforms;wipeObject(l);l.merge(r._uniforms);l.merge(n._uniforms);l.merge(k.uniforms);l=k._final_samplers;wipeObject(l);l.merge(n._samplers);l.merge(k.samplers)}g=a._lights;this._blend_instances=d;this._opaque_instances=c;this._visible_instances=h;this._visible_lights=a._lights;
this._visible_cameras=a._cameras;this._visible_materials=f;q=0;for(s=g.length;q<s;++q)g[q].prepare(b)},_prepareMaterials:function(a,b){for(var c in a){var d=a[c];d._uniforms||(d._uniforms={},d._samplers={});d.fillShaderQuery(b);d.fillUniforms(b)}},_sort_far_to_near_func:function(a,b){return b._dist-a._dist},_sort_near_to_far_func:function(a,b){return a._dist-b._dist},_sort_by_priority_func:function(a,b){return b.priority-a.priority},renderInstancesToRT:function(a,b,c){function d(){gl.clearColor(f.info.background_color[0],
f.info.background_color[1],f.info.background_color[2],f.info.background_color[3]);!0!=c.ignore_clear&&gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);e.Renderer.renderInstances(c)}c=c||this.default_render_settings;this._current_target=b;var f=e.Renderer._current_scene;b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a,c),b.drawTo(d)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),b.width,b,c,a.near,a.far);this._current_target=null},renderToCubemap:function(a,b,c,d,f,g){b=b||
256;f=f||1;g=g||1E3;c&&c.constructor==Texture||(c=null);var h=this._current_scene;this._current_target=c=c||new Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c.drawTo(function(b,c){var e=w.cubemap_camera_parameters;d.is_shadowmap||!h.info?gl.clearColor(0,0,0,0):gl.clearColor(h.info.background_color[0],h.info.background_color[1],h.info.background_color[2],h.info.background_color[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);e=new w({eye:a,center:[a[0]+e[c].dir[0],a[1]+
e[c].dir[1],a[2]+e[c].dir[2]],up:e[c].up,fov:90,aspect:1,near:f,far:g});Oa.enableCamera(e,d,!0);Oa.renderInstances(d)});this._current_target=null;return c},renderMaterialPreview:function(a,b,c){c=c||{};var d=this._material_scene;if(!d){d=this._material_scene=new e.SceneTree;d.info.background_color.set([0,0,0,0]);c.environment_texture&&(d.info.textures.environment=c.environment_texture);c=new e.SceneNode("sphere");var f=new e.Components.GeometricPrimitive({size:40,subdivisions:50,geometry:e.Components.GeometricPrimitive.SPHERE});
c.addComponent(f);d.root.addChild(c)}c=d.getNode("sphere");c.material=a;a=new GL.Texture(b,b);a.drawTo(function(){e.Renderer.renderFrame(d.root.camera,{skip_viewport:!0},d)});return a.toCanvas(null,!0)},getCameraAtPosition:function(a,b,c){c=c||this._visible_cameras;if(!c||!c.length)return null;for(var d=c.length-1;0<=d;--d){var f=c[d];if(f.enabled&&!f.render_to_texture&&f.isPointInCamera(a,b))return f}return null}};e.Renderer=Oa;C={getNodeAtCanvasPosition:function(a,b,c,d,f){return(a=this.getInstanceAtCanvasPosition(a,
b,c,d,f))?a.constructor==e.SceneNode?a:a._root&&a._root.constructor==e.SceneNode?a._root:a.node?a.node:null:null},getInstanceAtCanvasPosition:function(a,b,c,d,f){f=f||e.GlobalScene;c||(c=e.Renderer.getCameraAtPosition(a,b,f._cameras));if(!c)return null;this._picking_nodes={};this.renderPickingBuffer(f,c,a,b,d);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a},raycast:function(a,b,c,d,f){c=c||Number.MAX_VALUE;void 0===
d&&(d=65535);f=f||e.GlobalScene;f=f._instances;if(!f||!f.length)return null;for(var g=[],h=vec3.create(),q=vec3.create(),s=0;s<f.length;++s){var k=f[s];if(k.flags&$a&&0!==(d&k.layers)&&!(k.flags&Na)){var l=vec3.create();if(geo.testRayBBox(a,b,k.aabb,null,l,c)){var r=k.matrix,n=mat4.invert(mat4.create(),r);mat4.multiplyVec3(h,n,a);mat4.rotateVec3(q,n,b);if(geo.testRayBBox(h,q,k.oobb,null,l,c)){if(k.collision_mesh){var n=k.collision_mesh,p=n.octree;p||(p=n.octree=new Octree(n));n=p.testRay(h,q,0,c);
if(!n)continue;mat4.multiplyVec3(l,r,n.pos)}else vec3.transformMat4(l,l,r);r=vec3.distance(a,l);r<c&&g.push(new e.Collision(k.node,k,l,r))}}}}g.sort(Ya.isCloser);return g},getNextPickingColor:function(a){this._picking_next_color_id+=10;var b=new Uint32Array(1);b[0]=this._picking_next_color_id;b=new Uint8Array(b.buffer);this._picking_nodes[this._picking_next_color_id]=a;return vec4.fromValues(b[0]/255,b[1]/255,b[2]/255,1)},_pickingMap:null,_picking_color:new Uint8Array(4),_picking_depth:0,_picking_next_color_id:0,
_picking_nodes:{},_picking_render_settings:new cb({is_picking:!0}),renderPickingBuffer:function(a,b,c,d,f){var g=this;void 0===f&&(f=65535);if(null==this._pickingMap||this._pickingMap.width!=gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST});this._picking_next_color_id=0;this._current_target=this._pickingMap;this._pickingMap.drawTo(function(){e.Renderer.enableCamera(b,g._picking_render_settings);
gl.scissor(c-1,d-1,2,2);gl.enable(gl.SCISSOR_TEST);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);g._picking_render_settings.current_pass="picking";g._picking_render_settings.layers=f;e.Renderer.renderInstances(g._picking_render_settings);LEvent.trigger(a,"renderPicking",[c,d]);LEvent.trigger(e.Renderer,"renderPicking",[c,d]);gl.readPixels(c,d,1,1,gl.RGBA,gl.UNSIGNED_BYTE,g._picking_color);gl.disable(gl.SCISSOR_TEST)});this._current_target=null;return this._picking_color}};
e.Picking=C;Ya.isCloser=function(a,b){return a.distance-b.distance};e.Collision=Ya;ma.BOX=1;ma.SPHERE=2;ma.PLANE=3;ma.CAPSULE=4;ma.MESH=5;ma.FUNCTION=6;ma.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};ma.prototype.setMesh=function(a){this.mesh=a;this.type=ma.MESH;BBox.setCenterHalfsize(this.oobb,BBox.getCenter(a.bounding),BBox.getHalfsize(a.bounding))};e.PhysicsInstance=ma;e.Physics={raycast:function(a,b,c,d,f){c=c||Number.MAX_VALUE;void 0===d&&(d=65535);f=f||
e.GlobalScene;f=f._colliders;for(var g=[],h=vec3.create(),q=vec3.create(),s=0;s<f.length;++s){var k=f[s];if(0!==(d&k.layers)){var l=vec3.create();if(geo.testRayBBox(a,b,k.aabb,null,l,c)){var r=k.matrix,n=mat4.invert(mat4.create(),r);mat4.multiplyVec3(h,n,a);mat4.rotateVec3(q,n,b);if(k.type==ma.SPHERE){if(!geo.testRaySphere(h,q,k.center,k.oobb[3],l,c))continue;vec3.transformMat4(l,l,r)}else{if(!geo.testRayBBox(h,q,k.oobb,null,l,c))continue;if(k.type==ma.MESH){n=k.mesh.octree;n||(n=k.mesh.octree=new Octree(k.mesh));
n=n.testRay(h,q,0,c);if(!n)continue;mat4.multiplyVec3(l,r,n.pos)}else vec3.transformMat4(l,l,r)}r=vec3.distance(a,l);g.push(new e.Collision(k.node,k,l,r))}}}g.sort(Ya.isCloser);return g},testSphere:function(a,b,c,d){void 0===c&&(c=65535);d=d||e.GlobalScene;d=d._colliders;for(var f=vec3.create(),g=0;g<d.length;++g){var h=d[g];if(0!==(c&h.layers)&&geo.testSphereBBox(a,b,h.aabb)){var q=h.matrix,q=mat4.invert(mat4.create(),q);mat4.multiplyVec3(f,q,a);if(h.type==ma.SPHERE){if(vec3.distance(a,f)>b+BBox.getRadius(h.oobb))continue}else{if(!geo.testSphereBBox(f,
b,h.oobb))continue;if(h.type==e.PhysicsInstance.MESH&&(q=h.mesh.octree,q||(q=h.mesh.octree=new Octree(h.mesh)),!q.testSphere(f,b)))continue}return h}}return null},testCollision:function(a,b){return geo.testBBoxBBox(a.aabb,b.aabb)?!0:!1},testAllCollisions:function(a,b,c){void 0===b&&(b=65535);c=c||e.GlobalScene;c=c._colliders;for(var d=c.length,f=!1,g=0;g<d;++g){var h=c[g];if(0!==(b&h.layers))for(var q=g+1;q<d;++q){var s=c[q];0!==(b&s.layers)&&this.testCollision(h,s)&&(a&&a(h,s),f=!0)}}return f}};
e.Formats={supported:{},safe_parsing:!1,merge_smoothgroups:!1,addSupportedFormat:function(a,b){a.constructor===String&&(a=a.split(","));for(var c=0;c<a.length;++c){var d=a[c].toLowerCase();this.supported[d]&&console.warning("There is already another parser associated to this extension");this.supported[d]=b}},registerParser:function(a){this.addSupportedFormat(a.extension,a)},parse:function(a,b,c){c=c||{};var d=this.getFileFormatInfo(a);c.extension&&(d.extension=c.extension);var f=this.supported[d.extension];
if(!f.parse)return console.error("Parser Error: No parser found for "+d.extension+" format"),null;d=null;if(this.safe_parsing)try{d=f.parse(b,c,a)}catch(g){return console.error("Error parsing content",g),null}else d=f.parse(b,c,a);d&&(d.name=a);return d},TEXT_FORMAT:"text",JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",MESH_DATA:"MESH",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",SCENE_DATA:"SCENE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(a){a=a.substr(a.lastIndexOf(".")+
1).toLowerCase();return this.supported[a]},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var f=0;f<b.width;++f)for(var g=0;g<b.height;++g){var h=g*b.width*4+4*f,e=(b.height-g-1)*b.width*3+3*f;d.data[h+2]=a.pixels[e];d.data[h+1]=a.pixels[e+1];d.data[h+0]=a.pixels[e+2];d.data[h+3]=255}else for(f=0;f<b.width;++f)for(g=0;g<b.height;++g)h=g*b.width*4+4*f,e=(b.height-
g-1)*b.width*4+4*f,d.data[h+0]=a.pixels[e+2],d.data[h+1]=a.pixels[e+1],d.data[h+2]=a.pixels[e+0],d.data[h+3]=a.pixels[e+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],d=0;d<a.length;d+=3){var f=[a[d],a[d+1],a[d+2]];f[0]<b[0]?b[0]=f[0]:f[0]>c[0]&&(c[0]=f[0]);f[1]<b[1]?b[1]=f[1]:f[1]>c[1]&&(c[1]=f[1]);f[2]<b[2]?b[2]=f[2]:f[2]>c[2]&&(c[2]=f[2])}a=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];
b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return BBox.setCenterHalfsize(BBox.create(),a,b)}};e.Formats.addSupportedFormat("png,jpg,webp,bmp,gif",{"native":!0,dataType:"arraybuffer",resource:"Texture",type:"image"});e.Formats.addSupportedFormat("wbin",{dataType:"arraybuffer"});x.classes=e.Classes;e.Formats.registerParser({extension:"ase",type:"mesh",resource:"Mesh",format:"text",parse:function(a,b,c){b=b||{};c=[];var d=[],f=[],g=[],h=[],q=null,q=null,s=0,k=-1,l=null,r=[],n=this.flipAxis;null!=b.flipAxis&&
(n=b.flipAxis);b=n||b.flipNormals;a=a.split("\n");for(var p=0;p<a.length;++p)if(q=a[p].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==q[0]&&(q=q.substr(1,q.length)),""!=q)if(q=q.split(" "),"*MESH"==q[0]){if(s+=1,g=[],h=[],1<s)break}else if("*NODE_NAME"==q[0])q[1].substr(1,q[1].length-2);else if("*MESH_VERTEX"==q[0])n?g.push([-1*parseFloat(q[2]),parseFloat(q[4]),parseFloat(q[3])]):g.push([parseFloat(q[2]),parseFloat(q[3]),parseFloat(q[4])]);else if("*MESH_FACE"==q[0]){var z=parseInt(q[17]);k!=z&&
(k=z,null!=l&&(l.length=c.length/3-l.start,0<l.length&&r.push(l)),l={name:"mat_"+z,start:c.length/3,length:-1,material:""});z=g[parseInt(q[3])];c.push(z[0],z[1],z[2]);z=g[parseInt(q[5])];c.push(z[0],z[1],z[2]);z=g[parseInt(q[7])];c.push(z[0],z[1],z[2])}else"*MESH_TVERT"==q[0]?h.push([parseFloat(q[2]),parseFloat(q[3])]):"*MESH_TFACE"==q[0]?(z=h[parseInt(q[2])],d.push(z[0],z[1]),z=h[parseInt(q[3])],d.push(z[0],z[1]),z=h[parseInt(q[4])],d.push(z[0],z[1])):"*MESH_VERTEXNORMAL"==q[0]&&(b?f.push(-1*parseFloat(q[2]),
parseFloat(q[4]),parseFloat(q[3])):f.push(parseFloat(q[2]),parseFloat(q[3]),parseFloat(q[4])));g=c.length/3-l.start;l&&1<g&&(l.length=g,r.push(l));l={info:{}};l.vertices=new Float32Array(c);0<f.length&&(l.normals=new Float32Array(f));0<d.length&&(l.coords=new Float32Array(d));l.bounding=e.Formats.computeMeshBounding(l.vertices);1<r.length&&(l.info.groups=r);return l}});(function(a){function b(a,b){var c=new XMLHttpRequest;c.onload=function(){200==this.status&&b&&b(this.response)};-1==a.indexOf("://")&&
(a=Collada.dataPath+a);c.open("get",a,!0);c.send()}var c=void 0===a.document,d=2*Math.PI/360;c&&(a.console={log:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"log",params:b})},warn:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"warn",params:b})},error:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"error",params:b})}},a.alert=console.error);a.Collada={libsPath:"./",workerPath:"./",no_flip:!0,
use_transferables:!0,onerror:null,verbose:!1,config:{forceParser:!1},init:function(a){a=a||{};for(var b in a)this[b]=a[b];this.config=a;if(c)try{importScripts(this.libsPath+"gl-matrix-min.js",this.libsPath+"tinyxml.js")}catch(d){Collada.throwException(Collada.LIBMISSING_ERROR)}mat4.create();vec3.create();vec3.create();vec3.create();quat.create();c&&console.log("Collada worker ready")},load:function(a,c){b(a,function(a){a?c(Collada.parse(a)):c(null)})},_xmlroot:null,_nodes_by_id:null,_transferables:null,
_controllers_found:null,_geometries_found:null,safeString:function(a){return a?this.convertID?this.convertID(a):a.replace(/ /g,"_"):""},LIBMISSING_ERROR:"Libraries loading error, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath",NOXMLPARSER_ERROR:"TinyXML not found, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath (Workers do not allow to access the native XML DOMParser)",throwException:function(a){if(c)self.postMessage({action:"exception",
msg:a});else if(Collada.onerror)Collada.onerror(a);throw a;},getFilename:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));b=a.lastIndexOf("/");-1!=b&&(a=a.substr(b+1));return a},parse:function(b,c,d){d=d||"_dae_"+Date.now()+".dae";var e=null;c=null;this._transferables=[];this.verbose&&console.log(" - XML parsing...");if(a.DOMParser&&!this.config.forceParser)e=new DOMParser,c=e.parseFromString(b,"text/xml"),this.verbose&&console.log(" - XML parsed");else{if(!a.DOMImplementation)return Collada.throwException(Collada.NOXMLPARSER_ERROR);
try{e=new DOMImplementation}catch(s){return Collada.throwException(Collada.NOXMLPARSER_ERROR)}c=e.loadXML(b);this.verbose&&console.log(" - XML parsed");b=c._nodes_by_id={};for(var e=0,k=c.all.length;e<k;++e){var l=c.all[e];b[l.id]=l;l.getAttribute("sid")&&(b[l.getAttribute("sid")]=l)}this.extra_functions||(this.extra_functions=!0,DOMDocument.prototype.querySelector=DOMElement.prototype.querySelector=function(a){a=a.split(" ");for(var b=this;a.length;){var c=a.shift().split("#"),d=c[0],c=c[1],d=d?
b.getElementsByTagName(d):b.childNodes;if(c)for(var f=0;f<d.length;f++){if(d.item(f).getAttribute("id")==c){if(0==a.length)return d.item(f);b=d.item(f);break}}else{if(0==a.length)return d.item(0);b=d.item(0)}}return null},DOMDocument.prototype.querySelectorAll=DOMElement.prototype.querySelectorAll=function(a){function b(a,c){if(c){var f=c.shift(),f=a.getElementsByTagName(f);if(0==c.length)for(var g=0;g<f.length;g++)d.push(f.item(g));else for(g=0;g<f.length;g++)b(f.item(g),c.concat())}}var c=a.split(" ");
if(1==c.length)return this.getElementsByTagName(a);var d=[];b(this,c);a=new DOMNodeList(this.documentElement);a._nodes=d;a.length=d.length;return a},Object.defineProperty(DOMElement.prototype,"textContent",{get:function(){return this.getChildNodes().item(0).toString()},set:function(){}}))}this._xmlroot=c;if(b=c.querySelector("COLLADA"))this._current_DAE_version=b.getAttribute("version"),console.log("DAE Version:"+this._current_DAE_version);e=c.getElementsByTagName("visual_scene").item(0);if(!e)throw"visual_scene XML node not found in DAE";
this._nodes_by_id={};this._controllers_found={};this._geometries_found={};b={object_type:"SceneTree",light:null,materials:{},meshes:{},resources:{},root:{children:[]},external_files:{}};if(l=c.getElementsByTagName("asset")[0])b.metadata=this.readAsset(l);k=e.childNodes;for(e=0;e<k.length;e++)"node"==k.item(e).localName&&(l=this.readNodeTree(k.item(e),b,0,!1))&&b.root.children.push(l);for(e=0;e<k.length;e++)"node"==k.item(e).localName&&this.readNodeInfo(k.item(e),b,0,!1);this.readLibraryControllers(b);
if(e=this.readAnimations(c,b))d="#animations_"+d.substr(0,d.indexOf(".")),b.resources[d]=e,b.root.animations=d;b.images=this.readImages(c);this._nodes_by_id={};this._controllers_found={};this._geometries_found={};this._xmlroot=null;return b},readAsset:function(a){for(var b={},c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c);if(1==d.nodeType)switch(d.localName){case "contributor":if(d=d.querySelector("authoring_tool")[0])b.authoring_tool=d.textContext;break;case "unit":b.unit=d.getAttribute("name");
break;default:b[d.localName]=d.textContent}}return b},readNodeTree:function(a,b,c,d){var e=this.safeString(a.getAttribute("id")),k=this.safeString(a.getAttribute("sid"));if(!e&&!k)return null;e={id:k||e,children:[],_depth:c};a.getAttribute("type");var l=a.getAttribute("name");l&&(e.name=l);this._nodes_by_id[e.id]=e;k&&(this._nodes_by_id[k]=e);e.model=this.readTransform(a,c,d);for(k=0;k<a.childNodes.length;k++)l=a.childNodes.item(k),1==l.nodeType&&"node"==l.localName&&(l=this.readNodeTree(l,b,c+1,
d))&&e.children.push(l);return e},readNodeInfo:function(a,b,c,d){var e=this.safeString(a.getAttribute("id")),k=this.safeString(a.getAttribute("sid"));if(!e&&!k)return null;e=this._nodes_by_id[e||k];for(k=0;k<a.childNodes.length;k++){var l=a.childNodes.item(k);if(1==l.nodeType)if("node"==l.localName)this.readNodeInfo(l,b,c+1,d);else{if("instance_geometry"==l.localName){var r=l.getAttribute("url"),n=r.toString().substr(1);e.mesh=n;if(!b.meshes[r]){var p=this.readGeometry(r,d);p&&(p.name=n,b.meshes[n]=
p)}if(r=l.querySelectorAll("instance_material"))for(p=0;p<r.length;++p)if(n=r.item(p)){n=n.getAttribute("target").toString().substr(1);if(!b.materials[n]){var z=this.readMaterial(n);z&&(z.id=n,b.materials[z.id]=z)}0==p?e.material=n:(e.materials||(e.materials=[]),e.materials.push(n))}else console.warn("instance_material not found: "+k)}if("instance_controller"==l.localName&&(r=l.getAttribute("url"),p=this._xmlroot.querySelector("controller"+r))){p=this.readController(p,d,b);if(n=l.querySelector("bind_material"))e.materials=
this.readBindMaterials(n);p&&(n=p,"morph"==p.type&&(n=p.mesh,e.morph_targets=p.morph_targets),n.name=r.toString(),e.mesh=r.toString(),b.meshes[r]=n)}"instance_light"==l.localName&&(r=l.getAttribute("url"),this.readLight(e,r));"instance_camera"==l.localName&&(r=l.getAttribute("url"),this.readCamera(e,r))}}},material_translate_table:{},light_translate_table:{point:"omni"},camera_translate_table:{xfov:"fov",aspect_ratio:"aspect",znear:"near",zfar:"far"},querySelectorAndId:function(a,b,c){a=a.querySelectorAll(b);
for(b=0;b<a.length;b++){var d=a.item(b).getAttribute("id");if(d&&(d=d.toString(),d==c))return a.item(b)}return null},getFirstChildElement:function(a,b){for(var c=a.childNodes,d=0;d<c.length;++d){var e=c.item(d);if(e.localName&&!b||b&&b==e.localName)return e}return null},readMaterial:function(a){a=this.querySelectorAndId(this._xmlroot,"library_materials material",a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url").substr(1);a=this.querySelectorAndId(this._xmlroot,
"library_effects effect",a);if(!a)return null;var b=a.querySelector("technique");if(!b)return null;a={};var c=b.querySelector("phong");c||(c=b.querySelector("blinn"));if(!c)return null;for(b=0;b<c.childNodes.length;++b){var d=c.childNodes.item(b);if(d.localName){var e=d.localName.toString();this.material_translate_table[e]&&(e=this.material_translate_table[e]);if(d=this.getFirstChildElement(d))if("color"==d.localName.toString())a[e]=this.readContentAsFloats(d).subarray(0,3);else if("float"==d.localName.toString())a[e]=
this.readContentAsFloats(d)[0];else if("texture"==d.localName.toString()){a.textures||(a.textures={});var k=d.getAttribute("texture");k&&(k={map_id:k},d=d.getAttribute("texcoord"),k.uvs=d,a.textures[e]=k)}}}a.object_type="Material";return a},readLight:function(a,b){var c={},d=null;if(1<b.length)d=this._xmlroot.querySelector("library_lights "+b);else var e=this._xmlroot.querySelector("library_lights"),d=this.getFirstChildElement(e,"light");if(!d)return null;var e=[],k=d.querySelector("technique_common");
if(k)for(var l=0;l<k.childNodes.length;l++)1==k.childNodes.item(l).nodeType&&e.push(k.childNodes.item(l));d=d.querySelectorAll("technique");for(l=0;l<d.length;l++)for(var k=d.item(l),r=0;r<k.childNodes.length;r++)1==k.childNodes.item(r).nodeType&&e.push(k.childNodes.item(r));for(l=0;l<e.length;l++)switch(k=e[l],k.localName){case "point":case "spot":c.type=this.light_translate_table[k.localName];d=c;for(r=0;r<k.childNodes.length;r++){var n=k.childNodes.item(r);if(n&&1==n.nodeType)switch(n.localName){case "color":d.color=
Collada.readContentAsFloats(n);break;case "falloff_angle":d.angle_end=Collada.readContentAsFloats(n)[0],d.angle=d.angle_end-10}}break;case "intensity":c.intensity=this.readContentAsFloats(k)[0]}c.position=[0,0,0];c.target=[0,-1,0];a.light=c},readCamera:function(a,b){var c={},d=this._xmlroot.querySelector("library_cameras "+b);if(!d)return null;var e=[],k=d.querySelector("technique_common");if(k)for(d=0;d<k.childNodes.length;d++)1==k.childNodes.item(d).nodeType&&e.push(k.childNodes.item(d));for(d=
0;d<e.length;d++)for(var k=c,l=e[d],r=0;r<l.childNodes.length;r++){var n=l.childNodes.item(r);n&&1==n.nodeType&&(k[Collada.camera_translate_table[n.localName]||n.localName]=parseFloat(n.textContent))}a.camera=c},readTransform:function(a,b,c){for(var e=mat4.create(),s=mat4.create(),k=quat.create(),l=0;l<a.childNodes.length;l++){var r=a.childNodes.item(l);if("matrix"==r.localName){e=this.readContentAsFloats(r);this.transformMatrix(e,0==b);break}if("translate"==r.localName){var n=this.readContentAsFloats(r);
c&&0<b&&(r=n[1],n[1]=n[2],n[2]=-r);mat4.translate(e,e,n)}else"rotate"==r.localName?(n=this.readContentAsFloats(r),4==n.length&&("jointOrientX"==r.getAttribute("sid")&&(n[3]+=90),c&&(r=n[1],n[1]=n[2],n[2]=-r),0!=n[3]&&(quat.setAxisAngle(k,n.subarray(0,3),n[3]*d),mat4.fromQuat(s,k),mat4.multiply(e,e,s)))):"scale"==r.localName&&(n=this.readContentAsFloats(r),c&&(r=n[1],n[1]=n[2],n[2]=-r),mat4.scale(e,e,n))}return e},readTransform2:function(a,b,c){for(var e=mat4.create(),s=quat.create(),k=mat4.create(),
l=quat.create(),r=vec3.create(),n=vec3.fromValues(1,1,1),p=0;p<a.childNodes.length;p++){var z=a.childNodes.item(p);if("matrix"==z.localName)return e=this.readContentAsFloats(z),this.transformMatrix(e,0==b),e;if("translate"==z.localName){var m=this.readContentAsFloats(z);r.set(m)}else"rotate"==z.localName?(m=this.readContentAsFloats(z),4==m.length&&("jointOrientX"==z.getAttribute("sid")&&(m[3]+=90),c&&(z=m[1],m[1]=m[2],m[2]=-z),0!=m[3]&&(quat.setAxisAngle(l,m.subarray(0,3),m[3]*d),quat.multiply(s,
s,l)))):"scale"==z.localName&&(m=this.readContentAsFloats(z),c&&(z=m[1],m[1]=m[2],m[2]=-z),n.set(m))}c&&0<b&&(z=r[1],r[1]=r[2],r[2]=-z);mat4.translate(e,e,r);mat4.fromQuat(k,s);mat4.multiply(e,e,k);mat4.scale(e,e,n);return e},readGeometry:function(a,b,d){if(void 0!==this._geometries_found[a])return this._geometries_found[a];var e=this._xmlroot.getElementById(a.substr(1));if(!e)return console.warn("readGeometry: geometry not found: "+a),this._geometries_found[a]=null;if("controller"==e.localName)return d=
this.readController(e,b,d),this._geometries_found[a]=d;if("geometry"!=e.localName)return console.warn("readGeometry: tag should be geometry, instead it was found: "+e.localName),this._geometries_found[a]=null;var s=e.querySelector("mesh");if(!s)return console.warn("readGeometry: mesh not found in geometry: "+a),this._geometries_found[a]=null;var e={},k=s.querySelectorAll("source");for(d=0;d<k.length;d++){var l=k.item(d);if(l.querySelector){var r=l.querySelector("float_array");if(r){var r=this.readContentAsFloats(r),
n=l.querySelector("accessor"),n=parseInt(n.getAttribute("stride"));e[l.getAttribute("id")]={stride:n,data:r}}}}k=s.querySelector("vertices input");vertices_source=e[k.getAttribute("source").substr(1)];e[s.querySelector("vertices").getAttribute("id")]=vertices_source;k=null;(l=s.querySelector("polygons"))&&(k=this.readTriangles(l,e));k||(l=s.querySelectorAll("triangles"))&&l.length&&(k=this.readTriangles(l,e));k||(l=s.querySelector("polylist"))&&(k=this.readPolylist(l,e));k||(s=s.querySelector("linestrips"))&&
(k=this.readLineStrip(e,s));if(!k)return console.log("no polygons or triangles in mesh: "+a),this._geometries_found[a]=null;if(b&&!this.no_flip){b=0;e=k.vertices;d=0;for(s=e.length;d<s;d+=3)b=e[d+1],e[d+1]=e[d+2],e[d+2]=-b;e=k.normals;d=0;for(s=e.length;d<s;d+=3)b=e[d+1],e[d+1]=e[d+2],e[d+2]=-b}if(c&&this.use_transferables)for(d in k)(b=k[d])&&b.buffer&&100<b.length&&this._transferables.push(b.buffer);k.filename=a;k.object_type="Mesh";return this._geometries_found[a]=k},readTriangles:function(a,b){for(var c=
[],d=[],e=0,k={},l=[],r=[],n=0,p="",m=0;m<a.length;m++){var w=a.item(m),t="triangles"==w.localName,p=w.getAttribute("material");0==m&&(d=this.readShapeInputs(w,b));for(var w=w.querySelectorAll("p"),x=d.length,u=0;u<w.length;u++){var B=w.item(u);if(!B||!B.textContent)break;for(var B=B.textContent.trim().split(" "),C=-1,D=-1,F=-1,A=0,H=B.length;A<H;A+=x){var I=B.slice(A,A+x).join(" "),F=D;if(k.hasOwnProperty(I))D=k[I];else{for(D=0;D<d.length;++D){var G=d[D],J=parseInt(B[A+D]),E=G[1],K=G[3];0==D&&(l[E.length/
x]=J);for(var J=J*G[2],L=0;L<G[2];++L)E.push(K[J+L])}D=e;e+=1;k[I]=D}t||(0==A&&(C=D),A>2*x&&(r.push(C),r.push(F)));r.push(D)}}p={name:"group"+m,start:n,length:r.length-n,material:p||""};n=r.length;c.push(p)}c={vertices:new Float32Array(d[0][1]),info:{groups:c},_remap:new Uint32Array(l)};this.transformMeshInfo(c,d,r);return c},readPolylist:function(a,b){var c=[],d=0,e={},k=[],l=[];a.getAttribute("material");for(var c=this.readShapeInputs(a,b),r=a.querySelector("vcount"),r=this.readContentAsUInt32(r),
n=a.querySelector("p"),n=this.readContentAsUInt32(n),p=c.length,m=0,w=0;w<r.length;++w)for(var t=r[w],x=-1,u=-1,B=-1,C=0;C<t;++C){var D=n.subarray(m,m+p).join(" "),B=u;if(e.hasOwnProperty(D))u=e[D];else{for(u=0;u<c.length;++u){var A=c[u],F=parseInt(n[m+u]),G=A[1],I=A[3];0==u&&(k[G.length/p]=F);for(var F=F*A[2],H=0;H<A[2];++H)G.push(I[F+H])}u=d;d+=1;e[D]=u}3<t&&(0==C&&(x=u),C>2*p&&(l.push(x),l.push(B)));l.push(u);m+=p}d={vertices:new Float32Array(c[0][1]),info:{},_remap:new Uint32Array(k)};this.transformMeshInfo(d,
c,l);return d},readShapeInputs:function(a,b){for(var c=[],d=a.querySelectorAll("input"),e=0;e<d.length;e++){var k=d.item(e);if(k.getAttribute){var l=k.getAttribute("semantic").toUpperCase(),r=b[k.getAttribute("source").substr(1)],n=parseInt(k.getAttribute("offset")),p=0;k.getAttribute("set")&&(p=parseInt(k.getAttribute("set")));c.push([l,[],r.stride,r.data,n,p])}}return c},transformMeshInfo:function(a,b,c){for(var d={normal:"normals",texcoord:"coords"},e=1;e<b.length;++e){var k=b[e][0].toLowerCase(),
l=b[e][1];l.length&&(d[k]&&(k=d[k]),a[k]&&(k+=b[e][5]),a[k]=new Float32Array(l))}c&&c.length&&(a.triangles=65536<a.vertices.length?new Uint32Array(c):new Uint16Array(c));return a},readLineStrip:function(a,b){for(var c=[],d=0,e={},k=[],l=b.querySelectorAll("input"),r=0;r<l.length;r++){var n=l.item(r);if(n.getAttribute){var p=n.getAttribute("semantic").toUpperCase(),m=a[n.getAttribute("source").substr(1)],w=parseInt(n.getAttribute("offset")),t=0;n.getAttribute("set")&&(t=parseInt(n.getAttribute("set")));
c.push([p,[],m.stride,m.data,w,t])}}l=b.querySelectorAll("p");n=c.length;for(r=0;r<l.length;r++){p=l.item(r);if(!p||!p.textContent)break;for(var p=p.textContent.trim().split(" "),x=-1,m=0,w=p.length;m<w;m+=n){t=p.slice(m,m+n).join(" ");if(e.hasOwnProperty(t))x=e[t];else{for(x=0;x<c.length;++x)for(var u=c[x],B=parseInt(p[m+x]),C=u[1],D=u[3],B=B*u[2],A=0;A<u[2];++A)C.push(D[B+A]);x=d;d+=1;e[t]=x}k.push(x)}}d={primitive:"line_strip",vertices:new Float32Array(c[0][1]),info:{}};return this.transformMeshInfo(d,
c,k)},findXMLNodeById:function(a,b,c){if(this._xmlroot._nodes_by_id){var d=this._xmlroot._nodes_by_id[c];if(d&&d.localName==b)return d}else if(d=this._xmlroot.getElementById(c))return d;a=a.childNodes;for(d=0;d<a.length;++d){var e=a.item(d);if(1==e.nodeType&&e.localName==b&&e.getAttribute("id")==c)return e}return null},readImages:function(a){var b=a.querySelector("library_images");if(!b)return null;a={};for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);if(1==d.nodeType){var e=d.querySelector("init_from");
if(e&&e.textContent){var k=this.getFilename(e.textContent),l=d.getAttribute("id");a[l]={filename:k,map:l,name:d.getAttribute("name"),path:e.textContent}}}}return a},readAnimations:function(a,b){var c=a.querySelector("library_animations");if(!c)return null;for(var d=c.childNodes,c={object_type:"Animation",takes:{}},e={tracks:[]},k=e.tracks,l=0;l<d.length;++l){var r=d.item(l);if(1==r.nodeType&&"animation"==r.localName)if(r.getAttribute("id"))(p=this.readAnimationTrack(r))&&k.push(p);else for(var r=
r.querySelectorAll("animation"),n=0;n<r.length;++n){var p=r.item(n),p=this.readAnimationTrack(p);k.push(p)}}if(!k.length)return null;for(l=d=0;l<k.length;++l)d<k[l].duration&&(d=p.duration);e.name="default";e.duration=d;c.takes[e.name]=e;return c},readAnimationTrack:function(a){if("animation"!=a.localName)return null;var b=a.getAttribute("id"),d=a.querySelector("channel");if(!d)return null;var e=d.getAttribute("source"),s=d.getAttribute("target");xmlsampler=this.findXMLNodeById(a,"sampler",e.substr(1));
if(!xmlsampler)return console.error("Error DAE: Sampler not found in "+e),null;for(var k={},l={},r={},n=xmlsampler.querySelectorAll("input"),e=null,d=0;d<n.length;d++){var p=n.item(d),m=p.getAttribute("source"),w=p.getAttribute("semantic"),t=this.findXMLNodeById(a,"source",m.substr(1));if(t){var x=t.querySelector("param");if(x){p=x.getAttribute("type");k[w]={source:m,type:p};var u=null;if("float"==p||"float4x4"==p)u=t.querySelector("float_array"),u=this.readContentAsFloats(u),l[m]=u,m=x.getAttribute("name"),
"TIME"==m&&(e=u),r["OUTPUT"==w?w:m]=p}}}if(!e)return console.error("Error DAE: no TIME info found in animation: "+b),null;d=s.split("/");a={};p=d[0];b=p+"/"+d[1];a.name=d[1];a.property=b;b=this._nodes_by_id[p];p="number";s=1;r=r.OUTPUT;switch(r){case "float":s=1;break;case "float3x3":s=9;p="mat3";break;case "float4x4":s=16,p="mat4"}a.type=p;a.value_size=s;a.duration=e[e.length-1];k=l[k.OUTPUT.source];if(!k)return null;l=s+1;p=new Float32Array(e.length*l);for(d=0;d<e.length;++d)p[d*l]=e[d],n=k.subarray(d*
s,(d+1)*s),"float4x4"==r&&this.transformMatrix(n,b?0==b._depth:0),p.set(n,d*l+1);c&&this.use_transferables&&p&&p.buffer&&100<p.length&&this._transferables.push(p.buffer);a.data=p;return a},findNode:function(a,b){if(a.id==b)return a;if(a.children)for(var c in a.children){var d=this.findNode(a.children[c],b);if(d)return d}return null},readLibraryControllers:function(a){var b=this._xmlroot.querySelector("library_controllers");if(!b)return null;for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);
if(1==d.nodeType&&"controller"==d.localName){var e=d.getAttribute("id");this._controllers_found[e]||this.readController(d,null,a)}}},readController:function(a,b,c){if("controller"==!a.localName)return console.warn("readController: not a controller: "+a.localName),null;var d=a.getAttribute("id"),e=null,k=a.querySelector("skin");k&&(e=this.readSkinController(k,b,c));(a=a.querySelector("morph"))&&(e=this.readMorphController(a,b,c,e));return this._controllers_found[d]=e},readSkinController:function(a,
b,c){var d=a.getAttribute("source");c=this.readGeometry(d,b,c);if(!c)return null;var e=this.readSources(a,b);if(!e)return null;b=null;(b=a.querySelector("bind_shape_matrix"))?(b=this.readContentAsFloats(b),this.transformMatrix(b,!0,!0)):b=mat4.create();var d=[],k=a.querySelector("joints");if(k){for(var l=null,r=null,n=k.querySelectorAll("input"),k=0;k<n.length;k++){var p=n[k],m=p.getAttribute("semantic").toUpperCase(),p=p.getAttribute("source"),p=e[p.substr(1)];"JOINT"==m?l=p:"INV_BIND_MATRIX"==m&&
(r=p)}if(!r||!l)return console.error("Error DAE: no joints or inv_bind sources found"),null;for(k in l)n=r.subarray(16*k,16*k+16),m=l[k],(p=this._nodes_by_id[m])?(this.transformMatrix(n,0==p._depth,!0),d.push([m,n])):console.warn("Node "+m+" not found")}if(a=a.querySelector("vertex_weights")){for(var w=null,n=a.querySelectorAll("input"),k=0;k<n.length;k++)"WEIGHT"==n[k].getAttribute("semantic").toUpperCase()&&(w=e[n.item(k).getAttribute("source").substr(1)]);if(!w)throw"no weights found";var k=a.querySelector("vcount"),
t=this.readContentAsUInt32(k),k=a.querySelector("v"),x=this.readContentAsUInt32(k);a=c.vertices.length/3;for(var e=new Float32Array(4*a),l=new Uint8Array(4*a),u=0,r=c._remap,k=n=0;k<t.length;++k){for(var B=t[k],C=u,p=l.subarray(4*k,4*k+4),m=e.subarray(4*k,4*k+4),D=0,A=0;A<B&&4>A;++A)p[A]=x[C+2*A],p[A]>n&&(n=p[A]),m[A]=w[x[C+2*A+1]],D+=m[A];if(4<B&&1>D)for(p=1/D,A=0;4>A;++A)m[A]*=p;u+=2*B}w=new Float32Array(4*a);t=new Uint8Array(4*a);x=[];for(k=0;k<a;++k){p=4*r[k];m=e.subarray(p,p+4);p=l.subarray(p,
p+4);for(u=0;3>u;++u){B=u;C=m[u];for(A=u+1;4>A;++A)m[A]<=C||(B=A,C=m[A]);B!=u&&(A=m[u],m[u]=m[B],m[B]=A,A=p[u],p[u]=p[B],p[B]=A)}w.set(m,4*k);t.set(p,4*k);m[0]&&(x[p[0]]=!0);m[1]&&(x[p[1]]=!0);m[2]&&(x[p[2]]=!0);m[3]&&(x[p[3]]=!0)}n>=d.length&&console.warn("Mesh uses higher bone index than bones found");a=[];e={};for(k=0;k<x.length;++k)x[k]&&(e[k]=a.length,a.push(d[k]));if(a.length<d.length){for(k=0;k<t.length;k++)t[k]=e[t[k]];d=a}c.weights=w;c.bone_indices=t;c.bones=d;c.bind_matrix=b;delete c._remap}return c},
readMorphController:function(a,b,c,d){d=a.getAttribute("source");d=this.readGeometry(d,b,c);if(!d)return null;var e=this.readSources(a,b),k=[];a=a.querySelector("targets");if(!a)return null;for(var l=a.querySelectorAll("input"),r=a=null,n=0;n<l.length;n++){var p=l.item(n),m=p.getAttribute("semantic").toUpperCase(),p=e[p.getAttribute("source").substr(1)];"MORPH_TARGET"==m?a=p:"MORPH_WEIGHT"==m&&(r=p)}if(!a||!r)return console.warn("Morph controller without targets or weights. Skipping it."),null;for(n in a)e=
"#"+a[n],l=this.readGeometry(e,b,c),c.meshes[e]=l,k.push({mesh:e,weight:r[n]});d.morph_targets=k;return d},readBindMaterials:function(a,b){for(var c=[],d=a.querySelectorAll("technique_common"),e=0;e<d.length;e++)for(var k=d.item(e).querySelectorAll("instance_material"),l=0;l<k.length;l++){var r=k.item(l);r&&c.push(r.getAttribute("symbol"))}return c},readSources:function(a,b){for(var c={},d=a.querySelectorAll("source"),e=0;e<d.length;e++){var k=d.item(e);if(k.querySelector)if(k.querySelector("float_array")){var l=
this.readContentAsFloats(k);c[k.getAttribute("id")]=l}else(l=k.querySelector("Name_array"))?(l=this.readContentAsStringsArray(l))&&(c[k.getAttribute("id")]=l):(l=k.querySelector("IDREF_array"))&&(l=this.readContentAsStringsArray(l))&&(c[k.getAttribute("id")]=l)}return c},readContentAsUInt32:function(a){if(!a)return null;a=a.textContent;a=a.replace(/\n/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;
var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" ");a=(a=a.getAttribute("count"))?parseInt(a):b.length;a=new Float32Array(a);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},readContentAsStringsArray:function(a){if(!a)return null;for(var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" "),c=0;c<b.length;c++)b[c]=b[c].trim();if(a.getAttribute("count")&&parseInt(a.getAttribute("count"))!=b.length){var c=[],
d="",e;for(e in b)d=d?d+(" "+b[e]):b[e],this._nodes_by_id[this.safeString(d)]&&(c.push(this.safeString(d)),d="");a=parseInt(a.getAttribute("count"));if(c.length==a)return c;console.error("Error: bone names have spaces, avoid using spaces in names");return null}return b},max3d_matrix_0:new Float32Array([0,-1,0,0,0,0,-1,0,1,0,0,-0,0,0,0,1]),transformMatrix:function(a,b,c){mat4.transpose(a,a);if(this.no_flip)return a;b?(b=new Float32Array(a.subarray(4,8)),a.set(a.subarray(8,12),4),a.set(b,8),b=a.subarray(8,
12),vec4.scale(b,b,-1)):(b=mat4.create(),b.set([a[0],a[2],-a[1]],0),b.set([a[8],a[10],-a[9]],4),b.set([-a[4],-a[6],a[5]],8),b.set([a[12],a[14],-a[13]],12),a.set(b));return a}};c?(Collada.loadInWorker=function(a,b){Collada.load(b,a)},Collada.parseInWorker=function(a,b){a(Collada.parse(b))}):(Collada.launchWorker=function(){var a=this.worker=new Worker(Collada.workerPath+"collada.js");a.callback_ids={};a.addEventListener("error",function(a){if(Collada.onerror)Collada.onerror(err)});a.addEventListener("message",
function(a){if(a.data)switch(a=a.data,a.action){case "log":console.log.apply(console,a.params);break;case "warn":console.warn.apply(console,a.params);break;case "exception":console.error.apply(console,a.params);if(Collada.onerror)Collada.onerror(a.msg);break;case "error":console.error.apply(console,a.params);break;case "result":var b=this.callback_ids[a.callback_id];if(!b)throw"callback not found";b(a.result);break;default:console.warn("Unknown action:",a.action)}});this.callback_ids={};this.last_callback_id=
1;this.toWorker("init",[this.config])},Collada.toWorker=function(a,b,c){this.worker||this.launchWorker();var d=this.last_callback_id++;this.worker.callback_ids[d]=c;this.worker.postMessage({func:a,params:b,callback_id:d})},Collada.loadInWorker=function(a,b){this.toWorker("loadInWorker",[a],b)},Collada.parseInWorker=function(a,b){this.toWorker("parseInWorker",[a],b)});c&&self.addEventListener("message",function(a){if("init"==a.data.func)return Collada.init.apply(Collada,a.data.params);var b=a.data.func,
c=a.data.params,d=a.data.callback_id;a=function(a){self.postMessage({action:"result",callback_id:d,result:a},Collada._transferables);Collada._transferables=null};var e=Collada[b];if(void 0===e)console.error("function not found:",b),a(null);else try{e.apply(Collada,c?[a].concat(c):[a])}catch(k){console.error("Error inside worker function call to "+b+" :: "+k),a(null)}},!1)})("undefined"!=typeof window?window:self);e.Formats.registerParser({extension:"dae",type:"scene",resource:"SceneTree",format:"text",
parse:function(a,b,c){function d(a){a.id&&(a.uid="@"+e+"::"+a.id,f[a.id]=a.uid);a.mesh&&f[a.mesh]&&(a.mesh=f[a.mesh]);if(a.children)for(var b in a.children)d(a.children[b])}if(!a||a.constructor!==String)return console.error("DAE parser requires string"),null;Collada.material_translate_table={transparency:"opacity",reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",emission:"emissive",diffuse:"color"};a=Collada.parse(a,b,c);console.log(a);a.root.name=c;a.metadata&&
"Z_UP"==a.metadata.up_axis&&(a.root.model=mat4.rotateX(mat4.create(),mat4.create(),-90*0.0174532925));if(b.skip_renaming)return a;var f={},e=c.substr(0,c.indexOf("."));b={};for(var h in a.meshes)c=e+"__"+h,c=c.replace(/[^a-z0-9]/gi,"_"),f[h]=c,b[c]=a.meshes[h];a.meshes=b;for(h in a.meshes)if(b=a.meshes[h],b.morph_targets)for(var q=0;q<b.morph_targets.length;++q)c=b.morph_targets[q],c.mesh&&f[c.mesh]&&(c.mesh=f[c.mesh]);d(a.root);for(h in a.meshes)if(b=a.meshes[h],b.bones)for(q in b.bones)(c=f[b.bones[q][0]])&&
(b.bones[q][0]=c);for(h in a.resources)q=a.resources[h],"Animation"==q.object_type&&this.processAnimation(q,f);return a},processAnimation:function(a,b){for(var c in a.takes){for(var d=a.takes[c],e=0;e<d.tracks.length;++e){var g=d.tracks[e],h=g.property.indexOf("/");if(h){var q=g.property.substr(0,h),s=g.property.substr(h);"/transform"==s&&(s="/matrix");b[q]&&(q=b[q],g.property=q+s)}}s={};for(e=0;e<d.tracks.length;++e)if(g=d.tracks[e],g.packed_data=!0,"rotateX.ANGLE"==g.name||"rotateY.ANGLE"==g.name||
"rotateZ.ANGLE"==g.name)q=g.property.split("/")[0],s[q]||(s[q]={tracks:[]}),s[q].tracks.push(g);for(e in s){for(var q=s[e],h={data:[],type:"quat",value_size:4,property:e+"/Transform/rotation",name:"rotation"},k=[],l=0;l<q.tracks.length;++l)for(var g=q.tracks[l],g=g.data,r=0;r<g.length;r+=2)k.push(g[r]);k.sort();g=-1;r=[];for(l=0;l<k.length;++l)k[l]!=g&&(r.push(k[l]),g=k[l]);k=r;h.data.length=k.length;for(l=0;l<h.data.length;++l){var n=k[l],p=quat.create();h.data[l]=[n,p];for(r=0;r<q.tracks.length;++r){var g=
q.tracks[r],m;a:{m=g.data;for(var w=m.length,t=0;t<w;t+=2){if(m[t]==n){m=m[t+1];break a}if(m[t]>n){m=null;break a}}m=null}if(m)switch(m*=0.0174532925,g.name){case "rotateX.ANGLE":quat.rotateX(p,p,-m);break;case "rotateY.ANGLE":quat.rotateY(p,p,m);break;case "rotateZ.ANGLE":quat.rotateZ(p,p,m)}}}d.tracks.push(h);for(r=0;r<q.tracks.length;++r)g=q.tracks[r],h=d.tracks.indexOf(g),-1!=h&&d.tracks.splice(h,1)}}}});e.Formats.registerParser({extension:"dds",type:"image",dataType:"arraybuffer",resource:"Texture",
format:"binary",parse:function(a,b){if(!a||a.constructor!==ArrayBuffer)throw"ParserDDS: data must be ArrayBuffer";var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d,!0);return d}});e.Formats.registerParser({extension:"jsmesh",type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==
Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&
(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=e.Formats.computeMeshBounding(c.vertices));return c}});e.Formats.registerParser({extension:"obj",type:"mesh",resource:"Mesh",format:"text",flipAxis:!1,parse:function(a,b){b=b||{};for(var c=b.noindex?b.noindex:!1,d=[],e=[],g=[],h=[],q=[],m=[],k=[],l={},r=0,n=null,p=null,t=0,w=0,u=p=0,x=0,A=0,B=null,C=!1,D=!1,F=!1,G=!1,H=0,I=this.flipAxis||b.flipAxis,J=I||b.flipNormals,E=null,K=0,L=[],N={},O=a.split("\n"),P=O.length,Q=0;Q<P;++Q)if(n=
O[Q].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=n[0]&&""!=n)if(B=n.split(" "),G&&"v"==B[0]&&(G=!1),"v"==B[0])I?q.push(-1*parseFloat(B[1]),parseFloat(B[3]),parseFloat(B[2])):q.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if("vt"==B[0])m.push(parseFloat(B[1]),parseFloat(B[2]));else if("vn"==B[0])J?k.push(-parseFloat(B[2]),-parseFloat(B[3]),parseFloat(B[1])):k.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if("f"==B[0]){if(G=!0,!(4>B.length)){for(var n=[],M=1;M<
B.length;++M){var S=K+":"+B[M];if(!(S in l)||c){p=B[M].split("/");if(1==p.length)p=w=t=parseInt(p[0])-1;else if(2==p.length)t=parseInt(p[0])-1,w=parseInt(p[1])-1,p=-1;else if(3==p.length)t=parseInt(p[0])-1,w=parseInt(p[1])-1,p=parseInt(p[2])-1;else return console.log("Problem parsing: unknown number of values per face"),!1;3<M&&c&&(u=d.length,d.push(d[u-9*(M-3)],d[u-9*(M-3)+1],d[u-9*(M-3)+2]),d.push(d[u-3],d[u-2],d[u-1]),u=e.length,e.push(e[u-6*(M-3)],e[u-6*(M-3)+1]),e.push(e[u-2],e[u-1]),u=g.length,
g.push(g[u-9*(M-3)],g[u-9*(M-3)+1],g[u-9*(M-3)+2]),g.push(g[u-3],g[u-2],g[u-1]));A=x=u=0;3*t+2<q.length&&(C=!0,0>t&&(t=q.length/3+t+1),u=q[3*t+0],x=q[3*t+1],A=q[3*t+2]);d.push(u,x,A);x=u=0;2*w+1<m.length&&(D=!0,0>w&&(w=m.length/2+w+1),u=m[2*w+0],x=m[2*w+1]);e.push(u,x);x=u=0;A=1;-1!=p&&(3*p+2<k.length&&(F=!0,0>p&&(p=k.length/3+p+1),u=k[3*p+0],x=k[3*p+1],A=k[3*p+2]),g.push(u,x,A));c||(l[S]=r++)}c||(t=l[S],n.push(t),H<t&&(H=t))}if(!c)for(B=2;B<n.length;B++)h.push(n[0],n[B-1],n[B])}}else if("g"==B[0]||
"o"==B[0]){if(1<B.length){n=h.length?h.length:d.length/3;null!=E&&(E.length=n-E.start,0<E.length&&(N[R]=E,L.push(E),K++));var R=B[1];N[R]&&(R=R+"."+K);E={name:R,start:n,length:-1,material:""}}}else"usemtl"==B[0]?E&&(E.material=B[1]):"o"!=B[0]&&"s"!=B[0]&&Ga("unknown code: "+n);E&&1<h.length-E.start&&(E.length=h.length-E.start,L.push(E));c={};C&&(c.vertices=new Float32Array(d));F&&0<g.length&&(c.normals=new Float32Array(g));D&&0<e.length&&(c.coords=new Float32Array(e));h&&0<h.length&&(c.triangles=
new Uint16Array(h));c.bounding=Mesh.computeBounding(c.vertices);d={};1<L.length&&(d.groups=L);c.info=d;(0==c.bounding.radius||isNaN(c.bounding.radius))&&console.log("no radius found in mesh");return c}});e.Formats.registerParser({extension:"stl",type:"mesh",format:"binary",parse:function(a,b){var c=[],d=[],f=[],g=new DataView(a,80),h=g.getUint32(0,!0);console.log("number of triangles: "+h);for(var q=4,m=vec3.create(),k=vec3.create(),l=vec3.create(),r=vec3.create(),n=0;n<h;n++){for(var p=g.getFloat32(q,
!0),t=g.getFloat32(q+4,!0),u=g.getFloat32(q+8,!0),q=q+12,w=0;3>w;w++){var x=g.getFloat32(q,!0),A=g.getFloat32(q+4,!0),B=g.getFloat32(q+8,!0);c.push(x,B,-A);q+=12}0==p&&0==t&&0==u&&(p=c.length,m.set(c.slice(p-9,p-6)),k.set(c.slice(p-6,p-3)),l.set(c.slice(p-3,p)),vec3.sub(k,k,m),vec3.sub(l,l,m),vec3.cross(r,l,k),p=r[0],t=r[1],u=r[2]);d.push(p,u,-t,p,u,-t,p,u,-t);q+=2}g={info:{}};g.vertices=new Float32Array(c);0<d.length&&(g.normals=new Float32Array(d));f&&0<f.length&&(g.triangles=new Uint16Array(f));
g.bounding=e.Formats.computeMeshBounding(g.vertices);return g}});e.Formats.registerParser({extension:"tga",type:"image",dataType:"arraybuffer",format:"binary",parse:function(a,b){if(!a||a.constructor!==ArrayBuffer)throw"ParserTGA: data must be ArrayBuffer";a=new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=
c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);for(e=0;e<c.imageSize;e+=c.bytesPerPixel)d=c.pixels[e],c.pixels[e]=c.pixels[e+2],c.pixels[e+2]=d;c.flipY=!0;c.format=32==c.bpp?"BGRA":"BGR";return c}});e.Formats.registerParser({extension:"cgart",type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.faces=c.faces[0];c.normals=c.normals[0];c.vertices=c.vertices[0];c.uvs=c.uvs[0][0];for(var d=[],f=[],g=[],h=null,
q=[],m=0,k=0;m<c.faces.length;)if(43==c.faces[m]){var l=c.faces[m+5];k<l&&(k=l,null!=h&&(h.length=d.length/3-h.start,0<h.length&&q.push(h)),h={name:"mat_"+l,start:d.length/3,length:-1,material:""});var l=c.faces[m+1],r=c.faces[m+2],n=c.faces[m+3],p=c.faces[m+4];d.push(c.vertices[3*l],c.vertices[3*l+1],c.vertices[3*l+2]);d.push(c.vertices[3*r],c.vertices[3*r+1],c.vertices[3*r+2]);d.push(c.vertices[3*n],c.vertices[3*n+1],c.vertices[3*n+2]);d.push(c.vertices[3*l],c.vertices[3*l+1],c.vertices[3*l+2]);
d.push(c.vertices[3*n],c.vertices[3*n+1],c.vertices[3*n+2]);d.push(c.vertices[3*p],c.vertices[3*p+1],c.vertices[3*p+2]);l=c.faces[m+6];r=c.faces[m+7];n=c.faces[m+8];p=c.faces[m+9];g.push(c.uvs[2*l],c.uvs[2*l+1]);g.push(c.uvs[2*r],c.uvs[2*r+1]);g.push(c.uvs[2*n],c.uvs[2*n+1]);g.push(c.uvs[2*l],c.uvs[2*l+1]);g.push(c.uvs[2*n],c.uvs[2*n+1]);g.push(c.uvs[2*p],c.uvs[2*p+1]);l=c.faces[m+10];r=c.faces[m+11];n=c.faces[m+12];p=c.faces[m+13];f.push(c.normals[3*l],c.normals[3*l+1],c.normals[3*l+2]);f.push(c.normals[3*
r],c.normals[3*r+1],c.normals[3*r+2]);f.push(c.normals[3*n],c.normals[3*n+1],c.normals[3*n+2]);f.push(c.normals[3*l],c.normals[3*l+1],c.normals[3*l+2]);f.push(c.normals[3*n],c.normals[3*n+1],c.normals[3*n+2]);f.push(c.normals[3*p],c.normals[3*p+1],c.normals[3*p+2]);m+=14}else 42==c.faces[m]?(l=c.faces[m+4],k<l&&(Ga("New mat: "+l),k=l,null!=h&&(h.length=d.length/3-h.start,0<h.length&&q.push(h)),h={name:"mat_"+l,start:d.length/3,length:-1,material:""}),l=c.faces[m+1],r=c.faces[m+2],n=c.faces[m+3],d.push(c.vertices[3*
l],c.vertices[3*l+1],c.vertices[3*l+2]),d.push(c.vertices[3*r],c.vertices[3*r+1],c.vertices[3*r+2]),d.push(c.vertices[3*n],c.vertices[3*n+1],c.vertices[3*n+2]),l=c.faces[m+5],r=c.faces[m+6],n=c.faces[m+7],g.push(c.uvs[2*l],c.uvs[2*l+1]),g.push(c.uvs[2*r],c.uvs[2*r+1]),g.push(c.uvs[2*n],c.uvs[2*n+1]),l=c.faces[m+8],r=c.faces[m+9],n=c.faces[m+10],f.push(c.normals[3*l],c.normals[3*l+1],c.normals[3*l+2]),f.push(c.normals[3*r],c.normals[3*r+1],c.normals[3*r+2]),f.push(c.normals[3*n],c.normals[3*n+1],c.normals[3*
n+2]),m+=11):(Ga("Warning: unsupported primitive type: "+c.faces[m]),m+=1);h&&1<d.length-h.start&&(h.length=d.length-h.start,q.push(h));c={};c.vertices=new Float32Array(d);0<f.length&&(c.normals=new Float32Array(f));0<g.length&&(c.coords=new Float32Array(g));c.bounding=e.Formats.computeMeshBounding(c.vertices);c.info={};1<q.length&&(c.info.groups=q);Ga("Num vertex: "+d.length/3);Ga(c.info.groups);return c}});e.Formats.registerParser({extension:"gr2",type:"mesh",format:"text",parse:function(a,b){a=
a.replace(/\'/g,'"');Ga(a);a=JSON.parse("["+a+"]");window.foo=a;a=a[0];var c={vertices:a[0][2][0],normals:a[0][2][1],triangles:a[0][3]};c.bounding=e.Formats.computeMeshBounding(c.vertices);return c}});e.extendClass(D,ja);Object.defineProperty(D.prototype,"root",{enumerable:!0,get:function(){return this._root},set:function(a){throw"Root node cannot be replaced";}});D.supported_events="start update finish clear beforeReload change afterRender configure nodeAdded nodeChangeParent nodeComponentRemoved reload renderPicking scene_loaded serialize".split(" ");
D.prototype.init=function(){this.id="";this.local_repository=null;this._root.removeAllComponents();this._root.uid=e.generateUId("NODE-");this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this.info=new e.Components.GlobalInfo;this._root.addComponent(this.info);this._root.addComponent(new e.Camera);this.current_camera=this._root.camera;this._root.addComponent(new e.Light({position:vec3.fromValues(100,100,100),target:vec3.fromValues(0,
0,0)}));this._frame=0;this._last_collect_frame=-1;this._state=e.STOPPED;this._start_time=this._global_time=this._time=0;this._last_dt=1/60;this._must_redraw=!0;this.selected_node&&delete this.selected_node;this.layer_names=["main","secondary"];this.animation=null;this._local_resources={};this.extra={};this._renderer=e.Renderer};D.prototype.clear=function(){for(;this._root._children&&this._root._children.length;)this._root.removeChild(this._root._children[0],!1,!0);this._root.processActionInComponents("onRemovedFromNode",
this);this._root.processActionInComponents("onRemovedFromScene",this);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};D.prototype.configure=function(a){this._root.removeAllComponents();a.uid&&(this.uid=a.uid);"SceneTree"!=a.object_type&&console.warn("Warning: object set to scene doesnt look like a propper one.");a.local_repository&&(this.local_repository=a.local_repository);a.extra&&(this.extra=a.extra);a.root&&this.root.configure(a.root);a.nodes&&this.root.configure({children:a.nodes});
a.components&&this._root.configureComponents(a);a.camera&&(this._root.camera?this._root.camera.configure(a.camera):this._root.addComponent(new w(a.camera)));a.light?this._root.light?this._root.light.configure(a.light):this._root.addComponent(new u(a.light)):a.hasOwnProperty("light")&&this._root.light&&(this._root.removeComponent(this._root.light),this._root.light=null);a.external_scripts&&(this.external_scripts=a.external_scripts);a.layer_names&&(this.layer_names=a.layer_names);a.animation&&(this.animation=
new e.Animation(a.animation));a.components&&this.configureComponents(a);LEvent.trigger(this,"configure",a);LEvent.trigger(this,"change")};D.prototype.serialize=function(){var a={};a.uid=this.uid;a.object_type=e.getObjectClassName(this);a.local_repository=this.local_repository;a.extra=this.extra||{};a.root=this.root.serialize();this.animation&&(a.animation=this.animation.serialize());a.layer_names=this.layer_names.concat();a.external_scripts=this.external_scripts.concat();this.serializeComponents(a);
LEvent.trigger(this,"serialize",a);return a};D.prototype.load=function(a,b,c){function d(a){a.external_scripts&&a.external_scripts.length?m.loadExternalScripts(a.external_scripts,function(){f(a)},c):f(a)}function f(a){m.init();m.configure(a);m.loadResources(g);LEvent.trigger(m,"load")}function g(){b&&b(m,a);LEvent.trigger(m,"loadCompleted")}function h(b){console.warn("Error loading scene: "+a+" -> "+b);c&&c(a)}if(a){var m=this,s=e.ResourcesManager.getNoCache(!0);s&&(a+=(-1==a.indexOf("?")?"?":"&")+
s);e.Network.request({url:a,dataType:"json",success:d,error:h});LEvent.trigger(this,"beforeLoad")}};D.prototype.loadExternalScripts=function(a,b,c){e.Network.requestScript(a,b,c)};D.prototype.appendScene=function(a){a=a.root.childNodes;for(var b in a){var c=a[b],d=new e.SceneNode(c.id);this.root.addChild(d);d.configure(c.constructor==e.SceneNode?c.serialize():c)}};D.prototype.getCamera=function(){var a=this._root.camera;if(a)return a;if(this._cameras&&this._cameras.length)return this._cameras[0];
this.collectData();return this._cameras[0]};D.prototype.getLight=function(){return this._root.light};D.prototype.onNodeAdded=function(a,b){if(b._in_tree&&b._in_tree!=this)throw"Cannot add a node from other scene, clone it";b._name&&!this._nodes_by_name[b._name]&&(this._nodes_by_name[b._name]=b);b.uid||(b.uid=e.generateUId("NODE-"));this._nodes_by_uid[b.uid]=b;this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);LEvent.trigger(this,"nodeAdded",b);LEvent.trigger(this,"change")};D.prototype.onNodeRemoved=
function(a,b){var c=this._nodes.indexOf(b);if(-1!=c)return this._nodes.splice(c,1),b._name&&this._nodes_by_name[b._name]==b&&delete this._nodes_by_name[b._name],b.uid&&delete this._nodes_by_uid[b.uid],b.processActionInComponents("onRemovedFromScene",this),LEvent.trigger(this,"nodeRemoved",b),LEvent.trigger(this,"change"),!0};D.prototype.getNodes=function(){return this._nodes};D.prototype.getNode=function(a){if(""==a)return this.root;if(!a)return null;if(a.charAt(0)==e._uid_prefix)return this._nodes_by_uid[a];
if(-1!=a.indexOf("|")){a=a.split("|");for(var b=this.root,c=0;c<a.length&&b;++c)b=b.getChildByName(a[c]);return b}return this._nodes_by_name[a]};D.prototype.getNodeByName=function(a){return this._nodes_by_name[a]};D.prototype.getNodeByUId=function(a){return this._nodes_by_uid[a]};D.prototype.getNodeByIndex=function(a){return this._nodes[a]};D.prototype.getElementById=D.prototype.getNode;D.prototype.filterNodes=function(a){for(var b=[],c=0;c<this._nodes.length;++c)a(this._nodes[c])&&b.push(this._nodes[c]);
return b};D.prototype.findComponentByUId=function(a){for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponentByUId(a);if(c)return c}return null};D.prototype.findMaterialByUId=function(a){if(e.RM.materials[a])return e.RM.materials[a];for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getMaterial();if(c.uid==a)return c}return null};D.prototype.getPropertyInfo=function(a){a=a.split("/");if("@MAT-"==a[0].substr(0,5)){var b=e.RM.materials_by_uid[a[0]];return b?b.getPropertyInfoFromPath(a.slice(1)):
null}return(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):null};D.prototype.getPropertyInfoFromPath=function(a){if("@MAT-"==a[0].substr(0,5)){var b=e.RM.materials_by_uid[a[0]];return b?b.getPropertyInfoFromPath(a.slice(1)):null}return(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):null};D.prototype.setPropertyValue=function(a,b){var c=a.split("/");if("@MAT-"==c[0].substr(0,5)){var d=e.RM.materials_by_uid[c[0]];return d?d.setPropertyValueFromPath(c.slice(1),b):null}return(d=
this.getNode(c[0]))?d.setPropertyValueFromPath(c.slice(1),b):null};D.prototype.setPropertyValueFromPath=function(a,b){if("@MAT-"==a[0].substr(0,5)){var c=e.RM.materials_by_uid[a[0]];return c?c.setPropertyValueFromPath(a.slice(1),b):null}return(c=this.getNode(a[0]))?c.setPropertyValueFromPath(a.slice(1),b):null};D.prototype.loadResources=function(a){function b(){LEvent.unbind(e.ResourcesManager,"end_loading_resources",b);a&&a()}var c={},d;for(d in this.textures)this.textures[d]&&(c[this.textures[d]]=
Texture);this.light&&this.light.getResources(c);for(d in this._nodes)this._nodes[d].getResources(c);var f=0;for(d in c)++f;0==f?a&&a():(LEvent.bind(e.ResourcesManager,"end_loading_resources",b),e.ResourcesManager.loadResources(c))};D.prototype.start=function(){this._state!=e.RUNNING&&(this._state=e.RUNNING,this._start_time=0.001*getTime(),LEvent.trigger(this,"start",this),this.triggerInNodes("start"))};D.prototype.finish=function(){this._state!=e.STOPPED&&(this._state=e.STOPPED,LEvent.trigger(this,
"finish",this),this.triggerInNodes("finish"),this.purgeResidualEvents())};D.prototype.render=function(a){this._renderer.render(this,a)};D.prototype.collectData=function(){for(var a=this.getNodes(),b=[],c=[],d=[],e=[],g=0,h=a.length;g<h;++g){var m=a[g];if(!1!=m.flags.visible){LEvent.trigger(m,"computeVisibility");m.transform&&m.transform.updateGlobalMatrix();var s=new ya;LEvent.trigger(m,"computingShaderQuery",s);var k={};LEvent.trigger(m,"computingShaderUniforms",k);m._query=s;m._uniforms=k;m._instances?
m._instances.length=0:m._instances=[];LEvent.trigger(m,"collectRenderInstances",m._instances);LEvent.trigger(m,"collectPhysicInstances",e);LEvent.trigger(m,"collectLights",c);LEvent.trigger(m,"collectCameras",d);b=b.concat(m._instances)}}LEvent.trigger(this,"collectRenderInstances",b);LEvent.trigger(this,"collectPhysicInstances",e);LEvent.trigger(this,"collectLights",c);LEvent.trigger(this,"collectCameras",d);g=0;for(h=b.length;g<h;++g)a=b[g],a.flags&na||a.updateAABB();g=0;for(h=e.length;g<h;++g)e[g].updateAABB();
this._instances=b;this._lights=c;this._cameras=d;this._colliders=e;this._last_collect_frame=this._frame};D.prototype.updateCollectedData=function(){for(var a=this._nodes,b=this._instances,c=this._lights,d=this._cameras,e=this._colliders,g=0,h=a.length;g<h;++g)a[g].transform&&a[g].transform.updateGlobalMatrix();g=0;for(h=b.length;g<h;++g)a=b[g],a.flags&eb&&a.update(),a.flags&na||a.updateAABB();g=0;for(h=c.length;g<h;++g);g=0;for(h=d.length;g<h;++g);g=0;for(h=e.length;g<h;++g)e[g].updateAABB()};D.prototype.update=
function(a){LEvent.trigger(this,"beforeUpdate",this);this._global_time=0.001*getTime();this._time=this._global_time-this._start_time;this._last_dt=a;LEvent.trigger(this,"update",a);this.triggerInNodes("update",a,!0);LEvent.trigger(this,"afterUpdate",this)};D.prototype.triggerInNodes=function(a,b){LEvent.triggerArray(this._nodes,a,b)};D.prototype.generateUniqueNodeName=function(a){a=a||"node";var b=1,c=a.lastIndexOf("_");if(c){var d=a.substr(c+1);parseInt(d)&&(b=parseInt(d),a=a.substr(0,c))}for(c=
a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};D.prototype.refresh=function(){this._must_redraw=!0};D.prototype.getTime=function(){return this._time};D.prototype.purgeResidualEvents=function(){if(this.__events)for(var a in this.__events){var b=this.__events[a];if(b){for(var c=[],d=0;d<b.length;++d){var f=b[d][1];!f||!e.isClassComponent(f.constructor)||f._root&&f._root.scene===this?c.push(b[d]):console.warn("Event attached to the Scene belongs to a removed node, purged. Event:",a,"Class:",e.getObjectClassName(f))}this.__events[a]=
c}}};D.prototype.getLayerNames=function(a){for(var b=[],c=0;32>c;++c)(void 0===a||a&1<<c)&&b.push(this.layer_names[c]||"layer"+c);return b};D.prototype.findNodeComponents=function(a){if(a){var b=null;if(b=a.constructor===String?e.Components[a]:a){a=[];for(var c=e.GlobalScene._nodes,d=0;d<c.length;++d)for(var f=c[d]._components,g=0;g<f.length;++g)f[g].constructor===b&&a.push(f[g]);return a}}};e.SceneTree=D;e.extendClass(G,ja);e.extendClass(G,Z);Object.defineProperty(G.prototype,"name",{set:function(a){this.setName(a)},
get:function(){return this._name},enumerable:!0});Object.defineProperty(G.prototype,"uid",{set:function(a){a&&(a[0]!=e._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=e._uid_prefix+a),a!=this._uid&&(this._in_tree&&this._in_tree._nodes_by_uid[this.uid]&&delete this._in_tree._nodes_by_uid[this.uid],this._uid=a,this._in_tree&&(this._in_tree._nodes_by_uid[this.uid]=this)))},get:function(){return this._uid},enumerable:!0});Object.defineProperty(G.prototype,"visible",{set:function(a){this.flags.visible=
a},get:function(){return this.flags.visible},enumerable:!0});Object.defineProperty(G.prototype,"material",{set:function(a){(this._material=a)&&a.constructor!==String&&(a._root&&a._root!=this?console.warn("Cannot assign a material of one SceneNode to another, you must clone it or register it"):a._root=this)},get:function(){return this._material},enumerable:!0});G.prototype.setName=function(a){if(this._name==a)return!0;if(!e.validateName(a))return!1;var b=this._in_tree;if(!b)return this._name=a,!0;
this._name&&delete b._nodes_by_name[this._name];(this._name=a)&&!b._nodes_by_name[a]&&(b._nodes_by_name[this._name]=this);LEvent.trigger(this,"name_changed",a);b&&LEvent.trigger(b,"node_name_changed",this);return!0};Object.defineProperty(G.prototype,"classList",{get:function(){return this._classList},set:function(a){},enumerable:!1});Object.defineProperty(G.prototype,"className",{get:function(){var a=null;if(Object.keys)a=Object.keys(this._classList);else{var a=[],b;for(b in this._classList)a.push(b)}return a.join(" ")},
set:function(a){this._classList={};if(a){a=a.split(" ");for(var b in a)this._classList[a[b]]=!0}},enumerable:!0});G.prototype.getLocator=function(){return this.uid};G.prototype.getPropertyInfo=function(a){a=a.split("/");return this.getPropertyInfoFromPath(a)};G.prototype.getPropertyInfoFromPath=function(a){var b=this,c=a[0];if(0==a.length)return{node:this,target:null,name:"",value:this,type:"node"};if(1==a.length){if("@"==a[0][0])return b=this.getComponentByUId(a[0]),{node:this,target:b,name:b?e.getObjectClassName(b):
"",type:"component",value:b};if("material"==a[0])return b=this.getMaterial(),{node:this,target:b,name:b?e.getObjectClassName(b):"",type:"material",value:b};if(b=this.getComponent(a[0]))return{node:this,target:b,name:b?e.getObjectClassName(b):"",type:"component",value:b};switch(a[0]){case "matrix":case "x":case "y":case "z":b=this.transform;c=a[0];break;default:b=this,c=a[0]}}else if(1<a.length&&("@"==a[0][0]?(c=a[1],b=this.getComponentByUId(a[0])):(b="material"==a[0]?this.getMaterial():"flags"==a[0]?
this.flags:this.getComponent(a[0]),c=a[1]),!b))return null;var d=void 0;if(b.getPropertyInfoFromPath&&b!=this&&(a=b.getPropertyInfoFromPath(a.slice(1))))return a;b.getPropertyValue&&(d=b.getPropertyValue(c));if(void 0===d&&void 0===b[c])return null;d=void 0!==d?d:b[c];a=b.constructor["@"+c];var f="";a&&(f=a.type);f||null===d||void 0===d||(d.constructor===String?f="string":d.constructor===Boolean?f="boolean":d.length?f="vec"+d.length:d.constructor===Number&&(f="number"));return{node:this,target:b,
name:c,value:d,type:f}};G.prototype.setPropertyValue=function(a,b){var c=a.split("/");return this.setPropertyValueFromPath(c,b)};G.prototype.setPropertyValueFromPath=function(a,b){var c=null,d=a[0];if(1<a.length){if("@"==a[0][0]?(d=a[1],c=this.getComponentByUId(a[0])):(c="material"==a[1]?this.getMaterial():"flags"==a[1]?this.flags:this.getComponent(a[0]),d=a[1]),!c)return null}else switch(a[0]){case "matrix":c=this.transform;break;case "x":case "translate.X":c=this.transform;d="x";break;case "y":case "translate.Y":c=
this.transform;d="y";break;case "z":case "translate.Z":c=this.transform;d="z";break;case "rotateX.ANGLE":c=this.transform;d="pitch";break;case "rotateY.ANGLE":c=this.transform;d="yaw";break;case "rotateZ.ANGLE":c=this.transform;d="roll";break;default:c=this}if(!c)return null;if(c.setPropertyValueFromPath&&c!=this&&!0===c.setPropertyValueFromPath(a.slice(1),b)||c.setPropertyValue&&c!=this&&!0===c.setPropertyValue(d,b))return c;if(void 0!==c[d])return c[d]=b,c};G.prototype.getResources=function(a,b){for(var c in this._components)this._components[c].getResources&&
this._components[c].getResources(a);if(this.material)if("string"==typeof this.material)":"!=this.material[0]&&(a[this.material]=e.Material);else{var d=this.getMaterial();d&&d.getResources(a)}this.prefab&&(a[this.prefab]=e.Prefab);if(b)for(c in this._children)this._children[c].getResources(a,!0);return a};G.prototype.getTransform=function(){return this.transform};G.prototype.getMesh=function(){var a=this.mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.mesh);return a?a.constructor===String?ba.meshes[a]:
a:null};G.prototype.getLight=function(){return this.light};G.prototype.getCamera=function(){return this.camera};G.prototype.getLODMesh=function(){var a=this.lod_mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.lod_mesh);return a?a.constructor===String?ba.meshes[a]:a:null};G.prototype.setMesh=function(a,b){this.meshrenderer?"string"==typeof a?this.meshrenderer.configure({mesh:a,submesh_id:b}):this.meshrenderer.mesh=a:this.addComponent(new e.MeshRenderer({mesh:a,submesh_id:b}))};G.prototype.loadAndSetMesh=
function(a,b){b=b||{};if(e.ResourcesManager.meshes[a]||!a){if(this.setMesh(a),b.on_complete)b.on_complete(e.ResourcesManager.meshes[a],this)}else{var c=this;e.ResourcesManager.load(a,b,function(a){c.setMesh(a.filename);c.loading-=1;0==c.loading&&(LEvent.trigger(c,"resource_loaded",c),delete c.loading);if(b.on_complete)b.on_complete(a,c)})||(this.loading?this.loading+=1:(this.loading=1,LEvent.trigger(this,"resource_loading")))}};G.prototype.getMaterial=function(){return this.material?this.material.constructor===
String?this._in_tree?e.ResourcesManager.materials[this.material]:null:this.material:null};G.prototype.setPrefab=function(a){this._prefab_name=a};G.prototype.setLayer=function(a,b){var c=1<<a;this.layers&=~c;b&&(this.layers|=c)};G.prototype.isInLayer=function(a){return 0!==(this.layers&1<<a)};G.prototype.getLayers=function(){var a=[];if(!this.scene)return a;for(var b=0;32>b;++b)this.layers&1<<b&&a.push(this.scene.layer_names[b]||"layer"+b);return a};G.prototype.clone=function(){var a=this._in_tree,
a=a?a.generateUniqueNodeName(this._name):this._name,a=new e.SceneNode(a),b=this.serialize();e.clearUIds(b);b.uid=e.generateUId("NODE-");a.configure(b);return a};G.prototype.configure=function(a){a.name?this.setName(a.name):a.id&&this.setName(a.id);void 0!==a.layers&&(this.layers=a.layers);a.uid&&(this.uid=a.uid);a.className&&a.className.constructor==String&&(this.className=a.className);if(a.mesh){var b=a.mesh,c=e.ResourcesManager.meshes[b],b={mesh:b};void 0!==a.submesh_id&&(b.submesh_id=a.submesh_id);
void 0!==a.morph_targets&&(b.morph_targets=a.morph_targets);b=new e.Components.MeshRenderer(b);"line_strip"===c.primitive&&(b.primitive=3,delete c.primitive);this.addComponent(b);c&&c.bones&&(b=new e.Components.SkinDeformer,this.addComponent(b));c&&c.morph_targets&&(b=new e.Components.MorphDeformer({morph_targets:c.morph_targets}),this.addComponent(b))}a.model&&this.transform.fromMatrix(a.model);a.material&&((c=a.material.material_class)||(c="Material"),this.material="string"==typeof a.material?a.material:
new e.MaterialClasses[c](a.material));if(a.flags)for(var d in a.flags)this.flags[d]=a.flags[d];a.prefab&&(this.prefab=a.prefab);a.animations&&(this.animations=a.animations,this.addComponent(new e.Components.PlayAnimation({animation:this.animations})));a.extra&&(this.extra=a.extra);a.comments&&(this.comments=a.comments);a.components&&this.configureComponents(a);this.configureChildren(a);LEvent.trigger(this,"configure",a)};G.prototype.serialize=function(){var a={};this._name&&(a.name=this._name);this.uid&&
(a.uid=this.uid);this.className&&(a.className=this.className);a.layers=this.layers;this.mesh&&"string"==typeof this.mesh&&(a.mesh=this.mesh);null!=this.submesh_id&&(a.submesh_id=this.submesh_id);this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());this.prefab&&(a.prefab=this.prefab);this.flags&&(a.flags=e.cloneObject(this.flags));this.extra&&(a.extra=this.extra);this.comments&&(a.comments=this.comments);this._children&&(a.children=this.serializeChildren());
this.serializeComponents(a);LEvent.trigger(this,"serialize",a);return a};G.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c));a.transform.getGlobalMatrix()}this.transform&&(a.transform._parent=this.transform)};G.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=this.transform.getGlobalMatrix(),d=a.transform.getGlobalMatrix();mat4.invert(d,d);
this.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform&&(this.transform._parent=a.transform)};G.prototype._onChildRemoved=function(a,b,c){this.transform&&(b?(b=a.transform.getGlobalMatrix(),a.transform._parent=null,a.transform.fromMatrix(b)):a.transform._parent=null);c&&a.removeAllComponents()};G.prototype.getBoundingBox=function(a,b){a=a||BBox.create();var c=this._instances;if(c)for(var d=0;d<c.length;++d)0==d?a.set(c[d].aabb):BBox.merge(a,a,c[d].aabb);return b?a:c&&0!=c.length||!this.transform?
a:BBox.fromPoint(this.transform.getGlobalPosition())};e.SceneNode=G;xa.prototype.loadScene=function(a,b){var c=this;this.scene.load(a,function(){c.autoplay&&c.play();console.log("Scene playing");b&&b()})};xa.prototype.setScene=function(a,b){var c=this,d=this.scene;"string"==typeof a&&(a=JSON.parse(a));d.configure(a);d.loadResources(function(){c.autoplay&&c.play();d._must_redraw=!0;console.log("Scene playing");b&&b()})};xa.prototype.pause=function(){this.state="paused"};xa.prototype.play=function(){this.state=
"playing";this.scene.start()};xa.prototype.stop=function(){this.state="stopped";this.scene.finish()};xa.prototype._ondraw=function(){if("playing"==this.state){if(this.onPreDraw)this.onPreDraw();var a=this.scene;(a._must_redraw||this.force_redraw)&&a.render(this.render_settings);if(this.onDraw)this.onDraw();void 0!==this.loading_bar&&this.renderLoadingBar()}};xa.prototype._onupdate=function(a){if("playing"==this.state){if(this.onPreUpdate)this.onPreUpdate(a);this.scene.update(a);if(this.onUpdate)this.onUpdate(a)}};
xa.prototype._onmouse=function(a){if("playing"==this.state&&(LEvent.trigger(this.scene,a.eventType,a),this.onMouse))this.onMouse(a)};xa.prototype._onkey=function(a){"playing"!=this.state||this.onKey&&this.onKey(a)||LEvent.trigger(this.scene,a.eventType,a)};xa.prototype.renderLoadingBar=function(){window.enableWebGLCanvas&&(gl.canvas.canvas2DtoWebGL_enabled&&enableWebGLCanvas(gl.canvas),gl.start2D(),gl.fillStyle=[0,0,0,0.5],gl.fillRect(0,0,gl.drawingBufferWidth,6),gl.fillColor=this.loadingbar_color||
[0.9,0.5,1,1],gl.fillRect(0,0,gl.drawingBufferWidth*this.loading_bar,6),gl.finish2D())};e.Player=xa;e.getCurveValueAt=function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var g=0,g=0;g<a.length;g+=1){var h=a[g];if(e==h[0])return h[1];if(e<h[0])return g=(e-b[0])/(h[0]-b[0]),b[1]*(1-g)+h[1]*g;b=h}h=[c,d];g=(e-b[0])/(h[0]-b[0]);return b[1]*(1-g)+h[1]*g};e.resampleCurve=function(a,b,c,d,f){var g=[];g.length=f;for(var h=(c-b)/f,m=0;m<f;m++)g[m]=e.getCurveValueAt(a,b,c,d,b+h*m);return g};Object.prototype.hasOwnProperty("defineAttribute")||
(Object.defineProperty(Object.prototype,"defineAttribute",{value:function(a,b,c){c&&"string"==typeof c&&(c={type:c});var d=this;"function"!=typeof this&&(this[a]=b,d=this.constructor);Object.defineProperty(d,"@"+a,{value:c||{},enumerable:!1})},enumerable:!1}),Object.defineProperty(Object.prototype,"getAttribute",{value:function(a){a="@"+a;return this.hasOwnProperty(a)?this[a]:this.constructor&&this.constructor.hasOwnProperty(a)?this.constructor[a]:null},enumerable:!1}));Object.defineProperty(Object.prototype,
"merge",{value:function(a){for(var b in a)this[b]=a[b];return this},configurable:!1,writable:!1,enumerable:!1});String.prototype.hashCode=function(){var a=0,b,c,d;if(0==this.length)return a;b=0;for(d=this.length;b<d;++b)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};Object.equals=function(a,b){if(a===b)return!0;if(!(a instanceof Object&&b instanceof Object)||a.constructor!==b.constructor)return!1;for(var c in a)if(a.hasOwnProperty(c)&&(!b.hasOwnProperty(c)||a[c]!==b[c]&&("object"!==typeof a[c]||
!Object.equals(a[c],b[c]))))return!1;for(c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c))return!1;return!0};var bb=e.GlobalScene=new D;e.newMeshNode=function(a,b){var c=new e.SceneNode(a);c.addComponent(new e.Components.MeshRenderer);c.setMesh(b);return c};e.newLightNode=function(a){a=new e.SceneNode(a);a.addComponent(new e.Components.Light);return a};e.newCameraNode=function(a){a=new e.SceneNode(a);a.addComponent(new e.Components.Camera);return a};Wa.LS=e})("undefined"!=typeof window?window:
self);
