'use strict';(function(r){function O(f,e){this.handler=null;this._old_viewport=new Float32Array(4);this.setTextures(f,e)}var n=r.GL={};r.requestAnimationFrame=r.requestAnimationFrame||r.mozRequestAnimationFrame||r.webkitRequestAnimationFrame||function(f){setTimeout(f,1E3/60)};n.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};n.LEFT_MOUSE_BUTTON=1;n.RIGHT_MOUSE_BUTTON=3;n.MIDDLE_MOUSE_BUTTON=2;n.last_context_id=0;n.BYTE=5120;n.UNSIGNED_BYTE=5121;n.SHORT=5122;n.UNSIGNED_SHORT=5123;n.INT=5124;n.UNSIGNED_INT=
5125;n.FLOAT=5126;n.ZERO=0;n.ONE=1;n.SRC_COLOR=768;n.ONE_MINUS_SRC_COLOR=769;n.SRC_ALPHA=770;n.ONE_MINUS_SRC_ALPHA=771;n.DST_ALPHA=772;n.ONE_MINUS_DST_ALPHA=773;n.DST_COLOR=774;n.ONE_MINUS_DST_COLOR=775;n.SRC_ALPHA_SATURATE=776;n.CONSTANT_COLOR=32769;n.ONE_MINUS_CONSTANT_COLOR=32770;n.CONSTANT_ALPHA=32771;n.ONE_MINUS_CONSTANT_ALPHA=32772;r.DEG2RAD=0.0174532925;r.RAD2DEG=57.295779578552306;r.EPSILON=1E-6;r.isPowerOfTwo=n.isPowerOfTwo=function(f){return 0==Math.log(f)/Math.log(2)%1};r.getTime="undefined"!=
typeof performance?performance.now.bind(performance):Date.now.bind(Date);n.getTime=r.getTime;r.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)};r.isArray=function(f){return f&&f.constructor===Array};r.isNumber=function(f){return null!=f&&f.constructor===Number};r.cloneObject=n.cloneObject=function(f,e){if(f.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";e=e||{};for(var a in f){var b=f[a];if(null===b)e[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[a]=
new b.constructor(b);break;case Boolean:case Number:case String:e[a]=b;break;case Array:e[a]=b.concat();break;case Object:e[a]=n.cloneObject(b)}}return e};r.regexMap=function(f,e,a){for(var b;null!=(b=f.exec(e));)a(b)};r.createCanvas=n.createCanvas=function(f,e){var a=document.createElement("canvas");a.width=f;a.height=e;return a};r.cloneCanvas=n.cloneCanvas=function(f){var e=document.createElement("canvas");e.width=f.width;e.height=f.height;e.getContext("2d").drawImage(f,0,0);return e};"undefined"!=
typeof Image&&(Image.prototype.getPixels=function(){var f=document.createElement("canvas");f.width=this.width;f.height=this.height;f=f.getContext("2d");f.drawImage(this,0,0);return f.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(f){var e=this,a;for(a in f)e=e.split(a).join(f[a]);return e},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,
"hashCode",{value:function(){var f=0,e,a,b;if(0==this.length)return f;e=0;for(b=this.length;e<b;++e)a=this.charCodeAt(e),f=(f<<5)-f+a,f|=0;return f},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});r.wipeObject=function(f){for(var e in f)f.hasOwnProperty(e)&&delete f[e]};r.extendClass=n.extendClass=function(f,e){for(var a in e)f.hasOwnProperty(a)||(f[a]=e[a]);if(e.prototype)for(a in e.prototype)e.prototype.hasOwnProperty(a)&&
!f.prototype.hasOwnProperty(a)&&(e.prototype.__lookupGetter__(a)?f.prototype.__defineGetter__(a,e.prototype.__lookupGetter__(a)):f.prototype[a]=e.prototype[a],e.prototype.__lookupSetter__(a)&&f.prototype.__defineSetter__(a,e.prototype.__lookupSetter__(a)));f.hasOwnProperty("superclass")||Object.defineProperty(f,"superclass",{get:function(){return e},enumerable:!1})};r.HttpRequest=n.request=function(f,e,a,b,c){if(e){var d=null,d=[],g;for(g in e)d.push(g+"="+e[g]);d=d.join("&");f=f+"?"+d}var h=new XMLHttpRequest;
h.open("GET",f,!c);h.onload=function(){200!=this.status?(w.trigger(h,"fail",this.status),b&&b(this.status)):(w.trigger(h,"done",this.response),a&&a(this.response))};h.onerror=function(a){w.trigger(h,"fail",a)};h.send();return h};XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(f){w.bind(this,"done",function(e,a){f(a)});return this}});XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,
"fail",{enumerable:!1,value:function(f){w.bind(this,"fail",function(e,a){f(a)});return this}});r.getFileExtension=function(f){var e=f.indexOf("?");-1!=e&&(f=f.substr(0,e));e=f.lastIndexOf(".");return-1==e?"":f.substr(e+1).toLowerCase()};r.loadFileAtlas=n.loadFileAtlas=function(f,e,a){function b(a,b){function c(){var a=q.join("\n");f[m]=a;q.length=0;m=u.substr(1)}for(var e=a.split("\n"),f={},q=[],m="",n=0,p=e.length;n<p;n++){var u=e[n].trim();u.length&&("\\"==u[0]?m?c():m=u.substr(1):q.push(u))}m&&
c();return f}var c=null;HttpRequest(f,null,function(a){a=b(a);e&&e(a);c&&c(a)},alert,a);return{done:function(a){c=a}}};r.hexColorToRGBA=function(){var f={white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],green:[0,0.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,
0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var c=f[e];if(void 0!==c)a.set(c),a[3]=3==a.length?b:a[3]*b;else{c=e.indexOf("rgba(");if(-1!=c)return e=e.substr(5),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;a[3]=b;c=e.indexOf("rgb(");
if(-1!=c)return e=e.substr(3),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,e){return b+b+c+c+e+e});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}}();var P=function(){function f(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function e(a,
b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),g=0,h=0,k=0,l=h=g=0,m=0,q=0,p=0,z=c/4;d/=4;for(var n=0;n<d;n++)for(var t=0;t<z;t++)k=b+4*(n*z+t),e[0]=a[k],e[1]=a[k+1],g=e[0]&31,h=e[0]&2016,l=e[0]&63488,m=e[1]&31,q=e[1]&2016,p=e[1]&63488,e[2]=5*g+3*m>>3|5*h+3*q>>3&2016|5*l+3*p>>3&63488,e[3]=5*m+3*g>>3|5*q+3*h>>3&2016|5*p+3*l>>3&63488,g=a[k+2],h=4*n*c+4*t,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&3],h+=c,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],f[h+3]=e[g>>14],g=a[k+
3],h+=c,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&3],h+=c,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],f[h+3]=e[g>>14];return f}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,f){var E=new Int32Array(d,0,p),F,y,A,B,C,H,M,G,w;if(E[u]!=g)return console.error("Invalid magic number in DDS header"),0;if(!E[r]&l)return console.error("Unsupported format, must contain a FourCC code"),0;F=E[I];switch(F){case q:y=8;A=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:
null;break;case m:y=16;A=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case n:y=16;A=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:y=4,F=null,A=b.RGBA}M=1;E[z]&h&&!1!==f&&(M=Math.max(1,E[K]));B=E[J];C=E[t];H=E[s]+4;if(E[N+1]&k)for(w=0;6>w;++w)for(B=E[J],C=E[t],G=0;G<M;++G)F?(f=Math.max(4,B)/4*Math.max(4,C)/4*y,c=new Uint8Array(d,H,f),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+w,G,A,B,C,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),f=B*C*y,c=new Uint8Array(d,H,f),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+
w,G,A,B,C,0,b.RGBA,b.UNSIGNED_BYTE,c)),H+=f,B*=0.5,C*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),G=0;G<M;++G)F?(f=Math.max(4,B)/4*Math.max(4,C)/4*y,c=new Uint8Array(d,H,f),b.compressedTexImage2D(b.TEXTURE_2D,G,A,B,C,0,c)):(f=B*C*y,c=new Uint8Array(d,H,f),a(c),b.texImage2D(b.TEXTURE_2D,G,A,B,C,0,A,b.UNSIGNED_BYTE,c)),H+=f,B*=0.5,C*=0.5;else if(F==q)Math.max(4,B),Math.max(4,C),c=new Uint16Array(d),d=e(c,H/2,B,C),b.texImage2D(b.TEXTURE_2D,0,b.RGB,B,C,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),
f&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(F&255,F>>8&255,F>>16&255,F>>24&255),"and no native support"),0;return M}function c(b,c){var d=new Int32Array(b,0,p),f,E,F,y,A,B,C,H,w,G,D;if(d[u]!=g)return console.error("Invalid magic number in DDS header"),0;if(!d[r]&l)return console.error("Unsupported format, must contain a FourCC code"),0;f=d[I];switch(f){case q:E=8;F="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case m:E=16;F="COMPRESSED_RGBA_S3TC_DXT3_EXT";
break;case n:E=16;F="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:E=4,F="RGBA"}w=1;d[z]&h&&!1!==loadMipmaps&&(w=Math.max(1,d[K]));y=d[J];A=d[t];C=d[s]+4;var R=[];if(d[N+1]&k)for(D=0;6>D;++D)for(y=d[J],A=d[t],G=0;G<w;++G)f?(B=Math.max(4,y)/4*Math.max(4,A)/4*E,new Uint8Array(b,C,B),R.push({tex:"TEXTURE_CUBE_MAP",face:D,mipmap:G,internalFormat:F,width:y,height:A,offset:0,dataOffset:C,dataLength:B})):(B=y*A*E,H=new Uint8Array(b,C,B),a(H),R.push({tex:"TEXTURE_CUBE_MAP",face:D,mipmap:G,internalFormat:F,
width:y,height:A,offset:0,type:"UNSIGNED_BYTE",dataOffset:C,dataLength:B})),C+=B,y*=0.5,A*=0.5;else if(c)if(f==q)Math.max(4,y),Math.max(4,A),H=new Uint16Array(b),d=e(H,C/2,y,A),R.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:y,height:A,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(f&255,f>>8&255,f>>16&255,f>>24&255),"and no native support"),0;else for(G=0;G<w;++G)B=Math.max(4,y)/4*Math.max(4,A)/4*E,new Uint8Array(b,
C,B),R.push({tex:"TEXTURE_2D",mipmap:G,internalFormat:F,width:y,height:A,offset:0,type:"UNSIGNED_BYTE",dataOffset:C,dataLength:B}),C+=B,y*=0.5,A*=0.5;return R}function d(a,c,d,e,f,g){var h=new XMLHttpRequest;h.open("GET",d,!0);h.responseType="arraybuffer";h.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,p),h=d[N+1]&k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(h,e);var l=b(a,c,this.response,f);a.texParameteri(h,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(h,a.TEXTURE_MIN_FILTER,
1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(h,null);e.texture_type=h;e.width=d[J];e.height=d[t]}g&&g(e)};h.send(null);return e}var g=542327876,h=131072,k=512,l=4,q=f("DXT1"),m=f("DXT3"),n=f("DXT5"),p=31,u=0,s=1,z=2,t=3,J=4,K=7,r=20,I=21,N=27;return{dxtToRgb565:e,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,
0,p),h=!!(g[N+1]&k),l=h?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(l,e.handler);c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);h&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=g[J],e.height=g[t]);return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,p),d=b[N+1]&k?"TEXTURE_CUBE_MAP":
"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[J],height:b[t]}}}}();"undefined"!=typeof r&&(r.DDS=P);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(f,e,a){return e>f?e:a<f?a:f};vec2.rotate=function(f,e,a){var b=e[0];e=e[1];var c=Math.cos(a);a=Math.sin(a);f[0]=b*c-e*a;f[1]=b*a+e*c;return f};vec3.zero=function(f){f[0]=f[1]=f[2]=0;return f};vec3.minValue=function(f){return f[0]<f[1]&&f[0]<f[2]?f[0]:f[1]<f[2]?f[1]:f[2]};vec3.maxValue=function(f){return f[0]>
f[1]&&f[0]>f[2]?f[0]:f[1]>f[2]?f[1]:f[2]};vec3.minValue=function(f){return f[0]<f[1]&&f[0]<f[2]?f[0]:f[1]<f[2]?f[1]:f[2]};vec3.addValue=function(f,e,a){f[0]=e[0]+a;f[1]=e[1]+a;f[2]=e[2]+a};vec3.subValue=function(f,e,a){f[0]=e[0]-a;f[1]=e[1]-a;f[2]=e[2]-a};vec3.toArray=function(f){return[f[0],f[1],f[2]]};vec3.rotateX=function(f,e,a){var b=e[1],c=e[2],d=Math.cos(a);a=Math.sin(a);f[0]=e[0];f[1]=b*d-c*a;f[2]=b*a+c*d;return f};vec3.rotateY=function(f,e,a){var b=e[0],c=e[2],d=Math.cos(a);a=Math.sin(a);
f[0]=b*d-c*a;f[1]=e[1];f[2]=b*a+c*d;return f};vec3.rotateZ=function(f,e,a){var b=e[0],c=e[1],d=Math.cos(a);a=Math.sin(a);f[0]=b*d-c*a;f[1]=b*a+c*d;f[2]=e[2];return f};vec2.perpdot=function(f,e){return f[1]*e[0]+-f[0]*e[1]};vec2.computeSignedAngle=function(f,e){return Math.atan2(vec2.perpdot(f,e),vec2.dot(f,e))};vec2.random=function(f){f[0]=Math.random();f[1]=Math.random();return f};vec3.angle=function(f,e){return Math.acos(vec3.dot(f,e))};vec3.random=function(f){f[0]=Math.random();f[1]=Math.random();
f[2]=Math.random();return f};vec4.random=function(f){f[0]=Math.random();f[1]=Math.random();f[2]=Math.random();f[3]=Math.random();return f};vec3.polarToCartesian=function(f,e){var a=e[0],b=e[1],c=e[2];f[0]=a*Math.cos(b)*Math.sin(c);f[1]=a*Math.sin(b);f[2]=a*Math.cos(b)*Math.cos(c);return f};mat4.toArray=function(f){return[f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],f[9],f[10],f[11],f[12],f[13],f[14],f[15]]};mat4.setUpAndOrthonormalize=function(f,e,a){e!=f&&mat4.copy(f,e);e=f.subarray(0,3);vec3.normalize(f.subarray(4,
7),a);f=f.subarray(8,11);vec3.cross(e,a,f);vec3.normalize(e,e);vec3.cross(f,e,a);vec3.normalize(f,f)};mat4.multiplyVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];f[0]=e[0]*b+e[4]*c+e[8]*a+e[12];f[1]=e[1]*b+e[5]*c+e[9]*a+e[13];f[2]=e[2]*b+e[6]*c+e[10]*a+e[14];return f};mat4.projectVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];var d=e[1]*b+e[5]*c+e[9]*a+e[13],g=e[2]*b+e[6]*c+e[10]*a+e[14],h=e[3]*b+e[7]*c+e[11]*a+e[15];f[0]=((e[0]*b+e[4]*c+e[8]*a+e[12])/h+1)/2;f[1]=(d/h+1)/2;f[2]=(g/h+1)/2;return f};
vec3.project=function(f,e,a,b){b=b||gl.viewport_data;var c=e[0],d=e[1];e=e[2];var g=a[3]*c+a[7]*d+a[11]*e+a[15],h=1-((a[1]*c+a[5]*d+a[9]*e+a[13])/g+1)/2;f[0]=((a[0]*c+a[4]*d+a[8]*e+a[12])/g+1)/2*b[2]+b[0];f[1]=h*b[3]+b[1];f[2]=g;return f};var T=mat4.create(),D=vec4.create();vec3.unproject=function(f,e,a,b){D[0]=2*(e[0]-b[0])/b[2]-1;D[1]=2*(e[1]-b[1])/b[3]-1;D[2]=2*e[2]-1;D[3]=1;if(!mat4.invert(T,a))return null;vec4.transformMat4(D,D,T);if(0===D[3])return null;f[0]=D[0]/D[3];f[1]=D[1]/D[3];f[2]=D[2]/
D[3];return f};mat4.rotateVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];f[0]=e[0]*b+e[4]*c+e[8]*a;f[1]=e[1]*b+e[5]*c+e[9]*a;f[2]=e[2]*b+e[6]*c+e[10]*a;return f};mat4.fromTranslationFrontTop=function(f,e,a,b){vec3.cross(f.subarray(0,3),a,b);f.set(b,4);f.set(a,8);f.set(e,12);return f};mat4.translationMatrix=function(f){var e=mat4.create();e[12]=f[0];e[13]=f[1];e[14]=f[2];return e};mat4.setTranslation=function(f,e){f[12]=e[0];f[13]=e[1];f[14]=e[2];return f};mat4.getTranslation=function(f,e){f[0]=e[12];
f[1]=e[13];f[2]=e[14];return f};mat4.toRotationMat4=function(f,e){mat4.copy(f,e);f[12]=f[13]=f[14]=0;return f};mat4.swapRows=function(f,e,a,b){if(f!=e)return mat4.copy(f,e),f[4*a]=e[4*b],f[4*a+1]=e[4*b+1],f[4*a+2]=e[4*b+2],f[4*a+3]=e[4*b+3],f[4*b]=e[4*a],f[4*b+1]=e[4*a+1],f[4*b+2]=e[4*a+2],f[4*b+3]=e[4*a+3],f;e=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(e,4*b);return f};mat4.scaleAndAdd=function(f,e,a,b){f[0]=e[0]+a[0]*b;f[1]=e[1]+a[1]*b;f[2]=e[2]+
a[2]*b;f[3]=e[3]+a[3]*b;f[4]=e[4]+a[4]*b;f[5]=e[5]+a[5]*b;f[6]=e[6]+a[6]*b;f[7]=e[7]+a[7]*b;f[8]=e[8]+a[8]*b;f[9]=e[9]+a[9]*b;f[10]=e[10]+a[10]*b;f[11]=e[11]+a[11]*b;f[12]=e[12]+a[12]*b;f[13]=e[13]+a[13]*b;f[14]=e[14]+a[14]*b;f[15]=e[15]+a[15]*b;return f};quat.toEuler=function(f,e){var a=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*e[1]-2*e[2]*e[2]),b=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),c=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);f||(f=vec3.create());vec3.set(f,a,b,c);return f};
quat.fromEuler=function(f,e){var a=e[0],b=e[1],c=e[2],d=Math.cos(a),g=Math.cos(b),h=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),k=0.5*Math.sqrt(1+d*g+d*h-a*b*c+g*h);quat.set(f,(g*c+d*c+a*b*h)/(4*k),(a*g+a*h+d*b*c)/(4*k),(-a*c+d*b*h+b)/(4*k),k);return f};quat.fromMat4=function(f,e){var a=e[0]+e[5]+e[10];if(0<a){var b=Math.sqrt(a+1);f[3]=0.5*b;b=0.5/b;f[0]=(e[9]-e[6])*b;f[1]=(e[2]-e[8])*b;f[2]=(e[4]-e[1])*b}else{a=0;e[5]>e[0]&&(a=1);e[10]>e[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(e[4*
a+a]-e[4*c+c]-e[4*d+d]+1);f[a]=0.5*b;b=0.5/b;f[3]=(e[4*d+c]-e[4*c+d])*b;f[c]=(e[4*c+a]+e[4*a+c])*b;f[d]=(e[4*d+a]+e[4*a+d])*b}quat.normalize(f,f)};n.Indexer=function(){this.unique=[];this.indices=[];this.map={}};n.Indexer.prototype={add:function(f){var e=JSON.stringify(f);e in this.map||(this.map[e]=this.unique.length,this.unique.push(f));return this.map[e]}};r.Buffer=n.Buffer=function(f,e,a,b,c){c=c||r.gl;this.buffer=null;this.target=f;this.gl=c;this.data=e;this.spacing=a||3;this.data&&this.upload(b)};
n.Buffer.prototype.forEach=function(f){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)f(e.subarray(a,a+b),a);return this};n.Buffer.prototype.applyTransform=function(f){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)b=e.subarray(a,a+b),vec3.transformMat4(b,b,f);return this};n.Buffer.prototype.upload=function(f){var e=this.spacing||3,a=this.gl;if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";this.buffer=this.buffer||a.createBuffer();
this.buffer.length=b.length;this.buffer.spacing=e;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";
}a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,f||this.stream_type||a.STATIC_DRAW)};n.Buffer.prototype.compile=n.Buffer.prototype.upload;n.Buffer.prototype.uploadRange=function(f,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,f,e),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,f,a)};r.Mesh=n.Mesh=function(f,e,a,b){this.gl=b=b||r.gl;this._context_id=
b.context_id;this.vertexBuffers={};this.indexBuffers={};(f||e)&&this.addBuffers(f,e);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",
type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Mesh.prototype.addBuffer=function(f,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[f]=e:this.indexBuffers[f]=e;e.attribute||(e.attribute=n.Mesh.common_buffers[f].attribute)};Mesh.prototype.addBuffers=function(f,e,a){var b=0;this.vertexBuffers.vertices&&
(b=this.vertexBuffers.vertices.data.length/3);for(var c in f){var d=f[c];if(d){if(d.constructor==n.Buffer)d=d.data;else if("number"!=typeof d[0]){for(var g=[],h=0,k=1E4;h<d.length;h+=k)g=Array.prototype.concat.apply(g,d.slice(h,h+k));d=g}g=n.Mesh.common_buffers[c];d.constructor===Array&&(h=n.Mesh.default_datatype,g&&g.type&&(h=g.type),d=new h(d));"vertices"==c&&(b=d.length/3);h=d.length/b;g&&g.spacing&&(h=g.spacing);k="a_"+c;g&&g.attribute&&(k=g.attribute);this.createVertexBuffer(c,k,h,d,a)}}if(e)for(c in e)if(d=
e[c]){d.constructor==n.Buffer&&(d=d.data);if("number"!=typeof d[0])for(d=[],c=0,k=1E4;c<this.data.length;c+=k)d=Array.prototype.concat.apply(d,this.data.slice(c,c+k));d.constructor===Array&&(h=Uint16Array,65536<b&&(h=Uint32Array),d=new h(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(f,e,a,b,c){var d=n.Mesh.common_buffers[f];!e&&d&&(e=d.attribute);if(!e)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();
if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";b=new n.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[f]=new n.Buffer(gl.ARRAY_BUFFER,b,a,c,this.gl);a.name=f;a.attribute=e;return a};Mesh.prototype.removeVertexBuffer=function(f){this.vertexBuffers[f]&&delete this.vertexBuffers[f]};Mesh.prototype.getVertexBuffer=function(f){return this.vertexBuffers[f]};Mesh.prototype.createIndexBuffer=
function(f,e,a){return this.indexBuffers[f]=new n.Buffer(gl.ELEMENT_ARRAY_BUFFER,e,0,a,this.gl)};Mesh.prototype.getBuffer=function(f){return this.vertexBuffers[f]};Mesh.prototype.getIndexBuffer=function(f){return this.indexBuffers[f]};Mesh.prototype.upload=function(f){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e];a.upload(f)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.bindBuffers=function(f){for(var e in this.vertexBuffers){var a=
this.vertexBuffers[e],b=f.attributes[a.attribute||e];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=function(f){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=a.attribute||e;null!=f.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(f.attributes[b])}};Mesh.prototype.clone=function(f){f=f||r.gl;var e={},a={},b;for(b in this.vertexBuffers){var c=
this.vertexBuffers[b];e[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new n.Mesh(e,a,void 0,f)};Mesh.prototype.cloneShared=function(f){f=f||r.gl;return new n.Mesh(this.vertexBuffers,this.indexBuffers,void 0,f)};Mesh.prototype.toObject=function(){var f={},e={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];f[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],
e[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:f,indexBuffers:e}};Mesh.prototype.generateMetadata=function(){var f={},e=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;f.vertices=e.length/3;f.faces=a?a.length/3:e.length/9;f.indexed=!!this.metadata.faces;this.metadata=f};Mesh.prototype.toJSON=function(){return""};Mesh.prototype.computeWireframe=function(){var f=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(f){for(var a=f.data,b=new n.Indexer,
f=0;f<a.length;f+=3)for(var c=a.subarray(f,f+3),d=0;d<c.length;d++){var g=c[d],h=c[(d+1)%c.length];b.add([Math.min(g,h),Math.max(g,h)])}a=b.unique;b=65536<e?new Uint32Array(2*a.length):new Uint16Array(2*a.length);f=0;for(e=a.length;f<e;++f)b.set(a[f],2*f)}else for(f=e/3,b=65536<e?new Uint32Array(6*f):new Uint16Array(6*f),f=0;f<e;f+=3)b[2*f]=f,b[2*f+1]=f+1,b[2*f+2]=f+1,b[2*f+3]=f+2,b[2*f+4]=f+2,b[2*f+5]=f;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.computeNormals=function(f){var e=
this.vertexBuffers.vertices.data,a=new Float32Array(e.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=vec3.create(),d=vec3.create(),g,h,k,l,q,m,x=b?b.length:e.length,p=0;p<x;p+=3)b?(g=b[p],h=b[p+1],k=b[p+2],l=e.subarray(3*g,3*g+3),q=e.subarray(3*h,3*h+3),m=e.subarray(3*k,3*k+3),g=a.subarray(3*g,3*g+3),h=a.subarray(3*h,3*h+3),k=a.subarray(3*k,3*k+3)):(l=e.subarray(3*p,3*p+3),q=e.subarray(3*p+3,3*p+6),m=e.subarray(3*p+6,3*p+9),g=a.subarray(3*p,3*p+3),h=a.subarray(3*
p+3,3*p+6),k=a.subarray(3*p+6,3*p+9)),vec3.sub(c,q,l),vec3.sub(d,m,l),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(g,g,c),vec3.add(h,h,c),vec3.add(k,k,c);if(b)for(p=0,x=a.length;p<x;p+=3)e=a.subarray(p,p+3),vec3.normalize(e,e);if(x=this.vertexBuffers.normals)x.data=a,x.upload(f);else return this.createVertexBuffer("normals",n.Mesh.common_buffers.normals.attribute,3,a);return x};Mesh.prototype.computeTangents=function(){var f=this.vertexBuffers.vertices.data,e=this.vertexBuffers.normals.data,a=this.vertexBuffers.coords.data,
b=this.indexBuffers.triangles.data;if(f&&e&&a){var c=f.length/3,d=new Float32Array(4*c),g=new Float32Array(6*c),c=g.subarray(3*c),h,k,l=vec3.create(),q=vec3.create(),m=vec3.create(),n=vec3.create();h=0;for(k=b.length;h<k;h+=3){var p=b[h],r=b[h+1],s=b[h+2],z=f.subarray(3*p,3*p+3),t=f.subarray(3*r,3*r+3),J=f.subarray(3*s,3*s+3),K=a.subarray(2*p,2*p+2),v=a.subarray(2*r,2*r+2),I=a.subarray(2*s,2*s+2),N=t[0]-z[0],w=J[0]-z[0],D=t[1]-z[1],Q=J[1]-z[1],t=t[2]-z[2],z=J[2]-z[2],J=v[0]-K[0],L=I[0]-K[0],v=v[1]-
K[1],K=I[1]-K[1],I=J*K-L*v,I=1E-9>Math.abs(I)?0:1/I;vec3.copy(l,[(K*N-v*w)*I,(K*D-v*Q)*I,(K*t-v*z)*I]);vec3.copy(q,[(J*w-L*N)*I,(J*Q-L*D)*I,(J*z-L*t)*I]);vec3.add(g.subarray(3*p,3*p+3),g.subarray(3*p,3*p+3),l);vec3.add(g.subarray(3*r,3*r+3),g.subarray(3*r,3*r+3),l);vec3.add(g.subarray(3*s,3*s+3),g.subarray(3*s,3*s+3),l);vec3.add(c.subarray(3*p,3*p+3),c.subarray(3*p,3*p+3),q);vec3.add(c.subarray(3*r,3*r+3),c.subarray(3*r,3*r+3),q);vec3.add(c.subarray(3*s,3*s+3),c.subarray(3*s,3*s+3),q)}h=0;for(k=f.length;h<
k;h+=3)f=e.subarray(h,h+3),a=g.subarray(h,h+3),vec3.subtract(m,a,vec3.scale(m,f,vec3.dot(f,a))),vec3.normalize(m,m),f=0>vec3.dot(vec3.cross(n,f,a),c.subarray(h,h+3))?-1:1,d.set([m[0],m[1],m[2],f],h/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,d)}};Mesh.prototype.getNumVertices=function(){var f=this.vertexBuffers.vertices;return f?f.data.length/f.spacing:0};Mesh.computeBounding=function(f,e){if(f){for(var a=vec3.clone(f.subarray(0,3)),b=vec3.clone(f.subarray(0,3)),
c,d=3;d<f.length;d+=3)c=f.subarray(d,d+3),vec3.min(a,c,a),vec3.max(b,c,b);a=vec3.add(vec3.create(),a,b);vec3.scale(a,a,0.5);b=vec3.subtract(vec3.create(),b,a);return BBox.setCenterHalfsize(e||BBox.create(),a,b)}};Mesh.prototype.getBoundingBox=function(){this.bounding||this.updateBounding();return this.bounding};Mesh.prototype.updateBounding=function(){var f=this.vertexBuffers.vertices.data;f&&(this.bounding=n.Mesh.computeBounding(f,this.bounding))};Mesh.prototype.setBounding=function(f,e){this.bounding=
BBox.setCenterHalfsize(this.bounding||BBox.create(),f,e)};Mesh.prototype.freeData=function(){for(var f in this.vertexBuffers)this.vertexBuffers[f].data=null,delete this[this.vertexBuffers[f].name];for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]};Mesh.prototype.configure=function(f,e){var a={},b={};e=e||{};for(var c in f)f[c]&&("indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=f[c]:n.Mesh.common_buffers[c]?a[c]=f[c]:e[c]=f[c]);this.addBuffers(a,
b);for(b in e)this[b]=e[b]};Mesh.prototype.totalMemory=function(){var f=0,e;for(e in this.vertexBuffers)f+=this.vertexBuffers[e].data.buffer.byteLength;for(e in this.indexBuffers)f+=this.indexBuffers[e].data.buffer.byteLength;return f};Mesh.load=function(f,e,a){e=e||{};a=a||new n.Mesh;a.configure(f,e);return a};Mesh.mergeMeshes=function(f,e){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,
e,d)}}function c(a,b,c,d){for(c=b+c;b<c;++b)a[b]+=d}e=e||{};for(var d={},g={},h={},k=[],l=0,q=0;q<f.length;++q){var m=f[q],x=m.mesh;k.push(l);var l=l+x.vertexBuffers.vertices.data.length/3,p;for(p in x.vertexBuffers)d[p]=d[p]?d[p]+x.vertexBuffers[p].data.length:x.vertexBuffers[p].data.length;for(p in x.indexBuffers)g[p]=g[p]?g[p]+x.indexBuffers[p].data.length:x.indexBuffers[p].data.length}for(p in d)q=e[p],null===q?delete d[p]:(q||(q=Float32Array),d[p]=new q(d[p]),h[p]=0);for(p in g)g[p]=new Uint32Array(g[p]),
h[p]=0;for(q=0;q<f.length;++q){m=f[q];x=m.mesh;for(p in x.vertexBuffers)d[p]&&(d[p].set(x.vertexBuffers[p].data,h[p]),m[p+"_matrix"]&&(l=m[p+"_matrix"],16==l.length?a(d[p],h[p],x.vertexBuffers[p].data.length,l):9==l.length&&b(d[p],h[p],x.vertexBuffers[p].data.length,l)),h[p]+=x.vertexBuffers[p].data.length);for(p in x.indexBuffers)g[p].set(x.indexBuffers[p].data,h[p]),c(g[p],h[p],x.indexBuffers[p].data.length,k[q]),h[p]+=x.indexBuffers[p].data.length}return"undefined"!=typeof gl?new n.Mesh(d,g):{vertexBuffers:d,
indexBuffers:g}};Mesh.parsers={};Mesh.encoders={};Mesh.fromURL=function(f,e,a){a=a||r.gl;var b=new n.Mesh(void 0,void 0,void 0,a);b.ready=!1;HttpRequest(f,null,function(a){var d=f.lastIndexOf("."),d=f.substr(d+1);b.parse(a,d);delete b.ready;e&&e(b,f)},function(a){e&&e(null)});return b};Mesh.prototype.parse=function(f,e){e=e.toLowerCase();var a=n.Mesh.parsers[e];if(a)return a.call(null,f,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+e;};Mesh.prototype.encode=function(f,e){f=f.toLowerCase();
var a=n.Mesh.encoders[f];if(a)return a.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+f;};Mesh.getScreenQuad=function(f){f=f||r.gl;var e=f.meshes[":screen_quad"];if(e)return e;var e=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),e=new n.Mesh({vertices:e,coords:a},void 0,void 0,f);return f.meshes[":screen_quad"]=e};Mesh.plane=function(f){f=f||{};f.triangles=[];var e=f.detailX||f.detail||1,a=f.detailY||f.detail||1,b=f.width||
f.size||1,c=f.height||f.size||1,d=f.xz,b=0.5*b,c=0.5*c;f=[];var g=[],h=[],k=[],l=vec3.fromValues(0,0,1);d&&l.set([0,1,0]);for(var q=0;q<=a;q++)for(var m=q/a,x=0;x<=e;x++){var p=x/e;d?g.push((2*p-1)*b,0,-(2*m-1)*c):g.push((2*p-1)*b,(2*m-1)*c,0);h&&h.push(p,m);k&&k.push(l[0],l[1],l[2]);x<e&&q<a&&(p=x+q*(e+1),d?(f.push(p+1,p+e+1,p),f.push(p+1,p+e+2,p+e+1)):(f.push(p,p+1,p+e+1),f.push(p+e+1,p+1,p+e+2)))}e=BBox.fromCenterHalfsize([0,0,0],d?[b,0,c]:[b,c,0]);return n.Mesh.load({vertices:g,normals:k,coords:h,
triangles:f},{bounding:e})};Mesh.plane2D=function(f){var e=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),a=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(f&&f.size){f=0.5*f.size;for(var b=0;b<e.length;++b)e[b]*=f}return new n.Mesh({vertices2D:e,coords:a})};Mesh.point=function(f){return new n.Mesh({vertices:[0,0,0]})};Mesh.cube=function(f){f=f||{};var e=0.5*(f.size||1),a={};a.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,
1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var b=0,c=a.vertices.length;b<c;++b)a.vertices[b]*=e;a.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);a.coords=
new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);f.wireframe&&(a.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));f.bounding=BBox.fromCenterHalfsize([0,0,0],[e,e,e]);return Mesh.load(a,f)};Mesh.box=function(f){f=f||{};var e=f.sizex||1,a=f.sizey||1,b=f.sizez||1,e=0.5*e,a=0.5*a,b=0.5*b,c={};c.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,
-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var d=0,g=c.vertices.length;d<g;d+=3)c.vertices[d]*=e,c.vertices[d+1]*=a,c.vertices[d+2]*=b;c.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,
-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);c.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);f.wireframe&&(c.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));f.bounding=BBox.fromCenterHalfsize([0,0,0],[e,a,b]);return Mesh.load(c,f)};Mesh.circle=function(f){f=f||{};var e=f.size||f.radius||
1,a=Math.ceil(f.slices||24),b=f.xz||!1,c=f.empty||!1;3>a&&(a=3);var d=2*Math.PI/a,g=vec3.create(),h=vec3.create(),k=vec3.fromValues(0,0,1),l=vec2.fromValues(0.5,0.5),q=vec2.create();b&&k.set([0,1,0]);var m=b?2:1,n=new Float32Array(3*(a+1)),p=new Float32Array(3*(a+1)),r=new Float32Array(2*(a+1)),s=null;n.set(g,0);p.set(k,0);r.set(l,0);for(g=l=s=0;g<a;++g)s=Math.sin(d*g),l=Math.cos(d*g),h[0]=s*e,h[m]=l*e,q[0]=0.5*s+0.5,q[1]=0.5*l+0.5,n.set(h,3*g+3),p.set(k,3*g+3),r.set(q,2*g+2);if(c)n=n.subarray(3),
p=n.subarray(3),r=n.subarray(2),s=null;else{s=new Uint16Array(3*a);c=2;d=1;b&&(c=1,d=2);for(g=0;g<a-1;++g)s[3*g]=0,s[3*g+1]=g+c,s[3*g+2]=g+d;s[3*g]=0;b?(s[3*g+1]=g+1,s[3*g+2]=1):(s[3*g+1]=1,s[3*g+2]=g+1)}f.bounding=BBox.fromCenterHalfsize([0,0,0],b?[e,0,e]:[e,e,0]);e={vertices:n,normals:p,coords:r,triangles:s};if(f.wireframe){b=new Uint16Array(2*a);for(g=0;g<a;g++)b[2*g]=g,b[2*g+1]=g+1;b[0]=a;e.wireframe=b}return Mesh.load(e,f)};Mesh.cylinder=function(f){f=f||{};for(var e=f.radius||f.size||1,a=f.height||
f.size||2,b=f.subdivisions||64,c=new Float32Array(36*b),d=new Float32Array(36*b),g=new Float32Array(24*b),h=2*Math.PI/b,k=null,l=0;l<b;++l){var q=l*h,k=[Math.sin(q),0,Math.cos(q)];c.set([k[0]*e,0.5*a,k[2]*e],18*l);d.set(k,18*l);g.set([l/b,1],12*l);k=[Math.sin(q),0,Math.cos(q)];c.set([k[0]*e,-0.5*a,k[2]*e],18*l+3);d.set(k,18*l+3);g.set([l/b,0],12*l+2);k=[Math.sin(q+h),0,Math.cos(q+h)];c.set([k[0]*e,-0.5*a,k[2]*e],18*l+6);d.set(k,18*l+6);g.set([(l+1)/b,0],12*l+4);k=[Math.sin(q+h),0,Math.cos(q+h)];c.set([k[0]*
e,0.5*a,k[2]*e],18*l+9);d.set(k,18*l+9);g.set([(l+1)/b,1],12*l+6);k=[Math.sin(q),0,Math.cos(q)];c.set([k[0]*e,0.5*a,k[2]*e],18*l+12);d.set(k,18*l+12);g.set([l/b,1],12*l+8);k=[Math.sin(q+h),0,Math.cos(q+h)];c.set([k[0]*e,-0.5*a,k[2]*e],18*l+15);d.set(k,18*l+15);g.set([(l+1)/b,0],12*l+10)}for(var k=18*l,m=12*l,n=vec3.fromValues(0,0.5*a,0),p=vec3.fromValues(0,-0.5*a,0),r=vec3.fromValues(0,1,0),s=vec3.fromValues(0,-1,0),l=0;l<b;++l){var q=l*h,z=vec3.fromValues(Math.sin(q),0,Math.cos(q)),q=vec3.fromValues(Math.sin(q+
h),0,Math.cos(q+h));c.set([z[0]*e,0.5*a,z[2]*e],k+18*l);d.set(r,k+18*l);g.set([0.5*-z[0]+0.5,0.5*z[2]+0.5],m+12*l);c.set([q[0]*e,0.5*a,q[2]*e],k+18*l+3);d.set(r,k+18*l+3);g.set([0.5*-q[0]+0.5,0.5*q[2]+0.5],m+12*l+2);c.set(n,k+18*l+6);d.set(r,k+18*l+6);g.set([0.5,0.5],m+12*l+4);c.set([q[0]*e,-0.5*a,q[2]*e],k+18*l+9);d.set(s,k+18*l+9);g.set([0.5*q[0]+0.5,0.5*q[2]+0.5],m+12*l+6);c.set([z[0]*e,-0.5*a,z[2]*e],k+18*l+12);d.set(s,k+18*l+12);g.set([0.5*z[0]+0.5,0.5*z[2]+0.5],m+12*l+8);c.set(p,k+18*l+15);
d.set(s,k+18*l+15);g.set([0.5,0.5],m+12*l+10)}b={vertices:c,normals:d,coords:g};f.bounding=BBox.fromCenterHalfsize([0,0,0],[e,0.5*a,e]);return Mesh.load(b,f)};Mesh.sphere=function(f){f=f||{};for(var e=f.radius||f.size||1,a=f.lat||f.subdivisions||16,b=f["long"]||f.subdivisions||16,c=new Float32Array((a+1)*(b+1)*3),d=new Float32Array((a+1)*(b+1)*3),g=new Float32Array((a+1)*(b+1)*2),h=new Uint16Array(a*b*6),k=f.hemi?0.5*Math.PI:Math.PI,l=0,q=0,m=0;m<=a;m++)for(var n=m*k/a,p=Math.sin(n),r=Math.cos(n),
n=0;n<=b;n++){var s=2*n*Math.PI/b,z=Math.sin(s),s=Math.cos(s)*p,t=r,z=z*p,J=1-n/b,K=1-m/a;c.set([e*s,e*t,e*z],l);d.set([s,t,z],l);g.set([J,K],q);l+=3;q+=2}for(m=l=0;m<a;m++)for(n=0;n<b;n++)k=m*(b+1)+n,q=k+b+1,h.set([q,k,k+1],l),h.set([q+1,q,k+1],l+3),l+=6;c={vertices:c,normals:d,coords:g,triangles:h};if(f.wireframe){d=new Uint16Array(b*a*4);for(l=g=0;l<a;l++){for(h=0;h<b;h++)d[g]=l*(b+1)+h,d[g+1]=l*(b+1)+h+1,g+=2;d[g-2*b]=l*(b+1)+h}for(l=0;l<b;l++)for(h=0;h<a;h++)d[g]=h*(b+1)+l,d[g+1]=(h+1)*(b+1)+
l,g+=2;c.wireframe=d}f.bounding=f.hemi?BBox.fromCenterHalfsize([0,0.5*e,0],[e,0.5*e,e],e):BBox.fromCenterHalfsize([0,0,0],[e,e,e],e);return Mesh.load(c,f)};Mesh.grid=function(f){f=f||{};var e=f.lines||11;0>e&&(e=1);var a=f.size||10;f=new Float32Array(12*e);for(var b=0.5*a,c=0,d=-b,a=a/(e-1),g=0;g<e;g++)f[c]=d,f[c+2]=-b,f[c+3]=d,f[c+5]=b,f[c+6]=b,f[c+8]=d,f[c+9]=-b,f[c+11]=d,d+=a,c+=12;return new n.Mesh({vertices:f})};Mesh.icosahedron=function(f){function e(b,c){var e=k[b]<k[c]?k[b]+":"+k[c]:k[c]+
":"+k[b],f=u[e];if(f)return f;f=d.length/3;d.push(0.5*(d[3*k[b]]+d[3*k[c]]),0.5*(d[3*k[b]+1]+d[3*k[c]+1]),0.5*(d[3*k[b]+2]+d[3*k[c]+2]));var l=Math.sqrt(d[3*f]*d[3*f]+d[3*f+1]*d[3*f+1]+d[3*f+2]*d[3*f+2]),m=d[3*f]/l,q=d[3*f+1]/l,p=d[3*f+2]/l;g.push(m,q,p);h.push(Math.atan2(m,p)/Math.PI*0.5,Math.acos(q)/Math.PI);d[3*f]*=a/l;d[3*f+1]*=a/l;d[3*f+2]*=a/l;return u[e]=f}f=f||{};var a=f.radius||f.size||1,b=void 0===f.subdivisions?0:f.subdivisions;6<b&&(b=6);for(var c=(1+Math.sqrt(5))/2,d=[-1,c,0,1,c,0,-1,
-c,0,1,-c,0,0,-1,c,0,1,c,0,-1,-c,0,1,-c,c,0,-1,c,0,1,-c,0,-1,-c,0,1],g=[],h=[],k=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],c=d.length,l=0;l<c;l+=3){var q=Math.sqrt(d[l]*d[l]+d[l+1]*d[l+1]+d[l+2]*d[l+2]),m=d[l]/q,r=d[l+1]/q,p=d[l+2]/q;g.push(m,r,p);h.push(Math.atan2(m,p),Math.acos(r));d[l]*=a/q;d[l+1]*=a/q;d[l+2]*=a/q}for(var u={},q=0;q<b;++q){m=[];c=k.length;for(l=0;l<c;l+=3){var r=e(l,l+1),p=e(l+1,l+2),s=e(l+
2,l);m.push(k[l],r,s);m.push(k[l+1],p,r);m.push(k[l+2],s,p);m.push(r,p,s)}k=m}f.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return new n.Mesh.load({vertices:d,coords:h,normals:g,triangles:k},f)};r.Texture=n.Texture=function e(a,b,c,d){c=c||{};this.gl=d=d||r.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);this.handler=d.createTexture();this.width=a;this.height=b;this.format=c.format||d.RGBA;this.type=c.type||d.UNSIGNED_BYTE;this.texture_type=c.texture_type||d.TEXTURE_2D;this.magFilter=
c.magFilter||c.filter||d.LINEAR;this.minFilter=c.minFilter||c.filter||d.LINEAR;this.wrapS=c.wrap||c.wrapS||d.CLAMP_TO_EDGE;this.wrapT=c.wrap||c.wrapT||d.CLAMP_TO_EDGE;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float)throw"Float Texture not supported";if(this.type==d.HALF_FLOAT_OES&&
!d.extensions.OES_texture_half_float)throw"Half Float Texture not supported";if(!((this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE||isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";a&&b&&(d.activeTexture(d.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1),d.bindTexture(this.texture_type,
this.handler),d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter),d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter),d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS),d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT),this.texture_type==d.TEXTURE_2D?((c=c.pixel_data)&&!c.buffer&&(c=new (this.type==d.FLOAT?Float32Array:Uint8Array)(c)),d.texImage2D(d.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,c||null)):this.texture_type==d.TEXTURE_CUBE_MAP&&
(d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,
this.height,0,this.format,this.type,null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,null)),d.bindTexture(this.texture_type,null),d.activeTexture(d.TEXTURE0))};Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,
magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=(gl.getExtension("WEBGL_depth_texture")||gl.getExtension("WEBKIT_WEBGL_depth_texture")||gl.getExtension("MOZ_WEBGL_depth_texture"))};Texture.prototype.bind=function(e){void 0==e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,this.handler);return e};Texture.prototype.unbind=function(e){void 0===
e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(e,a){this.gl.texParameteri(this.texture_type,e,a)};Texture.setUploadOptions=function(e,a){a=a||r.gl;e?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=
function(e,a){this.bind();var b=this.gl;Texture.setUploadOptions(a,b);try{b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=e.videoWidth||e.width,this.height=e.videoHeight||e.height}catch(c){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=
b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(e,a){var b=this.gl;this.bind();Texture.setUploadOptions(a,b);b.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,e);this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(texture.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=
[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];Texture.prototype.drawTo=function(e,a){function b(){6E4<=n.getTime()-this.time?(console.log("Buffer cleared"),
c.deleteRenderbuffer(c._renderbuffers_pool[l]),delete c._renderbuffers_pool[l]):setTimeout(b.bind(this),6E4)}var c=this.gl;if(this.format==c.DEPTH_COMPONENT)throw"cannot use drawTo in depth textures, use Texture.drawToColorAndDepth";var d=c.getViewport(),g=n.getTime(),h=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,h);var k=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var l=this.width+":"+this.height;c._renderbuffers_pool[l]?
(k=c._renderbuffers_pool[l],k.time=g,c.bindRenderbuffer(c.RENDERBUFFER,k)):(c._renderbuffers_pool[l]=k=c.createRenderbuffer(),k.time=g,k.width=this.width,k.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,k),setTimeout(b.bind(k),6E4))}else k=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),k.width=this.width,k.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,k);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=
this;c._current_fbo_color=h;c._current_fbo_depth=k;if(this.texture_type==c.TEXTURE_2D)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,k),e(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(g=0;6>g;g++)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+g,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,k),
e(this,g,a);c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.drawTo=function(e,a,b){for(var c=-1,d=-1,g=null,h=0;h<e.length;h++){var k=e[h];if(-1==c)c=k.width;else if(c!=k.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==d)d=k.height;else if(d!=k.height)throw"Cannot use Texture.drawTo if textures have different dimensions";
if(null==g)g=k.type;else if(g!=k.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";}g=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);gl.viewport(0,0,c,d);var l=gl.extensions.WEBGL_draw_buffers;if(!l&&1<e.length)throw"Rendering to several textures not supported";h=null;b||(h=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),h.width=c,h.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,
h));b?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,b.handler,0):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h));b=[];for(h=0;h<e.length;h++)k=e[h],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+h,gl.TEXTURE_2D,k.handler,0),b.push(gl.COLOR_ATTACHMENT0+h);1<e.length&&l.drawBuffersWEBGL(b);e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(e!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+
e;a();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(g[0],g[1],g[2],g[3])};Texture.drawToColorAndDepth=function(e,a,b){var c=e.gl;if(a.width!=e.width||a.height!=e.height)throw"Different size between color texture and depth texture";var d=c.getViewport();c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,c._framebuffer);c.viewport(0,0,e.width,e.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0);c.framebufferTexture2D(c.FRAMEBUFFER,
c.DEPTH_ATTACHMENT,c.TEXTURE_2D,a.handler,0);b();c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(d[0],d[1],d[2],d[3])};Texture.prototype.copyTo=function(e,a){var b=this.gl,c=b.getParameter(b.FRAMEBUFFER_BINDING),d=b.getViewport(),g=b.__copy_fbo=b.__copy_fbo||b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,g);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,e.handler,0);b.viewport(0,0,e.width,e.height);b.disable(b.BLEND);b.disable(b.DEPTH_TEST);this.toViewport(a);b.setViewport(d);
b.bindFramebuffer(b.FRAMEBUFFER,c);e.minFilter&&e.minFilter!=b.NEAREST&&e.minFilter!=b.LINEAR&&(e.bind(),b.generateMipmap(e.texture_type),e.has_mipmaps=!0);b.bindTexture(e.texture_type,null);return this};Texture.prototype.toViewport=function(e,a){e=e||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&e.uniforms(a);e.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(e){var a=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(e[0],e[1],e[2],e[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});
gl.clearColor(a[0],a[1],a[2],a[3])};Texture.prototype.renderQuad=function(){var e=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,g,h,k,l,q){a[0]=d;a[1]=g;b[0]=h;b[1]=k;l=l||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e});q&&l.uniforms(q);l.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(e,a,b,c,d){var g=
this,h=this.gl,k=n.Shader.getBlurShader();c||(c=new n.Texture(this.width,this.height,this.getProperties()));e/=this.width;a/=this.height;h.disable(h.DEPTH_TEST);h.disable(h.BLEND);c.drawTo(function(){g.toViewport(k,{u_intensity:b,u_offset:[0,a]})});(d||this).drawTo(function(){c.toViewport(k,{u_intensity:b,u_offset:[e,0]})});return c};Texture.fromURL=function(e,a,b,c){c=c||r.gl;a=a||{};var d=a.texture||new n.Texture(1,1,a,c);64>e.length&&(d.url=e);d.bind();Texture.setUploadOptions(a);var g=a.temp_color||
Texture.loading_color,g=a.type==c.FLOAT?new Float32Array(g):new Uint8Array(g);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,g);c.bindTexture(d.texture_type,null);d.ready=!1;if(-1!=e.toLowerCase().indexOf(".dds")){var g=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),h=new n.Texture(0,0,a,c);P.loadDDSTextureEx(c,g,e,h.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;b&&b(d,e)})}else c=new Image,
c.src=e,c.onload=function(){a.texture=d;n.Texture.fromImage(this,a);delete d.ready;b&&b(d,e)},c.onerror=function(){b&&b(null)};return d};Texture.fromImage=function(e,a){a=a||{};var b=a.texture||new n.Texture(e.width,e.height,a);b.bind();b.uploadImage(e,a);n.isPowerOfTwo(b.width)&&n.isPowerOfTwo(b.height)&&a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);a.keep_image&&(b.img=e);return b};
Texture.fromVideo=function(e,a){a=a||{};var b=a.texture||new n.Texture(e.videoWidth,e.videoHeight,a);b.bind();b.uploadImage(e,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(e,a){a=a||{};var b=new n.Texture(e.width,e.height,a);e.copyTo(b);return b};Texture.fromMemory=function(e,a,b,c){c=c||{};var d=c.texture||new n.Texture(e,a,c);Texture.setUploadOptions(c);
d.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,d.format,e,a,0,d.format,d.type,b)}catch(g){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};
Texture.fromDDSInMemory=function(e,a){a=a||{};var b=a.texture||new n.Texture(0,0,a);n.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");P.loadDDSTextureFromMemoryEx(gl,c,e,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=function(e,a,b,c){c=c||{};e=new n.Texture(e,a,c);e.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();
b.draw(a)});return e};Texture.cubemapFromImages=function(e,a){a=a||{};if(6!=e.length)throw"missing images to create cubemap";var b=e[0].width,c=e[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;b=a.texture||new Texture(b,c,a);Texture.setUploadOptions(a);b.bind();try{for(c=0;6>c;c++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,b.format,b.format,b.type,e[c])}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),b.has_mipmaps=!0);b.unbind();return b};Texture.cubemapFromImage=function(e,a){a=a||{};if(e.width!=e.height/6&&0!=e.height%6&&!a.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var b=e.width,c=e.height;void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(e.width,a.is_cross),b=c=e.width/4):a.faces?(b=
a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;var d=b;a.no_flip=!0;for(var g=[],h=0;6>h;h++){var k=createCanvas(d,d),l=k.getContext("2d");a.faces?l.drawImage(e,a.faces[h].x,a.faces[h].y,a.faces[h].width||d,a.faces[h].height||d,0,0,d,d):l.drawImage(e,0,c*h,b,c,0,0,d,d);g.push(k)}b=Texture.cubemapFromImages(g,a);a.keep_image&&(b.img=e);return b};Texture.generateCubemapCrossFacesInfo=
function(e,a){void 0===a&&(a=1);var b=e/4;return[{x:2*b,y:b,width:b,height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};Texture.cubemapFromURL=function(e,a,b){a=a||{};a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new n.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),g=0;6>g;g++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+
g,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=e;d.onload=function(){a.texture=c;(c=n.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(e,a){var b=this.gl,c=b.getViewport();e=e||this.type;var d=b.createFramebuffer(),g=b.createRenderbuffer();if(this.format==b.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";b.bindFramebuffer(b.FRAMEBUFFER,d);b.bindRenderbuffer(b.RENDERBUFFER,
g);g.width=this.width;g.height=this.height;b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);b.viewport(0,0,this.width,this.height);if(this.texture_type!=b.TEXTURE_2D)throw"getPixels only work with texture2D";b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.handler,0);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,g);d=this.format==b.RGB?3:4;a&&(d=4);g=null;g=e==b.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*
d):new Float32Array(this.width*this.height*d);b.readPixels(0,0,this.width,this.height,a?b.RGBA:this.format,e,g);b.bindFramebuffer(b.FRAMEBUFFER,b._current_fbo_color);b.bindRenderbuffer(b.RENDERBUFFER,b._current_fbo_depth);b.viewport(c[0],c[1],c[2],c[3]);return g};Texture.prototype.toCanvas=function(e,a){var b=this.gl;if(this.texture_type!=b.TEXTURE_2D)return null;var c=this.width,d=this.height;e=e||createCanvas(c,d);e.width!=c&&(e.width=c);e.height!=d&&(e.height=d);var g=this.getPixels(b.UNSIGNED_BYTE,
!0),b=e.getContext("2d"),h=b.getImageData(0,0,c,d);h.data.set(g);b.putImageData(h,0,0);a&&(c=createCanvas(c,d),d=c.getContext("2d"),d.translate(0,c.height),d.scale(1,-1),d.drawImage(e,0,0,c.width,c.height),b.drawImage(c,0,0));return e};Texture.prototype.toBlob=function(){var e=this.width,a=this.height;if(this.texture_type==gl.TEXTURE_CUBE_MAP){if(this.image)return e=createCanvas(this.image.width,this.image.height),a=e.getContext("2d"),a.drawImage(this.image,0,0),e.toBlob();console.warning("Litegl: cannot call toBlob of a cubemap GL.Texture");
return null}var b=this.getPixels(),c=createCanvas(e,a);if(!c.toBlob)throw"toBlob not supported on Canvas element";var d=c.getContext("2d"),g=d.getImageData(0,0,e,a);g.data.set(b);d.putImageData(g,0,0);e=createCanvas(e,a);a=e.getContext("2d");a.translate(0,e.height);a.scale(1,-1);a.drawImage(c,0,0);return e.toBlob()};Texture.prototype.toBase64=function(e){var a=this.width,b=this.height,c=this.getPixels(),d=createCanvas(a,b),g=d.getContext("2d"),h=g.getImageData(0,0,a,b);h.data.set(c);g.putImageData(h,
0,0);e&&(e=createCanvas(a,b),a=e.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(d,0,0),d=e);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var e={};e.width=this.width;e.height=this.height;this.metadata=e};Texture.compareFormats=function(e,a){return e&&a?e==a?!0:e.width!=a.width||e.height!=a.height||e.type!=a.type||e.texture_type!=a.texture_type?!1:!0:!1};Texture.getWhiteTexture=function(){var e=this.gl,a=e.textures[":white"];if(a)return a;a=new Uint8Array([255,
255,255,255]);return e.textures[":white"]=new n.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(){var e=this.gl,a=e.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new n.Texture(1,1,{pixel_data:a})};n.FBO=O;O.prototype.setTextures=function(e,a){this.handler||(this.handler=gl.createFramebuffer());var b=-1,c=-1,d=null;this.color_textures=e;this.depth_texture=a;for(var g=0;g<e.length;g++){var h=e[g];if(-1==b)b=h.width;else if(b!=h.width)throw"Cannot use Texture.drawTo if textures have different dimensions";
if(-1==c)c=h.height;else if(c!=h.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==d)d=h.type;else if(d!=h.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";}this.width=b;this.height=c;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);d=gl.extensions.WEBGL_draw_buffers;if(!d&&1<e.length)throw"Rendering to several textures not supported";a?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,
a.handler,0):(g=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),g.width=b,g.height=c,gl.bindRenderbuffer(gl.RENDERBUFFER,g),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b,c),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,g));this.order=[];for(g=0;g<e.length;g++)h=e[g],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+g,gl.TEXTURE_2D,h.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+g);1<e.length&&d.drawBuffersWEBGL(this.order);
b=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(b!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+b;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)};O.prototype.bind=function(e){this._old_viewport.set(gl.viewport_data);this._old_fbo=e?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.viewport(0,0,this.width,this.height)};O.prototype.unbind=function(){this._old_fbo?(gl.bindFramebuffer(gl.FRAMEBUFFER,
this._old_fbo),this._old_fbo=null):gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.setViewport(this._old_viewport)};r.Shader=n.Shader=function a(b,c,d){this._context_id=r.gl.context_id;var g=this.gl=r.gl;d=a.expandMacros(d);this.program=g.createProgram();b=b.constructor===String?n.Shader.compileSource(g.VERTEX_SHADER,d+b):b;c=c.constructor===String?n.Shader.compileSource(g.FRAGMENT_SHADER,d+c):c;g.attachShader(this.program,b,g);g.attachShader(this.program,c,g);g.linkProgram(this.program);if(!g.getProgramParameter(this.program,
g.LINK_STATUS))throw"link error: "+g.getProgramInfoLog(this.program);this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+="#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.compileSource=function(a,b,c){c=c||r.gl;var d=c.createShader(a);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw(a==c.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+c.getShaderInfoLog(d);
return d};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=a.getActiveUniform(this.program,c);if(!d)break;var g=d.name,h=g.indexOf("[");-1!=h&&-1==g.indexOf("].")&&(g=g.substr(0,h));if(d.type==a.SAMPLER_2D||d.type==a.SAMPLER_CUBE)this.samplers[g]=d.type;var h=Shader.getUniformFunc(d),k=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)k=!0;this.uniformInfo[g]={type:d.type,func:h,size:d.size,
is_matrix:k,loc:a.getUniformLocation(this.program,g)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,c);if(!d)break;h=Shader.getUniformFunc(d);this.uniformInfo[d.name]={type:d.type,func:h,size:d.size,loc:null};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=
null;switch(a.type){case gl.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:b=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:b=gl.uniform2fv;break;case gl.FLOAT_VEC3:b=gl.uniform3fv;break;case gl.FLOAT_VEC4:b=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:b=gl.uniform2iv;break;case gl.INT_VEC3:b=gl.uniform3iv;break;case gl.INT_VEC4:b=
gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:b=gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=new n.Shader(h,k),b;for(b in a)g[b]=a[b];g.ready=!0}var g=new n.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");
g.ready=!1;var h=null,k=null;HttpRequest(a,null,function(a){h=a;k&&d()});HttpRequest(b,null,function(a){k=a;h&&d()});return g};Shader.prototype.bind=function(){var a=this.gl;a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var c in a)this.setUniform(c,a[c]);
return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var b=0,c=a.length;b<c;++b){var d=a[b],g;for(g in d)this._setUniform(g,d[g])}return this};Shader.prototype.setUniform=function(a,b){this.gl._current_shader!=this&&this.bind();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(b=new Float32Array(b)),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))};Shader.prototype._setUniform=
function(a,b){var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(b=new Float32Array(b)),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))};Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,g){g=void 0===g?b==gl.LINES?"lines":"triangles":g;this.drawBuffers(a.vertexBuffers,g?a.indexBuffers[g]:
null,b,c,d)};var S=new Uint8Array(16),U=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,g){if(0!=g){var h=this.gl;h.useProgram(this.program);var k=0;S.set(U);for(var l in a){var q=a[l],m=q.attribute||l,n=this.attributes[m];null!=n&&q.buffer&&(S[n]=1,h.bindBuffer(h.ARRAY_BUFFER,q.buffer),h.enableVertexAttribArray(n),h.vertexAttribPointer(n,q.buffer.spacing,q.buffer.gl_type,!1,0,0),k=q.buffer.length/q.buffer.spacing)}a=0;0<d&&(a=d*(b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1));
0<g?k=g:b&&(k=b.buffer.length-a);for(m in this.attributes)n=this.attributes[m],S[n]||h.disableVertexAttribArray(this.attributes[m]);!k||b&&!b.buffer||(b?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,b.buffer),h.drawElements(c,k,b.buffer.gl_type,a),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):h.drawArrays(c,a,k));return this}};Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=
a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var g=b[a];c[a]=!0;return g?g+"\n":"//import code not found: "+a+"\n"})};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(a,b){return new n.Shader(n.Shader.SCREEN_VERTEX_SHADER,n.Shader.SCREEN_FRAGMENT_FX,{FX_CODE:a,FX_UNIFORMS:b||""})};Shader.prototype.toViewport=function(a){var b=n.Mesh.getScreenQuad();a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||r.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=
new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getColoredScreenShader=function(a){a=a||r.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,
Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad2"];return b?b:a.shaders[":quad2"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur"];if(b)return b;b=new n.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||r.gl;var b=a.shaders[":fxaa"];if(b)return b;b=new n.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t");return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||r.gl;var b=a.shaders[":flat"];if(b)return b;b=new n.Shader(Shader.FLAT_VERTEX_SHADER,
Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};n.create=function(a){function b(a){var c=m.mouse_buttons;n.augmentEvent(a,k);a.eventType=a.eventType||a.type;var d=getTime();p.dragging=a.dragging;p.x=a.canvasx;p.y=a.canvasy;p.left_button=m.mouse_buttons&1<<n.LEFT_MOUSE_BUTTON;p.right_button=m.mouse_buttons&1<<n.RIGHT_MOUSE_BUTTON;if("mousedown"==a.eventType){a.leftButton&&(p.left_button=!0);a.rightButton&&(p.right_button=!0);0==c&&(k.removeEventListener("mousemove",
b),c=k.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));x=d;if(m.onmousedown)m.onmousedown(a);w.trigger(m,"mousedown")}else if("mousemove"==a.eventType){if(m.onmousemove)m.onmousemove(a);w.trigger(m,"mousemove",a)}else if("mouseup"==a.eventType){0==m.mouse_buttons&&(k.addEventListener("mousemove",b),c=k.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-x;x=d;if(m.onmouseup)m.onmouseup(a);w.trigger(m,"mouseup",a)}else if("mousewheel"==
a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;if(m.onmousewheel)m.onmousewheel(a);w.trigger(m,"mousewheel",a)}if(m.onmouse)m.onmouse(a);"mousemove"!=a.eventType&&a.stopPropagation();a.preventDefault();return!1}function c(a){var b=event.changedTouches,c=b[0],d="";if(!(a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(event.type){case "touchstart":d=
"mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}a=document.createEvent("MouseEvent");a.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);c.target.dispatchEvent(a);event.preventDefault()}}function d(a){m.ongesture&&(a.eventType=a.type,m.ongesture(a));event.preventDefault()}function g(a,b){console.log(a);if(b&&m.onbuttondown)m.onbuttondown(a);else if(!b&&m.onbuttonup)m.onbuttonup(a);if(m.onbutton)m.onbutton(a);
w.trigger(m,b?"buttondown":"buttonup",a)}function h(a){console.log(a);if(m.ongamepad)m.ongamepad(a)}a=a||{};var k=null;if(a.canvas)if("string"==typeof a.canvas){if(k=document.getElementById(a.canvas),!k)throw"Canvas element not found: "+a.canvas;}else k=a.canvas;else k=createCanvas(a.width||800,a.height||600);"alpha"in a||(a.alpha=!1);try{r.gl=k.getContext("webgl",a)}catch(l){}try{r.gl=r.gl||k.getContext("experimental-webgl",a)}catch(q){}if(!r.gl)throw"WebGL not supported";var m=r.gl;k.is_webgl=!0;
m.context_id=this.last_context_id++;m.extensions={};m.extensions.OES_standard_derivatives=m.derivatives_supported=m.getExtension("OES_standard_derivatives")||!1;m.extensions.WEBGL_depth_texture=m.getExtension("WEBGL_depth_texture")||m.getExtension("WEBKIT_WEBGL_depth_texture")||m.getExtension("MOZ_WEBGL_depth_texture");m.extensions.OES_element_index_uint=m.getExtension("OES_element_index_uint");m.extensions.WEBGL_draw_buffers=m.getExtension("WEBGL_draw_buffers");m.extensions.EXT_shader_texture_lod=
m.getExtension("EXT_shader_texture_lod");m.extensions.EXT_sRGB=m.getExtension("EXT_sRGB");m.extensions.EXT_texture_filter_anisotropic=m.getExtension("EXT_texture_filter_anisotropic")||m.getExtension("WEBKIT_EXT_texture_filter_anisotropic");m.extensions.OES_texture_float_linear=m.getExtension("OES_texture_float_linear");m.extensions.OES_texture_float_linear&&(m.extensions.OES_texture_float=m.getExtension("OES_texture_float"));m.extensions.OES_texture_half_float_linear=m.getExtension("OES_texture_half_float_linear");
m.extensions.OES_texture_half_float_linear&&(m.extensions.OES_texture_half_float=m.getExtension("OES_texture_half_float"));m.HALF_FLOAT_OES=36193;m.extensions.OES_texture_half_float&&(m.HALF_FLOAT_OES=m.extensions.OES_texture_half_float.HALF_FLOAT_OES);m.HIGH_PRECISION_FORMAT=m.extensions.OES_texture_half_float?m.HALF_FLOAT_OES:m.extensions.OES_texture_float?m.FLOAT:m.UNSIGNED_BYTE;m.max_texture_units=m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS);m._viewport_func=m.viewport;m.viewport_data=new Float32Array([0,
0,m.canvas.width,m.canvas.height]);m.viewport=function(a,b,c,d){var g=this.viewport_data;g[0]=a|0;g[1]=b|0;g[2]=c|0;g[3]=d|0;this._viewport_func(a,b,c,d)};m.getViewport=function(a){return a?(a[0]=m.viewport_data[0],a[1]=m.viewport_data[1],a[2]=m.viewport_data[2],a[3]=m.viewport_data[3],a):new Float32Array(m.viewport_data)};m.setViewport=function(a){m.viewport_data.set(a);this._viewport_func(a[0],a[1],a[2],a[3])};if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";
var x=0;m.mouse_buttons=0;m.shaders={};m.textures={};m.meshes={};m.makeCurrent=function(){r.gl=this};m.execute=function(a){var b=r.gl;r.gl=this;a();r.gl=b};m.animate=function(){function a(){if(!m.destroyed){b(a);var g=getTime(),h=0.001*(g-c);if(d.onupdate)d.onupdate(h);w.trigger(m,"update",h);d.ondraw&&(h=r.gl,r.gl=d,d.ondraw(),w.trigger(m,"draw"),r.gl=h);c=g}}var b=r.requestAnimationFrame,c=getTime(),d=this;b(a)};m.destroy=function(){u&&(document.removeEventListener("keydown",u),document.removeEventListener("keyup",
u));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;r.gl==this&&(r.gl=null)};var p=m.mouse={left_button:!1,middle_button:!1,right_button:!1,x:0,y:0,deltax:0,deltay:0};m.captureMouse=function(a){k.addEventListener("mousedown",b);k.addEventListener("mousemove",b);a&&(k.addEventListener("mousewheel",b,!1),k.addEventListener("wheel",b,!1));k.addEventListener("contextmenu",function(a){a.preventDefault();return!1});k.addEventListener("touchstart",c,!0);k.addEventListener("touchmove",
c,!0);k.addEventListener("touchend",c,!0);k.addEventListener("touchcancel",c,!0);k.addEventListener("gesturestart",d);k.addEventListener("gesturechange",d);k.addEventListener("gestureend",d)};m.keys={};var u=null;m.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var g=b.target.nodeName.toLowerCase();if("input"!==g&&"textarea"!==g&&"select"!==g){b.character=String.fromCharCode(b.keyCode).toLowerCase();var g=!1,h=n.mapKeyCode(b.keyCode);h||(h=b.character);b.altKey||b.ctrlKey||b.metaKey||
(h&&(m.keys[h]="keydown"==b.type),g=m.keys[b.keyCode],m.keys[b.keyCode]="keydown"==b.type);if(g!=m.keys[b.keyCode]){if("keydown"==b.type&&m.onkeydown)m.onkeydown(b);else if("keyup"==b.type&&m.onkeyup)m.onkeyup(b);w.trigger(m,b.type,b)}if(m.onkey)m.onkey(b);d&&(b.isChar||n.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}u||(m.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",c),u=c)};m.gamepads=null;m.captureGamepads=function(){var a=navigator.getGamepads||
navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator),window.addEventListener("gamepadButtonDown",function(a){g(a,!0)},!1),window.addEventListener("MozGamepadButtonDown",function(a){g(a,!0)},!1),window.addEventListener("WebkitGamepadButtonDown",function(a){g(a,!0)},!1),window.addEventListener("gamepadButtonUp",function(a){g(a,!1)},!1),window.addEventListener("MozGamepadButtonUp",function(a){g(a,!1)},!1),window.addEventListener("WebkitGamepadButtonUp",function(a){g(a,
!1)},!1),window.addEventListener("gamepadconnected",h,!1),window.addEventListener("gamepaddisconnected",h,!1))};m.getGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(a){for(var a=a.call(navigator),b=null,c=0;4>c;c++)if(a[c]){b=a[c];if(this.gamepads)if(!this.gamepads[c]&&a[c]&&this.ongamepadconnected)this.ongamepadconnected(b);else if(this.gamepads[c]&&!a[c]&&this.ongamepaddisconnected)this.ongamepaddisconnected(this.gamepads[c]);var d={axes:[],
buttons:{},hat:""};d.axes.lx=b.axes[0];d.axes.ly=b.axes[1];d.axes.rx=b.axes[2];d.axes.ry=b.axes[3];for(c=0;c<b.buttons.length;c++)switch(c){case 0:d.buttons.a=b.buttons[c].pressed;break;case 1:d.buttons.b=b.buttons[c].pressed;break;case 2:d.buttons.x=b.buttons[c].pressed;break;case 3:d.buttons.y=b.buttons[c].pressed;break;case 4:d.buttons.lb=b.buttons[c].pressed;break;case 5:d.buttons.rb=b.buttons[c].pressed;break;case 6:d.buttons.lt=b.buttons[c].pressed;break;case 7:d.buttons.rt=b.buttons[c].pressed;
break;case 8:d.buttons.back=b.buttons[c].pressed;break;case 9:d.buttons.start=b.buttons[c].pressed;break;case 10:d.buttons.ls=b.buttons[c].pressed;break;case 11:d.buttons.rs=b.buttons[c].pressed;break;case 12:b.buttons[c].pressed&&(d.hat+="up");break;case 13:b.buttons[c].pressed&&(d.hat+="down");break;case 14:b.buttons[c].pressed&&(d.hat+="left");break;case 15:b.buttons[c].pressed&&(d.hat+="right");break;case 16:d.buttons.home=b.buttons[c].pressed}b.xbox=d}return this.gamepads=a}};m.fullscreen=function(){var a=
this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};m.snapshot=function(a,b,c,d,g){var h=createCanvas(c,d),k=h.getContext("2d"),l=k.getImageData(0,0,h.width,h.height),p=new Uint8Array(c*d*4);m.readPixels(a,b,h.width,h.height,m.RGBA,m.UNSIGNED_BYTE,p);l.data.set(p);k.putImageData(l,0,0);if(g)return h;a=createCanvas(c,d);k=a.getContext("2d");k.translate(0,
d);k.scale(1,-1);k.drawImage(h,0,0);return a};var s={};m.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(s[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=n.Texture.fromImage(this,b);a.img=this;m.textures[this.url]=a;delete s[this.url];c&&c(a)};d.src=a;s[a]=!0;return null};m.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),g=vec4.fromValues(1,1,1,1),h=vec2.create(),k={u_texture:0,u_position:b,u_color:g,u_size:c,
u_texture_area:d,u_viewport:h,u_transform:a};return function(a,g,l,p,q,n,r,s,x,u,v){b[0]=g;b[1]=l;void 0===p&&(p=a.width);void 0===q&&(q=a.height);c[0]=p;c[1]=q;void 0===n&&(n=0);void 0===r&&(r=0);void 0===s&&(s=a.width);void 0===x&&(x=a.height);d[0]=n/a.width;d[1]=r/a.height;d[2]=(n+s)/a.width;d[3]=(r+x)/a.height;h[0]=this.viewport_data[2];h[1]=this.viewport_data[3];u=u||Shader.getPartialQuadShader(this);g=Mesh.getScreenQuad(this);a.bind(0);u.uniforms(k);v&&u.uniforms(v);u.draw(g,m.TRIANGLES)}}();
m.reset=function(){m.viewport(0,0,this.canvas.width,this.canvas.height);m.disable(m.BLEND);m.disable(m.CULL_FACE);m.disable(m.DEPTH_TEST);m.frontFace(m.CCW);m._current_texture_drawto=null;m._current_fbo_color=null;m._current_fbo_depth=null};m.reset();return m};n.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};n.dragging=!1;n.last_pos=[0,0];n.augmentEvent=
function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.pageX-c.left;a.mousey=a.pageY-c.top;a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;"mousedown"==a.type?(this.dragging=!0,gl.mouse_buttons|=1<<a.which):"mousemove"!=a.type&&"mouseup"==a.type&&(gl.mouse_buttons&=~(1<<a.which),0==gl.mouse_buttons&&(this.dragging=!1));a.deltax=a.mousex-this.last_pos[0];a.deltay=a.mousey-this.last_pos[1];this.last_pos[0]=a.mousex;this.last_pos[1]=a.mousey;a.dragging=
this.dragging;a.buttons_mask=gl.mouse_buttons;a.leftButton=gl.mouse_buttons&1<<n.LEFT_MOUSE_BUTTON;a.rightButton=gl.mouse_buttons&1<<n.RIGHT_MOUSE_BUTTON;a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};var w=r.LEvent=n.LEvent={jQuery:!1,bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";b="__on_"+b;a.hasOwnProperty(b)?a[b].push([c,d]):a[b]=[[c,d]]},unbind:function(a,b,
c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";if(a.constructor===String)throw"cannot bind event to a string";b="__on_"+b;if(a.hasOwnProperty(b)){for(var g=0,h=a[b].length;g<h;++g){var k=a[b][g];if(k[0]===c&&k[1]===d){a[b].splice(g,1);break}}0==a[b].length&&delete a[b]}},unbindAll:function(a,b){if(!a)throw"cannot unbind events in null";if(!b){var c=[],d;for(d in a)"__on_"==d.substring(0,5)&&c.push(d);for(d in c)delete a[remove[d]]}else for(d in a)if("__on_"==
d.substring(0,5)){for(var c=a[d],g=0;g<c.length;++g)c[g][1]==b&&(c.splice(g,1),--g);0==c.length&&delete a[d]}},isBind:function(a,b,c,d){b="__on_"+b;if(!a||!a.hasOwnProperty(b))return!1;for(var g=0,h=a[b].length;g<h;++g){var k=a[b][g];if(k[0]===c&&k[1]===d)return!0}return!1},trigger:function(a,b,c,d){if(!a)throw"cannot trigger event from null";if(a.constructor===String)throw"cannot bind event to a string";w.jQuery&&!d&&$(a).trigger(":"+b,c);d="__on_"+b;if(a.hasOwnProperty(d)){a=a[d];d=0;for(var g=
a.length;d<g;++d){var h=a[d];if(!1==h[0].call(h[1],b,c))break}}},triggerArray:function(a,b,c,d){d=w.jQuery&&!d;for(var g="__on_"+b,h=0,k=a.length;h<k;++h){var l=a[h];if(!l)throw"cannot trigger event from null";if(l.constructor===String)throw"cannot bind event to a string";d&&$(l).trigger(":"+b,c);if(l.hasOwnProperty(g))for(var q=0,m=l[g].length;q<m;++q){var n=l[g][q];if(!1==n[0].call(n[1],b,c))break}}}};r.CLIP_INSIDE=n.CLIP_INSIDE=0;r.CLIP_OUTSIDE=n.CLIP_OUTSIDE=1;r.CLIP_OVERLAP=n.CLIP_OVERLAP=2;
r.geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*
c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,g){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;g&&vec3.add(g,a,vec3.scale(g,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,g,h){d=vec3.dot(d,g)-vec3.dot(g,b);c=vec3.sub(a,c,b);g=vec3.dot(g,c);if(Math.abs(g)<EPSILON)return!1;
g=d/g;if(0>g||1<g)return!1;h&&vec3.add(h,b,vec3.scale(h,c,g));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,g,h,k){var l=vec3.subtract(a,b,d),q=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];d=2*l[0]*c[0]+2*l[1]*c[1]+2*l[2]*c[2];g=d*d-4*q*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-g*g);if(0>g)return!1;if(h){g=Math.sqrt(g);l=1/(2*q);q=(-d+g)*l;d=(-d-g)*l;d=q<d?q:d;if(d>k)return!1;vec3.add(h,b,vec3.scale(h,c,d))}return!0}}(),testRayCylinder:function(a,b,c,d,g,h){var k=vec3.clone(a);a=vec3.add(vec3.create(),
a,vec3.scale(vec3.create(),b,1E5));var l=0;b=vec3.subtract(vec3.create(),d,c);var q=vec3.subtract(vec3.create(),k,c);c=vec3.subtract(vec3.create(),a,k);d=vec3.dot(q,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var m=vec3.dot(c,c),n=vec3.dot(q,c),l=b*m-a*a;g=vec3.dot(q,q)-g*g;var p=b*g-d*d;if(Math.abs(l)<EPSILON){if(0<p)return!1;l=0>d?-n/m:d>b?(a-n)/m:0;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0}q=b*n-a*d;p=q*q-l*p;if(0>p)return!1;l=(-q-Math.sqrt(p))/l;if(0>l||
1<l)return!1;if(0>d+l*a){if(0>=a)return!1;l=-d/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return 0>=g+2*l*(n+l*m)}if(d+l*a>b){if(0<=a)return!1;l=(b-d)/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return 0>=g+b-2*d+l*(2*(n-a)+l*m)}h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0},testRayBox:function(a,b,c,d,g,h){g=g||vec3.create();h=h||Number.MAX_VALUE;for(var k=!0,l=new Float32Array(3),q=0,m=new Float32Array(3),n=new Float32Array(3),q=0;3>q;++q)a[q]<c[q]?(l[q]=1,n[q]=c[q],k=!1):a[q]>
d[q]?(l[q]=0,n[q]=d[q],k=!1):l[q]=2;if(k)return vec3.copy(g,a),!0;for(q=0;3>q;++q)m[q]=2!=l[q]&&0!=b[q]?(n[q]-a[q])/b[q]:-1;k=0;for(q=1;3>q;q++)m[k]<m[q]&&(k=q);if(0>m[k]||m[k]>h)return!1;for(q=0;3>q;++q)if(k!=q){if(g[q]=a[q]+m[k]*b[q],g[q]<c[q]||g[q]>d[q])return!1}else g[q]=n[q];return!0},testRayBBox:function(a,b,c,d,g,h){if(d){var k=mat4.invert(mat4.create(),d);b=vec3.add(vec3.create(),a,b);a=vec3.transformMat4(vec3.create(),a,k);vec3.transformMat4(b,b,k);vec3.sub(b,b,a);b=vec3.normalize(b,b)}a=
this.testRayBox(a,b,c.subarray(6,9),c.subarray(9,12),g,h);d&&vec3.transformMat4(g,g,d);return a},testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,g=BBox.getMin(c),h=BBox.getMax(c),
k=0;3>k;++k)a[k]<g[k]?(c=a[k]-g[k],d+=c*c):a[k]>h[k]&&(c=a[k]-h[k],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,g,h){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var k=vec3.subtract(vec3.create(),a,c),l=vec3.dot(b,b),q=vec3.dot(b,d),m=vec3.dot(d,d),n=vec3.dot(b,k),p=vec3.dot(d,k),r=l*m-q*q,s;r<EPSILON?(s=0,l=q>m?n/q:p/m):(s=(q*p-m*n)/r,l=(l*p-q*n)/r);g&&vec3.add(g,a,vec3.scale(vec3.create(),b,s));h&&vec3.add(h,c,vec3.scale(vec3.create(),d,l));a=vec3.add(vec3.create(),
k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,s),vec3.scale(vec3.create(),d,l)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],
12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;
d+=c;c=planeBoxOverlap(a.subarray(16,20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,g=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(12,
16),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);return g?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,g=a.length,h=g-1;++d<g;h=d)(a[d][1]<=b[1]&&b[1]<a[h][1]||a[h][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[h][0]-a[d][0])*(b[1]-a[d][1])/(a[h][1]-a[d][1])+a[d][0]&&(c=!c);return c}};r.BBox=n.BBox=
{center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,
b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c.set(b.subarray(0,3));d.set(c);for(var g=0,h=3,k=b.length;h<k;h+=3)g=b.subarray(h,h+3),vec3.min(c,g,c),vec3.max(d,g,d);c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=
b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(0,3);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a.set([c[0]-d[0],c[1]-d[1],c[2]-d[2]],3);vec3.sub(a.subarray(3,6),c,d);a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];vec3.sub(a.subarray(6,9),a.subarray(0,3),a.subarray(3,6));vec3.add(a.subarray(9,12),a.subarray(0,3),a.subarray(3,6));a[12]=d?d:vec3.length(c);return a},transformMat4:function(a,b,c){var d=
b.subarray(3,6),g=this.tmp_corners;g.set(this.corners);for(var h=0;8>h;++h){var k=g.subarray(3*h,3*h+3);vec3.multiply(k,d,k);vec3.add(k,k,b);mat4.multiplyVec3(k,c,k)}return this.setFromPoints(a,g)},getCorners:function(a,b){var c=a.subarray(3,6),d=null;b?(b.set(this.corners),d=b):d=new Float32Array(this.corners);for(var g=0;8>g;++g){var h=d.subarray(3*g,3*g+3);vec3.multiply(h,c,h);vec3.add(h,h,a)}return d},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,6)},
getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};r.distanceToPlane=n.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};r.planeBoxOverlap=n.planeBoxOverlap=function(a,b){var c=a[3],d=vec3.fromValues(Math.abs(b[3]*a[0]),Math.abs(b[4]*a[1]),Math.abs(b[5]*a[2])),d=d[0]+d[1]+d[2],c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};r.Octree=n.Octree=function(a){this.root=null;this.total_nodes=this.total_depth=
0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.prototype.buildFromMesh=function(a){this.total_nodes=this.total_depth=0;var b=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;this.total_triangles=a?a.length/3:b.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;
var d=vec3.create();vec3.scale(d,c.size,Octree.OCTREE_MARGIN_RATIO);d[0]<Octree.OCTREE_MIN_MARGIN&&(d[0]=Octree.OCTREE_MIN_MARGIN);d[1]<Octree.OCTREE_MIN_MARGIN&&(d[1]=Octree.OCTREE_MIN_MARGIN);d[2]<Octree.OCTREE_MIN_MARGIN&&(d[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(c.min,c.min,d);vec3.add(c.max,c.max,d);c.faces=[];c.inside=0;if(a)for(d=0;d<a.length;d+=3){var g=new Float32Array([b[3*a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(g,
c,0)}else for(d=0;d<b.length;d+=9)g=new Float32Array(b.subarray(d,d+9)),this.addToNode(g,c,0);return c};Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),g=!1,h;for(h in b.c){var k=b.c[h];if(Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=
c+1);var l=b.faces.concat();b.faces=null;for(h in l){a=l[h];var d=this.computeAABB(a),g=!1,q;for(q in b.c)if(k=b.c[q],Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],
g={};this.total_nodes+=1;g.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];g.max=[g.min[0]+b[0],g.min[1]+b[1],g.min[2]+b[2]];g.faces=null;g.inside=0;a.c.push(g)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array([a[0],a[1],a[2]]),d=0;d<a.length;d+=3)for(var g=0;3>g;g++)b[g]>a[d+g]&&(b[g]=a[d+g]),c[g]<a[d+g]&&(c[g]=a[d+g]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;
for(var b=1,c=[],d=a.c,g=0;g<d.length;++g)d[g].inside&&(c.push(d[g]),b+=this.trim(d[g]));a.c=c;return b};Octree.prototype.testRay=function(a,b,c,d){a=vec3.clone(a);b=vec3.clone(b);if(!this.root)throw"Error: octree not build";c=Octree.hitTestBox(a,b,vec3.clone(this.root.min),vec3.clone(this.root.max));if(!c)return null;c=Octree.testRayInNode(this.root,a,b);return null!=c?(b=vec3.scale(vec3.create(),b,c.t),vec3.add(b,b,a),c.pos=b,c):null};Octree.testRayInNode=function(a,b,c){var d=null,g=null;if(a.faces)for(var h=
0,k=a.faces.length;h<k;++h)d=a.faces[h],d=Octree.hitTestTriangle(b,c,d.subarray(0,3),d.subarray(3,6),d.subarray(6,9)),null!=d&&(g?g.mergeWith(d):g=d);if(a.c)for(h=0;h<a.c.length;++h)k=a.c[h],d=Octree.hitTestBox(b,c,vec3.clone(k.min),vec3.clone(k.max)),null==d||g&&d.t>g.t||(d=Octree.testRayInNode(k,b,c),null!=d&&(g?g.mergeWith(d):g=d));return g};Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?
!1:!0};Octree.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),g=vec3.create(),h=vec3.create(),k=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,q,m,n){vec3.subtract(a,m,l);vec3.subtract(b,n,l);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,l,q);c[0]=1/q[0];c[1]=1/q[1];c[2]=1/q[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(g,a,b);var p=vec3.maxValue(d),r=vec3.minValue(g);return 0<p&&p<r?(l=vec3.add(vec3.create(),vec3.scale(h,
q,p),l),vec3.add(m,m,k),vec3.subtract(m,m,k),new HitTest(p,l,vec3.fromValues((l[0]>n[0])-(l[0]<m[0]),(l[1]>n[1])-(l[1]<m[1]),(l[2]>n[2])-(l[2]<m[2])))):null}}();Octree.hitTestTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(g,h,k,l,q){vec3.subtract(a,l,k);vec3.subtract(b,q,k);l=vec3.cross(vec3.create(),a,b);vec3.normalize(l,l);if(0<vec3.dot(l,h))return null;q=vec3.dot(l,vec3.subtract(d,k,g))/vec3.dot(l,h);if(0<q){h=vec3.scale(vec3.create(),h,
q);vec3.add(h,h,g);vec3.subtract(c,h,k);g=vec3.dot(b,b);k=vec3.dot(b,a);var m=vec3.dot(b,c),n=vec3.dot(a,a),p=vec3.dot(a,c),r=g*n-k*k,n=(n*m-k*p)/r;g=(g*p-k*m)/r;if(0<=n&&0<=g&&1>=n+g)return new HitTest(q,h,l)}return null}}();r.HitTest=n.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};r.Raytracer=n.Raytracer=function(a,b){this.viewport=b=b||gl.getViewport();
var c=b[0],d=c+b[2],g=b[1],h=g+b[3];this.ray00=vec3.unproject(vec3.create(),vec3.fromValues(c,g,1),a,b);this.ray10=vec3.unproject(vec3.create(),vec3.fromValues(d,g,1),a,b);this.ray01=vec3.unproject(vec3.create(),vec3.fromValues(c,h,1),a,b);this.ray11=vec3.unproject(vec3.create(),vec3.fromValues(d,h,1),a,b);c=this.eye=vec3.create();vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,
c)};Raytracer.prototype.getRayForPixel=function(a,b){a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];var c=vec3.lerp(vec3.create(),this.ray00,this.ray10,a),d=vec3.lerp(vec3.create(),this.ray01,this.ray11,a);return vec3.normalize(vec3.create(),vec3.lerp(vec3.create(),c,d,b))};var V=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,g){var h=new Float32Array(30);g&&(g=mat4.invert(V,g),a=mat4.multiplyVec3(h.subarray(3,6),g,a),b=mat4.rotateVec3(h.subarray(6,9),g,b));
var k=vec3.subtract(h.subarray(9,12),c,a);vec3.divide(k,k,b);var l=vec3.subtract(h.subarray(12,15),d,a);vec3.divide(l,l,b);g=vec3.min(h.subarray(15,18),k,l);k=vec3.max(h.subarray(18,21),k,l);g=vec3.maxValue(g);k=vec3.minValue(k);return 0<g&&g<=k?(b=vec3.scale(h.subarray(21,24),b,g),vec3.add(b,a,b),vec3.addValue(h.subarray(24,27),c,1E-6),vec3.subValue(h.subarray(27,30),d,1E-6),new HitTest(g,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=
function(a,b,c,d){var g=vec3.subtract(vec3.create(),a,c),h=vec3.dot(b,b),k=2*vec3.dot(b,g),g=vec3.dot(g,g)-d*d,g=k*k-4*h*g;return 0<g?(h=(-k-Math.sqrt(g))/(2*h),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,h)),new HitTest(h,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,g){var h=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),g,c);g=vec3.cross(vec3.create(),h,k);vec3.normalize(g,g);d=vec3.dot(g,vec3.subtract(vec3.create(),
c,a))/vec3.dot(g,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,d));var l=vec3.subtract(vec3.create(),a,c);c=vec3.dot(k,k);b=vec3.dot(k,h);var k=vec3.dot(k,l),n=vec3.dot(h,h),h=vec3.dot(h,l),l=c*n-b*b,n=(n*k-b*h)/l,h=(c*h-b*k)/l;if(0<=n&&0<=h&&1>=n+h)return new HitTest(d,a,g)}return null};Mesh.parseOBJ=function(a,b){b=b||{};for(var c=[],d=[],g=[],h=[],k=[],l=[],n=[],m={},r=0,p=null,u=null,s=0,z=0,t=u=0,w=0,D=0,v=null,I=!1,N=!1,O=!1,P=!1,Q=0,L=b.noindex?b.noindex:1E7<a.length?!0:
!1,E=b.flipAxis,F=E||b.flipNormals,y=null,A=[],B=a.split("\n"),C=B.length,H=0;H<C;++H)if(p=B[H].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=p[0]&&""!=p)if(v=p.split(" "),P&&"v"==v[0]&&(P=!1),"v"==v[0])E?k.push(-1*parseFloat(v[1]),parseFloat(v[3]),parseFloat(v[2])):k.push(parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]));else if("vt"==v[0])l.push(parseFloat(v[1]),parseFloat(v[2]));else if("vn"==v[0])F?n.push(-parseFloat(v[2]),-parseFloat(v[3]),parseFloat(v[1])):n.push(parseFloat(v[1]),parseFloat(v[2]),
parseFloat(v[3]));else if("f"==v[0]){if(P=!0,!(4>v.length)){for(var M=[],p=1;p<v.length;++p){if(!(v[p]in m)||L){u=v[p].split("/");if(1==u.length)u=z=s=parseInt(u[0])-1;else if(2==u.length)s=parseInt(u[0])-1,z=parseInt(u[1])-1,u=-1;else if(3==u.length)s=parseInt(u[0])-1,z=parseInt(u[1])-1,u=parseInt(u[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;3<p&&L&&(t=c.length,c.push(c[t-9*(p-3)],c[t-9*(p-3)+1],c[t-9*(p-3)+2]),c.push(c[t-3],c[t-2],c[t-1]),t=d.length,d.push(d[t-
6*(p-3)],d[t-6*(p-3)+1]),d.push(d[t-2],d[t-1]),t=g.length,g.push(g[t-9*(p-3)],g[t-9*(p-3)+1],g[t-9*(p-3)+2]),g.push(g[t-3],g[t-2],g[t-1]));D=w=t=0;3*s+2<k.length&&(I=!0,t=k[3*s+0],w=k[3*s+1],D=k[3*s+2]);c.push(t,w,D);w=t=0;2*z+1<l.length&&(N=!0,t=l[2*z+0],w=l[2*z+1]);d.push(t,w);w=t=0;D=1;-1!=u&&(3*u+2<n.length&&(O=!0,t=n[3*u+0],w=n[3*u+1],D=n[3*u+2]),g.push(t,w,D));L||(m[v[p]]=r++)}L||(s=m[v[p]],M.push(s),Q<s&&(Q=s))}if(!L)for(p=2;p<M.length;p++)h.push(M[0],M[p-1],M[p])}}else"g"==v[0]||"usemtl"==
v[0]?1<v.length&&(null!=y&&(y.length=h.length-y.start,0<y.length&&A.push(y)),y={name:v[1],start:h.length,length:-1,material:""}):"usemtl"==v[0]&&y&&(y.material=v[1]);if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;y&&1<h.length-y.start&&(y.length=h.length-y.start,A.push(y));if((65536<Q||L)&&0<h.length){console.log("Deindexing mesh...");k=new Float32Array(3*h.length);l=g&&g.length?new Float32Array(3*h.length):null;n=d&&d.length?new Float32Array(2*h.length):
null;for(p=0;p<h.length;p+=1)k.set(c.slice(3*h[p],3*h[p]+3),3*p),l&&l.set(g.slice(3*h[p],3*h[p]+3),3*p),n&&n.set(d.slice(2*h[p],2*h[p]+2),2*p);c=k;l&&(g=l);n&&(d=n);h=null}p={};I&&(p.vertices=new Float32Array(c));O&&0<g.length&&(p.normals=new Float32Array(g));N&&0<d.length&&(p.coords=new Float32Array(d));h&&0<h.length&&(p.triangles=new Uint16Array(h));c={};1<A.length&&(c.groups=A);p.info=c;A=null;A=Mesh.load(p,null,b.mesh);A.updateBounding();return A};Mesh.parsers.obj=Mesh.parseOBJ.bind(Mesh);Mesh.encoders.obj=
function(a,b){var c=a.getBuffer("vertices");if(!c)return null;for(var d="# Generated with liteGL.js by Javi Agenjo\n\n",c=c.data,g=0;g<c.length;g+=3)d+="v "+c[g].toFixed(4)+" "+c[g+1].toFixed(4)+" "+c[g+2].toFixed(4)+"\n";if(g=a.getBuffer("normals"))for(var d=d+"\n",h=g.data,g=0;g<h.length;g+=3)d+="vn "+h[g].toFixed(4)+" "+h[g+1].toFixed(4)+" "+h[g+2].toFixed(4)+"\n";if(g=a.getBuffer("coords"))for(d+="\n",h=g.data,g=0;g<h.length;g+=2)d+="vt "+h[g].toFixed(4)+" "+h[g+1].toFixed(4)+"  0.0000\n";d+=
"\ng mesh\n";if(g=a.getIndexBuffer("triangles"))for(c=g.data,g=0;g<c.length;g+=3)d+="f "+(c[g]+1)+"/"+(c[g]+1)+"/"+(c[g]+1)+" "+(c[g+1]+1)+"/"+(c[g+1]+1)+"/"+(c[g+1]+1)+" "+(c[g+2]+1)+"/"+(c[g+2]+1)+"/"+(c[g+2]+1)+"\n";else for(g=0;g<c.length/3;g+=3)d+="f "+(g+1)+"/"+(g+1)+"/"+(g+1)+" "+(g+2)+"/"+(g+2)+"/"+(g+2)+" "+(g+3)+"/"+(g+3)+"/"+(g+3)+"\n";return d}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
